<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Name: Hawkins - ROL Assignment</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Inter:wght@400;500;600&family=Bebas+Neue&display=swap" rel="stylesheet">
    
    <style>
        .st-font { font-family: 'Bebas Neue', sans-serif; }
        .tech-font { font-family: 'Rajdhani', sans-serif; }

        body {
            background-color: #000000;
            color: #f7f7f7;
            font-family: 'Inter', sans-serif;
            line-height: 1.75; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.1"><rect width="100" height="100" fill="black"/><path d="M0 0L100 100M100 0L0 100" stroke="%23d1121c" stroke-width="1"/></svg>');
        }
        
        .st-title {
            font-family: 'Bebas Neue', sans-serif;
            color: #d1121c;
            text-shadow: 0 0 5px rgba(209, 18, 28, 0.7), 0 0 10px rgba(209, 18, 28, 0.6);
            letter-spacing: 0.2em;
        }

        .game-panel {
            background-color: rgba(10, 0, 0, 0.85);
            border: 3px solid #330000;
            box-shadow: 0 0 60px rgba(209, 18, 28, 0.5);
            border-radius: 10px;
        }

        input[type="text"], select {
            background-color: #1a0000;
            border: 1px solid #330000;
            color: #f7f7f7;
            padding: 12px;
            border-radius: 4px;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
            font-family: 'Rajdhani', monospace;
        }

        .spin-button {
            background-color: #d1121c;
            color: #f7f7f7;
            font-weight: 700;
            padding: 15px 30px;
            border-radius: 6px;
            transition: background-color 0.3s, transform 0.1s, box-shadow 0.3s;
            font-family: 'Rajdhani', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            box-shadow: 0 0 10px rgba(209, 18, 28, 0.3);
        }

        #spinner-text {
            color: #ffcc00;
            font-size: 3rem;
            text-shadow: 0 0 15px rgba(255, 204, 0, 0.8);
            font-family: 'Bebas Neue', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.2em;
        }

        #result-name {
            font-size: 3.5rem;
            color: #d1121c;
            text-shadow: 0 0 10px rgba(209, 18, 28, 0.8);
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.3em;
        }
    </style>
</head>
<body class="antialiased">

    <header class="w-full bg-black/90">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <a href="#" class="text-xl font-bold st-title text-white tracking-wider">NOYZZING // OPS</a>
            <div class="text-sm font-semibold tech-font text-red-500 uppercase tracking-wider">
                Alliance: **ROL**
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-10 flex-grow flex items-center justify-center">
        
        <div class="game-panel w-full max-w-2xl p-6 md:p-10">
            <h1 class="text-4xl md:text-6xl text-center mb-1 uppercase tracking-wider st-title">
                Code Name: HAWKINS
            </h1>
            <p class="text-center text-red-700 mb-8 text-sm uppercase tracking-wider font-semibold tech-font">
                STRANGER THINGS GLOBAL ROSTER - ROL ALLIANCE
            </p>

            <div id="user-profile" class="bg-gray-900/50 border border-red-900 text-gray-400 p-3 rounded-lg mb-6 text-xs font-mono">
                 <p class="font-bold text-red-400 mb-1">ROSTER SYNC STATUS</p>
                 <p><span class="text-red-500">Session ID:</span> <span id="current-user-id">Loading...</span></p>
                 <p><span class="text-red-500">Characters Claimed:</span> <span id="global-count">0</span> globally</p>
            </div>

            <div id="status-message" class="bg-blue-900/30 border border-blue-500/50 text-blue-300 p-3 rounded-lg mb-6">
                <i class="fa-solid fa-satellite-dish mr-2"></i> Connecting to the Stranger Things roster...
            </div>

            <div id="assignment-form" class="space-y-4 hidden">
                <p class="text-sm text-gray-300 mb-4 tech-font">Input operator details to retrieve **Hawkins Lab** code name assignment.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="game-name" class="block text-sm font-medium text-red-400 mb-1">Operator Alias:</label>
                        <input type="text" id="game-name" placeholder="ROL | NoyZZiz" maxlength="20" required>
                    </div>
                    <div>
                        <label for="player-gender" class="block text-sm font-medium text-red-400 mb-1">Character Pool:</label>
                        <select id="player-gender" required>
                            <option value="" disabled selected>-- Select --</option>
                            <option value="Male">Male Character Pool</option>
                            <option value="Female">Female Character Pool</option>
                        </select>
                    </div>
                </div>

                <div class="pt-4">
                    <button id="assign-btn" class="spin-button w-full">
                        <i class="fa-solid fa-mask mr-2"></i> BEGIN CLASSIFIED ASSIGNMENT
                    </button>
                </div>
            </div>

            <div id="spinner" class="mt-8 flex items-center justify-center p-6 hidden rounded-lg">
                <span id="spinner-text">SYNCING WITH STRANGER THINGS ROSTER</span>
            </div>

            <div id="result-display" class="mt-8 text-center hidden p-6 border-2 border-red-900 rounded-lg">
                <h3 class="text-lg text-gray-300 font-medium uppercase tracking-wider mb-2 tech-font">OPERATOR ASSIGNMENT SUCCESSFUL:</h3>
                <p id="result-name" class="font-bold"></p>
                <p id="result-char-type" class="text-sm text-red-600 mt-2 font-mono"></p>
                <p id="discord-notice" class="text-xs text-green-400 mt-2 hidden">
                    <i class="fa-brands fa-discord mr-1"></i> Notification sent to Discord!
                </p>
                <button id="share-btn" class="spin-button w-full mt-4 bg-green-600 hover:bg-green-700 text-xs">
                    <i class="fa-solid fa-share-nodes mr-1"></i> SHARE WITH ROL ALLIANCE
                </button>
                <button id="reset-btn" class="spin-button w-full mt-2 text-xs bg-red-800 hover:bg-red-900">
                    <i class="fa-solid fa-radiation mr-1"></i> RESET & RE-ROLL (<span id="reset-count-display">2</span> TRIES LEFT)
                </button>
            </div>
            
            <div class="mt-10">
                <h2 class="text-2xl st-title mb-3 border-b border-red-900 pb-1">
                    <i class="fa-solid fa-users text-red-500 mr-2"></i> STRANGER THINGS GLOBAL ROSTER
                </h2>
                <div id="global-roster" class="text-sm text-gray-400 font-mono p-4 border border-red-900 rounded-lg">
                    Loading Stranger Things roster from Discord...
                </div>
            </div>
            
        </div>

    </main>

    <footer class="w-full text-center text-gray-600 text-xs py-4 bg-black/50">
        &copy; 2025 Noyzzing | Stranger Things Roster | LIVE DISCORD SYNC ACTIVE
    </footer>

    <script>
        // ===== CONFIGURATION =====
        // Use your deployed Vercel API base URL here (or use env.js to inject at runtime)
       const API_BASE = 'https://your-actual-vercel-app.vercel.app/api';
        
        // ===== GLOBAL STATE =====
        let currentAssignment = null;
        let globalUsedCharacters = new Set();
        let resetCount = 2;
        
        const ELEMENTS = {
            form: document.getElementById('assignment-form'),
            spinner: document.getElementById('spinner'),
            spinnerText: document.getElementById('spinner-text'),
            resultDisplay: document.getElementById('result-display'),
            resultName: document.getElementById('result-name'),
            resultCharType: document.getElementById('result-char-type'),
            discordNotice: document.getElementById('discord-notice'),
            assignBtn: document.getElementById('assign-btn'),
            resetBtn: document.getElementById('reset-btn'),
            shareBtn: document.getElementById('share-btn'),
            resetCountDisplay: document.getElementById('reset-count-display'),
            gameName: document.getElementById('game-name'),
            playerGender: document.getElementById('player-gender'),
            statusMessage: document.getElementById('status-message'),
            currentUserId: document.getElementById('current-user-id'),
            globalCount: document.getElementById('global-count'),
            globalRoster: document.getElementById('global-roster')
        };

        const CHARACTERS = {
            Male: [
                'Mike Wheeler', 'Will Byers', 'Dustin Henderson', 'Lucas Sinclair', 'Jim Hopper',
                'Steve Harrington', 'Eddie Munson', 'Jonathan Byers', 'Argyle', 'Murray Bauman',
                'Bob Newby', 'Dr. Alexey', 'Ted Wheeler', 'Mr. Clarke', 'Billy Hargrove',
                'Dr. Brenner', 'Dr. Owens', 'Lt. Colonel Sullivan', 'Jason Carver', 'Patrick McKinney',
                'Fred Benson', 'Calvin Powell', 'Phillip Callahan', 'Tommy H.', 'Keith',
                'Enzo (Dmitri)', 'Yuri Ismaylov', 'Larry Kline', 'Senator Hatch', 'Peter Ballard',
                'The Shadow Monster', 'Lonnie Byers', 'Axel', 'Mick', 'Agent Orange', 'Greg', 'Rich'
            ],
            Female: [
                'Eleven (El)', 'Max Mayfield', 'Nancy Wheeler', 'Robin Buckley', 'Joyce Byers',
                'Erica Sinclair', 'Suzie Bingham', 'Chrissy Cunningham', 'Angela', 'Vickie',
                'Holly Wheeler', 'Tammy Thompson', 'Mrs. Wheeler', 'Claudia Henderson', 'Kali Prasad (Eight)',
                'Mrs. Henderson', 'Connie Frazier', 'Patty', 'Flo', 'Becky Ives',
                'Heather Holloway', 'Melanie', 'Stacy', 'Tina', 'Carol', 'Ms. Kelly',
                'Mrs. Driscoll', 'Anya', 'Sara Hopper', 'Janet Hayes', 'Florence'
            ],
            Villain_Neutral: [
                'Vecna (Henry Creel)', 'The Mind Flayer', 'Demogorgon', 'Demo-Dog', 'The Gate',
                'The Rift', 'Dr. Brenner', 'Dr. Owens', 'Peter Ballard'
            ]
        };

        // ===== API FUNCTIONS =====
        async function callAPI(endpoint, data = {}) {
            try {
                const url = `${API_BASE}/${endpoint}`;
                const options = {
                    method: endpoint === 'characters/claimed' ? 'GET' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };

                if (endpoint !== 'characters/claimed') {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(url, options);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        async function loadGlobalData() {
            try {
                displayStatus('info', 'üõ∞Ô∏è Syncing with global database...');
                const usedChars = await callAPI('characters/claimed');
                globalUsedCharacters = new Set(usedChars);
                ELEMENTS.globalCount.textContent = globalUsedCharacters.size;
                
                // Update roster display
                ELEMENTS.globalRoster.innerHTML = `
                    <div class="text-green-400 mb-2">
                        <i class="fa-solid fa-circle-check mr-2"></i>
                        Connected to Discord & Google Sheets
                    </div>
                    <div class="text-xs">
                        <strong>${globalUsedCharacters.size} characters</strong> claimed globally<br>
                        <strong>${getAvailableCount()} characters</strong> still available
                    </div>
                `;
                
                displayStatus('success', `‚úÖ Global sync complete! ${globalUsedCharacters.size} characters tracked.`);
                return true;
            } catch (error) {
                console.error('Failed to load global data:', error);
                ELEMENTS.globalRoster.innerHTML = `
                    <div class="text-red-400">
                        <i class="fa-solid fa-triangle-exclamation mr-2"></i>
                        Offline Mode - Using local data only
                    </div>
                `;
                displayStatus('error', '‚ö†Ô∏è Offline mode: Using local data only');
                return false;
            }
        }

        function getAvailableCount() {
            const totalChars = CHARACTERS.Male.length + CHARACTERS.Female.length + CHARACTERS.Villain_Neutral.length;
            return totalChars - globalUsedCharacters.size;
        }

        async function saveAssignmentToGlobal(playerName, characterName, gender, sessionId) {
            try {
                const result = await callAPI('characters/claim', { 
                    playerName, 
                    characterName, 
                    characterPool: gender, 
                    sessionId 
                });
                
                if (result.success) {
                    globalUsedCharacters.add(characterName);
                    ELEMENTS.globalCount.textContent = globalUsedCharacters.size;
                    ELEMENTS.discordNotice.classList.remove('hidden');
                    return true;
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Failed to save globally:', error);
                displayStatus('warning', '‚ö†Ô∏è Assignment saved locally only. Global sync failed.');
                return false;
            }
        }

        // ===== CORE GAME FUNCTIONS =====
        async function initializeGame() {
            const sessionId = 'ROL-' + Date.now().toString().slice(-6) + '-' + Math.random().toString(36).substr(2, 4).toUpperCase();
            ELEMENTS.currentUserId.textContent = sessionId;
            
            // Load global data first
            const globalSync = await loadGlobalData();
            
            if (globalSync) {
                ELEMENTS.form.classList.remove('hidden');
            } else {
                // Even if global sync fails, show form for offline use
                ELEMENTS.form.classList.remove('hidden');
            }
            
            loadExistingAssignment();
            setupEventListeners();
        }

        function setupEventListeners() {
            ELEMENTS.assignBtn.addEventListener('click', startAssignment);
            ELEMENTS.resetBtn.addEventListener('click', resetAssignment);
            ELEMENTS.shareBtn.addEventListener('click', shareAssignment);
        }

        function loadExistingAssignment() {
            const saved = localStorage.getItem('rol_assignment');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    currentAssignment = data;
                    ELEMENTS.gameName.value = data.gameName || '';
                    ELEMENTS.gameName.disabled = true;
                    ELEMENTS.playerGender.value = data.gender || '';
                    ELEMENTS.playerGender.disabled = true;
                    displayFinalResult(data.characterName, data.gender, true);
                    ELEMENTS.assignBtn.disabled = true;
                } catch (e) {
                    console.log('No previous assignment found');
                }
            }
        }

        async function startAssignment() {
            const gameName = ELEMENTS.gameName.value.trim();
            const gender = ELEMENTS.playerGender.value;
            
            if (!gameName || !gender) {
                displayStatus('error', '‚ö†Ô∏è Operator Alias and Character Pool required.');
                return;
            }

            ELEMENTS.form.classList.add('hidden');
            ELEMENTS.spinner.classList.remove('hidden');
            ELEMENTS.spinnerText.textContent = "ANALYZING GLOBAL AVAILABILITY...";
            ELEMENTS.assignBtn.disabled = true;
            ELEMENTS.discordNotice.classList.add('hidden');

            setTimeout(async () => {
                try {
                    // Get available characters (not used globally)
                    const availablePool = (gender === 'Male' ? CHARACTERS.Male : CHARACTERS.Female)
                        .filter(name => !globalUsedCharacters.has(name));
                    const availableVillain = CHARACTERS.Villain_Neutral
                        .filter(name => !globalUsedCharacters.has(name));

                    let pool = [...availablePool, ...availableVillain];
                    
                    if (pool.length === 0) {
                        displayStatus('error', '‚ùå ALL CHARACTERS TAKEN GLOBALLY! No unique assignments available.');
                        resetToForm();
                        return;
                    }
                    
                    // Select random available character
                    const randomIndex = Math.floor(Math.random() * pool.length);
                    const assignedCharacter = pool[randomIndex];
                    
                    // Save locally and globally
                    const sessionId = ELEMENTS.currentUserId.textContent;
                    const newAssignment = {
                        userId: sessionId,
                        gameName: gameName,
                        characterName: assignedCharacter,
                        gender: gender,
                        timestamp: new Date().toISOString()
                    };

                    // Save to global database (this also sends Discord notification)
                    await saveAssignmentToGlobal(gameName, assignedCharacter, gender, sessionId);

                    // Save locally
                    localStorage.setItem('rol_assignment', JSON.stringify(newAssignment));
                    currentAssignment = newAssignment;
                    
                    // Display result
                    ELEMENTS.spinner.classList.remove('spinning');
                    ELEMENTS.spinnerText.textContent = "ASSIGNMENT SECURED!";
                    
                    setTimeout(() => {
                        ELEMENTS.spinner.classList.add('hidden');
                        displayFinalResult(assignedCharacter, gender, false);
                        ELEMENTS.gameName.disabled = true;
                        ELEMENTS.playerGender.disabled = true;
                        
                        // Refresh global data to show updated counts
                        loadGlobalData();
                    }, 1500);
                    
                } catch (error) {
                    console.error("Assignment failed:", error);
                    displayStatus('error', '‚ùå Assignment failed. Try again.');
                    resetToForm();
                }
            }, 2000);
        }

        function displayFinalResult(characterName, gender, isExisting) {
            ELEMENTS.resultName.textContent = characterName.toUpperCase();
            
            let charType = 'HAWKINS CREW / PROTAGONIST';
            if (CHARACTERS.Villain_Neutral.includes(characterName)) {
                charType = 'UPSIDE DOWN AGENT / NEUTRAL';
            }

            ELEMENTS.resultCharType.textContent = `(${charType})`;
            ELEMENTS.resultDisplay.classList.remove('hidden');
            
            if(isExisting) {
                displayStatus('info', `‚úÖ Welcome back, Operator ${characterName.toUpperCase()}`);
            } else {
                displayStatus('success', `üéâ GLOBAL ASSIGNMENT SECURED! ${characterName.toUpperCase()} is now yours exclusively!`);
            }
            
            updateResetButtonState();
        }

        function updateResetButtonState() {
            ELEMENTS.resetCountDisplay.textContent = resetCount;
            if (resetCount <= 0) {
                ELEMENTS.resetBtn.disabled = true;
                ELEMENTS.resetBtn.innerHTML = '<i class="fa-solid fa-lock mr-1"></i> ASSIGNMENT LOCKED (NO RESETS LEFT)';
            }
        }

        function shareAssignment() {
            if (!currentAssignment) return;
            
            const shareText = `
üéÆ ROL ALLIANCE - CHARACTER ASSIGNMENT üéÆ

OPERATOR: ${currentAssignment.gameName}
CODE NAME: ${currentAssignment.characterName}
POOL: ${currentAssignment.gender}
SESSION: ${currentAssignment.userId}

‚úÖ This character is now LOCKED globally across all ROL operators!
üîó Share this game: [URL_TO_YOUR_HTML_FILE]

#StrangerThings #ROLAlliance
            `.trim();
            
            if (navigator.share) {
                navigator.share({
                    title: 'ROL Character Assignment',
                    text: shareText
                });
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    displayStatus('success', 'üìã Assignment copied! Share in your group chat.');
                });
            }
        }

        function resetAssignment() {
            if (resetCount <= 0) {
                displayStatus('error', '‚ùå No reset attempts remaining.');
                return;
            }

            if (!confirm(`WARNING: This will free up "${currentAssignment.characterName}" for others. Continue?`)) {
                return;
            }
            
            resetCount--;
            localStorage.removeItem('rol_assignment');
            currentAssignment = null;
            ELEMENTS.gameName.disabled = false;
            ELEMENTS.playerGender.disabled = false;
            ELEMENTS.resultDisplay.classList.add('hidden');
            ELEMENTS.form.classList.remove('hidden');
            ELEMENTS.assignBtn.disabled = false;
            ELEMENTS.discordNotice.classList.add('hidden');
            
            updateResetButtonState();
            displayStatus('warning', `üîÑ Reset complete. ${resetCount} attempts remaining.`);
        }

        function resetToForm() {
            ELEMENTS.spinner.classList.add('hidden');
            ELEMENTS.assignBtn.disabled = false;
            ELEMENTS.form.classList.remove('hidden');
        }

        function displayStatus(type, message) {
            ELEMENTS.statusMessage.innerHTML = message;
            ELEMENTS.statusMessage.className = 'p-3 rounded-lg mb-6';
            
            const styles = {
                error: 'bg-red-900/30 border-red-500/50 text-red-300',
                success: 'bg-green-900/30 border-green-500/50 text-green-300',
                info: 'bg-blue-900/30 border-blue-500/50 text-blue-300',
                warning: 'bg-yellow-900/30 border-yellow-500/50 text-yellow-300'
            };
            
            ELEMENTS.statusMessage.classList.add(styles[type]);
            ELEMENTS.statusMessage.classList.remove('hidden');

            if (type !== 'error') {
                setTimeout(() => ELEMENTS.statusMessage.classList.add('hidden'), 5000);
            }
        }

        // ===== START THE GAME =====
        initializeGame();
    </script>
</body>
</html>