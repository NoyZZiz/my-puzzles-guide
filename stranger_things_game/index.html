<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Name: Hawkins - ROL Operator Assignment</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Inter:wght@400;500;600&family=Bebas+Neue&display=swap" rel="stylesheet">
    
    <style>
        /* BASE THEME & FONTS */
        .st-font { font-family: 'Bebas Neue', sans-serif; }
        .tech-font { font-family: 'Rajdhani', sans-serif; }

        body {
            background-color: #000000;
            color: #f7f7f7;
            font-family: 'Inter', sans-serif;
            line-height: 1.75; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            /* Upside Down Texture */
            background-image: radial-gradient(ellipse at center, rgba(30, 0, 0, 0.2) 0%, rgba(0, 0, 0, 1) 100%);
            background-size: cover;
        }
        
        /* THE ICONIC RED GLOW */
        .st-title {
            font-family: 'Bebas Neue', sans-serif;
            color: #d1121c;
            text-shadow: 
                0 0 5px rgba(209, 18, 28, 0.7), 
                0 0 10px rgba(209, 18, 28, 0.6), 
                0 0 20px rgba(209, 18, 28, 0.5);
            letter-spacing: 0.2em;
        }

        /* MAIN PANEL */
        .game-panel {
            background-color: rgba(10, 0, 0, 0.85);
            border: 3px solid #330000;
            box-shadow: 0 0 60px rgba(209, 18, 28, 0.5);
            border-radius: 10px;
            position: relative;
        }
        /* VCR Accent Lines */
        .game-panel::before, .game-panel::after {
            content: '';
            position: absolute;
            height: 1px;
            left: 10%;
            right: 10%;
            background: repeating-linear-gradient(to right, 
                #d1121c, #d1121c 2px, 
                transparent 2px, transparent 6px);
            opacity: 0.4;
        }
        .game-panel::before { top: 10px; }
        .game-panel::after { bottom: 10px; }
        
        /* INPUTS */
        input[type="text"], select {
            background-color: #1a0000;
            border: 1px solid #d1121c;
            color: #ffcc00; 
            padding: 12px;
            border-radius: 4px;
            font-family: 'Rajdhani', monospace;
            font-size: 1rem;
        }
        input[type="text"]:focus, select:focus {
            border-color: #ffcc00;
            box-shadow: 0 0 10px rgba(255, 204, 0, 0.8);
            outline: none;
        }
        
        /* BUTTONS */
        .spin-button {
            background-color: #d1121c; 
            color: #f7f7f7;
            font-weight: 700;
            padding: 15px 30px;
            border-radius: 6px;
            font-family: 'Rajdhani', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            box-shadow: 0 0 10px rgba(209, 18, 28, 0.3);
            transition: all 0.2s;
        }

        /* RESULT DISPLAY */
        #result-name {
            font-size: 3.5rem;
            color: #d1121c;
            text-shadow: 0 0 10px rgba(209, 18, 28, 0.8);
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.3em;
        }
        
        /* STATUS MESSAGES (THEME OVERRIDE) */
        .status-info { background-color: rgba(50, 0, 0, 0.7); border: 1px solid #d1121c; color: #ffcc00; }
        .status-error { background-color: rgba(100, 0, 0, 0.7); border: 1px solid #ff333d; color: #f7f7f7; }
        .status-success { background-color: rgba(0, 50, 0, 0.7); border: 1px solid #32cd32; color: #90ee90; }
        .status-warning { background-color: rgba(50, 50, 0, 0.7); border: 1px solid #ffcc00; color: #ffcc00; }
        
        /* SCROLLBAR for roster */
        #castle-assignments::-webkit-scrollbar { width: 8px; }
        #castle-assignments::-webkit-scrollbar-thumb { background-color: #d1121c; border-radius: 4px; }
        
        /* THEME MODAL STYLING */
        #theme-modal {
            background-color: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(4px);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            background-color: rgba(10, 0, 0, 0.95);
            border: 3px solid #d1121c;
            box-shadow: 0 0 25px rgba(209, 18, 28, 0.8);
            border-radius: 8px;
        }
        
        /* CRAZY ANIMATION FOR SPINNER */
        .glitch-anim {
            animation: glitch 1.5s linear infinite alternate, shake 0.15s infinite;
        }

        @keyframes glitch {
            0% { text-shadow: 0 0 5px rgba(255, 0, 0, 0.7); transform: translate(1px, 1px); }
            50% { text-shadow: 0 0 5px rgba(0, 255, 0, 0.7); transform: translate(-1px, -1px); }
            100% { text-shadow: 0 0 5px rgba(0, 0, 255, 0.7); transform: translate(0, 0); }
        }

        @keyframes shake {
            0% { transform: translate(1px, 0); }
            100% { transform: translate(-1px, 0); }
        }

    </style>
</head>
<body class="antialiased">

    <header class="w-full bg-black/90">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <a href="#" class="text-xl font-bold st-title flex items-center tracking-wider">
                <i class="fa-solid fa-bolt mr-2 text-red-600" style="text-shadow: 0 0 5px #d1121c;"></i> 
                NOYZZING // OPS
            </a>
            <div class="text-sm font-semibold tech-font text-red-500 uppercase tracking-wider">
                Alliance: **ROL**
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-10 flex-grow flex items-center justify-center">
        
        <div class="game-panel w-full max-w-2xl p-6 md:p-10">
            <h1 class="text-4xl md:text-6xl text-center mb-1 uppercase tracking-wider st-title">
                Code Name: HAWKINS
            </h1>
            <p class="text-center text-red-700 mb-8 text-sm uppercase tracking-wider font-semibold tech-font">
                HAWKINS CHARACTER ASSIGNMENT DATABASE
            </p>

            <div id="status-message" class="status-info p-3 rounded-lg mb-6">
                <i class="fa-solid fa-circle-info mr-2"></i> Select your castle name to begin assignment.
            </div>

            <div id="castle-selection" class="space-y-4">
                <p class="text-sm text-gray-300 mb-4 tech-font">Enter your unique castle identifier (e.g., Main, Alt 1)</p>
                <div class="space-y-4">
                    <div>
                        <label for="castle-input" class="block text-sm font-medium text-red-400 mb-1">Castle Identifier:</label>
                        <input type="text" id="castle-input" placeholder="ROL | Alt Castle" maxlength="30" required>
                    </div>
                    <button id="select-castle-btn" class="spin-button w-full">
                        <i class="fa-solid fa-chess-rook mr-2"></i> ACCESS CASTLE FILE
                    </button>
                </div>
                
                <div class="mt-6 p-4 border border-red-600 rounded-lg bg-red-900/20">
                    <h3 class="text-red-400 font-bold mb-2">ðŸ’¡ IMPORTANT:</h3>
                    <p class="text-xs text-gray-300">Each unique identifier gets **10 re-roll attempts** maximum. Use this name for all future checks on this castle.</p>
                </div>
            </div>

            <div id="assignment-form" class="space-y-4 hidden">
                
                <div id="castle-info" class="bg-gray-900/50 border border-red-900 text-gray-400 p-3 rounded-lg text-xs font-mono">
                    <p class="font-bold text-red-400 mb-1">ACTIVE CASTLE/OPERATOR ALIAS: <span id="current-castle">None</span></p>
                    <p><span class="text-red-500">Resets Left:</span> <span id="reset-count-display">10</span>/10</p>
                </div>

                <p class="text-sm text-gray-300 mb-4 tech-font">Select the character pool for <span id="castle-name" class="text-red-400">your castle</span></p>
                
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label for="player-gender" class="block text-sm font-medium text-red-400 mb-1">Character Pool Selection:</label>
                        <select id="player-gender" required>
                            <option value="" disabled selected>-- Select --</option>
                            <option value="Male">Male Characters</option>
                            <option value="Female">Female Characters</option>
                        </select>
                    </div>
                </div>

                <div class="pt-4">
                    <button id="assign-btn" class="spin-button w-full">
                        <i class="fa-solid fa-mask mr-2"></i> ASSIGN CODE NAME
                    </button>
                </div>
            </div>

            <div id="spinner-container" class="mt-8 flex items-center justify-center p-6 hidden">
                <span id="spinner-text" class="st-title text-4xl">SEARCHING REALITY...</span>
            </div>

            <div id="result-display" class="mt-8 text-center hidden p-6 border-2 border-red-900 rounded-lg">
                <h3 class="text-lg text-gray-300 font-medium uppercase tracking-wider mb-2 tech-font">CASTLE ASSIGNMENT SECURED:</h3>
                <p id="result-name" class="font-bold"></p>
                <p id="result-char-type" class="text-sm text-red-600 mt-2 font-mono"></p>
                
                <div class="space-y-2 mt-6">
                    <button id="share-btn" class="spin-button w-full bg-yellow-600 hover:bg-yellow-700 text-black text-xs">
                        <i class="fa-solid fa-share-nodes mr-1"></i> COPY ASSIGNMENT DETAILS
                    </button>
                    <button id="reset-btn" class="spin-button w-full bg-red-800 hover:bg-red-900 text-xs">
                        <i class="fa-solid fa-radiation mr-1"></i> RESET & RE-ROLL (<span id="reset-count">10</span> LEFT)
                    </button>
                    <button id="new-castle-btn" class="spin-button w-full bg-gray-600 hover:bg-gray-700 text-xs">
                        <i class="fa-solid fa-chess-rook mr-1"></i> CHANGE / NEW CASTLE
                    </button>
                </div>
            </div>
            
            <div class="mt-10">
                <h2 class="text-2xl st-title mb-3 border-b border-red-900 pb-1">
                    <i class="fa-solid fa-chess-rook text-red-500 mr-2"></i> ROL CASTLE ASSIGNMENT LOG
                </h2>
                <div id="castle-assignments" class="text-sm text-gray-400 space-y-2 max-h-60 overflow-y-auto p-3 font-mono">
                    </div>
            </div>
        </div>

    </main>

    <footer class="w-full text-center text-gray-600 text-xs py-4 bg-black/50">
        &copy; 2025 Noyzzing | ROL Alliance | D.O.E. File 001
    </footer>
    
    <div id="theme-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 hidden opacity-0 transition-opacity">
        <div class="modal-content w-full max-w-sm p-6 relative">
            
            <h3 id="modal-title" class="st-title text-2xl mb-4 uppercase">WARNING: CLASSIFIED OPERATION</h3>
            
            <p id="modal-message" class="text-gray-300 text-sm mb-6 tech-font">
                </p>
            
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded text-sm tech-font">
                    CANCEL
                </button>
                <button id="modal-confirm" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded text-sm tech-font">
                    CONFIRM RE-ROLL
                </button>
            </div>
        </div>
    </div>
    <script>
        // --- CONFIGURATION & CONSTANTS ---
        const DISCORD_WEBHOOK = 'https://discord.com/api/webhooks/1444330680858447903/dvcgQu42zAycH3rsEx8GADtmKoIGl3mY0PaznYMHhuOdtTlUHcliQJAk_No0NEtQ3Bg0';
        const STORAGE_KEY = 'rol_castle_assignments';
        const MAX_RESETS = 10; 

        // --- UPDATED AND VERIFIED CHARACTER ROSTER (130+ CHARACTERS, FILTERED) ---
       const CHARACTERS = {
    Male: [
        // Core Party/Teens
        'Mike Wheeler', 'Will Byers', 'Dustin Henderson', 'Lucas Sinclair', 'Jim Hopper',
        'Steve Harrington', 'Eddie Munson', 'Jonathan Byers', 'Argyle', 'Murray Bauman',
        // Secondary Heroes/Adults
        'Bob Newby', 'Ted Wheeler', 'Mr. Clarke', 'Billy Hargrove', 'Enzo (Dmitri)', 'Yuri Ismaylov',
        // Hawkins Residents / Side Characters
        'Jason Carver', 'Patrick McKinney', 'Fred Benson', 'Calvin Powell', 'Phillip Callahan', 
        'Tommy H.', 'Keith', 'Lonnie Byers', 'Benny Hammond', 'Mr. Harrington', 'Charles Sinclair',
        'Mr. Henderson', 'Mr. Wheeler', 'Mr. Mayfield', 'Mr. Munson', 'Scott Clarke', 'Greg', 'Rich',
        'Dr. Alexey', 'Alexi', 'Officer Callahan', 'Officer Powell', 'Mr. Baldo', 'Mr. Mooney',
        'Coach Skip', 'Mr. Sinclair', 'Mayor Larry Kline', 'Senator Hatch', 'Father Mike', 'Clyde',
        // Kali's Gang / Military
        'Axel', 'Mick', 'Funshine', 'Dusty', 'Ray', 'Pierce', 'Bauer', 'Duff',
        // EPIC/FAMOUS ADDITIONS
        'Grigori', 'Gary', 'Tom Holloway', 'Brian', 'Derek Turnbow(Dipshit)'
    ],
    Female: [
        // Core Party/Teens
        'Eleven (El)', 'Max Mayfield', 'Nancy Wheeler', 'Robin Buckley', 'Joyce Byers', 
        'Erica Sinclair', 'Suzie Bingham', 'Kali Prasad (Eight)',
        // Secondary Heroes/Adults
        'Chrissy Cunningham', 'Angela', 'Vickie', 'Holly Wheeler', 'Tammy Thompson', 
        'Karen Wheeler', 'Claudia Henderson', 'Patty', 
        // Mothers / Residents
        'Mrs. Sinclair', 'Mrs. Byers', 'Mrs. Mayfield', 'Mrs. Munson', 'Mrs. Kelly',
        'Mrs. Driscoll', 'Anya', 'Sara Hopper', 'Janet Hayes', 'Florence',
        'Carol', 'Tina', 'Stacy', 'Melanie', 'Mrs. Reardon', 'Mrs. O\'Donnell',
        'Mrs. Bingley', 'Mrs. Harrington', 'Mrs. Coleman',
        // Added for completeness
        'Becky Ives', 'Sue', 'Dottie', 'Jen',
        // EPIC/FAMOUS ADDITIONS
        'Barb', 'Heather Holloway', 'Moe Eldridge', 'Terry Ives', 'Dr. Kay'
    ],
    Villain_Neutral: [
        // Monsters
        'Vecna (Henry Creel)', 
        'The Mind Flayer', 
        'Demogorgon', 
        'Demo-Dog', 
        // Human Antagonists
        'Peter Ballard (One)',
        'Dr. Brenner (Papa)', 
        'Dr. Owens', 
        'Lt. Colonel Sullivan', 
        'Connie Frazier', 
        'Agent Florence',
        // EPIC ADDITIONS
        'Grigori (Russian)', 'Antonov'
    ]
};

        // --- GLOBAL STATE & ELEMENTS ---
        let currentCastle = null;
        let currentAssignment = null;

        const ELEMENTS = {
            castleSelection: document.getElementById('castle-selection'),
            assignmentForm: document.getElementById('assignment-form'),
            resultDisplay: document.getElementById('result-display'),
            resultName: document.getElementById('result-name'),
            resultCharType: document.getElementById('result-char-type'),
            assignBtn: document.getElementById('assign-btn'),
            resetBtn: document.getElementById('reset-btn'),
            shareBtn: document.getElementById('share-btn'),
            newCastleBtn: document.getElementById('new-castle-btn'),
            selectCastleBtn: document.getElementById('select-castle-btn'),
            castleInput: document.getElementById('castle-input'),
            playerGender: document.getElementById('player-gender'),
            statusMessage: document.getElementById('status-message'),
            currentCastle: document.getElementById('current-castle'),
            castleName: document.getElementById('castle-name'),
            resetCount: document.getElementById('reset-count'),
            resetCountDisplay: document.getElementById('reset-count-display'),
            castleAssignments: document.getElementById('castle-assignments'),
            
            // Spinner update
            spinnerContainer: document.getElementById('spinner-container'),
            spinnerText: document.getElementById('spinner-text'),

            // Modal Elements
            themeModal: document.getElementById('theme-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalMessage: document.getElementById('modal-message'),
            modalConfirm: document.getElementById('modal-confirm'),
            modalCancel: document.getElementById('modal-cancel')
        };

        // --- LOCAL STORAGE HANDLERS ---
        function getCastleData(castle) {
            const allData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            const prevDefault = 6; // previous default resets used by older clients

            if (!allData[castle]) {
                allData[castle] = {
                    resetsLeft: MAX_RESETS,
                    assignment: null,
                    usedCharacters: [],
                    initialMaxResets: MAX_RESETS
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
                return allData[castle];
            }

            // Migration: if stored castle doesn't have an initialMaxResets value,
            // assume it was created when the previous default was prevDefault (6).
            // Recalculate resetsLeft = MAX_RESETS - used
            const data = allData[castle];
            if (!('initialMaxResets' in data)) {
                const used = Math.max(0, prevDefault - (data.resetsLeft ?? 0));
                data.resetsLeft = Math.max(0, MAX_RESETS - used);
                data.initialMaxResets = MAX_RESETS;
                allData[castle] = data;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
            } else if (data.initialMaxResets !== MAX_RESETS) {
                // If MAX_RESETS changed between versions, keep tracking used resets
                const used = Math.max(0, data.initialMaxResets - (data.resetsLeft ?? 0));
                data.resetsLeft = Math.max(0, MAX_RESETS - used);
                data.initialMaxResets = MAX_RESETS;
                allData[castle] = data;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
            }

            return allData[castle];
        }

        // Migrate all saved castles to use the new MAX_RESETS value while preserving used attempts
        function migrateAllCastles() {
            const allData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            const prevDefault = 6;
            let changed = false;

            for (const castle in allData) {
                if (!Object.prototype.hasOwnProperty.call(allData, castle)) continue;
                const data = allData[castle];
                const oldInitial = data.initialMaxResets || prevDefault;
                const used = Math.max(0, oldInitial - (data.resetsLeft ?? 0));
                const newResetsLeft = Math.max(0, MAX_RESETS - used);
                if (newResetsLeft !== data.resetsLeft || data.initialMaxResets !== MAX_RESETS) {
                    data.resetsLeft = newResetsLeft;
                    data.initialMaxResets = MAX_RESETS;
                    allData[castle] = data;
                    changed = true;
                }
            }

            if (changed) {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
            }
        }

        function saveCastleData(castle, data) {
            const allData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            allData[castle] = data;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
        }

        // --- MODAL HANDLERS ---
        function showModal(title, message, onConfirm) {
            ELEMENTS.modalTitle.textContent = title;
            ELEMENTS.modalMessage.innerHTML = message;
            
            ELEMENTS.themeModal.classList.remove('hidden');
            setTimeout(() => {
                ELEMENTS.themeModal.style.opacity = '1';
            }, 10);

            // Clone to remove previous event listeners
            const oldConfirm = ELEMENTS.modalConfirm;
            const newConfirm = oldConfirm.cloneNode(true);
            oldConfirm.parentNode.replaceChild(newConfirm, oldConfirm);
            
            const oldCancel = ELEMENTS.modalCancel;
            const newCancel = oldCancel.cloneNode(true);
            oldCancel.parentNode.replaceChild(newCancel, oldCancel);
            
            newConfirm.addEventListener('click', () => {
                hideModal();
                onConfirm(true);
            });

            newCancel.addEventListener('click', () => {
                hideModal();
                onConfirm(false);
            });
            
            ELEMENTS.modalConfirm = newConfirm;
            ELEMENTS.modalCancel = newCancel;
        }

        function hideModal() {
            ELEMENTS.themeModal.style.opacity = '0';
            setTimeout(() => {
                ELEMENTS.themeModal.classList.add('hidden');
            }, 300);
        }

        // --- UI & STATUS LOGIC ---
        function displayStatus(type, message) {
            ELEMENTS.statusMessage.innerHTML = `<i class="fa-solid fa-circle-info mr-2"></i> ${message}`;
            ELEMENTS.statusMessage.className = `p-3 rounded-lg mb-6 status-${type}`;
        }
        
        function resetToForm() {
            ELEMENTS.assignBtn.disabled = false;
            ELEMENTS.assignBtn.innerHTML = '<i class="fa-solid fa-mask mr-2"></i> ASSIGN CODE NAME';
        }

        function displayFinalResult(characterName, gender, isExisting) {
            ELEMENTS.resultName.textContent = characterName.toUpperCase();
            
            let charType = 'HAWKINS CREW';
            // Logic to determine specific antagonist type
            if (CHARACTERS.Villain_Neutral.includes(characterName)) {
                if (['The Mind Flayer', 'Demogorgon', 'Demo-Dog'].includes(characterName)) {
                    charType = 'UPSIDE DOWN AGENT (MONSTER)';
                } else if (['Vecna (Henry Creel)', 'Peter Ballard (One)'].includes(characterName)) {
                    charType = 'UPSIDE DOWN AGENT (PRIMARY)';
                } else {
                     charType = 'GOVERNMENT/LAB ANTAGONIST';
                }
            }

            ELEMENTS.resultCharType.textContent = `(${charType} - ${gender} Pool)`;
            ELEMENTS.assignmentForm.classList.add('hidden');
            ELEMENTS.resultDisplay.classList.remove('hidden');
            
            const castleData = getCastleData(currentCastle);
            ELEMENTS.resetCount.textContent = castleData.resetsLeft;
            
            if(isExisting) {
                displayStatus('info', `Welcome back! **${characterName.toUpperCase()}** assigned to ${currentCastle}`);
            } else {
                displayStatus('success', `Assignment complete! **${characterName.toUpperCase()}** secured.`);
            }
            
            // Migrate existing castle data if MAX_RESETS was increased
            migrateAllCastles();
            loadCastleAssignments();
            ELEMENTS.resetBtn.disabled = castleData.resetsLeft <= 0; 
        }

        // --- CORE GAME FLOW ---
        function initializeGame() {
            // Set up initial event listeners
            ELEMENTS.selectCastleBtn.addEventListener('click', selectCastle);
            ELEMENTS.assignBtn.addEventListener('click', startAssignment);
            ELEMENTS.shareBtn.addEventListener('click', shareAssignment);
            ELEMENTS.newCastleBtn.addEventListener('click', newCastle);
            
            // Use the custom modal reset flow
            ELEMENTS.resetBtn.addEventListener('click', function() {
                const castleData = getCastleData(currentCastle);
                if (castleData.resetsLeft <= 0) {
                    displayStatus('error', 'âŒ No reset attempts remaining for this castle.');
                    return;
                }
                
                showModal(
                    'SECURITY OVERRIDE REQUEST', 
                    `This will consume **1 of your ${castleData.resetsLeft} re-roll attempts** for **${currentCastle}**. The current code name will be lost.`,
                    (confirmed) => {
                        if (confirmed) {
                            performReset();
                        } else {
                            displayStatus('info', 'Re-roll cancelled. Current assignment remains active.');
                        }
                    }
                );
            });

            loadCastleAssignments();
        }

        function selectCastle() {
            const castleName = ELEMENTS.castleInput.value.trim();
            
            if (!castleName) {
                displayStatus('error', 'Please enter a castle name.');
                return;
            }

            currentCastle = castleName;
            const castleData = getCastleData(castleName);
            
            ELEMENTS.currentCastle.textContent = castleName;
            ELEMENTS.castleName.textContent = castleName;
            ELEMENTS.resetCount.textContent = castleData.resetsLeft;
            ELEMENTS.resetCountDisplay.textContent = castleData.resetsLeft;
            
            // UI Transition
            ELEMENTS.castleSelection.classList.add('hidden');
            ELEMENTS.assignmentForm.classList.remove('hidden');
            ELEMENTS.resultDisplay.classList.add('hidden');
            
            // Check for existing assignment
            if (castleData.assignment) {
                currentAssignment = castleData.assignment;
                ELEMENTS.playerGender.value = castleData.assignment.gender || '';
                ELEMENTS.playerGender.disabled = true;
                displayFinalResult(castleData.assignment.characterName, castleData.assignment.gender, true);
                ELEMENTS.assignBtn.disabled = true; 
            } else {
                currentAssignment = null;
                ELEMENTS.playerGender.value = '';
                ELEMENTS.playerGender.disabled = false;
                ELEMENTS.assignBtn.disabled = false;
                displayStatus('info', `Selected "${castleName}". Ready for assignment.`);
            }

            // Disable reset button if no resets left
            ELEMENTS.resetBtn.disabled = castleData.resetsLeft <= 0;
        }

        async function startAssignment() {
            const gameName = currentCastle;
            const gender = ELEMENTS.playerGender.value;
            
            if (!gameName || !gender) {
                displayStatus('error', 'Please select a character pool.');
                return;
            }

            const castleData = getCastleData(currentCastle);
            
            if (castleData.assignment) {
                displayStatus('info', 'Assignment already completed. Use Reset to re-roll.');
                return;
            }

            ELEMENTS.assignBtn.disabled = true;
            ELEMENTS.assignBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> INITIATING SEARCH...';

            // Show spinner container and start animation
            ELEMENTS.spinnerContainer.classList.remove('hidden');
            ELEMENTS.spinnerText.classList.add('glitch-anim');
            ELEMENTS.spinnerText.textContent = "SEARCHING THE UPSIDE DOWN";
            ELEMENTS.assignmentForm.classList.add('hidden');


            setTimeout(async () => {
                try {
                    const allCharacters = [...CHARACTERS.Male, ...CHARACTERS.Female, ...CHARACTERS.Villain_Neutral];
                    
                    const availablePool = allCharacters
                        .filter(name => !castleData.usedCharacters.includes(name))
                        .filter(name => (gender === 'Male' && (CHARACTERS.Male.includes(name) || CHARACTERS.Villain_Neutral.includes(name))) || 
                                         (gender === 'Female' && (CHARACTERS.Female.includes(name) || CHARACTERS.Villain_Neutral.includes(name))));

                    let pool = availablePool;
                    
                    if (pool.length === 0) {
                        pool = (gender === 'Male' ? CHARACTERS.Male : CHARACTERS.Female).concat(CHARACTERS.Villain_Neutral);
                        displayStatus('warning', 'All unique characters used for this castle! Allowing duplicates.');
                    }
                    
                    const randomIndex = Math.floor(Math.random() * pool.length);
                    const assignedCharacter = pool[randomIndex];
                    
                    const newAssignment = {
                        gameName: gameName, 
                        characterName: assignedCharacter,
                        gender: gender,
                        timestamp: new Date().toISOString(),
                        castle: currentCastle
                    };

                    castleData.assignment = newAssignment;
                    castleData.usedCharacters.push(assignedCharacter);
                    saveCastleData(currentCastle, castleData);
                    
                    currentAssignment = newAssignment;
                    
                    sendToDiscord(gameName, assignedCharacter, gender, currentCastle);
                    
                    // Stop animation and display final name in spinner area briefly
                    ELEMENTS.spinnerText.classList.remove('glitch-anim');
                    ELEMENTS.spinnerText.textContent = assignedCharacter.toUpperCase();

                    setTimeout(() => {
                        ELEMENTS.spinnerContainer.classList.add('hidden');
                        displayFinalResult(assignedCharacter, gender, false);
                        ELEMENTS.assignBtn.disabled = true; 
                        ELEMENTS.playerGender.disabled = true;
                    }, 1000); // Wait 1 second after name reveal

                    
                } catch (error) {
                    console.error("Assignment failed:", error);
                    ELEMENTS.spinnerContainer.classList.add('hidden');
                    displayStatus('error', 'Assignment failed. Try again.');
                    resetToForm();
                }
            }, 1500);
        }

        async function sendToDiscord(operatorName, codeName, characterPool, castle) {
            try {
                const payload = {
                    embeds: [{
                        title: `ðŸ”´ CODE NAME ASSIGNMENT: ${codeName.toUpperCase()}`,
                        description: `Assignment confirmed for Operator **${operatorName}** (Castle: ${castle}).`,
                        fields: [
                            { name: 'OPERATOR ALIAS', value: operatorName, inline: true },
                            { name: 'CODE NAME', value: codeName, inline: true },
                            { name: 'POOL', value: characterPool, inline: true }
                        ],
                        // ST Red color in decimal
                        color: 13369344, 
                        footer: { text: 'ROL Hawkins System | CLASSIFIED TRANSMISSION' },
                        timestamp: new Date().toISOString()
                    }]
                };
                
                await fetch(DISCORD_WEBHOOK, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                return true;
            } catch (error) {
                // If Discord fails, we ensure the local flow continues.
                return false;
            }
        }

        function performReset() {
            const castleData = getCastleData(currentCastle);
            
            castleData.resetsLeft--;
            castleData.assignment = null; 
            saveCastleData(currentCastle, castleData);
            
            currentAssignment = null;
            ELEMENTS.playerGender.disabled = false;
            ELEMENTS.resultDisplay.classList.add('hidden');
            ELEMENTS.assignmentForm.classList.remove('hidden');
            
            ELEMENTS.resetCount.textContent = castleData.resetsLeft;
            ELEMENTS.resetCountDisplay.textContent = castleData.resetsLeft;
            ELEMENTS.resetBtn.disabled = castleData.resetsLeft <= 0;
            
            displayStatus('warning', `Reset complete. ${castleData.resetsLeft} attempt(s) remaining for "${currentCastle}".`);
            resetToForm();
            loadCastleAssignments();
        }

        function newCastle() {
            currentCastle = null;
            currentAssignment = null;
            ELEMENTS.castleInput.value = '';
            ELEMENTS.assignmentForm.classList.add('hidden');
            ELEMENTS.resultDisplay.classList.add('hidden');
            ELEMENTS.castleSelection.classList.remove('hidden');
            displayStatus('info', 'Enter a new or existing castle name to proceed.');
        }

        function shareAssignment() {
            if (!currentAssignment) return;
            
            const shareText = `
ðŸŽ® ROL CASTLE CHARACTER ASSIGNMENT ðŸŽ®

CASTLE/ALIAS: ${currentCastle}
CODE NAME: ${currentAssignment.characterName}
POOL: ${currentAssignment.gender}

Assigned via ROL Hawkins System (Resets left: ${getCastleData(currentCastle).resetsLeft})
            `.trim();

            navigator.clipboard.writeText(shareText).then(() => {
                displayStatus('success', 'Copied to clipboard! Share this assignment in Discord.');
            });
        }

        function loadCastleAssignments() {
            const allData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            let html = '';
            
            Object.entries(allData).forEach(([castle, data]) => {
                if (data.assignment) {
                    const statusClass = data.resetsLeft === 0 ? 'text-red-600' : 'text-yellow-500'; 

                    html += `
                        <div class="roster-entry border border-red-900 rounded p-3 mb-2 font-mono hover:bg-red-900/30 cursor-pointer" onclick="ELEMENTS.castleInput.value='${castle}'; selectCastle();">
                            <div class="font-bold text-red-400">${castle}</div>
                            <div class="text-xs">
                                <span class="roster-name-glow st-title">${data.assignment.characterName.toUpperCase()}</span> 
                            </div>
                            <div class="text-xs ${statusClass}">Resets left: ${data.resetsLeft}/${MAX_RESETS}</div>
                        </div>
                    `;
                }
            });
            
            ELEMENTS.castleAssignments.innerHTML = html || '<p class="text-gray-500 text-center">No castle assignments found locally.</p>';
        }

        // Start the game!
        initializeGame();
    </script>
</body>
</html>