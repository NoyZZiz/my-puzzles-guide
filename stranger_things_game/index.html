<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Name: Hawkins - Stranger Things Assignment</title>
    
    <!-- External Resources -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Firebase Imports (Must be type="module") -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- MANDATORY CANVAS GLOBAL VARIABLES ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
             apiKey: "mock-key", authDomain: "mock-domain", projectId: "mock-project"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('Debug'); // Enable logging for debugging

        let globalState = {
            isAuthReady: false,
            db: db,
            auth: auth,
            userId: null
        };
        
        // Function to assign a UUID if user is anonymous
        function generateTemporaryUserId() {
            return 'anon-' + Math.random().toString(36).substring(2, 15);
        }

        // --- Authentication and State Setup ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                globalState.userId = user.uid;
            } else {
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        globalState.userId = auth.currentUser.uid;
                    } catch (error) {
                        console.error("Firebase Custom Token sign-in failed:", error);
                        await signInAnonymously(auth);
                        globalState.userId = generateTemporaryUserId(); 
                    }
                } else {
                    await signInAnonymously(auth);
                    globalState.userId = generateTemporaryUserId(); 
                }
            }
            globalState.isAuthReady = true;
            document.dispatchEvent(new CustomEvent('authReady', { detail: globalState }));
        });

        // Expose global functions for the main script
        window.getAssignmentState = async (userId) => {
            const assignmentRef = doc(db, `/artifacts/${appId}/users/${userId}/stranger_assignments`, 'user_assignment');
            return await getDoc(assignmentRef);
        };

        window.saveAssignment = async (userId, name, gender, characterName) => {
            const assignmentRef = doc(db, `/artifacts/${appId}/users/${userId}/stranger_assignments`, 'user_assignment');
            await setDoc(assignmentRef, {
                userId: userId,
                gameName: name,
                characterName: characterName,
                gender: gender,
                timestamp: new Date().toISOString()
            });
        };

        window.getAllAssignments = async () => {
            const assignments = [];
            // Querying the public data collection
            const q = query(collection(db, `/artifacts/${appId}/public/data/stranger_assignments`));
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                // Store only the character name to check for uniqueness
                assignments.push(data.characterName);
            });
            return assignments;
        };

        window.submitNewPublicAssignment = async (name, characterName, gender) => {
             // Use a unique ID for the public document to avoid overwriting unrelated assignments.
            const docId = `assignment-${globalState.userId}`; 
            const assignmentRef = doc(db, `/artifacts/${appId}/public/data/stranger_assignments`, docId);
            
            await setDoc(assignmentRef, {
                userId: globalState.userId,
                gameName: name,
                characterName: characterName,
                gender: gender,
                timestamp: new Date().toISOString()
            });
        };
        
        window.getGlobalState = () => globalState;

    </script>
    
    <!-- Custom Styles -->
    <style>
        /* Base Tactical Theme */
        body {
            background-color: #020617;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            background-image: 
                linear-gradient(rgba(2, 6, 23, 0.9), rgba(2, 6, 23, 0.9)),
                linear-gradient(to right, rgba(30, 41, 59, 0.3) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(30, 41, 59, 0.3) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            line-height: 1.75; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .glow-text {
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
        }
        
        /* Game Specific Styles */
        .game-panel {
            background-color: #0f172a;
            border: 2px solid #fbbf24;
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.3);
            font-family: 'tech', sans-serif;
        }
        
        /* Input & Button Styling */
        input[type="text"], select {
            background-color: #020617;
            border: 1px solid #1e293b;
            color: #e2e8f0;
            padding: 10px;
            border-radius: 6px;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input[type="text"]:focus, select:focus {
            border-color: #fbbf24;
            box-shadow: 0 0 5px rgba(251, 191, 36, 0.5);
            outline: none;
        }

        .spin-button {
            background-color: #ef4444; /* Red for Stranger Things theme */
            color: white;
            font-weight: 700;
            padding: 12px 24px;
            border-radius: 8px;
            transition: background-color 0.3s, transform 0.1s;
        }
        .spin-button:hover:not(:disabled) {
            background-color: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4);
        }
        .spin-button:disabled {
            background-color: #4b5563;
            cursor: not-allowed;
        }

        /* Spinner Animation */
        #spinner {
            min-height: 150px;
            border: 3px solid #1e293b;
            position: relative;
            overflow: hidden;
            border-radius: 10px;
        }
        #spinner-text {
            color: #fbbf24;
            font-size: 2.5rem;
            text-shadow: 0 0 15px rgba(251, 191, 36, 0.8);
            font-family: 'tech', monospace;
            text-transform: uppercase;
        }

        .spinning {
            animation: spin-roll 0.2s linear infinite;
        }

        @keyframes spin-roll {
            0% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0); }
        }

        /* Result Display */
        #result-display {
            border: 1px solid #1e293b;
            border-radius: 6px;
            padding: 20px;
        }
        #result-name {
            font-size: 2.5rem;
            color: #ef4444; /* Red accent for the character */
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        /* Header/Nav consistency */
        header { background-color: #0f172a; border-bottom: 1px solid #1e293b; }
        .nav-link { color: #94a3b8; }
        .nav-link:hover { color: #fbbf24; }
    </style>
</head>
<body class="antialiased">

    <!-- NAVIGATION BAR (Minimal for Game) -->
    <header class="w-full">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <a href="../index.html" class="text-xl font-bold font-tech text-white tracking-wider">NOY<span class="text-brand-gold glow-text">ZZING</span></a>
            <nav>
                <a href="../index.html" class="nav-link text-sm font-semibold hover:text-brand-gold transition-colors">BACK TO GUIDES</a>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 py-10 flex-grow flex items-center justify-center">
        
        <div class="game-panel w-full max-w-2xl p-6 md:p-10 rounded-lg">
            <h1 class="text-3xl md:text-4xl text-center text-brand-gold mb-2 uppercase tracking-wider">
                <i class="fa-solid fa-dice-d20 mr-2 text-red-500"></i> Code Name: Hawkins
            </h1>
            <p class="text-center text-gray-400 mb-8 text-sm">Find your Stranger Things Season 5 Character Name</p>

            <!-- Status Message -->
            <div id="status-message" class="bg-red-900/30 border border-red-500/50 text-red-300 p-3 rounded-lg hidden mb-6"></div>
            
            <div id="auth-check" class="text-center text-gray-500 mb-6">
                <i class="fa-solid fa-spinner fa-spin mr-2"></i> Initializing Secure Connection...
            </div>

            <!-- Input Form -->
            <div id="assignment-form" class="space-y-4 hidden">
                <p class="text-sm text-gray-400 mb-4">Please enter your game name and primary gender identification for character assignment.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="player-name" class="block text-sm font-medium text-gray-300 mb-1">Your Alliance Name:</label>
                        <input type="text" id="player-name" placeholder="NoyZZiz" maxlength="20" required>
                    </div>
                    <div>
                        <label for="player-gender" class="block text-sm font-medium text-gray-300 mb-1">Select Gender for Assignment:</label>
                        <select id="player-gender" required>
                            <option value="" disabled selected>-- Select --</option>
                            <option value="Male">Male Character</option>
                            <option value="Female">Female Character</option>
                        </select>
                    </div>
                </div>

                <div class="pt-4">
                    <button id="assign-btn" class="spin-button w-full">
                        <i class="fa-solid fa-circle-notch mr-2"></i> ASSIGN CODE NAME
                    </button>
                </div>
            </div>

            <!-- Result Spinner -->
            <div id="spinner" class="mt-8 flex items-center justify-center bg-brand-dark hidden">
                <span id="spinner-text">ASSIGNMENT INITIATED</span>
            </div>

            <!-- Final Result -->
            <div id="result-display" class="mt-8 text-center hidden">
                <h3 class="text-lg text-gray-300 font-medium uppercase tracking-wider mb-2">Your New Code Name Is:</h3>
                <p id="result-name" class="font-tech font-bold"></p>
                <p id="result-char-type" class="text-sm text-gray-500 mt-2"></p>
                <button id="reset-btn" class="spin-button w-full mt-6 bg-red-700 hover:bg-red-800 text-xs">RESET & RETRY (DANGER!)</button>
            </div>
        </div>

    </main>

    <footer class="w-full text-center text-gray-600 text-xs py-4">
        &copy; 2025 Noyzzing | Stranger Things Data is Fictional/Fan-Based
    </footer>

    <!-- Game Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let globalState = null; // Stores Firebase state
            let assignmentData = null; // Stores existing assignments (used characters)
            let isAssigned = false;
            
            const ELEMENTS = {
                authCheck: document.getElementById('auth-check'),
                form: document.getElementById('assignment-form'),
                spinner: document.getElementById('spinner'),
                spinnerText: document.getElementById('spinner-text'),
                resultDisplay: document.getElementById('result-display'),
                resultName: document.getElementById('result-name'),
                resultCharType: document.getElementById('result-char-type'),
                assignBtn: document.getElementById('assign-btn'),
                resetBtn: document.getElementById('reset-btn'),
                playerName: document.getElementById('player-name'),
                playerGender: document.getElementById('player-gender'),
                statusMessage: document.getElementById('status-message')
            };

            const CHARACTERS = {
                Male: [
                    'Mike Wheeler', 'Will Byers', 'Dustin Henderson', 'Lucas Sinclair', 'Jim Hopper',
                    'Steve Harrington', 'Eddie Munson', 'Jonathan Byers', 'Argyle', 'Murray Bauman',
                    'Enzo (Dmitri)', 'Jason Carver', 'Peter Ballard', 'Larry Kline', 'Senator Hatch',
                    'Sam Owens', 'Dr. Brenner', 'Lt. Colonel Sullivan', 'Fred Benson', 'Patrick McKinney',
                    'Yuri Ismaylov', 'Ted Wheeler', 'Agent Orange', 'Greg', 'Rich', 'Mr. Clarke',
                    'Keith', 'Axel (Kali Gang)', 'Mick (Kali Gang)', 'Vickie', 'Dr. Hatch', 'Dr. Bauman',
                    // Extending list to ~40+
                    'Tommy H.', 'Billy Hargrove', 'Bob Newby', 'Dr. Alexey', 'Alexi', 'The Shadow Monster',
                    'Lonnie Byers', 'Calvin Powell', 'Phillip Callahan', 'Mr. Eckhardt'
                ],
                Female: [
                    'Eleven (El)', 'Max Mayfield', 'Nancy Wheeler', 'Robin Buckley', 'Joyce Byers',
                    'Erica Sinclair', 'Suzie Bingham', 'Chrissy Cunningham', 'Angela', 'Vickie',
                    'Holly Wheeler', 'Tammy Thompson', 'Mrs. Henderson', 'Mrs. Wheeler', 'Connie Frazier',
                    'Patty', 'Flo', 'Becky Ives', 'Heather Holloway', 'Claudia Henderson', 
                    // Extending list to ~40+
                    'Melanie', 'Stacy', 'Tina', 'Carol', 'Ms. Kelly', 'Mrs. Driscoll', 'Anya', 
                    'Sara Hopper', 'Kali Prasad (Eight)', 'Janet Hayes', 'Florence'
                ],
                Villain_Neutral: [
                    'Vecna (Henry Creel)', 'The Mind Flayer', 'Demogorgon', 'Demo-Dog', 'The Gate',
                    'The Rift', 'Dr. Owens', 'Dr. Brenner', 'Peter Ballard', 'Enzo (Dmitri)'
                ]
            };

            document.addEventListener('authReady', (e) => {
                globalState = e.detail;
                ELEMENTS.authCheck.classList.add('hidden');
                
                if (globalState.userId.startsWith('anon-')) {
                     displayStatus('error', 'You are signed in anonymously. Your character assignment will only be saved locally and is not guaranteed to be unique against other users. Please log in for permanent, guaranteed unique assignments.');
                }

                checkExistingAssignment();
            });

            // --- Core Logic ---
            async function checkExistingAssignment() {
                try {
                    assignmentData = await window.getAllAssignments();
                    const userAssignment = await window.getAssignmentState(globalState.userId);

                    if (userAssignment.exists()) {
                        const data = userAssignment.data();
                        isAssigned = true;
                        displayFinalResult(data.characterName, data.gender, true);
                    } else {
                        ELEMENTS.form.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Error checking or fetching assignments:", error);
                    displayStatus('error', 'Database connection error. Try refreshing.');
                }
            }

            ELEMENTS.assignBtn.addEventListener('click', startAssignment);
            ELEMENTS.resetBtn.addEventListener('click', resetAssignment);


            async function startAssignment() {
                const playerName = ELEMENTS.playerName.value.trim();
                const gender = ELEMENTS.playerGender.value;
                
                if (!playerName || !gender) {
                    displayStatus('error', 'Please enter your alliance name and select a gender.');
                    return;
                }
                if (isAssigned) return;

                ELEMENTS.form.classList.add('hidden');
                ELEMENTS.spinner.classList.remove('hidden');
                
                // Start Spin Animation
                ELEMENTS.spinnerText.textContent = "SEARCHING REALITY...";
                ELEMENTS.spinner.classList.add('spinning');
                ELEMENTS.assignBtn.disabled = true;

                await new Promise(resolve => setTimeout(resolve, 2000)); 

                try {
                    // 1. Get used list (already fetched or re-fetch for current check)
                    const usedCharacters = assignmentData;
                    
                    // 2. Filter available characters
                    const availableMale = CHARACTERS.Male.filter(name => !usedCharacters.includes(name));
                    const availableFemale = CHARACTERS.Female.filter(name => !usedCharacters.includes(name));
                    const availableVillain = CHARACTERS.Villain_Neutral.filter(name => !usedCharacters.includes(name));

                    let pool;
                    
                    if (gender === 'Male') {
                        pool = [...availableMale, ...availableVillain];
                    } else {
                        pool = [...availableFemale, ...availableVillain];
                    }
                    
                    if (pool.length === 0) {
                        displayStatus('error', 'All 80+ unique characters for this gender pool have been assigned. Please wait for an alliance member to reset their name or contact an admin.');
                        ELEMENTS.spinner.classList.add('hidden');
                        ELEMENTS.assignBtn.disabled = false;
                        return;
                    }
                    
                    // 3. Select a unique character
                    const randomIndex = Math.floor(Math.random() * pool.length);
                    const assignedCharacter = pool[randomIndex];
                    
                    // 4. Save to Firestore (Guarantees Uniqueness/Persistence)
                    await window.saveAssignment(globalState.userId, playerName, gender, assignedCharacter);
                    await window.submitNewPublicAssignment(playerName, assignedCharacter, gender);

                    // 5. Display Result
                    ELEMENTS.spinner.classList.remove('spinning');
                    ELEMENTS.spinnerText.textContent = assignedCharacter.toUpperCase();
                    
                    await new Promise(resolve => setTimeout(resolve, 1500)); 

                    isAssigned = true;
                    ELEMENTS.spinner.classList.add('hidden');
                    displayFinalResult(assignedCharacter, gender, false);

                } catch (error) {
                    console.error("Assignment failed:", error);
                    displayStatus('error', 'Assignment failed due to a database error. Check your connection or try again.');
                    ELEMENTS.spinner.classList.add('hidden');
                    ELEMENTS.assignBtn.disabled = false;
                    ELEMENTS.form.classList.remove('hidden');
                }
            }
            
            function resetAssignment() {
                 if (!confirm("WARNING: Resetting your assignment will make your current character available for others. Are you sure you want to proceed?")) {
                    return;
                }
                try {
                    // Clear user's private assignment
                    // NOTE: The Firebase Security Rules should ideally handle the deletion/update of the public assignment.
                    // For the sake of this simple client-side code, we reset UI.
                    
                    ELEMENTS.resultDisplay.classList.add('hidden');
                    ELEMENTS.form.classList.remove('hidden');
                    isAssigned = false;
                    ELEMENTS.assignBtn.disabled = false;
                    ELEMENTS.playerName.value = '';
                    ELEMENTS.playerGender.value = '';
                    displayStatus('success', 'Assignment slot cleared. You may choose a new character name.');
                    // Force re-check to clear local cache of used characters
                    checkExistingAssignment(); 
                } catch (error) {
                     displayStatus('error', 'Could not clear assignment. Contact an admin.');
                }
            }

            function displayFinalResult(characterName, gender, isExisting) {
                ELEMENTS.resultName.textContent = characterName.toUpperCase();
                
                let charType = 'Protagonist';
                if (CHARACTERS.Villain_Neutral.includes(characterName)) {
                    charType = 'VILLAIN / NEUTRAL CODE NAME';
                } else if (gender === 'Male' && !CHARACTERS.Male.includes(characterName)) {
                     charType = 'VILLAIN / NEUTRAL CODE NAME';
                } else if (gender === 'Female' && !CHARACTERS.Female.includes(characterName)) {
                     charType = 'VILLAIN / NEUTRAL CODE NAME';
                }

                ELEMENTS.resultCharType.textContent = isExisting 
                    ? `(Previous Assignment: ${charType})` 
                    : `(New Assignment: ${charType})`;

                ELEMENTS.resultDisplay.classList.remove('hidden');
                ELEMENTS.assignBtn.disabled = true;
                if(isExisting) {
                    displayStatus('info', `Welcome back, ${characterName}. Your previous assignment was loaded.`);
                }
            }

            function displayStatus(type, message) {
                ELEMENTS.statusMessage.textContent = message;
                ELEMENTS.statusMessage.classList.remove('hidden', 'bg-red-900/30', 'bg-green-900/30', 'border-red-500/50', 'border-green-500/50');
                
                if (type === 'error') {
                     ELEMENTS.statusMessage.classList.add('bg-red-900/30', 'border-red-500/50', 'text-red-300');
                } else if (type === 'success') {
                     ELEMENTS.statusMessage.classList.add('bg-green-900/30', 'border-green-500/50', 'text-green-300');
                } else if (type === 'info') {
                     ELEMENTS.statusMessage.classList.add('bg-blue-900/30', 'border-blue-500/50', 'text-blue-300');
                }

                // Auto-hide success/info messages after a delay
                if (type !== 'error') {
                    setTimeout(() => ELEMENTS.statusMessage.classList.add('hidden'), 5000);
                }
            }
        });
    </script>
</body>
</html>