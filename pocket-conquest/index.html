<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pocket Conquest - Time Recruit Edition</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Rajdhani:wght@500;600;700&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --gold: #f59e0b;
            --gold-dark: #b45309;
            --purple: #a855f7;
            --purple-dark: #7c3aed;
            --green: #22c55e;
            --blue: #3b82f6;
            --red: #ef4444;
            --dark: #0a0a0f;
            --panel: #1e293b;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--dark);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        /* SCREENS */
        .screen {
            display: none;
            min-height: 100vh;
            padding: 20px;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
        }

        .hidden {
            display: none !important;
        }

        /* ========== TITLE SCREEN ========== */
        #titleScreen {
            background:
                radial-gradient(ellipse at 50% 30%, rgba(168, 85, 247, 0.2) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 70%, rgba(245, 158, 11, 0.15) 0%, transparent 50%),
                var(--dark);
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .game-logo {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            letter-spacing: 6px;
            background: linear-gradient(135deg, var(--gold), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 0 0 50px rgba(168, 85, 247, 0.5);
        }

        .game-subtitle {
            font-size: 1rem;
            color: var(--gold);
            letter-spacing: 8px;
            margin-bottom: 60px;
            opacity: 0.8;
        }

        .title-btn {
            padding: 18px 60px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: 4px;
            text-transform: uppercase;
            background: linear-gradient(135deg, var(--purple), var(--purple-dark));
            border: 2px solid var(--purple);
            border-radius: 50px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .title-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.5);
        }

        .title-btn.secondary {
            background: transparent;
            border-color: var(--gold);
            color: var(--gold);
        }

        .title-btn.secondary:hover {
            background: var(--gold);
            color: black;
        }

        /* ========== CHARACTER SELECT ========== */
        #characterSelect {
            background:
                radial-gradient(ellipse at 50% 0%, rgba(168, 85, 247, 0.15) 0%, transparent 50%),
                var(--dark);
        }

        .screen-title {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            text-align: center;
            color: var(--gold);
            letter-spacing: 5px;
            margin-bottom: 30px;
            padding-top: 20px;
        }

        .setup-fields {
            max-width: 400px;
            margin: 0 auto 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .field-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .field-group label {
            font-size: 0.85rem;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .field-group input,
        .field-group select {
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid #334155;
            border-radius: 10px;
            padding: 12px 15px;
            font-size: 1rem;
            color: white;
            font-family: 'Rajdhani', sans-serif;
            transition: border-color 0.3s;
        }

        .field-group input:focus,
        .field-group select:focus {
            outline: none;
            border-color: var(--purple);
        }

        .field-group input::placeholder {
            color: #64748b;
        }

        .character-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .character-card {
            background: linear-gradient(135deg, var(--panel), rgba(30, 41, 59, 0.5));
            border: 3px solid #334155;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .character-card:hover {
            border-color: var(--purple);
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(168, 85, 247, 0.2);
        }

        .character-card.selected {
            border-color: var(--gold);
            box-shadow: 0 0 30px rgba(245, 158, 11, 0.4);
        }

        .character-portrait {
            width: 120px;
            height: 120px;
            margin: 0 auto 15px;
            border-radius: 50%;
            border: 3px solid #475569;
            overflow: hidden;
            background: var(--dark);
        }

        .character-portrait img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .character-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: white;
            margin-bottom: 5px;
        }

        .character-desc {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .confirm-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 40px auto 0;
            padding: 15px 40px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: 3px;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            border: none;
            border-radius: 30px;
            color: black;
            cursor: pointer;
            transition: all 0.3s;
        }

        .confirm-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(245, 158, 11, 0.5);
        }

        .confirm-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ========== HOME SCREEN ========== */
        #homeScreen {
            background:
                radial-gradient(ellipse at 30% 20%, rgba(34, 197, 94, 0.1) 0%, transparent 40%),
                radial-gradient(ellipse at 70% 80%, rgba(168, 85, 247, 0.1) 0%, transparent 40%),
                var(--dark);
        }

        .home-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0 30px;
        }

        .player-profile {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .player-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid var(--gold);
            overflow: hidden;
        }

        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .player-info h3 {
            font-size: 1.1rem;
            color: var(--gold);
        }

        .player-alliance {
            background: linear-gradient(90deg, var(--purple-dark), var(--purple));
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            margin-top: 4px;
        }

        .player-info p {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .currency-display {
            display: flex;
            gap: 15px;
        }

        .currency-item {
            display: flex;
            align-items: center;
            gap: 0;
            background: var(--panel);
            padding: 8px 15px 8px 5px;
            border-radius: 25px;
            border: 1px solid #334155;
        }

        .currency-icon {
            font-size: 1.3rem;
        }

        .currency-icon-img {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        .tr-coin-header {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }

        .currency-amount {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--gold);
        }

        /* Menu Grid */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            max-width: 500px;
            margin: 0 auto;
        }

        .menu-item {
            background: linear-gradient(135deg, var(--panel), rgba(30, 41, 59, 0.7));
            border: 2px solid #334155;
            border-radius: 20px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .menu-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .menu-item.time-recruit {
            border-color: var(--purple);
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), var(--panel));
        }

        .menu-item.time-recruit:hover {
            box-shadow: 0 10px 40px rgba(168, 85, 247, 0.3);
        }

        .menu-item.search {
            border-color: var(--green);
        }

        .menu-item.search:hover {
            box-shadow: 0 10px 40px rgba(34, 197, 94, 0.3);
        }

        .menu-item.heroes {
            border-color: var(--blue);
        }

        .menu-item.gym {
            border-color: var(--red);
        }

        .menu-icon-text {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 10px;
            text-shadow: 0 0 15px rgba(245, 158, 11, 0.3);
        }

        .menu-label {
            font-size: 0.9rem;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .menu-status {
            font-size: 0.7rem;
            color: var(--gold);
            opacity: 0.7;
        }

        .menu-status.locked {
            color: #64748b;
        }

        /* ========== TIME RECRUIT SCREEN ========== */
        #timeRecruitScreen {
            background:
                radial-gradient(ellipse at 50% 40%, rgba(168, 85, 247, 0.3) 0%, transparent 50%),
                var(--dark);
            text-align: center;
        }

        /* ========== TIME RECRUIT SCREEN ========== */
        .time-recruit-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            padding-top: 40px;
        }

        .portal-wrapper {
            width: 300px;
            height: 200px;
            margin: 30px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .portal-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            animation: portalPulse 3s ease-in-out infinite;
        }

        @keyframes portalPulse {

            0%,
            100% {
                transform: scale(1);
                filter: brightness(1) drop-shadow(0 0 20px rgba(168, 85, 247, 0.5));
            }

            50% {
                transform: scale(1.05);
                filter: brightness(1.2) drop-shadow(0 0 40px rgba(168, 85, 247, 0.8));
            }
        }

        .summon-btn-large {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px 50px;
            background: linear-gradient(135deg, var(--purple), var(--purple-dark));
            border: 3px solid var(--purple);
            border-radius: 50px;
            color: white;
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 4px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 30px;
        }

        .summon-btn-large:hover {
            transform: scale(1.05);
            box-shadow: 0 0 50px rgba(168, 85, 247, 0.6);
        }

        .summon-coin-large {
            width: 150px;
            height: 150px;
            object-fit: contain;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--panel);
            border: 2px solid #475569;
            border-radius: 10px;
            padding: 10px 20px;
            color: white;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .back-btn:hover {
            border-color: white;
        }

        /* ========== SEARCH / ENCOUNTER SCREEN ========== */
        #searchScreen {
            background:
                radial-gradient(ellipse at 50% 50%, rgba(34, 197, 94, 0.15) 0%, transparent 50%),
                var(--dark);
        }

        .encounter-area {
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
        }

        .search-btn {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--green), #16a34a);
            border: 4px solid #4ade80;
            color: white;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            letter-spacing: 3px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 40px auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .search-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 50px rgba(34, 197, 94, 0.5);
        }

        .search-btn .icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .encounter-info {
            color: #94a3b8;
            font-size: 0.9rem;
            margin-top: 20px;
        }

        /* ========== HERO ROSTER SCREEN ========== */
        #heroesScreen {
            background: var(--dark);
        }

        .hero-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .hero-slot {
            aspect-ratio: 1;
            background: var(--panel);
            border: 2px solid #334155;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .hero-slot.empty {
            opacity: 0.5;
        }

        .hero-slot:hover {
            border-color: var(--gold);
            transform: scale(1.05);
        }

        .hero-slot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .hero-level {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: var(--gold);
            color: black;
            font-size: 0.7rem;
            font-weight: 700;
            border-radius: 10px;
        }

        .empty-slot-text {
            color: #475569;
            font-size: 2rem;
        }

        .coming-soon-box {
            max-width: 400px;
            margin: 100px auto 0;
            text-align: center;
            padding: 40px;
            background: var(--panel);
            border-radius: 20px;
            border: 2px solid #334155;
        }

        .coming-soon-box .coming-soon-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .coming-soon-box h3 {
            color: var(--gold);
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .coming-soon-box p {
            color: #cbd5e1;
            margin-bottom: 10px;
        }

        /* ========== HEROES GRID ========== */
        .heroes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            padding: 80px 40px 40px;
            max-width: 800px;
            margin: 0 auto;
        }

        .hero-card {
            background: var(--panel);
            border: 2px solid #334155;
            border-radius: 15px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .hero-card:hover {
            border-color: var(--gold);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .hero-card-img {
            width: 100%;
            height: 150px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        .hero-card-name {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 5px;
        }

        .hero-card-type {
            font-size: 0.8rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .hero-card-level {
            font-size: 0.9rem;
            font-weight: 700;
            color: #22c55e;
            margin-top: 5px;
        }

        /* ========== MODAL OVERLAY ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        /* ========== SUMMON MODAL ========== */
        .summon-modal {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px;
            max-width: 400px;
            text-align: center;
        }

        .summon-glow {
            position: absolute;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(168, 85, 247, 0.6) 0%, transparent 70%);
            border-radius: 50%;
            animation: summonGlow 2s ease-in-out infinite;
        }

        @keyframes summonGlow {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.8;
            }

            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        .summon-hero-reveal {
            position: relative;
            z-index: 1;
            animation: heroReveal 0.8s ease-out;
        }

        @keyframes heroReveal {
            0% {
                transform: scale(0) rotate(-10deg);
                opacity: 0;
            }

            50% {
                transform: scale(1.2) rotate(5deg);
                opacity: 1;
            }

            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .summon-hero-img {
            width: 200px;
            height: 250px;
            object-fit: contain;
            filter: drop-shadow(0 0 30px rgba(168, 85, 247, 0.8));
        }

        .summon-hero-info {
            position: relative;
            z-index: 1;
            margin-top: 20px;
            animation: fadeInUp 0.5s ease-out 0.3s both;
        }

        @keyframes fadeInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .summon-rarity {
            display: inline-block;
            padding: 4px 16px;
            background: linear-gradient(135deg, #a855f7, #7c3aed);
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            letter-spacing: 2px;
            color: white;
            margin-bottom: 10px;
        }

        .summon-hero-name {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            color: var(--gold);
            margin-bottom: 5px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .summon-hero-type {
            font-size: 1rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 20px;
        }

        .summon-stats {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .stat-box {
            display: flex;
            flex-direction: column;
            background: var(--panel);
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid #334155;
        }

        .stat-label {
            font-size: 0.7rem;
            color: #64748b;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: white;
        }

        .summon-close-btn {
            margin-top: 30px;
            padding: 15px 40px;
            background: transparent;
            border: 2px solid var(--gold);
            border-radius: 30px;
            color: var(--gold);
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s;
            animation: pulse 2s ease-in-out infinite;
        }

        .summon-close-btn:hover {
            background: var(--gold);
            color: var(--dark);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* ========== MESSAGE MODAL ========== */
        .message-modal {
            background: var(--panel);
            padding: 40px;
            border-radius: 20px;
            border: 2px solid #334155;
            text-align: center;
            max-width: 350px;
        }

        .message-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .message-title {
            font-family: 'Cinzel', serif;
            font-size: 1.4rem;
            color: var(--gold);
            margin-bottom: 10px;
        }

        .message-text {
            color: #cbd5e1;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .message-ok-btn {
            padding: 12px 40px;
            background: linear-gradient(135deg, var(--purple), var(--purple-dark));
            border: none;
            border-radius: 25px;
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .message-ok-btn:hover {
            transform: scale(1.05);
        }

        /* ========== HERO DETAIL MODAL ========== */
        .hero-detail-modal {
            position: relative;
            background: var(--panel);
            padding: 30px;
            border-radius: 20px;
            border: 2px solid #334155;
            text-align: center;
            max-width: 380px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-close-x {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #64748b;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-close-x:hover {
            color: white;
        }

        .hero-detail-img {
            width: 150px;
            height: 180px;
            object-fit: contain;
            margin-bottom: 15px;
        }

        .hero-detail-info {
            margin-bottom: 20px;
        }

        .hero-detail-rarity {
            display: inline-block;
            padding: 3px 12px;
            background: #64748b;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 1px;
            color: white;
            margin-bottom: 8px;
        }

        .hero-detail-name {
            font-family: 'Cinzel', serif;
            font-size: 1.6rem;
            color: var(--gold);
            margin-bottom: 5px;
        }

        .hero-detail-type {
            font-size: 0.9rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .hero-detail-level {
            font-size: 0.9rem;
            color: #22c55e;
            font-weight: 700;
            margin-top: 5px;
        }

        .hero-detail-stats {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .hero-detail-attacks {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .hero-detail-attacks h4 {
            color: var(--gold);
            font-size: 0.9rem;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        /* ========== XP PROGRESS ========== */
        .hero-xp-section {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .xp-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .xp-label {
            font-weight: 700;
            color: #22c55e;
            font-size: 0.8rem;
            letter-spacing: 1px;
        }

        .xp-text {
            color: #94a3b8;
            font-size: 0.8rem;
        }

        .xp-bar {
            width: 100%;
            height: 10px;
            background: #1e293b;
            border-radius: 5px;
            overflow: hidden;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #4ade80);
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .xp-next {
            margin-top: 8px;
            font-size: 0.75rem;
            color: #64748b;
            text-align: center;
        }

        .xp-next span {
            color: #22c55e;
            font-weight: 600;
        }

        .attacks-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .attack-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--panel);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .attack-name {
            color: white;
            font-weight: 600;
        }

        .attack-dmg {
            color: #ef4444;
            font-weight: 700;
        }

        .attack-effect {
            color: #a855f7;
            font-size: 0.75rem;
        }

        /* ========== BATTLE SCREEN ========== */
        #searchScreen.active {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 15px;
            box-sizing: border-box;
        }

        .battle-enemy-side {
            text-align: right;
            margin-bottom: 10px;
        }

        .battle-enemy-info,
        .battle-player-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .battle-name {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            color: white;
        }

        .battle-level {
            background: #334155;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .battle-hp-bar {
            width: 60%;
            height: 12px;
            background: #1e293b;
            border-radius: 6px;
            overflow: hidden;
            margin-left: auto;
        }

        .battle-hp-bar.player-bar {
            margin-left: 0;
            margin-right: auto;
        }

        .hp-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .enemy-hp {
            background: linear-gradient(90deg, #ef4444, #f97316);
        }

        .player-hp {
            background: linear-gradient(90deg, #22c55e, #4ade80);
        }

        .battle-hp-text {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 2px;
        }

        .status-icons {
            display: flex;
            gap: 4px;
            margin-top: 4px;
            font-size: 1rem;
        }

        .status-icon {
            background: rgba(0, 0, 0, 0.4);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
        }

        .battle-enemy-img {
            width: 150px;
            height: 150px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        .battle-player-side {
            margin-top: auto;
            text-align: left;
        }

        .battle-player-img {
            width: 140px;
            height: 140px;
            object-fit: contain;
        }

        .battle-log {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 15px;
            border-radius: 10px;
            margin: 10px 0;
            max-height: 60px;
            overflow-y: auto;
        }

        .battle-log p {
            margin: 3px 0;
            font-size: 0.85rem;
            color: #cbd5e1;
        }

        .attack-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 10px;
            background: var(--panel);
            border-radius: 15px;
            border: 2px solid #334155;
        }

        .attack-btn {
            padding: 15px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .attack-btn:hover {
            transform: scale(1.02);
        }

        .attack-btn:disabled {
            background: #334155;
            color: #64748b;
            cursor: not-allowed;
        }

        .attack-btn.ultimate {
            background: linear-gradient(135deg, #a855f7, #7c3aed);
        }

        /* ========== GYM INTRO VIDEO ========== */
        .gym-intro-container {
            position: relative;
            width: 100%;
            height: 100vh;
            background: black;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gym-intro-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .skip-intro-btn {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid white;
            color: white;
            padding: 10px 25px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
        }

        /* ========== GYM HERO SELECTION ========== */
        .gym-select-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }

        .gym-select-hero {
            background: var(--panel);
            border: 3px solid #334155;
            border-radius: 15px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .gym-select-hero:hover {
            border-color: var(--purple);
        }

        .gym-select-hero.selected {
            border-color: var(--gold);
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.4);
        }

        .gym-select-hero img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 10px;
        }

        .gym-select-hero .hero-name {
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .selected-team {
            background: var(--panel);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .selected-team h3 {
            color: var(--gold);
            margin-bottom: 10px;
        }

        .selected-team-row {
            display: flex;
            justify-content: center;
            gap: 10px;
            min-height: 60px;
            align-items: center;
        }

        .selected-team-row img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--gold);
            object-fit: contain;
            background: var(--dark);
        }

        /* ========== GYM BATTLE ========== */
        #gymBattleScreen {
            background:
                radial-gradient(ellipse at 50% 0%, rgba(239, 68, 68, 0.2) 0%, transparent 50%),
                var(--dark);
        }

        .gym-leader-header {
            display: flex;
            align-items: center;
            gap: 15px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(168, 85, 247, 0.1));
            padding: 10px 15px;
            border-radius: 15px;
            margin-bottom: 10px;
        }

        .gym-leader-portrait {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid var(--gold);
            object-fit: cover;
        }

        .gym-leader-name {
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            color: var(--gold);
        }

        .gym-leader-title {
            font-size: 0.85rem;
            color: #ef4444;
        }

        .gym-roster {
            display: flex;
            justify-content: center;
            padding: 5px;
        }

        .roster-icons {
            display: flex;
            gap: 8px;
        }

        .roster-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #334155;
            object-fit: contain;
            background: var(--panel);
            opacity: 0.5;
        }

        .roster-icon.active {
            border-color: var(--gold);
            opacity: 1;
        }

        .roster-icon.fainted {
            opacity: 0.3;
            filter: grayscale(100%);
        }

        .gym-battle-enemy,
        .gym-battle-player {
            text-align: center;
            padding: 10px;
        }

        .gym-battle-img {
            width: 100px;
            height: 100px;
            object-fit: contain;
        }

        .gym-battle-info {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 5px 0;
        }

        /* ========== MESSAGE MODAL ========== */
        .message-box {
            background: var(--panel);
            border: 2px solid var(--gold);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            max-width: 90%;
            width: 300px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* ========== BATTLE SELECT MODAL ========== */
        .battle-select-modal {
            position: relative;
            background: var(--panel);
            padding: 30px;
            border-radius: 20px;
            border: 2px solid #334155;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--gold);
            text-align: center;
            margin-bottom: 5px;
        }

        .modal-subtitle {
            text-align: center;
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .battle-hero-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .battle-hero-option {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .battle-hero-option:hover {
            border-color: var(--purple);
            transform: scale(1.05);
        }

        .battle-hero-option img {
            width: 60px;
            height: 70px;
            object-fit: contain;
        }

        .battle-hero-option .hero-name {
            font-size: 0.75rem;
            color: white;
            margin-top: 5px;
        }

        .battle-hero-option .hero-lvl {
            font-size: 0.65rem;
            color: #64748b;
        }

        /* ========== BATTLE RESULT MODAL ========== */
        .battle-result-modal {
            background: var(--panel);
            padding: 40px;
            border-radius: 20px;
            border: 2px solid #334155;
            text-align: center;
            max-width: 350px;
        }

        .result-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .result-title {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            margin-bottom: 20px;
        }

        .result-title.victory {
            color: #22c55e;
        }

        .result-title.defeat {
            color: #ef4444;
        }

        .result-rewards {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .reward-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
        }

        .reward-label {
            color: #94a3b8;
        }

        .reward-value {
            color: #22c55e;
            font-weight: 700;
        }

        /* ========== UTILITY ========== */
        .text-gold {
            color: var(--gold);
        }

        .text-purple {
            color: var(--purple);
        }

        .text-green {
            color: var(--green);
        }

        .text-muted {
            color: #94a3b8;
        }

        .mt-20 {
            margin-top: 20px;
        }
    </style>
    <style>
        /* ========== MOBILE RESPONSIVENESS ========== */
        @media (max-width: 768px) {
            .screen {
                padding: 10px;
                padding-bottom: 80px;
                /* Space for nav */
            }

            .game-logo {
                font-size: 2.5rem;
            }

            /* Character Selection */
            .character-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .setup-fields {
                flex-direction: column;
            }

            .field-group {
                width: 100%;
            }

            /* Heroes List */
            .heroes-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .hero-card .hero-card-img {
                height: 120px;
            }

            /* Battle & Gym */
            .battle-hero-grid,
            .gym-select-grid {
                grid-template-columns: repeat(3, 1fr);
                /* Keep 3 for compactness */
            }

            .gym-leader-header {
                flex-direction: column;
                text-align: center;
            }

            /* Modals */
            .summon-modal {
                width: 95%;
                padding: 15px;
            }

            .summon-hero-img {
                height: 200px;
            }
        }
    </style>
</head>

<body>
    <!-- ===== TITLE SCREEN ===== -->
    <div id="titleScreen" class="screen active">
        <h1 class="game-logo">POCKET CONQUEST</h1>
        <p class="game-subtitle">TIME RECRUIT EDITION</p>

        <button class="title-btn" onclick="startNewGame()">NEW GAME</button>
        <button id="continueBtn" class="title-btn secondary hidden" onclick="loadGame()">CONTINUE</button>
    </div>

    <!-- ===== CHARACTER SELECT ===== -->
    <div id="characterSelect" class="screen">
        <h2 class="screen-title">CHOOSE YOUR TRAINER</h2>

        <!-- Username & Alliance Setup -->
        <div class="setup-fields">
            <div class="field-group">
                <label for="usernameInput">Your Name</label>
                <input type="text" id="usernameInput" placeholder="Enter your name..." maxlength="20">
            </div>
            <div class="field-group">
                <label for="allianceSelect">Alliance</label>
                <select id="allianceSelect" onchange="handleAllianceChange()">
                    <option value="ROL">ROL (Rebirth of Legends)</option>
                    <option value="custom">Other Alliance...</option>
                </select>
                <input type="text" id="customAllianceInput" class="hidden" placeholder="Enter alliance name..."
                    maxlength="20">
            </div>
        </div>

        <div class="character-grid">
            <div class="character-card" onclick="selectCharacter('kai', this)">
                <div class="character-portrait">
                    <img src="assets/trainers/kai.png" alt="Kai"
                        onerror="this.parentElement.innerHTML='<div style=&quot;width:100%;height:100%;background:#ef4444;display:flex;align-items:center;justify-content:center;font-size:3rem;&quot;>üî¥</div>'">
                </div>
                <div class="character-name">KAI</div>
                <div class="character-desc">The Adventurer</div>
            </div>

            <div class="character-card" onclick="selectCharacter('raven', this)">
                <div class="character-portrait">
                    <img src="assets/trainers/raven.png" alt="Raven"
                        onerror="this.parentElement.innerHTML='<div style=&quot;width:100%;height:100%;background:#3b82f6;display:flex;align-items:center;justify-content:center;font-size:3rem;&quot;>üîµ</div>'">
                </div>
                <div class="character-name">RAVEN</div>
                <div class="character-desc">The Strategist</div>
            </div>

            <div class="character-card" onclick="selectCharacter('luna', this)">
                <div class="character-portrait">
                    <img src="assets/trainers/luna.png" alt="Luna"
                        onerror="this.parentElement.innerHTML='<div style=&quot;width:100%;height:100%;background:#ec4899;display:flex;align-items:center;justify-content:center;font-size:3rem;&quot;>üíñ</div>'">
                </div>
                <div class="character-name">LUNA</div>
                <div class="character-desc">The Cheerful One</div>
            </div>

            <div class="character-card" onclick="selectCharacter('nova', this)">
                <div class="character-portrait">
                    <img src="assets/trainers/nova.png" alt="Nova"
                        onerror="this.parentElement.innerHTML='<div style=&quot;width:100%;height:100%;background:#a855f7;display:flex;align-items:center;justify-content:center;font-size:3rem;&quot;>üíú</div>'">
                </div>
                <div class="character-name">NOVA</div>
                <div class="character-desc">The Scholar</div>
            </div>
        </div>

        <button id="confirmCharBtn" class="confirm-btn" onclick="confirmCharacter()" disabled>SELECT TRAINER</button>
    </div>

    <!-- ===== HOME SCREEN ===== -->
    <div id="homeScreen" class="screen">
        <div class="home-header">
            <div class="player-profile">
                <div class="player-avatar">
                    <img id="homeAvatar" src="assets/trainers/kai.png" alt="Trainer"
                        style="width:100%;height:100%;object-fit:cover;">
                </div>
                <div class="player-info">
                    <h3 id="homePlayerName">TRAINER</h3>
                    <p>Level <span id="homePlayerLevel">1</span> ‚Ä¢ <span id="homeGymBadges">0</span>/12 Badges</p>
                    <p class="player-alliance"><span id="homeAlliance">ROL</span></p>
                </div>
            </div>
            <div class="currency-display">
                <div class="currency-item tr-currency">
                    <img src="assets/tr_coin.png" alt="TR" class="tr-coin-header">
                    <span id="homeTRCoins" class="currency-amount">0</span>
                </div>
            </div>
        </div>

        <div class="menu-grid">
            <div class="menu-item time-recruit" onclick="showScreen('timeRecruitScreen')">
                <div class="menu-icon-text">TR</div>
                <div class="menu-label">Time Recruit</div>
                <div class="menu-status">Summon Heroes</div>
            </div>

            <div class="menu-item search" onclick="openBattleSelect()">
                <div class="menu-icon-text">VS</div>
                <div class="menu-label">Battle</div>
                <div class="menu-status">Find Wild Heroes</div>
            </div>

            <div class="menu-item heroes" onclick="showScreen('heroesScreen')">
                <div class="menu-icon-text">H</div>
                <div class="menu-label">My Heroes</div>
                <div class="menu-status">0 Heroes</div>
            </div>

            <div class="menu-item gym" onclick="goToGym()">
                <div class="menu-icon-text">GYM</div>
                <div class="menu-label">Gym Battle</div>
                <div class="menu-status">12 Gyms</div>
            </div>
        </div>
    </div>

    <!-- ===== TIME RECRUIT SCREEN ===== -->
    <div id="timeRecruitScreen" class="screen">
        <button class="back-btn" onclick="showScreen('homeScreen')">‚Üê Back</button>

        <div class="time-recruit-content">
            <h2 class="screen-title">TIME RECRUIT</h2>

            <div class="portal-wrapper">
                <img src="assets/time_recruit_portal.png" alt="Time Recruit Portal" class="portal-image">
            </div>

            <button class="summon-btn-large" onclick="summonHero()">
                <img src="assets/tr_coin.png" alt="TR" class="summon-coin-large">
                <span>SUMMON</span>
            </button>
        </div>
    </div>

    <!-- ===== GYM CAMPAIGN SCREEN ===== -->
    <div id="gymCampaignScreen" class="screen">
        <button class="back-btn" onclick="showScreen('homeScreen')">‚Üê Back</button>
        <h2 class="screen-title">GYM BATTLE CAMPAIGN</h2>

        <div class="campaign-list"
            style="max-width:500px;margin:20px auto;display:flex;flex-direction:column;gap:15px;">
            <!-- GYM 1 -->
            <div class="campaign-item" onclick="selectGym(1)"
                style="background:var(--panel);padding:20px;border-radius:15px;border:2px solid var(--red);cursor:pointer;display:flex;align-items:center;gap:15px;transition:transform 0.2s;"
                onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div class="gym-icon" style="font-size:2rem;">üî•</div>
                <div style="text-align:left;flex:1;">
                    <div style="font-family:'Cinzel';color:var(--gold);font-size:1.2rem;">GYM 1: SHELAK</div>
                    <div style="font-size:0.8rem;color:#94a3b8;">The Flame Warden</div>
                </div>
                <div
                    style="background:var(--red);color:white;padding:5px 15px;border-radius:20px;font-size:0.8rem;font-weight:bold;">
                    BATTLE</div>
            </div>

            <!-- GYM 2 -->
            <div class="campaign-item locked"
                style="background:#1e293b;padding:20px;border-radius:15px;border:2px solid #334155;opacity:0.7;display:flex;align-items:center;gap:15px;">
                <div class="gym-icon" style="font-size:2rem;">üîí</div>
                <div style="text-align:left;flex:1;">
                    <div style="font-family:'Cinzel';color:#94a3b8;font-size:1.2rem;">GYM 2: COMING SOON</div>
                    <div style="font-size:0.8rem;color:#64748b;">Locked</div>
                </div>
            </div>

            <!-- CHAPTER 2 -->
            <div class="campaign-item locked"
                style="background:#1e293b;padding:20px;border-radius:15px;border:2px solid #334155;opacity:0.7;display:flex;align-items:center;gap:15px;">
                <div class="gym-icon" style="font-size:2rem;">üîí</div>
                <div style="text-align:left;flex:1;">
                    <div style="font-family:'Cinzel';color:#94a3b8;font-size:1.2rem;">CHAPTER 2</div>
                    <div style="font-size:0.8rem;color:#64748b;">Coming Soon</div>
                </div>
            </div>
        </div>
        <div id="searchScreen" class="screen">
            <button class="back-btn" onclick="fleeBattle()">‚Üê Flee</button>

            <!-- ENEMY SIDE (top) -->
            <div class="battle-enemy-side">
                <img id="enemyImage" src="" alt="Enemy" class="battle-enemy-img">
                <div class="battle-enemy-info">
                    <span class="battle-name" id="enemyName">Wild Hero</span>
                    <span class="battle-level" id="enemyLevel">Lv.1</span>
                </div>
                <div class="battle-hp-bar">
                    <div class="hp-fill enemy-hp" id="enemyHpBar" style="width:100%"></div>
                </div>
                <div class="battle-hp-text" id="enemyHpText">100/100</div>
                <div class="status-icons" id="enemyStatusIcons"></div>
            </div>

            <!-- PLAYER SIDE (bottom) -->
            <div class="battle-player-side">
                <img id="playerHeroImage" src="" alt="Hero" class="battle-player-img">
                <div class="battle-player-info">
                    <span class="battle-name" id="playerHeroName">Your Hero</span>
                    <span class="battle-level" id="playerHeroLevel">Lv.1</span>
                </div>
                <div class="battle-hp-bar player-bar">
                    <div class="hp-fill player-hp" id="playerHpBar" style="width:100%"></div>
                </div>
                <div class="battle-hp-text" id="playerHpText">100/100</div>
                <div class="status-icons" id="playerStatusIcons"></div>
            </div>

            <!-- BATTLE LOG -->
            <div class="battle-log" id="battleLog">
                <p>A wild hero appeared!</p>
            </div>

            <!-- ATTACK BUTTONS -->
            <div class="attack-panel" id="attackPanel">
                <button class="attack-btn" onclick="useAttack(0)" id="atkBtn0">Attack 1</button>
                <button class="attack-btn" onclick="useAttack(1)" id="atkBtn1">Attack 2</button>
                <button class="attack-btn" onclick="useAttack(2)" id="atkBtn2">Attack 3</button>
                <button class="attack-btn ultimate" onclick="useAttack(3)" id="atkBtn3">Ultimate</button>
            </div>
        </div>

        <!-- ===== GYM INTRO VIDEO SCREEN ===== -->
        <div id="gymIntroScreen" class="screen">
            <div class="gym-intro-container">
                <video id="gymIntroVideo" class="gym-intro-video" autoplay playsinline>
                    <source src="" type="video/mp4">
                </video>
                <button class="skip-intro-btn" onclick="skipGymIntro()">Skip ‚Üí</button>
            </div>
        </div>

        <!-- ===== GYM HERO SELECTION ===== -->
        <div id="gymSelectScreen" class="screen">
            <button class="back-btn" onclick="showScreen('homeScreen')">‚Üê Back</button>
            <h2 class="screen-title">SELECT YOUR TEAM</h2>
            <p style="text-align:center;color:#94a3b8;margin-bottom:15px;">Choose 5 heroes for the gym battle</p>

            <div class="gym-select-grid" id="gymSelectGrid">
                <!-- Heroes rendered here -->
            </div>

            <div class="selected-team">
                <h3>Your Team (<span id="selectedCount">0</span>/5)</h3>
                <div class="selected-team-row" id="selectedTeamRow">
                    <!-- Selected heroes appear here -->
                </div>
            </div>

            <button id="startGymBattleBtn" class="confirm-btn" onclick="startGymBattle()" disabled>START GYM
                BATTLE</button>
        </div>

        <!-- ===== GYM BATTLE SCREEN ===== -->
        <div id="gymBattleScreen" class="screen">
            <button class="back-btn" onclick="fleeGymBattle()" style="left:auto;right:20px;">Forfeit üè≥Ô∏è</button>

            <!-- GYM LEADER INFO -->
            <div class="gym-leader-header">
                <img id="gymLeaderImg" src="" alt="Gym Leader" class="gym-leader-portrait">
                <div class="gym-leader-info">
                    <div class="gym-leader-name" id="gymLeaderName">GYM LEADER</div>
                    <div class="gym-leader-title" id="gymLeaderTitle">The Flame Warden</div>
                </div>
            </div>

            <!-- ENEMY TEAM ROSTER -->
            <div class="gym-roster enemy-roster">
                <div class="roster-icons" id="enemyRoster">
                    <!-- Enemy hero icons -->
                </div>
            </div>

            <!-- ACTIVE ENEMY -->
            <div class="gym-battle-enemy">
                <img id="gymEnemyImage" src="" alt="Enemy" class="gym-battle-img">
                <div class="gym-battle-info">
                    <span class="battle-name" id="gymEnemyName">Enemy</span>
                    <span class="battle-level" id="gymEnemyLevel">Lv.130</span>
                </div>
                <div class="battle-hp-bar">
                    <div class="hp-fill enemy-hp" id="gymEnemyHpBar" style="width:100%"></div>
                </div>
                <div class="battle-hp-text" id="gymEnemyHpText">500/500</div>
                <div class="status-icons" id="gymEnemyStatusIcons"></div>
            </div>

            <!-- PLAYER TEAM ROSTER -->
            <div class="gym-roster player-roster">
                <div class="roster-icons" id="playerRoster">
                    <!-- Player hero icons -->
                </div>
            </div>

            <!-- ACTIVE PLAYER HERO -->
            <div class="gym-battle-player">
                <img id="gymPlayerImage" src="" alt="Hero" class="gym-battle-img">
                <div class="gym-battle-info">
                    <span class="battle-name" id="gymPlayerName">Your Hero</span>
                    <span class="battle-level" id="gymPlayerLevel">Lv.1</span>
                </div>
                <div class="battle-hp-bar player-bar">
                    <div class="hp-fill player-hp" id="gymPlayerHpBar" style="width:100%"></div>
                </div>
                <div class="battle-hp-text" id="gymPlayerHpText">100/100</div>
                <div class="status-icons" id="gymPlayerStatusIcons"></div>
            </div>

            <!-- BATTLE LOG -->
            <div class="battle-log" id="gymBattleLog">
                <p>Gym battle started!</p>
            </div>

            <!-- ATTACK BUTTONS -->
            <div class="attack-panel" id="gymAttackPanel">
                <button class="attack-btn" onclick="useGymAttack(0)" id="gymAtkBtn0">Attack 1</button>
                <button class="attack-btn" onclick="useGymAttack(1)" id="gymAtkBtn1">Attack 2</button>
                <button class="attack-btn" onclick="useGymAttack(2)" id="gymAtkBtn2">Attack 3</button>
                <button class="attack-btn ultimate" onclick="useGymAttack(3)" id="gymAtkBtn3">Ultimate</button>
            </div>
        </div>

        <!-- ===== HEROES SCREEN ===== -->
        <div id="heroesScreen" class="screen">
            <button class="back-btn" onclick="showScreen('homeScreen')">‚Üê Back</button>

            <h2 class="screen-title">MY HEROES</h2>

            <div id="heroListContainer">
                <!-- Heroes will be dynamically rendered here -->
            </div>

            <div id="noHeroesMessage" class="coming-soon-box">
                <img id="heroesTrainerImg" src="assets/trainers/kai.png" alt="Trainer"
                    style="width:100px;height:100px;border-radius:50%;object-fit:cover;border:3px solid var(--gold);margin-bottom:20px;">
                <h3>No Heroes Yet</h3>
                <p>Use Time Recruit to summon your first hero!</p>
            </div>
        </div>



        <!-- ===== SUMMON RESULT MODAL ===== -->
        <div id="summonModal" class="modal-overlay" style="display:none;">
            <div class="summon-modal">
                <div class="summon-glow"></div>
                <div class="summon-hero-reveal">
                    <img id="summonHeroImg" src="" alt="Hero" class="summon-hero-img">
                </div>
                <div class="summon-hero-info">
                    <div class="summon-rarity" id="summonRarity">RARE</div>
                    <h2 class="summon-hero-name" id="summonHeroName">Hero Name</h2>
                    <div class="summon-hero-type" id="summonHeroType">Type</div>
                    <div class="summon-stats">
                        <div class="stat-box"><span class="stat-label">HP</span><span class="stat-value"
                                id="summonHP">100</span></div>
                        <div class="stat-box"><span class="stat-label">ATK</span><span class="stat-value"
                                id="summonATK">30</span></div>
                        <div class="stat-box"><span class="stat-label">DEF</span><span class="stat-value"
                                id="summonDEF">25</span></div>
                    </div>
                </div>
                <button class="summon-close-btn" onclick="closeSummonModal()">TAP TO CONTINUE</button>
            </div>
        </div>

        <!-- ===== CUSTOM MESSAGE MODAL ===== -->
        <div id="messageModal" class="modal-overlay" style="display:none;">
            <div class="message-modal">
                <div class="message-icon" id="messageIcon">‚ùå</div>
                <h3 class="message-title" id="messageTitle">Title</h3>
                <p class="message-text" id="messageText">Message text here</p>
                <button class="message-ok-btn" onclick="closeMessageModal()">OK</button>
            </div>
        </div>

        <!-- ===== HERO DETAILS MODAL ===== -->
        <div id="heroDetailModal" class="modal-overlay" style="display:none;">
            <div class="hero-detail-modal">
                <button class="modal-close-x" onclick="closeHeroDetailModal()">‚úï</button>
                <img id="heroDetailImg" src="" alt="Hero" class="hero-detail-img">
                <div class="hero-detail-info">
                    <div class="hero-detail-rarity" id="heroDetailRarity">COMMON</div>
                    <h2 class="hero-detail-name" id="heroDetailName">Hero Name</h2>
                    <div class="hero-detail-type" id="heroDetailType">Type</div>
                    <div class="hero-detail-level" id="heroDetailLevel">Level 1</div>
                </div>
                <div class="hero-detail-stats">
                    <div class="stat-box"><span class="stat-label">HP</span><span class="stat-value"
                            id="heroDetailHP">100</span></div>
                    <div class="stat-box"><span class="stat-label">ATK</span><span class="stat-value"
                            id="heroDetailATK">30</span></div>
                    <div class="stat-box"><span class="stat-label">DEF</span><span class="stat-value"
                            id="heroDetailDEF">25</span></div>
                </div>
                <div class="hero-xp-section">
                    <div class="xp-header">
                        <span class="xp-label">EXP</span>
                        <span class="xp-text" id="heroDetailXP">0 / 20</span>
                    </div>
                    <div class="xp-bar">
                        <div class="xp-fill" id="heroDetailXPBar" style="width:0%"></div>
                    </div>
                    <div class="xp-next">Next Level: <span id="heroDetailXPNeeded">20 XP</span></div>
                </div>
                <div class="hero-detail-attacks">
                    <h4>ATTACKS</h4>
                    <div id="heroDetailAttacksList" class="attacks-list"></div>
                </div>
                <button class="message-ok-btn" onclick="closeHeroDetailModal()">CLOSE</button>
            </div>
        </div>

        <!-- ===== BATTLE HERO SELECT MODAL ===== -->
        <div id="battleSelectModal" class="modal-overlay" style="display:none;">
            <div class="battle-select-modal">
                <button class="modal-close-x" onclick="closeBattleSelect()">‚úï</button>
                <h2 class="modal-title">SELECT YOUR HERO</h2>
                <p class="modal-subtitle">Choose a hero to battle with</p>
                <div id="battleHeroGrid" class="battle-hero-grid">
                    <!-- Heroes will be rendered here -->
                </div>
                <div id="noHeroesForBattle" style="display:none; text-align:center; padding:20px;">
                    <p style="color:#94a3b8;">You need at least 1 hero to battle!</p>
                    <button class="message-ok-btn" onclick="closeBattleSelect(); showScreen('timeRecruitScreen');">
                        Go Summon
                    </button>
                </div>
            </div>
        </div>

        <!-- ===== BATTLE RESULT MODAL ===== -->
        <div id="battleResultModal" class="modal-overlay" style="display:none;">
            <div class="battle-result-modal">
                <div class="result-icon" id="resultIcon">‚öîÔ∏è</div>
                <h2 class="result-title" id="resultTitle">VICTORY!</h2>
                <div class="result-rewards">
                    <div class="reward-item">
                        <span class="reward-label">XP Gained:</span>
                        <span class="reward-value" id="resultXP">+20</span>
                    </div>
                    <div class="reward-item" id="coinRewardRow" style="display:none;">
                        <span class="reward-label">TR Coin:</span>
                        <span class="reward-value">+1 ü™ô</span>
                    </div>
                </div>
                <button class="message-ok-btn" onclick="closeBattleResult()">CONTINUE</button>
            </div>
        </div>

        <script>
            // ========== GAME STATE ==========
            let gameState = {
                trainer: null,
                trainerName: '',
                level: 1,
                trCoins: 0,
                gems: 100,
                badges: 0,
                heroes: []
            };

            // ========== SCREEN MANAGEMENT ==========
            function showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');

                if (screenId === 'homeScreen') updateHomeScreen();
                if (screenId === 'heroesScreen') updateHeroesScreen();
            }

            function updateHeroesScreen() {
                const container = document.getElementById('heroListContainer');
                const noHeroesMsg = document.getElementById('noHeroesMessage');

                // Update trainer image
                if (gameState.trainer) {
                    document.getElementById('heroesTrainerImg').src = 'assets/trainers/' + gameState.trainer + '.png';
                }

                // Check if player has heroes
                if (gameState.heroes.length === 0) {
                    container.innerHTML = '';
                    noHeroesMsg.style.display = 'block';
                    return;
                }

                // Hide no heroes message
                noHeroesMsg.style.display = 'none';

                // Render hero grid
                container.innerHTML = '<div class="heroes-grid">' +
                    gameState.heroes.map((hero, index) => `
                    <div class="hero-card" onclick="showHeroDetails(${index})">
                        <img src="${hero.image}" alt="${hero.name}" class="hero-card-img">
                        <div class="hero-card-info">
                            <div class="hero-card-name">${hero.name}</div>
                            <div class="hero-card-type">${hero.type}</div>
                            <div class="hero-card-level">Lv.${hero.level}</div>
                        </div>
                    </div>
                `).join('') +
                    '</div>';
            }

            function showHeroDetails(index) {
                const hero = gameState.heroes[index];
                if (!hero) return;

                // Populate modal
                document.getElementById('heroDetailImg').src = hero.image;
                document.getElementById('heroDetailRarity').textContent = hero.rarity.toUpperCase();
                document.getElementById('heroDetailName').textContent = hero.name;
                document.getElementById('heroDetailType').textContent = hero.type + ' Type';
                document.getElementById('heroDetailLevel').textContent = 'Level ' + hero.level;
                document.getElementById('heroDetailHP').textContent = hero.hp + '/' + hero.maxHp;
                document.getElementById('heroDetailATK').textContent = hero.attack;
                document.getElementById('heroDetailDEF').textContent = hero.defense;

                // Calculate XP progress
                const xpNeeded = hero.level * 20;
                const currentXp = hero.xp || 0;
                const xpPct = Math.min(100, (currentXp / xpNeeded) * 100);
                document.getElementById('heroDetailXP').textContent = currentXp + ' / ' + xpNeeded;
                document.getElementById('heroDetailXPBar').style.width = xpPct + '%';
                document.getElementById('heroDetailXPNeeded').textContent = (xpNeeded - currentXp) + ' XP';

                // Build attacks list
                let attacksHtml = hero.attacks.map(a => `
                <div class="attack-item">
                    <span class="attack-name">${a.name}</span>
                    <span class="attack-dmg">${a.damage} DMG</span>
                    ${a.effect ? '<span class="attack-effect">' + a.effect + '</span>' : ''}
                </div>
            `).join('');
                document.getElementById('heroDetailAttacksList').innerHTML = attacksHtml;

                // Show modal
                document.getElementById('heroDetailModal').style.display = 'flex';
            }

            function closeHeroDetailModal() {
                document.getElementById('heroDetailModal').style.display = 'none';
            }

            // ========== CHARACTER SELECTION ==========
            let selectedTrainer = null;

            function selectCharacter(name, element) {
                document.querySelectorAll('.character-card').forEach(c => c.classList.remove('selected'));
                element.classList.add('selected');
                selectedTrainer = name;
                document.getElementById('confirmCharBtn').disabled = false;
            }

            function handleAllianceChange() {
                const select = document.getElementById('allianceSelect');
                const customInput = document.getElementById('customAllianceInput');

                if (select.value === 'custom') {
                    customInput.classList.remove('hidden');
                    customInput.focus();
                } else {
                    customInput.classList.add('hidden');
                    customInput.value = '';
                }
            }

            function confirmCharacter() {
                if (!selectedTrainer) return;

                // Get username
                const usernameInput = document.getElementById('usernameInput');
                const username = usernameInput.value.trim();

                if (!username) {
                    showMessage('Please enter your name!');
                    usernameInput.focus();
                    return;
                }

                // Get alliance
                const allianceSelect = document.getElementById('allianceSelect');
                const customAlliance = document.getElementById('customAllianceInput');
                let alliance = allianceSelect.value;

                if (alliance === 'custom') {
                    alliance = customAlliance.value.trim();
                    if (!alliance) {
                        showMessage('Please enter your alliance name!');
                        customAlliance.focus();
                        return;
                    }
                }

                gameState.trainer = selectedTrainer;
                gameState.username = username;
                gameState.trainerName = username.toUpperCase();
                gameState.alliance = alliance;
                // Special Tester Access
                if (username.toLowerCase() === 'noyzzing' && alliance === 'ROL') {
                    gameState.trCoins = 100; // Tester bonus
                    showMessage('Tester Access Granted! +100 TR Coins');
                } else {
                    gameState.trCoins = 1; // Standard starter bonus
                }

                // No fake heroes - wait for user to provide real hero images
                // Heroes will be added via Time Recruit when we have the assets

                saveGame();
                showScreen('homeScreen');
            }

            // ========== HOME SCREEN ==========
            function updateHomeScreen() {
                document.getElementById('homePlayerName').textContent = gameState.trainerName;
                document.getElementById('homePlayerLevel').textContent = gameState.level;
                document.getElementById('homeGymBadges').textContent = gameState.badges;
                document.getElementById('homeTRCoins').textContent = gameState.trCoins;
                document.getElementById('homeAlliance').textContent = gameState.alliance || 'ROL';

                // Update avatar to selected trainer image
                if (gameState.trainer) {
                    document.getElementById('homeAvatar').src = 'assets/trainers/' + gameState.trainer + '.png';
                }
            }

            // ========== STARTER HEROES DATABASE ==========
            const starterHeroes = [
                {
                    id: 'naax',
                    name: 'Naax',
                    type: 'Steel',
                    rarity: 'Common',
                    image: 'assets/heroes/naax.png',
                    baseHp: 120,
                    baseAtk: 35,
                    baseDef: 40,
                    attacks: [
                        { name: 'Sword Slash', damage: 25, type: 'Physical' },
                        { name: 'Shield Bash', damage: 20, type: 'Physical', effect: 'Stun 20%' },
                        { name: 'Steel Guard', damage: 0, type: 'Buff', effect: 'Defense +30%' },
                        { name: 'Knight\'s Fury', damage: 45, type: 'Physical', effect: 'Ultimate' }
                    ]
                },
                {
                    id: 'lamassu',
                    name: 'Lamassu',
                    type: 'Dark',
                    rarity: 'Common',
                    image: 'assets/heroes/lamassu.png',
                    baseHp: 100,
                    baseAtk: 45,
                    baseDef: 25,
                    attacks: [
                        { name: 'Shadow Claw', damage: 30, type: 'Dark' },
                        { name: 'Wing Gust', damage: 25, type: 'Wind', effect: 'Knockback' },
                        { name: 'Curse of Ages', damage: 20, type: 'Dark', effect: 'Poison 3 turns' },
                        { name: 'Abyssal Roar', damage: 50, type: 'Dark', effect: 'Ultimate' }
                    ]
                },
                {
                    id: 'albertus',
                    name: 'Albertus',
                    type: 'Light',
                    rarity: 'Common',
                    image: 'assets/heroes/albertus.png',
                    baseHp: 130,
                    baseAtk: 30,
                    baseDef: 45,
                    attacks: [
                        { name: 'Holy Flail', damage: 28, type: 'Light' },
                        { name: 'Divine Shield', damage: 0, type: 'Buff', effect: 'Block next hit' },
                        { name: 'Blessing', damage: 0, type: 'Heal', effect: 'Heal 30 HP' },
                        { name: 'Judgement', damage: 55, type: 'Light', effect: 'Ultimate' }
                    ]
                },
                {
                    id: 'garnet',
                    name: 'Garnet',
                    type: 'Fire',
                    rarity: 'Common',
                    image: 'assets/heroes/garnet.png',
                    baseHp: 90,
                    baseAtk: 50,
                    baseDef: 20,
                    attacks: [
                        { name: 'Flame Burst', damage: 35, type: 'Fire' },
                        { name: 'Ember Burst', damage: 18, type: 'Fire', effect: 'Burns enemy for 3 turns' },
                        { name: 'Ember Touch', damage: 25, type: 'Fire', effect: 'Burn 2 turns' },
                        { name: 'Inferno Crown', damage: 60, type: 'Fire', effect: 'Ultimate' }
                    ]
                },
                {
                    id: 'florine',
                    name: 'Florine',
                    type: 'Wind',
                    rarity: 'Common',
                    image: 'assets/heroes/florine.png',
                    baseHp: 95,
                    baseAtk: 40,
                    baseDef: 30,
                    attacks: [
                        { name: 'Swift Strike', damage: 28, type: 'Physical', effect: 'Always first' },
                        { name: 'Wind Cloak', damage: 0, type: 'Buff', effect: 'Evasion +40%' },
                        { name: 'Poison Dagger', damage: 22, type: 'Physical', effect: 'Poison 3 turns' },
                        { name: 'Gale Assault', damage: 48, type: 'Wind', effect: 'Ultimate, hits twice' }
                    ]
                }
            ];

            // ========== WILD HEROES DATABASE (Unlocked after first starter) ==========
            // These appear as wild enemies AND are summonable via Time Recruit
            // Slightly stronger than starters - Uncommon rarity
            const wildHeroes = [
                {
                    id: 'talon',
                    name: 'Talon',
                    type: 'Wind',
                    rarity: 'Uncommon',
                    image: 'assets/heroes/talon.png',
                    baseHp: 140,
                    baseAtk: 42,
                    baseDef: 35,
                    attacks: [
                        { name: 'Talon Strike', damage: 32, type: 'Physical' },
                        { name: 'Wing Buffet', damage: 28, type: 'Wind', effect: 'Knockback' },
                        { name: 'Eagle Eye', damage: 0, type: 'Buff', effect: 'Accuracy +50%' },
                        { name: 'Sky Dive', damage: 55, type: 'Wind', effect: 'Ultimate' }
                    ]
                },
                {
                    id: 'harald',
                    name: 'Harald',
                    type: 'Fire',
                    rarity: 'Uncommon',
                    image: 'assets/heroes/harald.png',
                    baseHp: 155,
                    baseAtk: 48,
                    baseDef: 30,
                    attacks: [
                        { name: 'Axe Cleave', damage: 35, type: 'Physical' },
                        { name: 'Lava Blade', damage: 30, type: 'Fire', effect: 'Burn 2 turns' },
                        { name: 'Stone Skin', damage: 0, type: 'Buff', effect: 'Defense +40%' },
                        { name: 'Magma Fury', damage: 60, type: 'Fire', effect: 'Ultimate' }
                    ]
                },
                {
                    id: 'hendrik',
                    name: 'Hendrik',
                    type: 'Light',
                    rarity: 'Uncommon',
                    image: 'assets/heroes/hendrik.png',
                    baseHp: 160,
                    baseAtk: 40,
                    baseDef: 45,
                    attacks: [
                        { name: 'Golden Blade', damage: 30, type: 'Light' },
                        { name: 'Shield Wall', damage: 0, type: 'Buff', effect: 'Block 2 hits' },
                        { name: 'Radiant Smite', damage: 35, type: 'Light', effect: 'Blind' },
                        { name: 'Divine Wrath', damage: 58, type: 'Light', effect: 'Ultimate' }
                    ]
                },
                {
                    id: 'eri',
                    name: 'Eri',
                    type: 'Nature',
                    rarity: 'Uncommon',
                    image: 'assets/heroes/eri.png',
                    baseHp: 130,
                    baseAtk: 38,
                    baseDef: 32,
                    attacks: [
                        { name: 'Thorn Whip', damage: 28, type: 'Nature' },
                        { name: 'Nature\'s Blessing', damage: 0, type: 'Heal', effect: 'Heal 35 HP' },
                        { name: 'Entangle', damage: 22, type: 'Nature', effect: 'Root 2 turns' },
                        { name: 'Forest Spirit', damage: 52, type: 'Nature', effect: 'Ultimate' }
                    ]
                },
                {
                    id: 'elros',
                    name: 'Elros',
                    type: 'Arcane',
                    rarity: 'Uncommon',
                    image: 'assets/heroes/elros.png',
                    baseHp: 115,
                    baseAtk: 52,
                    baseDef: 25,
                    attacks: [
                        { name: 'Fireball', damage: 38, type: 'Fire' },
                        { name: 'Ice Shard', damage: 32, type: 'Ice', effect: 'Slow' },
                        { name: 'Arcane Shield', damage: 0, type: 'Buff', effect: 'Magic DEF +50%' },
                        { name: 'Elemental Storm', damage: 65, type: 'Arcane', effect: 'Ultimate' }
                    ]
                },
                {
                    id: 'sakhir',
                    name: 'Sakhir',
                    type: 'Dark',
                    rarity: 'Uncommon',
                    image: 'assets/heroes/sakhir.png',
                    baseHp: 125,
                    baseAtk: 50,
                    baseDef: 28,
                    attacks: [
                        { name: 'Soul Drain', damage: 30, type: 'Dark', effect: 'Lifesteal' },
                        { name: 'Curse', damage: 25, type: 'Dark', effect: 'ATK -30%' },
                        { name: 'Dark Tome', damage: 0, type: 'Buff', effect: 'ATK +40%' },
                        { name: 'Necrotic Blast', damage: 62, type: 'Dark', effect: 'Ultimate' }
                    ]
                },
                {
                    id: 'dracula',
                    name: 'Dracula',
                    type: 'Dark',
                    rarity: 'Uncommon',
                    image: 'assets/heroes/dracula.png',
                    baseHp: 135,
                    baseAtk: 48,
                    baseDef: 32,
                    attacks: [
                        { name: 'Blood Lance', damage: 32, type: 'Dark' },
                        { name: 'Vampiric Bite', damage: 28, type: 'Dark', effect: 'Lifesteal 50%' },
                        { name: 'Bat Swarm', damage: 20, type: 'Dark', effect: 'Hits 3 times' },
                        { name: 'Crimson Night', damage: 58, type: 'Dark', effect: 'Ultimate' }
                    ]
                },
                {
                    id: 'al-morrah',
                    name: 'Al-Morrah',
                    type: 'Arcane',
                    rarity: 'Uncommon',
                    image: 'assets/heroes/al-morrah.png',
                    baseHp: 120,
                    baseAtk: 45,
                    baseDef: 35,
                    attacks: [
                        { name: 'Mystic Bolt', damage: 30, type: 'Arcane' },
                        { name: 'Wish', damage: 0, type: 'Heal', effect: 'Heal 40 HP' },
                        { name: 'Sandstorm', damage: 25, type: 'Arcane', effect: 'Blind 2 turns' },
                        { name: 'Genie\'s Wrath', damage: 56, type: 'Arcane', effect: 'Ultimate' }
                    ]
                },
                {
                    id: 'scarlet',
                    name: 'Scarlet',
                    type: 'Dark',
                    rarity: 'Uncommon',
                    image: 'assets/heroes/scarlet.png',
                    baseHp: 110,
                    baseAtk: 55,
                    baseDef: 22,
                    attacks: [
                        { name: 'Whip Lash', damage: 35, type: 'Physical' },
                        { name: 'Charm', damage: 0, type: 'Debuff', effect: 'Confuse 2 turns' },
                        { name: 'Hellfire', damage: 38, type: 'Fire', effect: 'Burn' },
                        { name: 'Demon\'s Embrace', damage: 60, type: 'Dark', effect: 'Ultimate' }
                    ]
                },
                {
                    id: 'cerno',
                    name: 'Cerno',
                    type: 'Nature',
                    rarity: 'Uncommon',
                    image: 'assets/heroes/cerno.png',
                    baseHp: 165,
                    baseAtk: 44,
                    baseDef: 38,
                    attacks: [
                        { name: 'Battle Axe', damage: 34, type: 'Physical' },
                        { name: 'Nature\'s Rage', damage: 30, type: 'Nature', effect: 'ATK +25%' },
                        { name: 'Stampede', damage: 28, type: 'Physical', effect: 'Stun' },
                        { name: 'Wild Fury', damage: 58, type: 'Nature', effect: 'Ultimate' }
                    ]
                },
                {
                    id: 'malice',
                    name: 'Malice',
                    type: 'Fire',
                    rarity: 'Uncommon',
                    image: 'assets/heroes/malice.png',
                    baseHp: 150,
                    baseAtk: 60,
                    baseDef: 35,
                    attacks: [
                        { name: 'Lava Fist', damage: 38, type: 'Fire', effect: 'Burn' },
                        { name: 'Demon Crush', damage: 42, type: 'Physical', effect: 'Stun' },
                        { name: 'Hellforge', damage: 0, type: 'Buff', effect: 'ATK +50%' },
                        { name: 'Infernal Wrath', damage: 70, type: 'Fire', effect: 'Ultimate' }
                    ]
                }
            ];

            // ========== GYM DATA ==========
            const gyms = [
                {
                    id: 1,
                    name: 'Shelak',
                    title: 'The Flame Warden',
                    image: 'assets/gym_leaders/shelak.png',
                    introVideo: 'assets/cutscenes/gym1_intro.mp4',
                    heroes: [
                        {
                            id: 'harald',
                            name: 'Harald',
                            type: 'Fire',
                            image: 'assets/heroes/harald.png',
                            level: 130,
                            baseHp: 130,
                            baseAtk: 48,
                            baseDef: 35,
                            attacks: [
                                { name: 'Lava Axe', damage: 35, type: 'Fire' },
                                { name: 'Molten Shield', damage: 0, type: 'Buff', effect: 'DEF +30%' },
                                { name: 'Magma Slam', damage: 40, type: 'Fire', effect: 'Burn' },
                                { name: 'Volcanic Eruption', damage: 55, type: 'Fire', effect: 'Ultimate' }
                            ]
                        },
                        {
                            ...wildHeroes.find(h => h.id === 'malice'),
                            level: 130
                        }
                    ],
                    badge: 'Flame Badge',
                    reward: { trCoins: 5, xp: 100 }
                }
            ];

            // ========== GYM BATTLE STATE ==========
            let gymState = {
                currentGym: null,
                playerTeam: [],           // Array of player heroes
                enemyTeam: [],            // Array of gym heroes
                playerIndex: 0,           // Current player hero index
                enemyIndex: 0,            // Current enemy hero index
                playerCurrentHp: [],      // HP for each player hero
                enemyCurrentHp: [],       // HP for each enemy hero
                playerStatus: [],         // Status effects per player hero
                enemyStatus: [],          // Status effects per enemy hero
                isPlayerTurn: true,
                selectedHeroIndices: []   // Indices of heroes selected for gym battle
            };

            // ========== GYM FUNCTIONS ==========
            function goToGym() {
                // Check if player has at least 5 heroes
                if (gameState.heroes.length < 5) {
                    showMessage('You need at least 5 heroes to challenge a gym! You have ' + gameState.heroes.length + '.');
                    return;
                }
                showScreen('gymCampaignScreen');
            }

            function selectGym(id) {
                if (id === 1) {
                    gymState.currentGym = gyms[0];
                    showGymSelectScreen();
                } else {
                    showMessage('Locked', 'Coming Soon', 'This challenge is not available yet!');
                }
            }

            function sendVictoryWebhook(gymName) {
                const webhookUrl = 'https://discord.com/api/webhooks/1448408278471016661/-tMJBZ60C32rzbPzRD2Z42E-H-YaT_rzv-5LRZOVVaShTJioT-VUBNmMwMjwptVJ2Dux';

                const heroesUsed = gymState.selectedHeroIndices.map(i => gameState.heroes[i].name).join(', ');

                const payload = {
                    username: "Pocket Conquest Announcer",
                    avatar_url: "https://i.imgur.com/4M34hi2.png",
                    embeds: [{
                        title: "üèÜ NEW GYM CHAMPION! üèÜ",
                        description: `**${gameState.trainerName}** from alliance **[${gameState.alliance}]** has defeated **${gymName}**!`,
                        color: 16766720, // Gold
                        fields: [
                            {
                                name: "Winning Team",
                                value: heroesUsed,
                                inline: false
                            }
                        ],
                        footer: {
                            text: "Pocket Conquest - Time Recruit"
                        },
                        timestamp: new Date().toISOString()
                    }]
                };

                fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }).catch(console.error);
            }

            function playGymIntro() {
                const gym = gymState.currentGym;
                const video = document.getElementById('gymIntroVideo');
                // Update source
                const source = video.querySelector('source');
                if (source) source.src = gym.introVideo;
                else video.src = gym.introVideo;

                video.load();

                showScreen('gymIntroScreen');

                video.play().catch(e => {
                    console.log('Video error:', e);
                    video.muted = true;
                    video.play().catch(() => startGymBattle());
                });

                video.onended = function () {
                    startGymBattle();
                };
            }

            function skipGymIntro() {
                const video = document.getElementById('gymIntroVideo');
                video.pause();
                startGymBattle();
            }

            function showGymSelectScreen() {
                gymState.selectedHeroIndices = [];
                updateGymSelectGrid();

                // Override button to play video first
                const startBtn = document.getElementById('startGymBattleBtn');
                if (startBtn) startBtn.onclick = playGymIntro;

                showScreen('gymSelectScreen');
            }

            function updateGymSelectGrid() {
                const grid = document.getElementById('gymSelectGrid');
                grid.innerHTML = gameState.heroes.map((hero, i) => `
                <div class="gym-select-hero ${gymState.selectedHeroIndices.includes(i) ? 'selected' : ''}" 
                     onclick="toggleGymHero(${i})">
                    <img src="${hero.image}" alt="${hero.name}">
                    <div class="hero-name">${hero.name}</div>
                    <div style="font-size:0.7rem;color:#94a3b8;">Lv.${hero.level}</div>
                </div>
            `).join('');

                // Update selected team display
                const teamRow = document.getElementById('selectedTeamRow');
                teamRow.innerHTML = gymState.selectedHeroIndices.map(i =>
                    `<img src="${gameState.heroes[i].image}" alt="${gameState.heroes[i].name}">`
                ).join('');

                document.getElementById('selectedCount').textContent = gymState.selectedHeroIndices.length;
                document.getElementById('startGymBattleBtn').disabled = gymState.selectedHeroIndices.length !== 5;
            }

            function toggleGymHero(index) {
                const pos = gymState.selectedHeroIndices.indexOf(index);
                if (pos > -1) {
                    gymState.selectedHeroIndices.splice(pos, 1);
                } else if (gymState.selectedHeroIndices.length < 5) {
                    gymState.selectedHeroIndices.push(index);
                }
                updateGymSelectGrid();
            }

            function startGymBattle() {
                if (gymState.selectedHeroIndices.length !== 5) return;

                const gym = gymState.currentGym;

                // Build player team
                gymState.playerTeam = gymState.selectedHeroIndices.map(i => {
                    const hero = { ...gameState.heroes[i] };
                    hero.maxHp = hero.hp;
                    return hero;
                });

                // Build enemy team with scaled stats
                gymState.enemyTeam = gym.heroes.map(h => {
                    const levelBonus = h.level - 1;
                    return {
                        ...h,
                        hp: h.baseHp + (levelBonus * 3),
                        maxHp: h.baseHp + (levelBonus * 3),
                        attack: h.baseAtk + (levelBonus * 2),
                        defense: h.baseDef + (levelBonus * 1)
                    };
                });

                // Initialize HP arrays
                gymState.playerCurrentHp = gymState.playerTeam.map(h => h.maxHp);
                gymState.enemyCurrentHp = gymState.enemyTeam.map(h => h.maxHp);
                gymState.playerStatus = gymState.playerTeam.map(() => []);
                gymState.enemyStatus = gymState.enemyTeam.map(() => []);
                gymState.playerIndex = 0;
                gymState.enemyIndex = 0;
                gymState.isPlayerTurn = true;

                // Update UI
                document.getElementById('gymLeaderImg').src = gym.image;
                document.getElementById('gymLeaderName').textContent = gym.name.toUpperCase();
                document.getElementById('gymLeaderTitle').textContent = gym.title;

                updateGymRosters();
                updateGymBattleUI();

                document.getElementById('gymBattleLog').innerHTML = '<p>' + gym.name + ' challenges you!</p>';

                showScreen('gymBattleScreen');
            }

            function updateGymRosters() {
                // Enemy roster
                document.getElementById('enemyRoster').innerHTML = gymState.enemyTeam.map((h, i) =>
                    `<img src="${h.image}" alt="${h.name}" class="roster-icon ${i === gymState.enemyIndex ? 'active' : ''} ${gymState.enemyCurrentHp[i] <= 0 ? 'fainted' : ''}">`
                ).join('');

                // Player roster
                document.getElementById('playerRoster').innerHTML = gymState.playerTeam.map((h, i) =>
                    `<img src="${h.image}" alt="${h.name}" class="roster-icon ${i === gymState.playerIndex ? 'active' : ''} ${gymState.playerCurrentHp[i] <= 0 ? 'fainted' : ''}">`
                ).join('');
            }

            function updateGymBattleUI() {
                const currentEnemy = gymState.enemyTeam[gymState.enemyIndex];
                const currentPlayer = gymState.playerTeam[gymState.playerIndex];

                // Enemy
                document.getElementById('gymEnemyImage').src = currentEnemy.image;
                document.getElementById('gymEnemyName').textContent = currentEnemy.name;
                document.getElementById('gymEnemyLevel').textContent = 'Lv.' + currentEnemy.level;

                const enemyHp = gymState.enemyCurrentHp[gymState.enemyIndex];
                const enemyMaxHp = currentEnemy.maxHp;
                document.getElementById('gymEnemyHpBar').style.width = Math.max(0, (enemyHp / enemyMaxHp) * 100) + '%';
                document.getElementById('gymEnemyHpText').textContent = Math.max(0, enemyHp) + '/' + enemyMaxHp;

                // Player
                document.getElementById('gymPlayerImage').src = currentPlayer.image;
                document.getElementById('gymPlayerName').textContent = currentPlayer.name;
                document.getElementById('gymPlayerLevel').textContent = 'Lv.' + currentPlayer.level;

                const playerHp = gymState.playerCurrentHp[gymState.playerIndex];
                const playerMaxHp = currentPlayer.maxHp;
                document.getElementById('gymPlayerHpBar').style.width = Math.max(0, (playerHp / playerMaxHp) * 100) + '%';
                document.getElementById('gymPlayerHpText').textContent = Math.max(0, playerHp) + '/' + playerMaxHp;

                // Attack buttons
                currentPlayer.attacks.forEach((atk, i) => {
                    document.getElementById('gymAtkBtn' + i).textContent = atk.name;
                });
            }

            function addGymBattleLog(message) {
                const log = document.getElementById('gymBattleLog');
                log.innerHTML += '<p>' + message + '</p>';
                log.scrollTop = log.scrollHeight;
            }

            function useGymAttack(index) {
                if (!gymState.isPlayerTurn) return;
                gymState.isPlayerTurn = false;

                const currentPlayer = gymState.playerTeam[gymState.playerIndex];
                const currentEnemy = gymState.enemyTeam[gymState.enemyIndex];
                const attack = currentPlayer.attacks[index];

                // Apply damage
                const damage = Math.max(1, attack.damage + currentPlayer.attack - currentEnemy.defense);
                gymState.enemyCurrentHp[gymState.enemyIndex] -= damage;
                addGymBattleLog(currentPlayer.name + ' used ' + attack.name + '! -' + damage + ' HP');

                updateGymBattleUI();
                updateGymRosters();

                // Check if enemy fainted
                if (gymState.enemyCurrentHp[gymState.enemyIndex] <= 0) {
                    addGymBattleLog(currentEnemy.name + ' fainted!');

                    // Check if all enemies defeated
                    const allEnemiesFainted = gymState.enemyCurrentHp.every(hp => hp <= 0);
                    if (allEnemiesFainted) {
                        setTimeout(() => endGymBattle(true), 1000);
                        return;
                    }

                    // Switch to next enemy
                    gymState.enemyIndex++;
                    updateGymRosters();
                    updateGymBattleUI();
                    addGymBattleLog(gymState.enemyTeam[gymState.enemyIndex].name + ' enters the battle!');
                }

                setTimeout(gymEnemyTurn, 1000);
            }

            function gymEnemyTurn() {
                const currentEnemy = gymState.enemyTeam[gymState.enemyIndex];
                const currentPlayer = gymState.playerTeam[gymState.playerIndex];

                // Pick random attack
                const attack = currentEnemy.attacks[Math.floor(Math.random() * currentEnemy.attacks.length)];

                // Apply damage
                const damage = Math.max(1, attack.damage + currentEnemy.attack - currentPlayer.defense);
                gymState.playerCurrentHp[gymState.playerIndex] -= damage;
                addGymBattleLog(currentEnemy.name + ' used ' + attack.name + '! -' + damage + ' HP');

                updateGymBattleUI();
                updateGymRosters();

                // Check if player hero fainted
                if (gymState.playerCurrentHp[gymState.playerIndex] <= 0) {
                    addGymBattleLog(currentPlayer.name + ' fainted!');

                    // Check if all player heroes defeated
                    const allPlayersFainted = gymState.playerCurrentHp.every(hp => hp <= 0);
                    if (allPlayersFainted) {
                        setTimeout(() => endGymBattle(false), 1000);
                        return;
                    }

                    // Switch to next alive hero
                    for (let i = 0; i < gymState.playerTeam.length; i++) {
                        if (gymState.playerCurrentHp[i] > 0) {
                            gymState.playerIndex = i;
                            break;
                        }
                    }
                    updateGymRosters();
                    updateGymBattleUI();
                    addGymBattleLog(gymState.playerTeam[gymState.playerIndex].name + ' enters the battle!');
                }

                gymState.isPlayerTurn = true;
            }

            function endGymBattle(victory) {
                if (victory) {
                    const gym = gymState.currentGym;
                    gameState.badges++;
                    gameState.trCoins += gym.reward.trCoins;

                    // Give XP to all heroes that participated
                    gymState.selectedHeroIndices.forEach(i => {
                        gameState.heroes[i].xp = (gameState.heroes[i].xp || 0) + gym.reward.xp;
                        // Check for level up
                        const xpNeeded = gameState.heroes[i].level * 20;
                        while (gameState.heroes[i].xp >= xpNeeded && gameState.heroes[i].level < getMaxLevel(gameState.heroes[i])) {
                            gameState.heroes[i].xp -= xpNeeded;
                            gameState.heroes[i].level++;
                            gameState.heroes[i].hp += 3;
                            gameState.heroes[i].maxHp += 3;
                            gameState.heroes[i].attack += 2;
                            gameState.heroes[i].defense += 1;
                        }
                    });

                    saveGame();
                    showMessage('üèÜ Victory! You earned the ' + gym.badge + '! +' + gym.reward.trCoins + ' TR Coins!');

                    // Webhook
                    sendVictoryWebhook(gym.name);
                } else {
                    showMessage('üò¢ Defeated! Train your heroes and try again!');
                }

                showScreen('homeScreen');
            }

            function fleeGymBattle() {
                showMessage('You forfeited the gym battle!');
                showScreen('homeScreen');
            }

            // ========== TIME RECRUIT ==========
            function summonHero() {
                const cost = 1;

                // Check if player has enough coins
                if (gameState.trCoins < cost) {
                    showMessage('‚ùå', 'Not Enough Coins!', 'You need ' + cost + ' Time Recruit coin to summon.');
                    return;
                }

                // Check if there are heroes available
                if (starterHeroes.length === 0) {
                    showMessage('üåÄ', 'Coming Soon', 'More heroes coming soon...');
                    return;
                }

                // Deduct cost
                gameState.trCoins -= cost;

                // Combine pools (allow duplicates for challenge)
                // Rule: First summon IS ALWAYS a Starter Hero
                let allHeroes;
                if (gameState.heroes.length === 0) {
                    allHeroes = starterHeroes;
                } else {
                    // Filter out Malice (Boss Only for now)
                    allHeroes = [...starterHeroes, ...wildHeroes].filter(h => h.id !== 'malice');
                }

                // Random hero from full pool
                const heroData = allHeroes[Math.floor(Math.random() * allHeroes.length)];

                // Check if player already owns this hero
                const existingHero = gameState.heroes.find(h => h.id === heroData.id);

                if (existingHero) {
                    // DUPLICATE: Convert to XP
                    const xpAmount = 80;
                    existingHero.xp = (existingHero.xp || 0) + xpAmount;

                    // Check for level up immediately
                    const xpNeeded = existingHero.level * 20;
                    if (existingHero.xp >= xpNeeded && existingHero.level < getMaxLevel(existingHero)) {
                        existingHero.xp -= xpNeeded;
                        existingHero.level++;
                        existingHero.hp += 3;
                        existingHero.maxHp += 3;
                        existingHero.attack += 2;
                        existingHero.defense += 1;
                    }

                    saveGame();
                    showMessage('Duplicate Summon!', 'Power Up!', `You already own ${heroData.name}. Converted to ${xpAmount} XP!`);

                    // Simple feedback for now, skips the summon reveal animation
                    return;
                }

                // NEW HERO: Create instance
                const newHero = {
                    id: heroData.id,
                    name: heroData.name,
                    type: heroData.type,
                    rarity: heroData.rarity,
                    image: heroData.image,
                    level: 1,
                    xp: 0,
                    hp: heroData.baseHp,
                    maxHp: heroData.baseHp,
                    attack: heroData.baseAtk,
                    defense: heroData.baseDef,
                    attacks: heroData.attacks
                };

                // Add to player's heroes
                gameState.heroes.push(newHero);

                // Save game
                saveGame();

                // Show result with animation
                showSummonResult(newHero);
            }

            function showSummonResult(hero) {
                // Populate modal
                document.getElementById('summonHeroImg').src = hero.image;
                document.getElementById('summonHeroName').textContent = hero.name;
                document.getElementById('summonRarity').textContent = hero.rarity.toUpperCase();
                document.getElementById('summonHeroType').textContent = hero.type + ' Type';
                document.getElementById('summonHP').textContent = hero.hp;
                document.getElementById('summonATK').textContent = hero.attack;
                document.getElementById('summonDEF').textContent = hero.defense;

                // Reset animation by forcing reflow
                const heroImg = document.getElementById('summonHeroImg');
                const modal = document.getElementById('summonModal');
                heroImg.style.animation = 'none';
                heroImg.offsetHeight; // Trigger reflow
                heroImg.style.animation = null;

                // Show modal
                modal.style.display = 'flex';

                // Update home screen in background
                updateHomeScreen();
            }

            function closeSummonModal() {
                document.getElementById('summonModal').style.display = 'none';
            }

            // ========== MESSAGE MODAL ==========
            // ========== MESSAGE MODAL ==========
            function showMessage(arg1, arg2, arg3) {
                let icon = '‚ÑπÔ∏è';
                let title = 'Message';
                let text = '';

                if (arg3) {
                    // 3 Args: Icon, Title, Text OR Title, Subtitle, Text?
                    // Based on usage: ('‚ùå', 'Not Enough Coins!', 'text') -> Icon, Title, Text
                    // AND: ('Duplicate!', 'Power Up', 'text') -> Title, Subtitle, Text
                    // Let's heuristically detect.
                    if (arg1.length <= 2 || arg1.includes('‚ùå') || arg1.includes('üèÜ') || arg1.includes('üåÄ')) {
                        icon = arg1;
                        title = arg2;
                        text = arg3;
                    } else {
                        // Assume Title, Subtitle, Text -> We'll map Subtitle to part of text or Title
                        icon = 'üì¢'; // Default icon
                        title = arg1;
                        text = `**${arg2}**\n\n${arg3}`;
                    }
                } else if (arg2) {
                    // 2 Args: Title, Text
                    title = arg1;
                    text = arg2;
                } else {
                    // 1 Arg: Text only
                    text = arg1;
                }

                document.getElementById('messageIcon').textContent = icon;
                document.getElementById('messageTitle').textContent = title;
                document.getElementById('messageText').innerHTML = text.replace(/\n/g, '<br>'); // Allow newlines
                document.getElementById('messageModal').style.display = 'flex';
            }

            function closeMessageModal() {
                document.getElementById('messageModal').style.display = 'none';
            }

            // ========== BATTLE SYSTEM ==========
            let battleState = {
                playerHero: null,
                playerHeroIndex: null,
                enemy: null,
                playerCurrentHp: 0,
                enemyCurrentHp: 0,
                isPlayerTurn: true,
                battleCount: 0,
                // Status effects: { name: 'Confuse', turns: 2 }
                playerStatus: [],
                enemyStatus: []
            };

            function openBattleSelect() {
                const grid = document.getElementById('battleHeroGrid');
                const noHeroes = document.getElementById('noHeroesForBattle');

                if (gameState.heroes.length === 0) {
                    grid.style.display = 'none';
                    noHeroes.style.display = 'block';
                } else {
                    noHeroes.style.display = 'none';
                    grid.style.display = 'grid';
                    grid.innerHTML = gameState.heroes.map((hero, i) => `
                    <div class="battle-hero-option" onclick="selectHeroForBattle(${i})">
                        <img src="${hero.image}" alt="${hero.name}">
                        <div class="hero-name">${hero.name}</div>
                        <div class="hero-lvl">Lv.${hero.level}</div>
                    </div>
                `).join('');
                }
                document.getElementById('battleSelectModal').style.display = 'flex';
            }

            function closeBattleSelect() {
                document.getElementById('battleSelectModal').style.display = 'none';
            }

            function selectHeroForBattle(index) {
                battleState.playerHero = gameState.heroes[index];
                battleState.playerHeroIndex = index;
                closeBattleSelect();
                startBattle();
            }

            function getEnemyLevelRange() {
                // Get player's max hero level
                let maxLevel = 1;
                gameState.heroes.forEach(h => { if (h.level > maxLevel) maxLevel = h.level; });

                // Level scaling based on player progress
                if (maxLevel <= 15) return { min: 1, max: 15 };
                if (maxLevel <= 30) return { min: 10, max: 30 };
                if (maxLevel <= 50) return { min: 25, max: 50 };
                return { min: 40, max: 70 };
            }

            function startBattle() {
                // Pick random wild enemy
                const enemyData = wildHeroes[Math.floor(Math.random() * wildHeroes.length)];
                const levelRange = getEnemyLevelRange();
                const enemyLevel = Math.floor(Math.random() * (levelRange.max - levelRange.min + 1)) + levelRange.min;

                // Scale enemy stats by level
                const levelBonus = enemyLevel - 1;
                battleState.enemy = {
                    ...enemyData,
                    level: enemyLevel,
                    hp: enemyData.baseHp + (levelBonus * 3),
                    maxHp: enemyData.baseHp + (levelBonus * 3),
                    attack: enemyData.baseAtk + (levelBonus * 2),
                    defense: enemyData.baseDef + (levelBonus * 1)
                };

                // Set player HP and reset status effects
                battleState.playerCurrentHp = battleState.playerHero.hp;
                battleState.enemyCurrentHp = battleState.enemy.maxHp;
                battleState.isPlayerTurn = true;
                battleState.playerStatus = [];
                battleState.enemyStatus = [];

                // Update UI
                document.getElementById('enemyName').textContent = battleState.enemy.name;
                document.getElementById('enemyLevel').textContent = 'Lv.' + battleState.enemy.level;
                document.getElementById('enemyImage').src = battleState.enemy.image;
                document.getElementById('playerHeroName').textContent = battleState.playerHero.name;
                document.getElementById('playerHeroLevel').textContent = 'Lv.' + battleState.playerHero.level;
                document.getElementById('playerHeroImage').src = battleState.playerHero.image;

                updateHpBars();

                // Set attack buttons
                battleState.playerHero.attacks.forEach((atk, i) => {
                    document.getElementById('atkBtn' + i).textContent = atk.name;
                });

                // Clear battle log
                document.getElementById('battleLog').innerHTML = '<p>A wild ' + battleState.enemy.name + ' appeared!</p>';

                showScreen('searchScreen');
            }

            function updateHpBars() {
                const enemyPct = Math.max(0, (battleState.enemyCurrentHp / battleState.enemy.maxHp) * 100);
                const playerPct = Math.max(0, (battleState.playerCurrentHp / battleState.playerHero.maxHp) * 100);

                document.getElementById('enemyHpBar').style.width = enemyPct + '%';
                document.getElementById('playerHpBar').style.width = playerPct + '%';
                document.getElementById('enemyHpText').textContent = Math.max(0, battleState.enemyCurrentHp) + '/' + battleState.enemy.maxHp;
                document.getElementById('playerHpText').textContent = Math.max(0, battleState.playerCurrentHp) + '/' + battleState.playerHero.maxHp;

                updateStatusIcons();
            }

            function updateStatusIcons() {
                const statusEmojis = {
                    'Confuse': 'üòµ',
                    'Stun': '‚ö°',
                    'Poison': '‚ò†Ô∏è',
                    'Burn': 'üî•',
                    'Blind': 'üëÅÔ∏è',
                    'Root': 'üåø',
                    'Slow': 'üêå'
                };

                // Update enemy status icons
                const enemyIconsDiv = document.getElementById('enemyStatusIcons');
                enemyIconsDiv.innerHTML = battleState.enemyStatus.map(s =>
                    '<span class="status-icon" title="' + s.name + ' (' + s.turns + ' turns)">' +
                    (statusEmojis[s.name] || '‚ùì') + s.turns + '</span>'
                ).join('');

                // Update player status icons
                const playerIconsDiv = document.getElementById('playerStatusIcons');
                playerIconsDiv.innerHTML = battleState.playerStatus.map(s =>
                    '<span class="status-icon" title="' + s.name + ' (' + s.turns + ' turns)">' +
                    (statusEmojis[s.name] || '‚ùì') + s.turns + '</span>'
                ).join('');
            }

            function addBattleLog(message) {
                const log = document.getElementById('battleLog');
                log.innerHTML += '<p>' + message + '</p>';
                log.scrollTop = log.scrollHeight;
            }

            // ========== STATUS EFFECT SYSTEM ==========
            function hasStatus(statusArray, statusName) {
                return statusArray.some(s => s.name === statusName && s.turns > 0);
            }

            function addStatus(statusArray, statusName, turns) {
                // Check if already has this status
                const existing = statusArray.find(s => s.name === statusName);
                if (existing) {
                    existing.turns = Math.max(existing.turns, turns); // Refresh duration
                } else {
                    statusArray.push({ name: statusName, turns: turns });
                }
            }

            function tickStatus(statusArray, isPlayer) {
                // Apply damage-over-time effects and reduce turns
                for (let i = statusArray.length - 1; i >= 0; i--) {
                    const status = statusArray[i];

                    // Poison/Burn damage
                    if (status.name === 'Poison' || status.name === 'Burn') {
                        const dot = Math.ceil((isPlayer ? battleState.playerHero.maxHp : battleState.enemy.maxHp) * 0.05);
                        if (isPlayer) {
                            battleState.playerCurrentHp = Math.max(1, battleState.playerCurrentHp - dot);
                            addBattleLog('üíÄ Poison dealt ' + dot + ' damage!');
                        } else {
                            battleState.enemyCurrentHp = Math.max(1, battleState.enemyCurrentHp - dot);
                            addBattleLog('üíÄ ' + battleState.enemy.name + ' took ' + dot + ' poison damage!');
                        }
                        updateHpBars();
                    }

                    // Reduce turns
                    status.turns--;
                    if (status.turns <= 0) {
                        const targetName = isPlayer ? battleState.playerHero.name : battleState.enemy.name;
                        addBattleLog('‚ú® ' + targetName + ' recovered from ' + status.name + '!');
                        statusArray.splice(i, 1);
                    }
                }
            }

            function applyAttackEffect(attack, isPlayerAttacking) {
                // Parse effect text for status effects
                const effect = attack.effect || '';
                const targetStatus = isPlayerAttacking ? battleState.enemyStatus : battleState.playerStatus;
                const targetName = isPlayerAttacking ? battleState.enemy.name : battleState.playerHero.name;

                // Check for various status effects
                if (effect.includes('Confuse')) {
                    addStatus(targetStatus, 'Confuse', 2);
                    addBattleLog('üòµ ' + targetName + ' is confused!');
                }
                if (effect.includes('Stun')) {
                    addStatus(targetStatus, 'Stun', 1);
                    addBattleLog('‚ö° ' + targetName + ' is stunned!');
                }
                if (effect.includes('Poison')) {
                    addStatus(targetStatus, 'Poison', 3);
                    addBattleLog('‚ò†Ô∏è ' + targetName + ' is poisoned!');
                }
                if (effect.includes('Burn')) {
                    addStatus(targetStatus, 'Burn', 3);
                    addBattleLog('üî• ' + targetName + ' is burning!');
                }
                if (effect.includes('Blind')) {
                    addStatus(targetStatus, 'Blind', 2);
                    addBattleLog('üëÅÔ∏è ' + targetName + ' is blinded!');
                }
                if (effect.includes('Root')) {
                    addStatus(targetStatus, 'Root', 2);
                    addBattleLog('üåø ' + targetName + ' is rooted!');
                }
                if (effect.includes('Slow')) {
                    addStatus(targetStatus, 'Slow', 2);
                    addBattleLog('üêå ' + targetName + ' is slowed!');
                }
            }

            function useAttack(index) {
                if (!battleState.isPlayerTurn) return;
                battleState.isPlayerTurn = false;

                // Check for status effects that prevent action
                if (hasStatus(battleState.playerStatus, 'Stun')) {
                    addBattleLog('‚ö° ' + battleState.playerHero.name + ' is stunned and cannot move!');
                    tickStatus(battleState.playerStatus, true);
                    setTimeout(enemyTurn, 1000);
                    return;
                }

                const attack = battleState.playerHero.attacks[index];
                const attackType = attack.type;

                // Handle different attack types
                if (attackType === 'Heal') {
                    const healAmount = parseInt(attack.effect.match(/\d+/)[0]) || 30;
                    const oldHp = battleState.playerCurrentHp;
                    battleState.playerCurrentHp = Math.min(battleState.playerHero.maxHp, battleState.playerCurrentHp + healAmount);
                    const actualHeal = battleState.playerCurrentHp - oldHp;
                    addBattleLog(battleState.playerHero.name + ' used ' + attack.name + '! +' + actualHeal + ' HP restored!');
                } else if (attackType === 'Buff') {
                    const boost = Math.ceil(battleState.playerHero.attack * 0.05);
                    battleState.playerHero.attack += boost;
                    addBattleLog(battleState.playerHero.name + ' used ' + attack.name + '! ATK +' + boost + '!');
                } else if (attackType === 'Debuff') {
                    const reduction = Math.ceil(battleState.enemy.attack * 0.05);
                    battleState.enemy.attack = Math.max(1, battleState.enemy.attack - reduction);
                    addBattleLog(battleState.playerHero.name + ' used ' + attack.name + '! Enemy ATK -' + reduction + '!');
                    applyAttackEffect(attack, true); // Apply status from debuff
                } else {
                    // Normal damage attack
                    // Check for Blind - 50% miss chance
                    if (hasStatus(battleState.playerStatus, 'Blind') && Math.random() < 0.5) {
                        addBattleLog('üëÅÔ∏è ' + battleState.playerHero.name + ' missed due to blindness!');
                    }
                    // Check for Confuse - 50% chance to hit self
                    else if (hasStatus(battleState.playerStatus, 'Confuse') && Math.random() < 0.5) {
                        const damage = Math.max(1, Math.floor(attack.damage / 2));
                        battleState.playerCurrentHp -= damage;
                        addBattleLog('üòµ ' + battleState.playerHero.name + ' hurt itself in confusion! -' + damage + ' HP');
                    } else {
                        const damage = Math.max(1, attack.damage + battleState.playerHero.attack - battleState.enemy.defense);
                        battleState.enemyCurrentHp -= damage;
                        addBattleLog(battleState.playerHero.name + ' used ' + attack.name + '! -' + damage + ' HP');
                        applyAttackEffect(attack, true); // Apply status effects from attack
                    }
                }

                // Tick player status effects (poison damage, reduce durations)
                tickStatus(battleState.playerStatus, true);
                updateHpBars();

                // Check if enemy defeated
                if (battleState.enemyCurrentHp <= 0) {
                    setTimeout(() => endBattle(true), 500);
                    return;
                }

                // Check if player died from confusion
                if (battleState.playerCurrentHp <= 0) {
                    setTimeout(() => endBattle(false), 500);
                    return;
                }

                // Enemy turn
                setTimeout(enemyTurn, 1000);
            }

            function enemyTurn() {
                // Check for status effects that prevent action
                if (hasStatus(battleState.enemyStatus, 'Stun')) {
                    addBattleLog('‚ö° ' + battleState.enemy.name + ' is stunned and cannot move!');
                    tickStatus(battleState.enemyStatus, false);
                    battleState.isPlayerTurn = true;
                    return;
                }

                // Enemy picks an attack (prefer damage attacks for AI)
                let attack = battleState.enemy.attacks[Math.floor(Math.random() * battleState.enemy.attacks.length)];

                // If enemy picks a heal/buff with no benefit, pick a different attack
                if ((attack.type === 'Heal' && battleState.enemyCurrentHp >= battleState.enemy.maxHp) ||
                    (attack.type === 'Buff' && Math.random() > 0.3)) {
                    const damageAttacks = battleState.enemy.attacks.filter(a => a.damage > 0);
                    if (damageAttacks.length > 0) {
                        attack = damageAttacks[Math.floor(Math.random() * damageAttacks.length)];
                    }
                }

                const attackType = attack.type;

                if (attackType === 'Heal') {
                    const healAmount = parseInt(attack.effect?.match(/\d+/)?.[0]) || 30;
                    const oldHp = battleState.enemyCurrentHp;
                    battleState.enemyCurrentHp = Math.min(battleState.enemy.maxHp, battleState.enemyCurrentHp + healAmount);
                    const actualHeal = battleState.enemyCurrentHp - oldHp;
                    addBattleLog(battleState.enemy.name + ' used ' + attack.name + '! +' + actualHeal + ' HP restored!');
                } else if (attackType === 'Buff') {
                    battleState.enemy.attack += 5;
                    addBattleLog(battleState.enemy.name + ' used ' + attack.name + '! ' + (attack.effect || 'Stats boosted!'));
                } else if (attackType === 'Debuff') {
                    battleState.playerHero.attack = Math.max(1, battleState.playerHero.attack - 5);
                    addBattleLog(battleState.enemy.name + ' used ' + attack.name + '! ' + (attack.effect || 'Your hero weakened!'));
                    applyAttackEffect(attack, false); // Apply status from debuff
                } else {
                    // Normal damage attack
                    // Check for Blind - 50% miss chance
                    if (hasStatus(battleState.enemyStatus, 'Blind') && Math.random() < 0.5) {
                        addBattleLog('üëÅÔ∏è ' + battleState.enemy.name + ' missed due to blindness!');
                    }
                    // Check for Confuse - 50% chance to hit self
                    else if (hasStatus(battleState.enemyStatus, 'Confuse') && Math.random() < 0.5) {
                        const damage = Math.max(1, Math.floor(attack.damage / 2));
                        battleState.enemyCurrentHp -= damage;
                        addBattleLog('üòµ ' + battleState.enemy.name + ' hurt itself in confusion! -' + damage + ' HP');
                    } else {
                        const damage = Math.max(1, attack.damage + battleState.enemy.attack - battleState.playerHero.defense);
                        battleState.playerCurrentHp -= damage;
                        addBattleLog(battleState.enemy.name + ' used ' + attack.name + '! -' + damage + ' HP');
                        applyAttackEffect(attack, false); // Apply status effects from attack
                    }
                }

                // Tick enemy status effects (poison damage, reduce durations)
                tickStatus(battleState.enemyStatus, false);
                updateHpBars();

                // Check if enemy died from confusion
                if (battleState.enemyCurrentHp <= 0) {
                    setTimeout(() => endBattle(true), 500);
                    return;
                }

                // Check if player defeated
                if (battleState.playerCurrentHp <= 0) {
                    setTimeout(() => endBattle(false), 500);
                    return;
                }

                battleState.isPlayerTurn = true;
            }

            function getMaxLevel(hero) {
                if (hero.id === 'malice') return 210;
                const isStarter = starterHeroes.some(h => h.id === hero.id);
                return isStarter ? 70 : 130;
            }

            function endBattle(victory) {
                battleState.battleCount++;

                // Calculate XP based on enemy level (higher level = more XP)
                // WIN: much more rewarding, LOSS: minimal consolation
                const playerLevel = battleState.playerHero.level;
                const enemyLevel = battleState.enemy.level;

                let xpGained;
                if (victory) {
                    // Win: base 20 + 2 XP per enemy level + bonus for higher level enemies
                    const levelBonus = Math.max(0, enemyLevel - playerLevel) * 5;
                    xpGained = 20 + (enemyLevel * 2) + levelBonus;
                } else {
                    // Loss: still decent consolation - base 8 + 1 XP per enemy level
                    // Players shouldn't feel TOO punished for losing
                    xpGained = 8 + enemyLevel;
                }

                // Cap at reasonable amounts
                xpGained = Math.min(xpGained, 100);

                // Award XP to player hero
                gameState.heroes[battleState.playerHeroIndex].xp += xpGained;

                // Check for level up
                const hero = gameState.heroes[battleState.playerHeroIndex];
                const xpNeeded = hero.level * 20;
                if (hero.xp >= xpNeeded && hero.level < getMaxLevel(hero)) {
                    hero.level++;
                    hero.xp -= xpNeeded;
                    hero.maxHp += 3;
                    hero.hp = hero.maxHp;
                    hero.attack += 2;
                    hero.defense += 1;
                    addBattleLog('üéâ ' + hero.name + ' leveled up to Lv.' + hero.level + '!');
                }

                // TR Coin drop (33% random chance on WIN)
                let gotCoin = false;
                if (victory && Math.random() < 0.33) {
                    gameState.trCoins++;
                    gotCoin = true;
                }

                saveGame();

                // Show result modal
                document.getElementById('resultIcon').textContent = victory ? 'üèÜ' : 'üíî';
                document.getElementById('resultTitle').textContent = victory ? 'VICTORY!' : 'DEFEAT';
                document.getElementById('resultTitle').className = 'result-title ' + (victory ? 'victory' : 'defeat');
                document.getElementById('resultXP').textContent = '+' + xpGained + ' XP';
                document.getElementById('coinRewardRow').style.display = gotCoin ? 'flex' : 'none';

                document.getElementById('battleResultModal').style.display = 'flex';
            }

            function closeBattleResult() {
                document.getElementById('battleResultModal').style.display = 'none';
                showScreen('homeScreen');
            }

            function fleeBattle() {
                showScreen('homeScreen');
            }



            // ========== UTILS ==========


            // ========== SAVE / LOAD ==========
            function saveGame() {
                localStorage.setItem('pocketConquest', JSON.stringify(gameState));
            }

            function loadGame() {
                const saved = localStorage.getItem('pocketConquest');
                if (saved) {
                    gameState = JSON.parse(saved);
                    showScreen('homeScreen');
                } else {
                    alert('No saved game found. Start a new game!');
                }
            }

            function startNewGame() {
                // Clear any existing save
                localStorage.removeItem('pocketConquest');
                // Reset game state
                gameState = {
                    trainer: null,
                    trainerName: '',
                    level: 1,
                    trCoins: 0,
                    gems: 100,
                    badges: 0,
                    heroes: []
                };
                showScreen('characterSelect');
            }

            // Check for existing save on load
            window.onload = function () {
                const saved = localStorage.getItem('pocketConquest');
                if (saved) {
                    document.getElementById('continueBtn').classList.remove('hidden');
                }
            };
        </script>
</body>

</html>