<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="doc_title">The Hogwarts Registry - A Magical Sorting Ceremony</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Cinzel+Decorative:wght@700;900&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Dancing+Script:wght@600;700&family=Lora:ital,wght@0,400;0,700;1,400&family=Uncial+Antiqua&display=swap" rel="stylesheet">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-VYP41CV8E4"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-VYP41CV8E4');
    </script>

    <style>
        :root {
            --hp-gold: #d4af37;
            --hp-parchment: #f4e4bc;
            --hp-ink: #1a1a1a;
            --hp-burgundy: #4a0404;
            --hp-border: #8d6e3f;
            --hp-shadow: rgba(0, 0, 0, 0.4);
        }

        body {
            background: #0d0d0d;
            color: var(--hp-ink);
            font-family: 'Lora', serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-image: 
                linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)),
                url('https://www.transparenttextures.com/patterns/dark-leather.png');
            background-attachment: fixed;
        }

        .hp-font { font-family: 'Cinzel', serif; }
        .wizard-script { font-family: 'Dancing Script', cursive; }

        .hp-title {
            font-family: 'Cinzel Decorative', cursive;
            color: var(--hp-gold);
            text-shadow: 
                0 0 10px rgba(212, 175, 55, 0.4),
                2px 2px 4px rgba(0, 0, 0, 0.8);
            letter-spacing: 0.1em;
            font-weight: 700;
        }

        .hp-ancient { font-family: 'Uncial Antiqua', serif; }

        /* The Registry / Parchment Panel */
        .game-panel {
            background-color: var(--hp-parchment);
            background-image: url('https://www.transparenttextures.com/patterns/parchment.png');
            border: 8px double var(--hp-border);
            box-shadow: 
                0 0 50px rgba(0, 0, 0, 0.8),
                inset 0 0 100px rgba(139, 69, 19, 0.1);
            border-radius: 4px;
            position: relative;
            transform: rotate(-0.5deg);
            z-index: 10;
        }

        .game-panel::after {
            content: '';
            position: absolute;
            bottom: 20px; right: 20px;
            width: 150px; height: 150px;
            background: url('https://www.transparenttextures.com/patterns/ink-quill.png');
            opacity: 0.1;
            pointer-events: none;
            filter: sepia(1) saturate(5) hue-rotate(-50deg);
        }

        .game-panel::before {
            content: '';
            position: absolute;
            top: -15px; left: -15px; right: -15px; bottom: -15px;
            border: 1px solid var(--hp-gold);
            opacity: 0.3;
            pointer-events: none;
        }

        /* Magical Inputs */
        input[type="text"], select {
            background: transparent;
            border: none;
            border-bottom: 2px solid var(--hp-border);
            color: var(--hp-ink);
            padding: 10px 5px;
            font-family: 'Dancing Script', cursive;
            font-size: 1.4rem;
            width: 100%;
            transition: all 0.3s;
        }

        input:focus {
            outline: none;
            border-bottom-color: var(--hp-gold);
            background: rgba(212, 175, 55, 0.05);
        }

        /* --- CUSTOM MAGICAL DROPDOWN --- */
        .custom-select-container { position: relative; width: 100%; cursor: pointer; }
        .custom-select-trigger {
            background: transparent;
            border-bottom: 2px solid var(--hp-border);
            color: var(--hp-ink);
            padding: 10px 5px;
            font-family: 'Dancing Script', cursive;
            font-size: 1.4rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .custom-options {
            position: absolute;
            top: 100%; left: 0; right: 0;
            background: var(--hp-parchment);
            background-image: url('https://www.transparenttextures.com/patterns/parchment.png');
            border: 4px double var(--hp-border);
            z-index: 100;
            display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-height: 250px;
            overflow-y: auto;
        }
        .custom-option {
            padding: 10px 15px;
            font-family: 'Lora', serif;
            font-size: 1.1rem;
            color: var(--hp-ink);
            transition: all 0.2s;
            border-bottom: 1px solid rgba(141, 110, 63, 0.1);
        }
        .custom-option:hover {
            background: rgba(141, 110, 63, 0.15);
            color: var(--hp-burgundy);
            padding-left: 20px;
        }
        .custom-option.selected {
            background: rgba(74, 4, 4, 0.05);
            font-weight: bold;
            color: var(--hp-burgundy);
        }
        .custom-select-container.open .custom-options { display: block; }
        .custom-select-container.open .fa-chevron-down { transform: rotate(180deg); }

        /* Header Fixes */
        #lang-selector {
            appearance: none;
            background: transparent;
            border: 1px solid var(--hp-gold);
            color: var(--hp-gold);
            padding: 2px 10px;
            border-radius: 4px;
            font-family: 'Cinzel', serif;
            text-shadow: 0 0 5px rgba(212, 175, 55, 0.5);
        }

        /* Wax Seal Style Button */
        .magical-button {
            background: var(--hp-burgundy);
            background-image: radial-gradient(circle at center, #800000 0%, #4a0404 100%);
            border: 2px solid var(--hp-gold);
            color: var(--hp-gold);
            font-family: 'Cinzel', serif;
            font-weight: 700;
            padding: 15px 30px;
            border-radius: 50px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            cursor: pointer;
        }

        .magical-button:hover:not(:disabled) {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.3);
            filter: brightness(1.2);
        }

        .magical-button:active { transform: scale(0.98); }
        .magical-button:disabled { opacity: 0.6; filter: grayscale(0.5); cursor: not-allowed; }

        .magical-button-compact {
            padding: 10px 15px !important;
            font-size: 0.75rem !important;
        }

        #result-name {
            font-size: 3rem;
            color: var(--hp-burgundy);
            font-family: 'Dancing Script', cursive;
            text-decoration: underline;
        }

        /* Status & Log Styles */
        .status-parchment {
            border: 2px dashed var(--hp-border);
            background: rgba(139, 69, 19, 0.05);
            padding: 1rem;
            border-radius: 4px;
            font-family: 'Lora', serif;
            font-style: italic;
            margin-bottom: 2rem;
            transition: all 0.5s ease;
            position: relative;
        }
        .status-error { color: #8b0000; border-color: rgba(139, 0, 0, 0.3); }
        .status-success { color: #1b5e20; border-color: rgba(27, 94, 32, 0.3); }
        .status-info { color: #5d4037; }
        .status-warning { color: #f57f17; }

        /* Ink Splotch Utility */
        .ink-splotch {
            position: relative;
        }
        .ink-splotch::before {
            content: '';
            position: absolute;
            width: 40px; height: 40px;
            background: rgba(26, 26, 26, 0.15);
            filter: blur(8px);
            border-radius: 50%;
            z-index: -1;
            transform: scale(1.5, 0.8) rotate(15deg);
        }

        /* Floating Animation */
        .floating { animation: float-anim 4s ease-in-out infinite; }
        @keyframes float-anim {
            0%, 100% { transform: translateY(0) rotate(-0.5deg); }
            50% { transform: translateY(-15px) rotate(0.5deg); }
        }
        @keyframes sway {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(10px, -10px) rotate(2deg); }
        }

        /* MAGICAL MANIFESTATIONS */
        .manifestation {
            position: fixed;
            pointer-events: none;
            z-index: 5;
            opacity: 0;
            filter: blur(1px);
            transition: opacity 2s ease;
        }

        .manifestation svg { fill: rgba(0, 0, 0, 0.08); }

        @keyframes dragon-pass {
            0% { transform: translate(-20vw, 120vh) rotate(45deg) scale(2); opacity: 0; }
            10% { opacity: 0.15; }
            90% { opacity: 0.15; }
            100% { transform: translate(120vw, -20vh) rotate(45deg) scale(3); opacity: 0; }
        }

        @keyframes snitch-flutter {
            0% { transform: translate(-10vw, 50vh) scale(0.5); opacity: 0; }
            20% { opacity: 1; transform: translate(20vw, 30vh) scale(0.8); }
            40% { transform: translate(40vw, 60vh) scale(0.6); }
            60% { transform: translate(70vw, 20vh) scale(0.9); }
            80% { opacity: 1; transform: translate(90vw, 40vh) scale(0.7); }
            100% { transform: translate(110vw, 50vh) scale(0.5); opacity: 0; }
        }

        @keyframes owl-glide {
            0% { transform: translate(110vw, 20vh) scale(1); opacity: 0; }
            10% { opacity: 0.1; }
            90% { opacity: 0.1; }
            100% { transform: translate(-20vw, 40vh) scale(1.2); opacity: 0; }
        }

        .reveal-sparkle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            background: var(--hp-gold);
            border-radius: 50%;
            box-shadow: 0 0 20px var(--hp-gold);
            pointer-events: none;
            z-index: 100;
        }

        @keyframes sparkle-burst {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }

        /* LIVING BESTIARY UI */
        .journal-spread {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            align-items: center;
            width: 100%;
        }

        @media (min-width: 768px) {
            .journal-spread {
                flex-direction: row;
                align-items: flex-start;
                text-align: left;
            }
        }

        .bestiary-illustration {
            width: 280px;
            height: 280px;
            border: 8px double var(--hp-border);
            background: rgba(139, 69, 19, 0.05);
            padding: 10px;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.1), 5px 10px 30px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            border-radius: 4px;
        }

        .bestiary-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: sepia(0.3) contrast(1.1) brightness(0.9);
            mix-blend-mode: multiply;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        /* Animations */
        .animate-ink-reveal {
            animation: ink-reveal 1.5s ease-out forwards;
        }

        .animate-breathing {
            animation: 
                breathing-loop 8s ease-in-out infinite,
                sway-loop 12s ease-in-out infinite,
                glow-pulse 5s ease-in-out infinite;
        }

        @keyframes ink-reveal {
            0% { opacity: 0; filter: blur(10px) grayscale(1); transform: scale(1.05); }
            100% { opacity: 1; filter: blur(0) grayscale(0); transform: scale(1); }
        }

        @keyframes breathing-loop {
            0%, 100% { transform: scale(1) translateY(0); }
            50% { transform: scale(1.05) translateY(-5px); }
        }

        @keyframes sway-loop {
            0%, 100% { transform: rotate(-1deg); }
            50% { transform: rotate(1deg); }
        }

        @keyframes glow-pulse {
            0%, 100% { filter: sepia(0.3) contrast(1.1) brightness(0.85); }
            50% { filter: sepia(0.4) contrast(1.2) brightness(1.05); }
        }

        .bestiary-details { flex-grow: 1; width: 100%; }

        /* CINEMATIC VFX SYSTEM */
        
        /* Golden Magic Particles */
        .magic-particle {
            position: fixed;
            background: radial-gradient(circle, #ffd700 0%, #ffed4e 50%, transparent 100%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 5;
            animation: particle-float linear infinite;
            box-shadow: 0 0 12px #ffd700, 0 0 20px rgba(255, 215, 0, 0.8);
        }

        .particle-sm { width: 4px; height: 4px; opacity: 0.4; filter: blur(1px); }
        .particle-md { width: 8px; height: 8px; opacity: 0.7; }
        .particle-lg { width: 12px; height: 12px; opacity: 1; filter: drop-shadow(0 0 5px #ffd700); }

        @keyframes particle-float {
            0% {
                transform: translate(0, 100vh) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
                transform: translate(var(--tx), 90vh) scale(1);
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), -10vh) scale(0);
                opacity: 0;
            }
        }

        /* Moving Shadow Silhouettes */
        .shadow-pass {
            position: fixed;
            width: 200px;
            height: 400px;
            background: linear-gradient(90deg, transparent 0%, rgba(0,0,0,0.3) 50%, transparent 100%);
            pointer-events: none;
            z-index: 5;
            filter: blur(20px);
            animation: shadow-walk linear;
        }

        @keyframes shadow-walk {
            0% { transform: translate(-200px, 0); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translate(calc(100vw + 200px), 0); opacity: 0; }
        }

        /* Light Rays from Windows */
        .light-ray {
            position: fixed;
            width: 2px;
            height: 100vh;
            background: linear-gradient(180deg, transparent 0%, rgba(255, 215, 0, 0.1) 20%, rgba(255, 215, 0, 0.05) 80%, transparent 100%);
            pointer-events: none;
            z-index: 5;
            transform-origin: top;
            animation: ray-pulse 8s ease-in-out infinite;
        }

        @keyframes ray-pulse {
            0%, 100% { opacity: 0.3; transform: scaleX(1); }
            50% { opacity: 0.6; transform: scaleX(1.5); }
        }

        /* Ambient Glow Orbs */
        .glow-orb {
            position: fixed;
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.15) 0%, transparent 70%);
            pointer-events: none;
            z-index: 5;
            border-radius: 50%;
            animation: orb-drift 20s ease-in-out infinite;
            filter: blur(40px);
        }

        @keyframes orb-drift {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(100px, -50px) scale(1.2); }
            50% { transform: translate(50px, 100px) scale(0.8); }
            75% { transform: translate(-100px, 50px) scale(1.1); }
        }

        .candle {
            position: fixed; width: 8px; height: 30px;
            background: linear-gradient(180deg, #fffde7 0%, #ffd700 100%);
            border-radius: 4px;
            box-shadow: 0 0 30px #ffd700, 0 0 50px rgba(255, 215, 0, 0.6), 0 5px 20px rgba(0,0,0,0.5);
            animation: candle-flicker 3s infinite ease-in-out, candle-sway 6s infinite ease-in-out;
            z-index: 5;
        }

        /* Alliance Logo Styles */
        .alliance-header-logo {
            height: 50px;
            width: auto;
            border-radius: 50%;
            border: 2px solid var(--hp-gold);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
            margin-right: 12px;
            object-fit: cover;
        }

        .alliance-result-seal {
            position: absolute;
            bottom: -20px;
            right: -20px;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px double var(--hp-border);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 20;
            background: var(--hp-parchment);
            overflow: hidden;
            opacity: 0;
            transform: scale(0.5) rotate(-20deg);
            transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .result-display-visible .alliance-result-seal {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }

        @media screen and (max-width: 768px) {
            .candle { width: 6px; height: 22px; }
            .flame { width: 8px; height: 12px; top: -7px; }
            .magic-particle { filter: blur(2px); }
            .hp-title { font-size: 2.5rem !important; }
            .alliance-header-logo { height: 40px; }
        }
        
        /* === FINAL CINEMATIC VFX ENHANCEMENTS === */
        .cinematic-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 25;
            background: 
                radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.3) 100%),
                url('https://www.transparenttextures.com/patterns/stardust.png');
            opacity: 0.15;
            mix-blend-mode: overlay;
        }

        .light-leak {
            position: fixed;
            width: 150vw;
            height: 150vh;
            top: -25vh;
            left: -25vw;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.05) 0%, transparent 70%);
            pointer-events: none;
            z-index: 20;
            animation: light-sweep 25s ease-in-out infinite;
        }

        @keyframes light-sweep {
            0%, 100% { transform: translate(-10%, -10%) rotate(0deg); }
            50% { transform: translate(10%, 10%) rotate(5deg); opacity: 0.8; }
        }

        .manifestation svg {
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.2));
            opacity: 0.15;
            transition: opacity 2s ease;
        }

        .manifestation:hover svg {
            opacity: 0.4;
        }
        
        .flame {
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            width: 12px; height: 18px;
            background: radial-gradient(ellipse, #fff 0%, #ffed4e 30%, #ffa500 60%, transparent 90%);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            animation: flame-dance 1s infinite;
            filter: blur(1px);
            box-shadow: 0 0 20px #ffd700;
        }
        
        @keyframes candle-flicker { 0%, 100% { opacity: 1; } 50% { opacity: 0.85; } }
        @keyframes candle-sway { 0%, 100% { transform: rotate(-1deg) translateY(0); } 50% { transform: rotate(1deg) translateY(-15px); } }
        @keyframes flame-dance {
            0%, 100% { transform: translateX(-50%) scale(1, 1); }
            25% { transform: translateX(-48%) scale(1.1, 0.9); }
            50% { transform: translateX(-52%) scale(0.9, 1.1); }
            75% { transform: translateX(-50%) scale(1.05, 0.95); }
        }

        /* Custom Quill Cursor */
        body { cursor: url('https://cdn-icons-png.flaticon.com/32/3067/3067451.png'), auto; }
        a, button, .custom-select-trigger, .custom-option, .cursor-pointer { 
            cursor: pointer !important; 
        }
    </style>
    <!-- Monetag MultiTag -->
    <meta name="monetag" content="dc4cd1c75e904df6c3759be0529f93c8">
    <script>(function(d,z,s){s.src='https://'+d+'/400/'+z;try{(document.body||document.documentElement).appendChild(s)}catch(e){}})('thubanoa.com','10303259',document.createElement('script'))</script>
    <!-- Open Graph / SEO -->
    <meta property="og:type" content="article" />
    <meta property="og:title" content="NoYzzing OPS" />
    <meta property="og:description" content="Puzzles and Conquest strategy guides and tools" />
    <meta property="og:image" content="https://noyziz.github.io/my-puzzles-guide/assets/images/noyzzing-logo-premium.jpg" />
    <meta property="og:site_name" content="NoYzzing OPS" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="NoYzzing OPS" />
    <meta name="twitter:description" content="Puzzles and Conquest strategy guides and tools" />
</head>
<body class="antialiased">
    
    <header class="w-full bg-hp-ink/90 border-b-4 border-double border-hp-border z-50">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex flex-col">
                <a href="index.html" class="hp-title text-2xl flex items-center tracking-widest no-underline" style="color: #ffd700;">
                    <img src="assets/alliance_logo_2.jpg" alt="ROL Alliance" class="alliance-header-logo">
                    NOYZZING <span class="mx-2" style="color: #ffd700;">|</span> <span style="color: #ffd700;">REGISTRY</span>
                </a>
            </div>
            <div class="flex items-center space-x-6">
                <div class="relative flex items-center space-x-2">
                    <i class="fa-solid fa-earth-americas text-hp-gold text-xs"></i>
                    <select id="lang-selector" class="text-xs h-8 cursor-pointer"></select>
                </div>
                <div class="wizard-script text-2xl flex items-center" style="color: #ffd700;">
                    House of <span class="hp-font font-bold text-white ml-2">ROL</span>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-12 flex-grow flex items-center justify-center">
        <div class="game-panel w-full max-w-2xl p-8 md:p-12 floating">
            <h1 class="text-5xl md:text-6xl text-center mb-4 hp-title" data-i18n="doc_title">
                THE HOGWARTS REGISTRY
            </h1>

            <p class="text-center text-hp-gold mb-10 text-xl wizard-script uppercase tracking-widest" data-i18n="castle_title">
                The Sorting of Magical Fates
            </p>

            <div id="status-message" class="status-parchment p-4 rounded-sm mb-8 text-center text-lg wizard-script ink-splotch">
                <i class="fa-solid fa-feather-pointed mr-2"></i> Declare your wizarding signature to begin the ceremony.
            </div>

            <!-- CASTLE SELECTION (IDENTIFIER) -->
            <div id="castle-selection" class="space-y-6">
                <p class="text-lg text-hp-ink mb-2 wizard-script" data-i18n="select_castle_prompt">Inscribe your magical signature (e.g., Main Wand, Alt Scroll)</p>
                <div class="space-y-6">
                    <div>
                        <label for="castle-input" class="block text-xs font-bold text-hp-burgundy/80 mb-1 uppercase tracking-tighter" data-i18n="castle_label">Signature:</label>
                        <input type="text" id="castle-input" placeholder="ROL | Potion Master" maxlength="30" required>
                    </div>
                    <button id="select-castle-btn" class="magical-button w-full text-xl" data-i18n="access_file">
                        <i class="fa-solid fa-scroll mr-2"></i> UNROLL PARCHMENT
                    </button>
                </div>
                <div class="mt-8 p-6 border-2 border-hp-border/30 bg-white/5 rounded-sm">
                    <h3 class="text-hp-burgundy font-bold mb-3 text-sm hp-font" data-i18n="info_important">OFFICIAL DECREE:</h3>
                    <p class="text-sm text-hp-ink/70 leading-relaxed" data-i18n="info_resets">Each magical signature is permitted **10 Sorting Ceremonies**. This identity shall be bound to your future visits.</p>
                </div>
            </div>

            <!-- ASSIGNMENT FORM -->
            <div id="assignment-form" class="space-y-6 hidden">
                <div id="castle-info" class="border-y border-hp-border/20 py-4 text-center">
                    <p class="text-2xl hp-font text-hp-burgundy mb-2" data-i18n="active_alias">Identity: <span id="current-castle" class="wizard-script text-3xl">None</span></p>
                    <p class="text-sm italic"><span data-i18n="resets_left">Magic Remaining:</span> <span id="reset-count-display" class="font-bold">10</span>/10 Scrolls</p>
                </div>
                <p class="text-center text-xl wizard-script mt-6"><span data-i18n="pool_prompt">Declare your magical lineage,</span> <span id="castle-name" class="text-hp-burgundy"></span></p>
                <div class="grid grid-cols-1 gap-6">
                    <div class="space-y-2">
                        <label class="block text-center text-xs font-bold text-hp-burgundy/80 uppercase tracking-widest" data-i18n="char_pool_select">Magical Lineage:</label>
                        <div id="gender-select-wrapper" class="custom-select-container">
                            <div class="custom-select-trigger" id="gender-trigger">
                                <span id="gender-selected-text" data-i18n="select_default">-- Make Your Choice --</span>
                                <i class="fa-solid fa-chevron-down text-sm transition-transform"></i>
                            </div>
                            <div class="custom-options" id="gender-options">
                                <!-- Options will be injected by JS -->
                            </div>
                        </div>
                        <input type="hidden" id="player-gender" value="">
                    </div>
                </div>
                <div class="pt-6">
                    <button id="assign-btn" class="magical-button w-full text-2xl" data-i18n="assign_code">
                        <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> CONSULT THE GOBLET
                    </button>
                </div>
            </div>

            <!-- SPINNER SCREEN -->
            <div id="spinner-container" class="mt-10 flex flex-col items-center justify-center p-8 hidden">
                <span id="spinner-text" class="hp-title text-4xl mb-4" data-i18n-spinner="ENCHANTING REALITY...">ENCHANTING REALITY...</span>
                <p class="text-lg wizard-script text-hp-burgundy">The Goblet is selecting your fate...</p>
            </div>

            <!-- RESULT DISPLAY -->
            <div id="result-display" class="mt-10 text-center animate-fade-in hidden">
                <div class="journal-spread">
                        <!-- Left Panel: Illustration -->
                        <div class="bestiary-illustration" id="bestiary-illustration-container">
                            <img id="bestiary-image" class="bestiary-image" src="" alt="Creature Illustration">
                            <div class="alliance-result-seal">
                                <img src="assets/alliance_logo_1.jpg" alt="ROL Seal" class="w-full h-full object-cover">
                            </div>
                        </div>

                        <!-- Right Panel: Details -->
                        <div class="bestiary-details">
                            <p class="hp-font uppercase text-hp-border tracking-[0.2em] text-sm mb-1" data-i18n="assignment_secured">IDENTITY REVEALED:</p>
                            <h2 id="result-name" class="leading-tight mb-2"></h2>
                            
                            <div id="house-badge-container" class="mb-4"></div>
                            
                            <p id="pool-display" class="hp-font text-hp-ink opacity-60 text-xs tracking-widest mb-6"></p>

                            <div class="flex flex-wrap gap-2 justify-center md:justify-start">
                                <button onclick="shareIdentity()" class="magical-button magical-button-compact">
                                    <span data-i18n="copy_details"><i class="fa-solid fa-feather mr-1"></i> COPY DETAILS</span>
                                </button>
                                <button id="reset-btn" onclick="showModal()" class="magical-button magical-button-compact">
                                    <span data-i18n="reset_reroll"><i class="fa-solid fa-rotate-left mr-1"></i> RE-SORT</span>
                                </button>
                                <button id="new-castle-btn" onclick="resetToSelection()" class="magical-button magical-button-compact">
                                    <span data-i18n="change_new_castle"><i class="fa-solid fa-user-plus mr-1"></i> NEW SIGNATURE</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            <!-- MARAUDER'S LOG -->
            <div class="mt-12 border-t-2 border-hp-border/20 pt-8">
                <h2 class="text-3xl wizard-script text-hp-burgundy mb-4 flex items-center" data-i18n="log_title">
                    <i class="fa-solid fa-feather-pointed text-hp-gold mr-3"></i> The Marauder's Log
                </h2>
                <div id="castle-assignments" class="text-sm space-y-3 max-h-60 overflow-y-auto p-4 wizard-script text-xl">
                    <!-- Log entries injected by JS -->
                </div>
            </div>
        </div>
    </main>

    <footer class="w-full bg-hp-ink/95 border-t-4 border-double border-hp-border mt-auto py-8">
        <div class="container mx-auto px-4 text-center">
            <div class="hp-title text-2xl mb-2 tracking-widest" style="color: #ffd700;">NOYZZING // OPERATIONAL COMMAND</div>
            <p class="text-xs uppercase tracking-widest mb-4 font-bold" style="color: #ffd700; opacity: 0.9;">Official Sorting Registry | Alliance Strategic Sector</p>
            <div class="flex justify-center items-center space-x-6 text-sm wizard-script">
                <a href="index.html" class="hover:underline transition-all font-bold" style="color: #ffd700;">Return to Headquarters</a>
                <span style="color: #8d6e3f;">|</span>
                <span class="italic" style="color: #ffd700; opacity: 0.9;">In Alliance with House of ROL</span>
            </div>
            <div class="mt-8 pt-6 border-t border-hp-border/30 text-[11px] hp-font tracking-widest" style="color: #ffd700; opacity: 0.6;">
                EST. 1991 | NOYZZING // OPS | OFFICIAL REGISTRY
            </div>
        </div>
    </footer>

    <!-- MODAL -->
    <div id="theme-modal" class="fixed inset-0 z-[100] flex items-center justify-center hidden opacity-0 transition-opacity bg-black/60 backdrop-blur-sm">
        <div class="modal-content w-full max-w-md p-10 relative rounded-sm shadow-2xl border-4 border-double border-hp-border bg-hp-parchment" style="background-image: url('https://www.transparenttextures.com/patterns/parchment.png');">
            <h3 id="modal-title" class="hp-title text-2xl mb-5 uppercase" data-i18n="modal_override_title">The Goblet's Warning</h3>
            <p id="modal-message" class="text-hp-ink text-lg mb-10 wizard-script leading-relaxed"></p>
            <div class="flex justify-end space-x-6">
                <button id="modal-cancel" class="text-hp-border hover:text-hp-burgundy text-sm font-bold transition-colors uppercase hp-font" data-i18n="cancel_btn">HALT</button>
                <button id="modal-confirm" class="magical-button text-xs py-2 px-6" data-i18n="confirm_reroll_btn">CAST SPELL</button>
            </div>
        </div>
    </div>

    <script>
        // --- TRANSLATION DATA ---
        const TRANSLATIONS = {
            'en': {
                'lang_name': 'English',
                'doc_title': 'The Hogwarts Registry',
                'castle_title': 'The Sorting of Magical Fates',
                'select_castle_prompt': 'Inscribe your magical signature...',
                'castle_label': 'Magical Signature:',
                'access_file': '<i class="fa-solid fa-scroll mr-2"></i> UNROLL PARCHMENT',
                'info_important': 'OFFICIAL DECREE:',
                'info_resets': 'Each magical signature is permitted **10 Sorting Ceremonies**. Use this name for all future checks.',
                'active_alias': 'ACTIVE SIGNATURE:', 'resets_left': 'Magic Remaining:',
                'pool_prompt': 'Declare your magical lineage,', 'char_pool_select': 'Magical Lineage Selection:',
                'select_default': '-- Select --', 'male_chars': 'Wizard', 'female_chars': 'Witch', 'creatures_chars': 'Magical Creature',
                'assign_code': '<i class="fa-solid fa-wand-magic-sparkles mr-2"></i> CONSULT THE GOBLET',
                'assignment_secured': 'IDENTITY REVEALED:',
                'copy_details': '<i class="fa-solid fa-feather mr-1"></i> COPY MAGICAL DETAILS',
                'reset_reroll': '<i class="fa-solid fa-rotate-left mr-1"></i> CAST RE-SORTING SPELL',
                'change_new_castle': '<i class="fa-solid fa-user-plus mr-1"></i> NEW WIZARD SIGNATURE',
                'log_title': 'The Marauder\'s Log',
                'modal_override_title': 'The Goblet\'s Warning',
                'modal_override_msg': 'You have already been sorted as **$1**. Casting a re-sorting spell will consume one of your limited magical scrolls ($2 left). Proceed?',
                'cancel_btn': 'HALT', 'confirm_reroll_btn': 'CAST SPELL',
                'status_default': 'Declare your wizarding signature to begin the ceremony.',
                'status_enter_name': 'Please inscribe your magical signature.',
                'status_select_pool': 'Please declare your magical lineage.',
                'status_assignment_exists': 'Sorting already completed. Cast a Re-Sorting Spell to try again.',
                'status_ready': 'Signature "$1" recognized. The ceremony is prepared.',
                'status_no_resets': '❌ No magical scrolls remaining for this signature.',
                'status_reset_confirm_msg': 'This will consume **1 of your $1 Sorting Ceremonies** for **$2**. Your current identity will be lost.',
                'status_reset_cancel': 'Ceremony cancelled. Current assignment remains active.',
                'status_reset_complete': 'Magic restored. "$2" has $1 scrolls remaining.',
                'status_new_castle': 'Inscribe a new magical signature to proceed.',
                'status_copy_success': 'Magical details copied! Share this fate in Discord.',
                'status_duplicate_warning': 'The Great Hall has been exhausted! Allowing duplicates.',
                'spinner_initiating': '<i class="fa-solid fa-spinner fa-spin mr-2"></i> MAGICAL INITIATION...',
                'result_welcome': 'Welcome **$1**! Your residence is $2',
                'result_secured': 'Sorting complete! You are **$1**.',
                'result_failed': 'Sorting failed. Dark magic detected. Try again.',
                'roster_empty': 'The Great Hall Log is empty.',
                'house_label': 'HOUSE:',
                'house_gryffindor': 'Gryffindor', 'house_slytherin': 'Slytherin', 
                'house_ravenclaw': 'Ravenclaw', 'house_hufflepuff': 'Hufflepuff',
                'house_durmstrang': 'Durmstrang', 'house_beauxbatons': 'Beauxbatons',
                'house_neutral': 'Wizarding World'
            },
            'ru': {
                'lang_name': 'Русский',
                'doc_title': 'Реестр Хогвартса',
                'castle_title': 'Распределение магических судеб',
                'select_castle_prompt': 'Впишите вашу магическую подпись...',
                'castle_label': 'Магическая подпись:',
                'access_file': '<i class="fa-solid fa-scroll mr-2"></i> РАЗВЕРНУТЬ ПЕРГАМЕНТ',
                'info_important': 'ОФИЦИАЛЬНЫЙ ДЕКРЕТ:',
                'info_resets': 'Каждой магической подписи разрешено **10 Церемоний Распределения**.',
                'active_alias': 'АКТИВНАЯ ПОДПИСЬ:', 'resets_left': 'Осталось магии:',
                'pool_prompt': 'Объявите о своем происхождении,', 'char_pool_select': 'Выбор магического происхождения:',
                'select_default': '-- Сделайте свой выбор --', 'male_chars': 'Волшебник', 'female_chars': 'Ведьма', 'creatures_chars': 'Магическое существо',
                'assign_code': '<i class="fa-solid fa-wand-magic-sparkles mr-2"></i> КОНСУЛЬТАЦИЯ КУБКА',
                'assignment_secured': 'ЛИЧНОСТЬ РАСКРЫТА:',
                'copy_details': '<i class="fa-solid fa-feather mr-1"></i> КОПИРОВАТЬ МАГИЧЕСКИЕ ДАННЫЕ',
                'reset_reroll': '<i class="fa-solid fa-rotate-left mr-1"></i> ЗАКЛИНАНИЕ ПЕРЕРАСПРЕДЕЛЕНИЯ',
                'change_new_castle': '<i class="fa-solid fa-user-plus mr-1"></i> НОВАЯ МАГИЧЕСКАЯ ПОДПИСЬ',
                'log_title': 'Карта Мародеров (Журнал)',
                'modal_override_title': 'Предупреждение Кубка',
                'modal_override_msg': 'Вы уже были распределены как **$1**. Заклинание перераспределения поглотит один из ваших ограниченных магических свитков (осталось: $2). Продолжить?',
                'cancel_btn': 'СТОЙ', 'confirm_reroll_btn': 'ПРОИЗНЕСТИ ЗАКЛИНАНИЕ',
                'status_default': 'Declare your wizarding signature to begin the ceremony.',
                'status_enter_name': 'Please inscribe your magical signature.',
                'status_select_pool': 'Please declare your magical lineage.',
                'status_assignment_exists': 'Sorting already completed. Cast a Re-Sorting Spell to try again.',
                'status_ready': 'Подпись "$1" признана. Церемония готова.',
                'status_no_resets': '❌ No magical scrolls remaining for this signature.',
                'status_reset_confirm_msg': 'This will consume **1 of your $1 Sorting Ceremonies** for **$2**. Your current identity will be lost.',
                'status_reset_cancel': 'Ceremony cancelled. Current assignment remains active.',
                'status_reset_complete': 'Магия восстановлена. У "$2" осталось $1 свитков.',
                'status_new_castle': 'Inscribe a new magical signature to proceed.',
                'status_copy_success': 'Magical details copied! Share this fate in Discord.',
                'status_duplicate_warning': 'Большой зал истощен! Разрешены дубликаты.',
                'spinner_initiating': '<i class="fa-solid fa-spinner fa-spin mr-2"></i> ПРИЗЫВ ДРЕВНЕЙ МАГИИ...',
                'result_welcome': 'Добро пожаловать, **$1**! Ваша обитель — $2',
                'result_secured': 'Распределение завершено! Вы — **$1**.',
                'result_failed': 'Распределение не удалось. Обнаружена темная магия.',
                'roster_empty': 'Журнал Мародеров пуст.'
            },
            'fr': {
                'lang_name': 'Français',
                'doc_title': 'Le Registre de Poudlard',
                'castle_title': 'La Répartition des Destins Magiques',
                'select_castle_prompt': 'Inscrivez votre signature magique...',
                'castle_label': 'Signature Magique :',
                'access_file': '<i class="fa-solid fa-scroll mr-2"></i> DÉROULER LE PARCHEMIN',
                'info_important': 'DÉCRET OFFICIEL :',
                'info_resets': 'Chaque signature magique est autorisée à **10 Cérémonies de Répartition**.',
                'active_alias': 'SIGNATURE ACTIVE :', 'resets_left': 'Magie Restante :',
                'pool_prompt': 'Déclarez votre lignée magique,', 'char_pool_select': 'Sélection de la Lignée :',
                'select_default': '-- Faites Votre Choix --', 'male_chars': 'Sorcier', 'female_chars': 'Sorcière', 'creatures_chars': 'Créature Magique',
                'assign_code': '<i class="fa-solid fa-wand-magic-sparkles mr-2"></i> CONSULTER LA COUPE',
                'assignment_secured': 'IDENTITÉ RÉVÉLÉE :',
                'copy_details': '<i class="fa-solid fa-feather mr-1"></i> COPIER LES DÉTAILS MAGIQUES',
                'reset_reroll': '<i class="fa-solid fa-rotate-left mr-1"></i> SORT DE RE-RÉPARTITION',
                'change_new_castle': '<i class="fa-solid fa-user-plus mr-1"></i> NOUVELLE SIGNATURE',
                'log_title': 'Le Journal du Maraudeur',
                'modal_override_title': 'L\'Avertissement de la Coupe',
                'modal_override_msg': 'Vous avez déjà été réparti comme **$1**. Lancer un sort de re-répartition consommera l\'un de vos parchemins magiques limités ($2 restants). Procéder ?',
                'cancel_btn': 'HALTE', 'confirm_reroll_btn': 'LANCER LE SORT',
                'status_default': 'Sélectionnez votre alias pour commencer.',
                'status_enter_name': 'Veuillez entrer un alias.',
                'status_select_pool': 'Sélectionnez un pool.',
                'status_assignment_exists': 'Répartition déjà terminée. Utilisez Réinitialiser pour relancer.',
                'status_ready': 'Signature "$1" reconnue. La cérémonie est prête.',
                'status_no_resets': '❌ Aucune tentative de réinitialisation restante.',
                'status_reset_confirm_msg': 'Ceci consommera **1 de vos $1 tentatives** pour **$2**. L\'identité actuelle sera perdue.',
                'status_reset_cancel': 'Annulé. L\'identité reste active.',
                'status_reset_complete': 'Magie restaurée. "$2" a $1 parchemins restants.',
                'status_new_castle': 'Entrez un nouvel alias.',
                'status_copy_success': 'Identité copiée !',
                'status_duplicate_warning': 'Le Grand Salon est épuisé ! Doublons autorisés.',
                'spinner_initiating': '<i class="fa-solid fa-spinner fa-spin mr-2"></i> INVOCATION DE LA MAGIE...',
                'result_welcome': 'Bienvenue **$1** ! Votre demeure est $2',
                'result_secured': 'Répartition terminée ! Vous êtes **$1**.',
                'result_failed': 'Échec de la répartition. Magie noire détectée.',
                'roster_empty': 'Le journal est vide.'
            },
            'es': {
                'lang_name': 'Español',
                'doc_title': 'El Registro de Hogwarts',
                'castle_title': 'La Selección de los Destinos Mágicos',
                'select_castle_prompt': 'Inscribe tu firma mágica...',
                'castle_label': 'Firma Mágica:',
                'access_file': '<i class="fa-solid fa-scroll mr-2"></i> DESENRROLLAR PERGAMINO',
                'info_important': 'DECRETO OFICIAL:',
                'info_resets': 'Cada firma mágica tiene permitidas **10 Ceremonias de Selección**.',
                'active_alias': 'FIRMA ACTIVA:', 'resets_left': 'Magia Restante:',
                'pool_prompt': 'Declara tu linaje mágico,', 'char_pool_select': 'Selección de Linaje:',
                'select_default': '-- Haz tu Elección --', 'male_chars': 'Mago', 'female_chars': 'Bruja', 'creatures_chars': 'Criatura Mágica',
                'assign_code': '<i class="fa-solid fa-wand-magic-sparkles mr-2"></i> CONSULTAR EL CÁLIZ',
                'assignment_secured': 'IDENTIDAD REVELADA:',
                'copy_details': '<i class="fa-solid fa-feather mr-1"></i> COPIAR DETALLES MÁGICOS',
                'reset_reroll': '<i class="fa-solid fa-rotate-left mr-1"></i> HECHIZO DE RE-SELECCIÓN',
                'change_new_castle': '<i class="fa-solid fa-user-plus mr-1"></i> NUEVA FIRMA MÁGICA',
                'log_title': 'El Diario del Merodeador',
                'modal_override_title': 'Advertencia del Cáliz',
                'modal_override_msg': 'Ya has sido seleccionado como **$1**. Lanzar un hechizo de re-selección consumirá uno de tus pergaminos mágicos limitados ($2 restantes). ¿Proceder?',
                'cancel_btn': 'ALTO', 'confirm_reroll_btn': 'LANZAR HECHIZO',
                'status_default': 'Selecciona tu alias para comenzar.',
                'status_enter_name': 'Ingresa un alias.',
                'status_select_pool': 'Selecciona un pool.',
                'status_assignment_exists': 'Selección ya completada.',
                'status_ready': 'Firma "$1" reconocida. La ceremonia está lista.',
                'status_no_resets': '❌ Sin intentos restantes.',
                'status_reset_confirm_msg': 'Se consumirá **1 de tus $1 intentos** para **$2**.',
                'status_reset_cancel': 'Ceremonia cancelada.',
                'status_reset_complete': 'Magia restaurada. "$2" tiene $1 pergaminos restantes.',
                'status_new_castle': 'Ingresa un nuevo alias.',
                'status_copy_success': '¡Identidad copiada!',
                'status_duplicate_warning': '¡Gran Comedor agotado! Duplicados permitidos.',
                'spinner_initiating': '<i class="fa-solid fa-spinner fa-spin mr-2"></i> INVOCANDO MAGIA...',
                'result_welcome': '¡Bienvenido **$1**! Tu residencia es $2',
                'result_secured': '¡Selección completa! Eres **$1**.',
                'result_failed': 'Selección fallida. Magia oscura detectada.',
                'roster_empty': 'El registro está vacío.'
            },
            'ja': {
                'lang_name': '日本語',
                'doc_title': 'ホグワーツ登録簿',
                'castle_title': '魔法の運命の組み分け',
                'select_castle_prompt': '魔法の署名を記入してください...',
                'castle_label': '魔法の署名:',
                'access_file': '<i class="fa-solid fa-scroll mr-2"></i> 羊皮紙を広げる',
                'info_important': '公式布告:',
                'info_resets': '各魔法の署名につき、**10回の組み分けの儀式**が許可されています。',
                'active_alias': '有効な署名:', 'resets_left': '残りの魔力:',
                'pool_prompt': '魔法の血統を宣言してください、', 'char_pool_select': '魔法の血統の選択:',
                'select_default': '-- 選択してください --', 'male_chars': '魔法使い', 'female_chars': '魔女', 'creatures_chars': '魔法生物',
                'assign_code': '<i class="fa-solid fa-wand-magic-sparkles mr-2"></i> 炎のゴブレットに相談する',
                'assignment_secured': '正体が判明しました:',
                'copy_details': '<i class="fa-solid fa-feather mr-1"></i> 魔法の詳細をコピー',
                'reset_reroll': '<i class="fa-solid fa-rotate-left mr-1"></i> 再組み分けの呪文を唱える',
                'change_new_castle': '<i class="fa-solid fa-user-plus mr-1"></i> 新しい魔法の署名',
                'log_title': '忍びの地図（記録）',
                'modal_override_title': 'ゴブレットの警告',
                'modal_override_msg': 'あなたはすでに **$1** として組み分けられています。再組み分けの呪文を唱えるには、限られた魔法の羊皮紙を1枚消費します（残り $2枚）。よろしいですか？',
                'cancel_btn': '止まれ', 'confirm_reroll_btn': '呪文を唱える',
                'status_default': 'エイリアスを選択して組み分けを開始してください。',
                'status_enter_name': 'エイリアスを入力してください。',
                'status_select_pool': '魔法のプールを選択してください。',
                'status_assignment_exists': 'Selección ya completada.',
                'status_ready': '署名 "$1" を確認。儀式の準備が整いました。',
                'status_no_resets': '❌ Sin intentos restantes.',
                'status_reset_confirm_msg': 'Se consumirá **1 de tus $1 intentos** para **$2**.',
                'status_reset_cancel': 'Ceremonia cancelada.',
                'status_reset_complete': '魔力が回復しました。 "$2" の残り羊皮紙は $1枚です。',
                'status_new_castle': 'Ingresa un nuevo alias.',
                'status_copy_success': '¡Identidad copiada!',
                'status_duplicate_warning': '大広間が満員です！重複を許可します。',
                'spinner_initiating': '<i class="fa-solid fa-spinner fa-spin mr-2"></i> 古代の魔法を召喚中...',
                'result_welcome': '**$1** おかえりなさい！ あなたの居場所は $2 です',
                'result_secured': '組み分け完了！ あなたは **$1** です。',
                'result_failed': 'Selección fallida. Magia oscura detectada.',
                'roster_empty': '記録は空です。'
            },
            'ko': {
                'lang_name': '한국어',
                'doc_title': '호그와트 등록부',
                'castle_title': '마법의 운명 배정',
                'select_castle_prompt': '마법의 서명을 남겨주세요...',
                'castle_label': '마법의 서명:',
                'access_file': '<i class="fa-solid fa-scroll mr-2"></i> 양피지 펼치기',
                'info_important': '공식 포고령:',
                'info_resets': '각 마법의 서명당 **10회의 배정 의식**이 허용됩니다.',
                'active_alias': '활성 서명:', 'resets_left': '남은 마력:',
                'pool_prompt': '마법의 혈통을 선언하십시오,', 'char_pool_select': '마법 혈통 선택:',
                'select_default': '-- 선택 --', 'male_chars': '마법사 (남)', 'female_chars': '마녀 (여)', 'creatures_chars': '신비한 동물',
                'assign_code': '<i class="fa-solid fa-wand-magic-sparkles mr-2"></i> 불의 잔에게 묻기',
                'assignment_secured': '정체가 밝혀졌습니다:',
                'copy_details': '<i class="fa-solid fa-feather mr-1"></i> 마법 정보 복사',
                'reset_reroll': '<i class="fa-solid fa-rotate-left mr-1"></i> 재배정 주문 시전',
                'change_new_castle': '<i class="fa-solid fa-user-plus mr-1"></i> 새로운 마법의 서명',
                'log_title': '도둑지도 (기록)',
                'modal_override_title': '불의 잔의 경고',
                'modal_override_msg': '당신은 이미 **$1**(으)로 배정되었습니다. 재배정 주문을 시전하면 제한된 마법 양피지 1장을 소비합니다 (남은 횟수: $2회). 계속하시겠습니까?',
                'cancel_btn': '멈춤', 'confirm_reroll_btn': '주문 시전',
                'status_default': 'Select your alias to begin.',
                'status_enter_name': 'Please enter an alias.',
                'status_select_pool': 'Please select a pool.',
                'status_assignment_exists': 'Selección ya completada.',
                'status_ready': '서명 "$1" 확인됨. 의식이 준비되었습니다.',
                'status_no_resets': '❌ Sin intentos restantes.',
                'status_reset_confirm_msg': 'Se consumirá **1 de tus $1 intentos** para **$2**.',
                'status_reset_cancel': 'Ceremonia cancelada.',
                'status_reset_complete': '마력이 회복되었습니다. "$2"님의 남은 양피지는 $1장입니다.',
                'status_new_castle': 'Ingresa un nuevo alias.',
                'status_copy_success': '¡Identidad copiada!',
                'status_duplicate_warning': '대연회장이 가득 찼습니다! 중복 배정을 허용합니다.',
                'spinner_initiating': '<i class="fa-solid fa-spinner fa-spin mr-2"></i> 고대 마법 소환 중...',
                'result_welcome': '환영합니다, **$1**! 당신의 거처는 $2입니다',
                'result_secured': '배정 완료! 당신은 **$1**입니다.',
                'result_failed': 'Selección fallida. Magia oscura detectada.',
                'roster_empty': '기록이 비어 있습니다.'
            }
            // Additional languages (es, pt, de, ja, ko) will follow the same pattern in the final implementation
        };

        // ==========================================
        // 🏰 MAGICAL CONFIGURATION 🏰
        // ==========================================
        // If you are using ngrok for international alliance access, 
        // paste your public link (https://...) here:
        const GLOBAL_REGISTRY_URL = 'http://localhost:5000'; 
        
        // ==========================================

        const STORAGE_KEY = 'hp_registry_data';
        const MAX_RESETS = 10;
        const DISCORD_WEBHOOK = 'https://discord.com/api/webhooks/1444330680858447903/dvcgQu42zAycH3rsEx8GADtmKoIGl3mY0PaznYMHhuOdtTlUHcliQJAk_No0NEtQ3Bg0';
        const DISCORD_WEBHOOK_PROXY = '/api/discord-webhook';
        const LOCAL_API_URL = GLOBAL_REGISTRY_URL;

        // COMPREHENSIVE CHARACTER ROSTER (100+ CHARACTERS)
        const CHARACTERS = {
            Male: [
                "Harry Potter", "Ron Weasley", "Albus Dumbledore", "Severus Snape", "Draco Malfoy", "Sirius Black", "Remus Lupin", "Neville Longbottom", "Cedric Diggory", "Viktor Krum", 
                "Voldemort", "Rubeus Hagrid", "Fred Weasley", "George Weasley", "Lucius Malfoy", "James Potter", "Arthur Weasley", "Percy Weasley", "Bill Weasley", "Charlie Weasley",
                "Newt Scamander", "Gellert Grindelwald", "Garrick Ollivander", "Kingsley Shacklebolt", "Alastor Moody", "Gilderoy Lockhart", "Horace Slughorn", "Xenophilius Lovegood", 
                "Cormac McLaggen", "Seamus Finnigan", "Dean Thomas", "Blaise Zabini", "Gregory Goyle", "Vincent Crabbe", "Dudley Dursley", "Vernon Dursley", "Regulus Black", "Phineas Nigellus Black",
                "Aberforth Dumbledore", "Barty Crouch Sr", "Barty Crouch Jr", "Igor Karkaroff", "Ludo Bagman", "Oliver Wood", "Lee Jordan", "Colin Creevey", "Dennis Creevey", "Justin Finch-Fletchley", 
                "Ernie Macmillan", "The Fat Friar", "Nearly Headless Nick", "Fenrir Greyback", "Professor Binns"
            ],
            Female: [
                "Hermione Granger", "Ginny Weasley", "Luna Lovegood", "Minerva McGonagall", "Bellatrix Lestrange", "Lily Potter", "Cho Chang", "Fleur Delacour", "Nymphadora Tonks", "Molly Weasley", 
                "Narcissa Malfoy", "Dolores Umbridge", "Sybil Trelawney", "Rita Skeeter", "Hestia Jones", "Pomona Sprout", "Madam Pomfrey", "Madam Rosmerta", "Lavender Brown", "Parvati Patil", 
                "Padma Patil", "Pansy Parkinson", "Astoria Greengrass", "Helena Ravenclaw", "Moaning Myrtle", "Madame Maxime", "Petunia Dursley", "Charity Burbage", "Mafalda Hopkirk", "Merope Gaunt",
                "Andromeda Tonks", "Alecto Carrow", "Millicent Bulstrode", "Susan Bones", "Hannah Abbott", "Madam Hooch", "Madam Pince", "Professor Sinistra", "Septima Vector", "Bathsheda Babbling",
                "Alicia Spinnet"
            ],
            Creatures: [
                "Dobby", "Kreacher", "Winky", "Griphook", "Gornuk", "Ragnok", 
                "Hungarian Horntail", "Chinese Fireball", "Norwegian Ridgeback", "Swedish Short-Snout", "Ukrainian Ironbelly", "Antipodean Opaleye", "Common Welsh Green", "Hebridean Black", "Peruvian Vipertooth", "Romanian Longhorn",
                "Fang", "Ripper", "Fluffy", "Mrs. Norris", "Crookshanks", "Kneazle", "Matagot", "Wampus Cat",
                "Unicorn", "Thestral", "Centaur (Firenze)", "Centaur (Magorian)", "Centaur (Bane)", "Abraxan", "Aethonan", "Granian", "Kelpie",
                "Fawkes", "Buckbeak", "Thunderbird", "Hedwig", "Errol", "Pigwidgeon", "Golden Snidget", "Occamy",
                "Bowtruckle", "Pickett", "Niffler", "Aragog", "Basilisk", "Sphinx", "Manticore", "Blast-Ended Skrewt",
                "Mermaid", "Siren", "Selkie", "Grawp", "Grindylow", "Kappa", "Boggart", "Dementor", "Pygmy Puff", "Gnome", "Doxy", "Cornish Pixie", "Mountain Troll",
                "Demiguise", "Graphorn", "Erumpent", "Occamy", "Diricawl", "Billywig"
            ]
        };

        const HOUSE_MAP = {
            "Harry Potter": "gryffindor", "Ron Weasley": "gryffindor", "Hermione Granger": "gryffindor", "Albus Dumbledore": "gryffindor", "Sirius Black": "gryffindor",
            "Remus Lupin": "gryffindor", "Neville Longbottom": "gryffindor", "Fred Weasley": "gryffindor", "George Weasley": "gryffindor", "James Potter": "gryffindor",
            "Lily Potter": "gryffindor", "Minerva McGonagall": "gryffindor", "Ginny Weasley": "gryffindor", "Arthur Weasley": "gryffindor", "Percy Weasley": "gryffindor",
            "Bill Weasley": "gryffindor", "Charlie Weasley": "gryffindor", "Rubeus Hagrid": "gryffindor", "Alastor Moody": "gryffindor", "Molly Weasley": "gryffindor",
            "Seamus Finnigan": "gryffindor", "Dean Thomas": "gryffindor", "Oliver Wood": "gryffindor", "Lee Jordan": "gryffindor", "Colin Creevey": "gryffindor",
            "Dennis Creevey": "gryffindor", "Nearly Headless Nick": "gryffindor", "Alicia Spinnet": "gryffindor", "Angelina Johnson": "gryffindor", "Katie Bell": "gryffindor",
            "Demelza Robins": "gryffindor", "Romilda Vane": "gryffindor", "The Fat Lady": "gryffindor", "Peter Pettigrew": "gryffindor",
            "Severus Snape": "slytherin", "Draco Malfoy": "slytherin", "Voldemort": "slytherin", "Bellatrix Lestrange": "slytherin", "Lucius Malfoy": "slytherin",
            "Narcissa Malfoy": "slytherin", "Dolores Umbridge": "slytherin", "Regulus Black": "slytherin", "Phineas Nigellus Black": "slytherin", "Pansy Parkinson": "slytherin",
            "Blaise Zabini": "slytherin", "Gregory Goyle": "slytherin", "Vincent Crabbe": "slytherin", "Millicent Bulstrode": "slytherin", "Astoria Greengrass": "slytherin",
            "Barty Crouch Jr": "slytherin", "Alecto Carrow": "slytherin", "Nagini": "slytherin", "Horace Slughorn": "slytherin", "Mrs. Norris": "slytherin",
            "Luna Lovegood": "ravenclaw", "Cho Chang": "ravenclaw", "Gilderoy Lockhart": "ravenclaw", "Sybil Trelawney": "ravenclaw", "Helena Ravenclaw": "ravenclaw",
            "Garrick Ollivander": "ravenclaw", "Xenophilius Lovegood": "ravenclaw", "Padma Patil": "ravenclaw", "Professor Flitwick": "ravenclaw", "The Grey Lady": "ravenclaw",
            "Cedric Diggory": "hufflepuff", "Newt Scamander": "hufflepuff", "Nymphadora Tonks": "hufflepuff", "Pomona Sprout": "hufflepuff", "Justin Finch-Fletchley": "hufflepuff",
            "Ernie Macmillan": "hufflepuff", "The Fat Friar": "hufflepuff", "Susan Bones": "hufflepuff", "Hannah Abbott": "hufflepuff", "Madam Hooch": "hufflepuff",
            "Madam Pomfrey": "hufflepuff",
            "Viktor Krum": "durmstrang", "Igor Karkaroff": "durmstrang",
            "Fleur Delacour": "beauxbatons", "Madame Maxime": "beauxbatons",
            "Hungarian Horntail": "neutral", "Chinese Fireball": "neutral", "Norwegian Ridgeback": "neutral", "Swedish Short-Snout": "neutral", 
            "Thestral": "neutral", "Centaur (Firenze)": "neutral", "Centaur (Magorian)": "neutral", "Pickett": "neutral", "Bowtruckle": "neutral", "Unicorn": "neutral", "Mermaid": "neutral", "Mountain Troll": "neutral",
            "Fluffy": "neutral", "Norbert": "neutral", "Basilisk": "slytherin", "Dementor": "neutral", "Boggart": "neutral", "Niffler": "neutral",
            "Grawp": "neutral", "Aragog": "neutral", "Buckbeak": "neutral", "Fawkes": "neutral", "Blast-Ended Skrewt": "neutral",
            "Ukrainian Ironbelly": "neutral", "Antipodean Opaleye": "neutral", "Common Welsh Green": "neutral", "Hebridean Black": "neutral", "Peruvian Vipertooth": "neutral", "Romanian Longhorn": "neutral",
            "Fang": "neutral", "Ripper": "neutral", "Mrs. Norris": "slytherin", "Crookshanks": "gryffindor", "Kneazle": "neutral", "Matagot": "neutral", "Wampus Cat": "neutral",
            "Centaur (Bane)": "neutral", "Abraxan": "neutral", "Aethonan": "neutral", "Granian": "neutral", "Kelpie": "neutral",
            "Thunderbird": "neutral", "Hedwig": "neutral", "Errol": "neutral", "Pigwidgeon": "neutral", "Golden Snidget": "neutral", "Occamy": "neutral",
            "Siren": "neutral", "Selkie": "neutral", "Grindylow": "neutral", "Kappa": "neutral", "Pygmy Puff": "neutral", "Gnome": "neutral", "Doxy": "neutral", "Cornish Pixie": "neutral",
            "Dobby": "neutral", "Kreacher": "slytherin", "Winky": "neutral", "Griphook": "neutral", "Gornuk": "neutral", "Ragnok": "neutral",
            "Demiguise": "neutral", "Graphorn": "neutral", "Erumpent": "neutral", "Occamy": "neutral", "Diricawl": "neutral", "Billywig": "neutral"
        };

        let currentLang = localStorage.getItem('hp_language') || 'en';
        let currentCastle = null;
        let currentAssignment = null;

        const ELEMENTS = {
            castleSelection: document.getElementById('castle-selection'),
            assignmentForm: document.getElementById('assignment-form'),
            resultDisplay: document.getElementById('result-display'),
            resultName: document.getElementById('result-name'),
            houseBadge: document.getElementById('house-badge-container'),
            poolDisplay: document.getElementById('pool-display'),
            assignBtn: document.getElementById('assign-btn'),
            resetBtn: document.getElementById('reset-btn'),
            newCastleBtn: document.getElementById('new-castle-btn'),
            selectCastleBtn: document.getElementById('select-castle-btn'),
            castleInput: document.getElementById('castle-input'),
            playerGender: document.getElementById('player-gender'),
            statusMessage: document.getElementById('status-message'),
            currentCastle: document.getElementById('current-castle'),
            castleNameDisplay: document.getElementById('castle-name'),
            resetCountDisplay: document.getElementById('reset-count-display'),
            castleAssignments: document.getElementById('castle-assignments'),
            spinnerContainer: document.getElementById('spinner-container'),
            spinnerText: document.getElementById('spinner-text'),
            themeModal: document.getElementById('theme-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalMessage: document.getElementById('modal-message'),
            modalConfirm: document.getElementById('modal-confirm'),
            modalCancel: document.getElementById('modal-cancel'),
            langSelector: document.getElementById('lang-selector')
        };

        // --- CORE FUNCTIONS ---
        function setLanguage(langCode) {
            const translations = TRANSLATIONS[langCode] || TRANSLATIONS['en'];
            currentLang = langCode;
            localStorage.setItem('hp_language', langCode);
            document.title = translations['doc_title'];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[key]) el.innerHTML = translations[key];
            });
            displayStatus('info', 'status_default');
            if (currentAssignment) displayFinalResult(currentAssignment.characterName, currentAssignment.gender, true);
        }

        function setupLanguageSelector() {
            Object.keys(TRANSLATIONS).forEach(code => {
                const opt = document.createElement('option');
                opt.value = code;
                opt.textContent = TRANSLATIONS[code]['lang_name'];
                opt.style.backgroundColor = '#1a1a1a'; // Match dark header
                ELEMENTS.langSelector.appendChild(opt);
            });
            ELEMENTS.langSelector.value = currentLang;
            setLanguage(currentLang);
            ELEMENTS.langSelector.addEventListener('change', (e) => setLanguage(e.target.value));
        }

        // --- CUSTOM DROPDOWN LOGIC ---
        function initCustomSelects() {
            const genderTrigger = document.getElementById('gender-trigger');
            const genderContainer = document.getElementById('gender-select-wrapper');
            const genderOptions = document.getElementById('gender-options');
            const genderInput = document.getElementById('player-gender');

            const options = [
                { value: 'Male', labelKey: 'male_chars' },
                { value: 'Female', labelKey: 'female_chars' },
                { value: 'Creatures', labelKey: 'creatures_chars' }
            ];

            function renderOptions() {
                genderOptions.innerHTML = '';
                options.forEach(opt => {
                    const div = document.createElement('div');
                    div.className = 'custom-option';
                    div.innerHTML = TRANSLATIONS[currentLang][opt.labelKey];
                    div.onclick = (e) => {
                        e.stopPropagation();
                        genderInput.value = opt.value;
                        document.getElementById('gender-selected-text').innerHTML = div.innerHTML;
                        genderContainer.classList.remove('open');
                        // Update visual selection
                        document.querySelectorAll('.custom-option').forEach(o => o.classList.remove('selected'));
                        div.classList.add('selected');
                    };
                    genderOptions.appendChild(div);
                });
            }

            genderTrigger.onclick = (e) => {
                e.stopPropagation();
                genderContainer.classList.toggle('open');
                renderOptions();
            };

            window.addEventListener('click', () => genderContainer.classList.remove('open'));
        }

        function getCastleData(id) {
            const all = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            if (!all[id]) {
                all[id] = { resetsLeft: MAX_RESETS, assignment: null, usedCharacters: [] };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(all));
            }
            return all[id];
        }

        function saveCastleData(id, data) {
            const all = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            all[id] = data;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(all));
        }

        function displayStatus(type, key, p1, p2) {
            const translations = TRANSLATIONS[currentLang] || TRANSLATIONS['en'];
            let msg = translations[key] || key;
            if (p1) msg = msg.replace('$1', p1);
            if (p2) msg = msg.replace('$2', p2);
            
            ELEMENTS.statusMessage.innerHTML = `<i class="fa-solid fa-scroll mr-2"></i> ${msg}`;
            ELEMENTS.statusMessage.className = `status-parchment status-${type} text-lg wizard-script ink-splotch`;
        }

        async function selectCastle() {
            const id = ELEMENTS.castleInput.value.trim();
            if (!id) return displayStatus('error', 'status_enter_name');
            currentCastle = id;
            
            ELEMENTS.currentCastle.textContent = id;
            ELEMENTS.castleNameDisplay.textContent = id;
            
            // Try fetching from global database first
            try {
                const resp = await fetch(`${LOCAL_API_URL}/get_global_assignment/${encodeURIComponent(id)}`);
                const globalData = await resp.json();
                if (globalData) {
                    currentAssignment = {
                        characterName: globalData.identity,
                        gender: globalData.pool,
                        house: globalData.house,
                        timestamp: globalData.timestamp
                    };
                    displayFinalResult(currentAssignment.characterName, currentAssignment.gender, true, currentAssignment.house);
                } else {
                    const localData = getCastleData(id);
                    ELEMENTS.resetCountDisplay.textContent = localData.resetsLeft;
                    if (localData.assignment) {
                        currentAssignment = localData.assignment;
                        displayFinalResult(localData.assignment.characterName, localData.assignment.gender, true);
                    } else {
                        currentAssignment = null;
                        ELEMENTS.resultDisplay.classList.add('hidden');
                        displayStatus('info', 'status_ready', id);
                    }
                }
            } catch (err) {
                console.warn('Local server not reachable, using local storage.');
                const data = getCastleData(id);
                ELEMENTS.resetCountDisplay.textContent = data.resetsLeft;
                if (data.assignment) {
                    currentAssignment = data.assignment;
                    displayFinalResult(data.assignment.characterName, data.assignment.gender, true);
                } else {
                    currentAssignment = null;
                    ELEMENTS.resultDisplay.classList.add('hidden');
                    displayStatus('info', 'status_ready', id);
                }
            }
            ELEMENTS.castleSelection.classList.add('hidden');
            ELEMENTS.assignmentForm.classList.remove('hidden');
        }

        async function startAssignment() {
            const pool = ELEMENTS.playerGender.value;
            if (!pool) return displayStatus('error', 'status_select_pool');
            const data = getCastleData(currentCastle);
            ELEMENTS.assignBtn.disabled = true;
            ELEMENTS.assignmentForm.classList.add('hidden');
            ELEMENTS.spinnerContainer.classList.remove('hidden');
            ELEMENTS.spinnerText.classList.add('glitch-anim');

            let assigned = null;
            let house = "neutral";
            
            try {
                // Fetch all assigned identities from the global database
                const resp = await fetch(`${LOCAL_API_URL}/get_all_assigned`);
                const globallyAssigned = await resp.json();
                
                const charPool = CHARACTERS[pool];
                // Exclude characters taken by ANYONE globally
                const available = charPool.filter(c => !globallyAssigned.includes(c));
                let finalPool = available.length > 0 ? available : charPool;
                
                assigned = finalPool[Math.floor(Math.random() * finalPool.length)];
                house = HOUSE_MAP[assigned] || "neutral";

                // Save to global database
                await fetch(`${LOCAL_API_URL}/save_global_assignment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        alias: currentCastle,
                        identity: assigned,
                        pool: pool,
                        house: house
                    })
                });

            } catch (err) {
                console.error('Global database failure, falling back to local storage:', err);
                const charPool = CHARACTERS[pool];
                const available = charPool.filter(c => !data.usedCharacters.includes(c));
                let finalPool = available.length > 0 ? available : charPool;
                assigned = finalPool[Math.floor(Math.random() * finalPool.length)];
                house = HOUSE_MAP[assigned] || "neutral";
            }

            setTimeout(() => {
                data.assignment = { characterName: assigned, gender: pool, house: house, timestamp: new Date().toISOString() };
                data.usedCharacters.push(assigned);
                saveCastleData(currentCastle, data);
                currentAssignment = data.assignment;
                sendToDiscord(currentCastle, assigned, pool, house);
                ELEMENTS.spinnerContainer.classList.add('hidden');
                createRevealVFX();
                displayFinalResult(assigned, pool, false, house);
                loadLog();
            }, 3000);
        }

        const BESTIARY_ASSETS = {
            'Hungarian Horntail': 'assets/hp_bestiary_dragon_1769555007191.png',
            'Dragon': 'assets/hp_bestiary_dragon_1769555007191.png',
            'Hebridian Black': 'assets/hp_bestiary_dragon_1769555007191.png',
            'Hedwig': 'assets/hp_bestiary_owl_1769555023115.png',
            'Snowy Owl': 'assets/hp_bestiary_owl_1769555023115.png',
            'Barn Owl': 'assets/hp_bestiary_owl_1769555023115.png',
            'Owl': 'assets/hp_bestiary_owl_1769555023115.png',
            'Niffler': 'assets/hp_bestiary_niffler_1769555038067.png',
            'Buckbeak': 'assets/hp_bestiary_hippogriff_1769555059251.png',
            'Hippogriff': 'assets/hp_bestiary_hippogriff_1769555059251.png',
            'Phoenix': 'assets/hp_bestiary_phoenix.png',
            'Fawkes': 'assets/hp_bestiary_phoenix.png',
            'Basilisk': 'assets/hp_bestiary_basilisk.png',
            'Dementor': 'assets/hp_bestiary_dementor.png',
            'unknown': 'assets/hp_bestiary_unknown_1769555275736.png'
        };

        const BESTIARY_GALLERY = [...new Set(Object.values(BESTIARY_ASSETS))].filter(v => v !== BESTIARY_ASSETS['unknown']);
        let galleryIndex = 0;
        let galleryInterval = null;

        function startGalleryCycle(opacity = '0.4') {
            if (galleryInterval) clearInterval(galleryInterval);
            const container = document.getElementById('bestiary-illustration-container');
            const img = document.getElementById('bestiary-image');
            
            const nextSlide = () => {
                img.style.opacity = '0';
                setTimeout(() => {
                    img.src = BESTIARY_GALLERY[galleryIndex];
                    img.style.opacity = opacity;
                    galleryIndex = (galleryIndex + 1) % BESTIARY_GALLERY.length;
                    container.classList.remove('hidden');
                }, 500);
            };
            
            nextSlide();
            galleryInterval = setInterval(nextSlide, 5000);
        }

        function displayFinalResult(name, pool, isExisting, houseCode) {
            const hCode = houseCode || (currentAssignment ? currentAssignment.house : 'neutral');
            const translations = TRANSLATIONS[currentLang] || TRANSLATIONS['en'];
            const houseName = translations[`house_${hCode}`] || translations['house_neutral'];
            
            ELEMENTS.resultName.textContent = name.toUpperCase();
            ELEMENTS.houseBadge.innerHTML = `
                <div class="inline-block px-6 py-2 border-2 border-hp-border text-hp-burgundy hp-font text-lg rounded-full bg-white/50 shadow-lg transform rotate-[-1deg] hover:rotate-0 transition-all cursor-default mb-4">
                    ${translations['house_label']} ${houseName.toUpperCase()}
                </div>
            `;
            ELEMENTS.poolDisplay.textContent = `${pool} POOL`;

            // Selective House Visibility
            if (pool === 'Creatures') {
                ELEMENTS.houseBadge.classList.add('hidden');
            } else {
                ELEMENTS.houseBadge.classList.remove('hidden');
            }

            // Living Bestiary Logic
            const resultImg = document.getElementById('bestiary-image');
            const container = document.getElementById('bestiary-illustration-container');
            
            // Normalize name for lookup
            const assetPath = BESTIARY_ASSETS[name];

            if (galleryInterval) clearInterval(galleryInterval);

            if (assetPath) {
                resultImg.src = assetPath;
                resultImg.classList.remove('animate-ink-reveal', 'animate-breathing');
                container.classList.remove('hidden');
                resultImg.style.opacity = '1';
                
                // Trigger animations
                setTimeout(() => {
                    resultImg.classList.add('animate-ink-reveal');
                    setTimeout(() => resultImg.classList.add('animate-breathing'), 2000);
                }, 100);
            } else if (pool === 'Creatures') {
                // Fallback for generic creatures: Cycle the gallery!
                startGalleryCycle('0.8');
            } else {
                container.classList.add('hidden');
            }
            
            ELEMENTS.assignmentForm.classList.add('hidden');
            ELEMENTS.resultDisplay.classList.remove('hidden');
            setTimeout(() => ELEMENTS.resultDisplay.classList.add('result-display-visible'), 100);
            const data = getCastleData(currentCastle);
            ELEMENTS.resetCountDisplay.textContent = data.resetsLeft;
            ELEMENTS.resetBtn.disabled = data.resetsLeft <= 0;
            displayStatus(isExisting ? 'info' : 'success', isExisting ? 'result_welcome' : 'result_secured', name.toUpperCase(), currentCastle);
        }

        function performReset() {
            const data = getCastleData(currentCastle);
            data.resetsLeft--;
            data.assignment = null;
            saveCastleData(currentCastle, data);
            currentAssignment = null;
            ELEMENTS.resultDisplay.classList.add('hidden');
            ELEMENTS.assignmentForm.classList.remove('hidden');
            ELEMENTS.assignBtn.disabled = false;
            displayStatus('warning', 'status_reset_complete', data.resetsLeft, currentCastle);
            loadLog();
        }

        // --- MAGICAL MANIFESTATIONS (REAL VFX) ---
        const CREATURE_VFX = {
            dragon: '<svg viewBox="0 0 100 100" width="400"><path d="M10,50 Q30,10 50,50 T90,50 Q70,90 50,50 T10,50 M30,30 L40,20 M60,30 L70,20" /></svg>',
            snitch: '<svg viewBox="0 0 100 100" width="40"><circle cx="50" cy="50" r="10" fill="gold"/><path d="M40,50 Q20,20 10,50 Q20,80 40,50 Z" fill="rgba(255,255,255,0.5)"/><path d="M60,50 Q80,20 90,50 Q80,80 60,50 Z" fill="rgba(255,255,255,0.5)"/></svg>',
            owl: '<svg viewBox="0 0 100 100" width="120"><path d="M20,40 Q50,0 80,40 Q50,60 20,40 M45,40 L55,40 M45,45 L55,45" /></svg>'
        };

        function manifestCreature() {
            const types = ['dragon', 'snitch', 'owl'];
            const type = types[Math.floor(Math.random() * types.length)];
            const div = document.createElement('div');
            div.className = 'manifestation';
            div.innerHTML = CREATURE_VFX[type];
            
            if(type === 'dragon') {
                div.style.animation = 'dragon-pass 20s linear forwards';
            } else if(type === 'snitch') {
                div.style.animation = 'snitch-flutter 15s ease-in-out forwards';
                div.querySelector('svg').style.fill = 'gold';
            } else {
                div.style.animation = 'owl-glide 25s linear forwards';
            }

            document.body.appendChild(div);
            setTimeout(() => div.remove(), 26000);
        }

        function createRevealVFX() {
            const container = document.body;
            for(let i=0; i<30; i++) {
                const s = document.createElement('div');
                s.className = 'reveal-sparkle';
                const tx = (Math.random() - 0.5) * 600 + 'px';
                const ty = (Math.random() - 0.5) * 600 + 'px';
                s.style.setProperty('--tx', tx);
                s.style.setProperty('--ty', ty);
                s.style.animation = `sparkle-burst ${1 + Math.random()}s forwards`;
                container.appendChild(s);
                setTimeout(() => s.remove(), 2000);
            }
        }

        // Random sightings every 8-20 seconds for a more "alive" castle
        setInterval(() => {
            if(Math.random() > 0.4) manifestCreature();
        }, 12000);

        function shareIdentity() {
            const translations = TRANSLATIONS[currentLang] || TRANSLATIONS['en'];
            const houseName = translations[`house_${currentAssignment.house}`] || translations['house_neutral'];
            const text = `🏰 HOGWARTS SECURED 🏰\nWIZARD: ${currentCastle}\nIDENTITY: ${currentAssignment.characterName}\nHOUSE: ${houseName}\nPOOL: ${currentAssignment.gender}\nSorting via Noyzzing HQ`;
            navigator.clipboard.writeText(text).then(() => displayStatus('success', 'status_copy_success'));
        }

        async function sendToDiscord(alias, id, pool, house) {
            try {
                const payload = {
                    embeds: [{
                        title: `✨ MAGICAL IDENTIFICATION ✨`,
                        description: `A unique identity has been forged for **${alias}**.`,
                        color: 13933367, // #d4af37 Gold
                        fields: [
                            { name: 'User', value: alias, inline: true },
                            { name: 'Assigned', value: id, inline: true }
                        ],
                        footer: { text: 'Alliance name ROL' },
                        timestamp: new Date().toISOString()
                    }]
                };

                // Try direct fetch first (like Stranger Things)
                try {
                    const respDirect = await fetch(DISCORD_WEBHOOK, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (respDirect && respDirect.ok) return true;
                } catch (err) {
                    console.warn('Direct magic failed, trying proxy...');
                }

                // Fallback to proxy
                try {
                    const respProxy = await fetch(DISCORD_WEBHOOK_PROXY, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (respProxy && respProxy.ok) return true;
                } catch (err) {
                    console.error('All magical transmissions failed');
                }

                return true;
            } catch (error) {
                console.error('Discord logic failure', error);
                return false;
            }
        }

        function loadLog() {
            const all = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            let html = '';
            
            Object.entries(all).forEach(([id, data]) => {
                if (data.assignment) {
                    const hClass = `house-${data.assignment.house || 'neutral'}`;
                    html += `<div class="p-3 border border-hp-border/30 rounded mb-2 hover:bg-hp-burgundy/5 cursor-pointer transition-all ${hClass}" onclick="ELEMENTS.castleInput.value='${id}'; selectCastle();">
                        <div class="font-bold text-hp-burgundy">${id}</div>
                        <div class="text-[10px] text-hp-border uppercase tracking-widest">${data.assignment.characterName}</div>
                    </div>`;
                }
            });
            ELEMENTS.castleAssignments.innerHTML = html || `<p class="text-gray-600 text-center italic">The log is empty.</p>`;
        }

        function showModal() {
            ELEMENTS.themeModal.classList.remove('hidden');
            ELEMENTS.modalMessage.textContent = TRANSLATIONS[currentLang]['status_reset_confirm_msg'].replace('$1', getCastleData(currentCastle).resetsLeft).replace('$2', currentCastle);
            setTimeout(() => ELEMENTS.themeModal.style.opacity = '1', 10);
        }

        function hideModal() {
            ELEMENTS.themeModal.style.opacity = '0';
            setTimeout(() => ELEMENTS.themeModal.classList.add('hidden'), 300);
        }

        // --- INIT ---
        setupLanguageSelector();
        initCustomSelects();
        ELEMENTS.selectCastleBtn.onclick = selectCastle;
        ELEMENTS.assignBtn.onclick = startAssignment;
        ELEMENTS.newCastleBtn.onclick = () => { 
            ELEMENTS.castleSelection.classList.remove('hidden'); 
            ELEMENTS.resultDisplay.classList.add('hidden'); 
            ELEMENTS.assignmentForm.classList.add('hidden'); 
            startGalleryCycle('0.4');
        };
        ELEMENTS.resetBtn.onclick = showModal;
        ELEMENTS.modalConfirm.onclick = () => { hideModal(); performReset(); startGalleryCycle('0.4'); };
        document.getElementById('modal-cancel').onclick = hideModal;
        loadLog();

        // Start initial Gallery loop
        startGalleryCycle('0.4');

        // === CINEMATIC VFX SYSTEM ===
        console.log('🎬 Initializing Cinematic VFX System...');
        
        // Cinematic Overlay & Light Leak
        const cinematic = document.createElement('div');
        cinematic.className = 'cinematic-overlay';
        document.body.appendChild(cinematic);

        const leak = document.createElement('div');
        leak.className = 'light-leak';
        document.body.appendChild(leak);

        // Create Floating Candles (Enhanced)
        const isMobile = window.innerWidth < 768;
        const candleCount = isMobile ? 8 : 20;
        for(let i=0; i<candleCount; i++) {
            const c = document.createElement('div');
            c.className = 'candle';
            c.style.left = Math.random() * 100 + 'vw';
            c.style.top = (Math.random() * 80 + 10) + 'vh';
            c.style.animationDelay = Math.random() * 5 + 's';
            c.innerHTML = '<div class="flame"></div>';
            document.body.appendChild(c);
        }
        console.log(`🕯️ Created ${candleCount} floating candles`);

        // Create Golden Magic Particles (50 floating particles with parallax)
        const particleCount = isMobile ? 15 : 50;
        for(let i=0; i<particleCount; i++) {
            const p = document.createElement('div');
            const size = Math.random();
            p.className = `magic-particle ${size > 0.8 ? 'particle-lg' : size > 0.4 ? 'particle-md' : 'particle-sm'}`;
            p.style.left = Math.random() * 100 + 'vw';
            p.style.setProperty('--tx', (Math.random() - 0.5) * 300 + 'px');
            p.style.animationDuration = (10 + Math.random() * 20) + 's';
            p.style.animationDelay = (-Math.random() * 20) + 's';
            document.body.appendChild(p);
        }
        console.log(`✨ Created ${particleCount} golden particles`);

        // Create Moving Shadows (Random intervals)
        function createShadow() {
            const s = document.createElement('div');
            s.className = 'shadow-pass';
            s.style.top = (Math.random() * 60) + 'vh';
            s.style.animationDuration = (20 + Math.random() * 10) + 's';
            document.body.appendChild(s);
            setTimeout(() => s.remove(), 35000);
        }
        setInterval(createShadow, 15000);
        createShadow();

        // Create Light Rays
        for(let i=0; i<8; i++) {
            const ray = document.createElement('div');
            ray.className = 'light-ray';
            ray.style.left = (i * 12 + Math.random() * 5) + 'vw';
            ray.style.animationDelay = Math.random() * 8 + 's';
            document.body.appendChild(ray);
        }

        // Create Ambient Glow Orbs
        for(let i=0; i<6; i++) {
            const orb = document.createElement('div');
            orb.className = 'glow-orb';
            orb.style.left = Math.random() * 100 + 'vw';
            orb.style.top = Math.random() * 100 + 'vh';
            orb.style.animationDelay = Math.random() * 20 + 's';
            orb.style.animationDuration = (15 + Math.random() * 10) + 's';
            document.body.appendChild(orb);
        }
        console.log('🌟 VFX System Ready! Check for particles, candles, and light rays.');
    </script>
</body>
</html>
