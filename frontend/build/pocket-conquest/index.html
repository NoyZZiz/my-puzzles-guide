<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pocket Conquest - Time Recruit Edition</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Rajdhani:wght@500;600;700&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --gold: #f59e0b;
            --gold-dark: #b45309;
            --purple: #a855f7;
            --purple-dark: #7c3aed;
            --green: #22c55e;
            --blue: #3b82f6;
            --red: #ef4444;
            --dark: #0a0a0f;
            --panel: #1e293b;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--dark);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        /* SCREENS */
        .screen {
            display: none;
            min-height: 100vh;
            padding: 20px;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
        }

        .hidden {
            display: none !important;
        }

        /* ========== TITLE SCREEN ========== */
        #titleScreen {
            background:
                radial-gradient(ellipse at 50% 30%, rgba(168, 85, 247, 0.2) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 70%, rgba(245, 158, 11, 0.15) 0%, transparent 50%),
                var(--dark);
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .game-logo {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            letter-spacing: 6px;
            background: linear-gradient(135deg, var(--gold), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 0 0 50px rgba(168, 85, 247, 0.5);
        }

        .game-subtitle {
            font-size: 1rem;
            color: var(--gold);
            letter-spacing: 8px;
            margin-bottom: 60px;
            opacity: 0.8;
        }

        .title-btn {
            padding: 18px 60px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: 4px;
            text-transform: uppercase;
            background: linear-gradient(135deg, var(--purple), var(--purple-dark));
            border: 2px solid var(--purple);
            border-radius: 50px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .title-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.5);
        }

        .title-btn.secondary {
            background: transparent;
            border-color: var(--gold);
            color: var(--gold);
        }

        .title-btn.secondary:hover {
            background: var(--gold);
            color: black;
        }

        /* ========== CHARACTER SELECT ========== */
        #characterSelect {
            background:
                radial-gradient(ellipse at 50% 0%, rgba(168, 85, 247, 0.15) 0%, transparent 50%),
                var(--dark);
        }

        .screen-title {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            text-align: center;
            color: var(--gold);
            letter-spacing: 5px;
            margin-bottom: 30px;
            padding-top: 20px;
        }

        .setup-fields {
            max-width: 400px;
            margin: 0 auto 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .field-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .field-group label {
            font-size: 0.85rem;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .field-group input,
        .field-group select {
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid #334155;
            border-radius: 10px;
            padding: 12px 15px;
            font-size: 1rem;
            color: white;
            font-family: 'Rajdhani', sans-serif;
            transition: border-color 0.3s;
        }

        .field-group input:focus,
        .field-group select:focus {
            outline: none;
            border-color: var(--purple);
        }

        .field-group input::placeholder {
            color: #64748b;
        }

        .character-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .character-card {
            background: linear-gradient(135deg, var(--panel), rgba(30, 41, 59, 0.5));
            border: 3px solid #334155;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .character-card:hover {
            border-color: var(--purple);
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(168, 85, 247, 0.2);
        }

        .character-card.selected {
            border-color: var(--gold);
            box-shadow: 0 0 30px rgba(245, 158, 11, 0.4);
        }

        .character-portrait {
            width: 120px;
            height: 120px;
            margin: 0 auto 15px;
            border-radius: 50%;
            border: 3px solid #475569;
            overflow: hidden;
            background: var(--dark);
        }

        .character-portrait img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .character-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: white;
            margin-bottom: 5px;
        }

        .character-desc {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .confirm-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 40px auto 0;
            padding: 15px 40px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: 3px;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            border: none;
            border-radius: 30px;
            color: black;
            cursor: pointer;
            transition: all 0.3s;
        }

        .confirm-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(245, 158, 11, 0.5);
        }

        .confirm-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ========== HOME SCREEN ========== */
        #homeScreen {
            background:
                radial-gradient(ellipse at 30% 20%, rgba(34, 197, 94, 0.1) 0%, transparent 40%),
                radial-gradient(ellipse at 70% 80%, rgba(168, 85, 247, 0.1) 0%, transparent 40%),
                var(--dark);
        }

        .home-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0 30px;
        }

        .player-profile {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .player-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid var(--gold);
            overflow: hidden;
        }

        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .player-info h3 {
            font-size: 1.1rem;
            color: var(--gold);
        }

        .player-alliance {
            background: linear-gradient(90deg, var(--purple-dark), var(--purple));
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            margin-top: 4px;
        }

        .player-info p {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .currency-display {
            display: flex;
            gap: 15px;
        }

        .currency-item {
            display: flex;
            align-items: center;
            gap: 0;
            background: var(--panel);
            padding: 8px 15px 8px 5px;
            border-radius: 25px;
            border: 1px solid #334155;
        }

        .currency-icon {
            font-size: 1.3rem;
        }

        .currency-icon-img {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        .tr-coin-header {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }

        .currency-amount {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--gold);
        }

        /* Menu Grid */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            max-width: 500px;
            margin: 0 auto;
        }

        .menu-item {
            background: linear-gradient(135deg, var(--panel), rgba(30, 41, 59, 0.7));
            border: 2px solid #334155;
            border-radius: 20px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .menu-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .menu-item.time-recruit {
            border-color: var(--purple);
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), var(--panel));
        }

        .menu-item.time-recruit:hover {
            box-shadow: 0 10px 40px rgba(168, 85, 247, 0.3);
        }

        .menu-item.search {
            border-color: var(--green);
        }

        .menu-item.search:hover {
            box-shadow: 0 10px 40px rgba(34, 197, 94, 0.3);
        }

        .menu-item.heroes {
            border-color: var(--blue);
        }

        .menu-item.gym {
            border-color: var(--red);
        }

        .menu-icon-text {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 10px;
            text-shadow: 0 0 15px rgba(245, 158, 11, 0.3);
        }

        .menu-label {
            font-size: 0.9rem;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .menu-status {
            font-size: 0.7rem;
            color: var(--gold);
            opacity: 0.7;
        }

        .menu-status.locked {
            color: #64748b;
        }

        /* ========== TIME RECRUIT SCREEN - PREMIUM GACHA STYLE ========== */
        #timeRecruitScreen {
            background: var(--dark);
            overflow: hidden;
            position: relative;
        }

        #timeRecruitScreen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse at 50% 40%, rgba(168, 85, 247, 0.3) 0%, transparent 50%),
                radial-gradient(ellipse at 30% 70%, rgba(124, 58, 237, 0.2) 0%, transparent 40%),
                radial-gradient(ellipse at 70% 80%, rgba(245, 158, 11, 0.15) 0%, transparent 40%);
            pointer-events: none;
        }

        .time-recruit-container {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 70px 20px 40px;
        }

        /* Header Section */
        .tr-title-section {
            text-align: center;
            margin-bottom: 20px;
        }

        .tr-title {
            font-family: 'Cinzel', serif;
            font-size: 2.2rem;
            letter-spacing: 8px;
            background: linear-gradient(135deg, var(--gold), #fbbf24, var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 40px rgba(245, 158, 11, 0.3);
            margin-bottom: 15px;
        }

        .tr-subtitle {
            font-size: 0.9rem;
            color: #94a3b8;
            letter-spacing: 3px;
        }

        /* Coin Display */
        .tr-coins-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.9));
            border: 2px solid var(--purple);
            border-radius: 40px;
            padding: 12px 30px;
            margin-bottom: 30px;
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.2);
        }

        .tr-coins-display img {
            width: 28px;
            height: 28px;
            animation: coinSpin 3s linear infinite;
        }

        @keyframes coinSpin {
            0% {
                transform: rotateY(0deg);
            }

            50% {
                transform: rotateY(180deg);
            }

            100% {
                transform: rotateY(360deg);
            }
        }

        .tr-coins-display .coin-count {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gold);
        }

        .tr-coins-display .coin-label {
            font-size: 0.8rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* MAGICAL PORTAL */
        .portal-container {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 20px auto 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Outer Ring */
        .portal-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 4px solid transparent;
            border-top-color: var(--purple);
            border-right-color: var(--gold);
            animation: portalSpin 4s linear infinite;
        }

        .portal-ring::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border-radius: 50%;
            border: 2px dashed rgba(168, 85, 247, 0.4);
            animation: portalSpinReverse 6s linear infinite;
        }

        @keyframes portalSpin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes portalSpinReverse {
            to {
                transform: rotate(-360deg);
            }
        }

        /* Inner Portal Glow */
        .portal-core {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background:
                radial-gradient(circle at 30% 30%, rgba(168, 85, 247, 0.8) 0%, transparent 50%),
                radial-gradient(circle at 70% 70%, rgba(124, 58, 237, 0.6) 0%, transparent 50%),
                radial-gradient(circle, rgba(168, 85, 247, 0.4) 0%, rgba(124, 58, 237, 0.2) 50%, transparent 70%);
            animation: portalPulse 2s ease-in-out infinite;
            box-shadow:
                0 0 60px rgba(168, 85, 247, 0.5),
                inset 0 0 60px rgba(168, 85, 247, 0.3);
        }

        @keyframes portalPulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.9;
            }

            50% {
                transform: scale(1.1);
                opacity: 1;
            }
        }

        /* Portal Icon */
        .portal-icon {
            position: relative;
            font-size: 4rem;
            z-index: 2;
            animation: portalIconFloat 3s ease-in-out infinite;
            text-shadow: 0 0 30px rgba(168, 85, 247, 0.8);
        }

        @keyframes portalIconFloat {

            0%,
            100% {
                transform: translateY(0) scale(1);
            }

            50% {
                transform: translateY(-10px) scale(1.1);
            }
        }

        /* Floating Particles */
        .particles-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: var(--purple);
            border-radius: 50%;
            animation: particleFloat 4s infinite ease-in-out;
            box-shadow: 0 0 10px var(--purple);
        }

        .particle:nth-child(1) {
            left: 20%;
            animation-delay: 0s;
            background: var(--gold);
        }

        .particle:nth-child(2) {
            left: 40%;
            animation-delay: 0.5s;
        }

        .particle:nth-child(3) {
            left: 60%;
            animation-delay: 1s;
            background: var(--gold);
        }

        .particle:nth-child(4) {
            left: 80%;
            animation-delay: 1.5s;
        }

        .particle:nth-child(5) {
            left: 10%;
            animation-delay: 2s;
        }

        .particle:nth-child(6) {
            left: 30%;
            animation-delay: 2.5s;
            background: var(--gold);
        }

        .particle:nth-child(7) {
            left: 50%;
            animation-delay: 3s;
        }

        .particle:nth-child(8) {
            left: 70%;
            animation-delay: 3.5s;
            background: var(--gold);
        }

        .particle:nth-child(9) {
            left: 90%;
            animation-delay: 0.25s;
        }

        .particle:nth-child(10) {
            left: 15%;
            animation-delay: 1.25s;
            background: var(--gold);
        }

        @keyframes particleFloat {
            0% {
                bottom: -10px;
                opacity: 0;
                transform: scale(0.5);
            }

            20% {
                opacity: 1;
            }

            80% {
                opacity: 1;
            }

            100% {
                bottom: 100%;
                opacity: 0;
                transform: scale(1.5);
            }
        }

        /* Summon Section */
        .summon-section {
            width: 100%;
            max-width: 320px;
            text-align: center;
        }

        .summon-btn-premium {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            width: 100%;
            padding: 20px 40px;
            background: linear-gradient(135deg, var(--purple), var(--purple-dark));
            border: none;
            border-radius: 60px;
            color: white;
            font-family: 'Cinzel', serif;
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: 4px;
            cursor: pointer;
            transition: all 0.3s;
            overflow: hidden;
            box-shadow:
                0 10px 40px rgba(168, 85, 247, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .summon-btn-premium::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: btnShine 3s infinite;
        }

        @keyframes btnShine {
            0% {
                left: -100%;
            }

            50%,
            100% {
                left: 100%;
            }
        }

        .summon-btn-premium:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow:
                0 15px 50px rgba(168, 85, 247, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .summon-btn-premium:active {
            transform: translateY(0) scale(0.98);
        }

        .summon-btn-premium img {
            width: 32px;
            height: 32px;
        }

        .summon-info {
            margin-top: 20px;
        }

        .summon-cost-text {
            font-size: 1rem;
            color: var(--gold);
            font-weight: 600;
            margin-bottom: 10px;
        }

        .summon-hint-text {
            font-size: 0.85rem;
            color: #64748b;
            line-height: 1.6;
        }

        /* Hero Preview Cards (decorative) */
        .hero-preview-cards {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            opacity: 0.6;
        }

        .preview-card {
            width: 50px;
            height: 65px;
            background: linear-gradient(135deg, var(--panel), #0f172a);
            border: 2px solid #334155;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            animation: cardFloat 2s ease-in-out infinite;
        }

        .preview-card:nth-child(1) {
            animation-delay: 0s;
            border-color: var(--purple);
        }

        .preview-card:nth-child(2) {
            animation-delay: 0.3s;
            border-color: var(--gold);
        }

        .preview-card:nth-child(3) {
            animation-delay: 0.6s;
            border-color: var(--green);
        }

        @keyframes cardFloat {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        /* Mobile Responsive */
        @media (max-width: 480px) {
            .tr-title {
                font-size: 1.6rem;
                letter-spacing: 4px;
            }

            .portal-container {
                width: 220px;
                height: 220px;
            }

            .portal-core {
                width: 160px;
                height: 160px;
            }

            .portal-icon {
                font-size: 3rem;
            }

            .summon-btn-premium {
                font-size: 1.2rem;
                padding: 16px 30px;
            }
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--panel);
            border: 2px solid #475569;
            border-radius: 10px;
            padding: 10px 20px;
            color: white;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10;
        }

        .back-btn:hover {
            border-color: white;
        }

        /* ========== SEARCH / ENCOUNTER SCREEN ========== */
        #searchScreen {
            background:
                radial-gradient(ellipse at 50% 50%, rgba(34, 197, 94, 0.15) 0%, transparent 50%),
                var(--dark);
        }

        .encounter-area {
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
        }

        .search-btn {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--green), #16a34a);
            border: 4px solid #4ade80;
            color: white;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            letter-spacing: 3px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 40px auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .search-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 50px rgba(34, 197, 94, 0.5);
        }

        .search-btn .icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .encounter-info {
            color: #94a3b8;
            font-size: 0.9rem;
            margin-top: 20px;
        }

        /* ========== HERO ROSTER SCREEN ========== */
        #heroesScreen {
            background: var(--dark);
        }

        .hero-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .hero-slot {
            aspect-ratio: 1;
            background: var(--panel);
            border: 2px solid #334155;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .hero-slot.empty {
            opacity: 0.5;
        }

        .hero-slot:hover {
            border-color: var(--gold);
            transform: scale(1.05);
        }

        .hero-slot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .hero-level {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: var(--gold);
            color: black;
            font-size: 0.7rem;
            font-weight: 700;
            border-radius: 10px;
        }

        .empty-slot-text {
            color: #475569;
            font-size: 2rem;
        }

        .coming-soon-box {
            max-width: 400px;
            margin: 100px auto 0;
            text-align: center;
            padding: 40px;
            background: var(--panel);
            border-radius: 20px;
            border: 2px solid #334155;
        }

        .coming-soon-box .coming-soon-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .coming-soon-box h3 {
            color: var(--gold);
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .coming-soon-box p {
            color: #cbd5e1;
            margin-bottom: 10px;
        }

        /* ========== HEROES GRID ========== */
        .heroes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            padding: 80px 40px 40px;
            max-width: 800px;
            margin: 0 auto;
        }

        .hero-card {
            background: var(--panel);
            border: 2px solid #334155;
            border-radius: 15px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .hero-card:hover {
            border-color: var(--gold);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .hero-card-img {
            width: 100%;
            height: 150px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        .hero-card-name {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 5px;
        }

        .hero-card-type {
            font-size: 0.8rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .hero-card-level {
            font-size: 0.9rem;
            font-weight: 700;
            color: #22c55e;
            margin-top: 5px;
        }

        /* ========== MODAL OVERLAY ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        /* ========== SUMMON MODAL ========== */
        .summon-modal {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px;
            max-width: 400px;
            text-align: center;
        }

        .summon-glow {
            position: absolute;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(168, 85, 247, 0.6) 0%, transparent 70%);
            border-radius: 50%;
            animation: summonGlow 2s ease-in-out infinite;
        }

        @keyframes summonGlow {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.8;
            }

            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        .summon-hero-reveal {
            position: relative;
            z-index: 1;
            animation: heroReveal 0.8s ease-out;
        }

        @keyframes heroReveal {
            0% {
                transform: scale(0) rotate(-10deg);
                opacity: 0;
            }

            50% {
                transform: scale(1.2) rotate(5deg);
                opacity: 1;
            }

            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .summon-hero-img {
            width: 200px;
            height: 250px;
            object-fit: contain;
            filter: drop-shadow(0 0 30px rgba(168, 85, 247, 0.8));
        }

        .summon-hero-info {
            position: relative;
            z-index: 1;
            margin-top: 20px;
            animation: fadeInUp 0.5s ease-out 0.3s both;
        }

        @keyframes fadeInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .summon-rarity {
            display: inline-block;
            padding: 4px 16px;
            background: linear-gradient(135deg, #a855f7, #7c3aed);
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            letter-spacing: 2px;
            color: white;
            margin-bottom: 10px;
        }

        .summon-hero-name {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            color: var(--gold);
            margin-bottom: 5px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .summon-hero-type {
            font-size: 1rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 20px;
        }

        .summon-stats {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .stat-box {
            display: flex;
            flex-direction: column;
            background: var(--panel);
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid #334155;
        }

        .stat-label {
            font-size: 0.7rem;
            color: #64748b;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: white;
        }

        .summon-close-btn {
            margin-top: 30px;
            padding: 15px 40px;
            background: transparent;
            border: 2px solid var(--gold);
            border-radius: 30px;
            color: var(--gold);
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s;
            animation: pulse 2s ease-in-out infinite;
        }

        .summon-close-btn:hover {
            background: var(--gold);
            color: var(--dark);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* ========== MESSAGE MODAL ========== */
        .message-modal {
            background: var(--panel);
            padding: 40px;
            border-radius: 20px;
            border: 2px solid #334155;
            text-align: center;
            max-width: 350px;
        }

        .message-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .message-title {
            font-family: 'Cinzel', serif;
            font-size: 1.4rem;
            color: var(--gold);
            margin-bottom: 10px;
        }

        .message-text {
            color: #cbd5e1;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .message-ok-btn {
            padding: 12px 40px;
            background: linear-gradient(135deg, var(--purple), var(--purple-dark));
            border: none;
            border-radius: 25px;
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .message-ok-btn:hover {
            transform: scale(1.05);
        }

        /* ========== HERO DETAIL MODAL ========== */
        .hero-detail-modal {
            position: relative;
            background: var(--panel);
            padding: 30px;
            border-radius: 20px;
            border: 2px solid #334155;
            text-align: center;
            max-width: 380px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-close-x {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #64748b;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-close-x:hover {
            color: white;
        }

        .hero-detail-img {
            width: 150px;
            height: 180px;
            object-fit: contain;
            margin-bottom: 15px;
        }

        .hero-detail-info {
            margin-bottom: 20px;
        }

        .hero-detail-rarity {
            display: inline-block;
            padding: 3px 12px;
            background: #64748b;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 1px;
            color: white;
            margin-bottom: 8px;
        }

        .hero-detail-name {
            font-family: 'Cinzel', serif;
            font-size: 1.6rem;
            color: var(--gold);
            margin-bottom: 5px;
        }

        .hero-detail-type {
            font-size: 0.9rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .hero-detail-level {
            font-size: 0.9rem;
            color: #22c55e;
            font-weight: 700;
            margin-top: 5px;
        }

        .hero-detail-stats {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .hero-detail-attacks {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .hero-detail-attacks h4 {
            color: var(--gold);
            font-size: 0.9rem;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        /* ========== XP PROGRESS ========== */
        .hero-xp-section {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .xp-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .xp-label {
            font-weight: 700;
            color: #22c55e;
            font-size: 0.8rem;
            letter-spacing: 1px;
        }

        .xp-text {
            color: #94a3b8;
            font-size: 0.8rem;
        }

        .xp-bar {
            width: 100%;
            height: 10px;
            background: #1e293b;
            border-radius: 5px;
            overflow: hidden;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #4ade80);
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .xp-next {
            margin-top: 8px;
            font-size: 0.75rem;
            color: #64748b;
            text-align: center;
        }

        .xp-next span {
            color: #22c55e;
            font-weight: 600;
        }

        .attacks-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .attack-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--panel);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .attack-name {
            color: white;
            font-weight: 600;
        }

        .attack-dmg {
            color: #ef4444;
            font-weight: 700;
        }

        .attack-effect {
            color: #a855f7;
            font-size: 0.75rem;
        }

        /* ========== BATTLE SCREEN ========== */
        #searchScreen.active {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 15px;
            box-sizing: border-box;
        }

        .battle-enemy-side {
            text-align: right;
            margin-bottom: 10px;
        }

        .battle-enemy-info,
        .battle-player-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .battle-name {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            color: white;
        }

        .battle-level {
            background: #334155;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .battle-hp-bar {
            width: 60%;
            height: 12px;
            background: #1e293b;
            border-radius: 6px;
            overflow: hidden;
            margin-left: auto;
        }

        .battle-hp-bar.player-bar {
            margin-left: 0;
            margin-right: auto;
        }

        .hp-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .enemy-hp {
            background: linear-gradient(90deg, #ef4444, #f97316);
        }

        .player-hp {
            background: linear-gradient(90deg, #22c55e, #4ade80);
        }

        .battle-hp-text {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 2px;
        }

        .status-icons {
            display: flex;
            gap: 4px;
            margin-top: 4px;
            font-size: 1rem;
        }

        .status-icon {
            background: rgba(0, 0, 0, 0.4);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
        }

        .battle-enemy-img {
            width: 150px;
            height: 150px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        .battle-player-side {
            margin-top: auto;
            text-align: left;
        }

        .battle-player-img {
            width: 140px;
            height: 140px;
            object-fit: contain;
        }

        .battle-log {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 15px;
            border-radius: 10px;
            margin: 10px 0;
            max-height: 60px;
            overflow-y: auto;
        }

        .battle-log p {
            margin: 3px 0;
            font-size: 0.85rem;
            color: #cbd5e1;
        }

        .attack-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 10px;
            background: var(--panel);
            border-radius: 15px;
            border: 2px solid #334155;
        }

        .attack-btn {
            padding: 15px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .attack-btn:hover {
            transform: scale(1.02);
        }

        .attack-btn:disabled {
            background: #334155;
            color: #64748b;
            cursor: not-allowed;
        }

        .attack-btn.ultimate {
            background: linear-gradient(135deg, #a855f7, #7c3aed);
        }

        /* ========== GYM INTRO VIDEO ========== */
        .gym-intro-container {
            position: relative;
            width: 100%;
            height: 100vh;
            background: black;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gym-intro-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .skip-intro-btn {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid white;
            color: white;
            padding: 10px 25px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
        }

        /* ========== GYM HERO SELECTION ========== */
        .gym-select-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }

        .gym-select-hero {
            background: var(--panel);
            border: 3px solid #334155;
            border-radius: 15px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .gym-select-hero:hover {
            border-color: var(--purple);
        }

        .gym-select-hero.selected {
            border-color: var(--gold);
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.4);
        }

        .gym-select-hero img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 10px;
        }

        .gym-select-hero .hero-name {
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .selected-team {
            background: var(--panel);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .selected-team h3 {
            color: var(--gold);
            margin-bottom: 10px;
        }

        .selected-team-row {
            display: flex;
            justify-content: center;
            gap: 10px;
            min-height: 60px;
            align-items: center;
        }

        .selected-team-row img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--gold);
            object-fit: contain;
            background: var(--dark);
        }

        /* ========== GYM BATTLE ========== */
        #gymBattleScreen {
            background:
                radial-gradient(ellipse at 50% 0%, rgba(239, 68, 68, 0.2) 0%, transparent 50%),
                var(--dark);
        }

        .gym-leader-header {
            display: flex;
            align-items: center;
            gap: 15px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(168, 85, 247, 0.1));
            padding: 10px 15px;
            border-radius: 15px;
            margin-bottom: 10px;
        }

        .gym-leader-portrait {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid var(--gold);
            object-fit: cover;
        }

        .gym-leader-name {
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            color: var(--gold);
        }

        .gym-leader-title {
            font-size: 0.85rem;
            color: #ef4444;
        }

        .gym-roster {
            display: flex;
            justify-content: center;
            padding: 5px;
        }

        .roster-icons {
            display: flex;
            gap: 8px;
        }

        .roster-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #334155;
            object-fit: contain;
            background: var(--panel);
            opacity: 0.5;
        }

        .roster-icon.active {
            border-color: var(--gold);
            opacity: 1;
        }

        .roster-icon.fainted {
            opacity: 0.3;
            filter: grayscale(100%);
        }

        .gym-battle-enemy,
        .gym-battle-player {
            text-align: center;
            padding: 10px;
        }

        .gym-battle-img {
            width: 100px;
            height: 100px;
            object-fit: contain;
        }

        .gym-battle-info {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 5px 0;
        }

        /* ========== MESSAGE MODAL ========== */
        .message-box {
            background: var(--panel);
            border: 2px solid var(--gold);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            max-width: 90%;
            width: 300px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* ========== BATTLE SELECT MODAL ========== */
        .battle-select-modal {
            position: relative;
            background: var(--panel);
            padding: 30px;
            border-radius: 20px;
            border: 2px solid #334155;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--gold);
            text-align: center;
            margin-bottom: 5px;
        }

        .modal-subtitle {
            text-align: center;
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .battle-hero-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .battle-hero-option {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .battle-hero-option:hover {
            border-color: var(--purple);
            transform: scale(1.05);
        }

        .battle-hero-option img {
            width: 60px;
            height: 70px;
            object-fit: contain;
        }

        .battle-hero-option .hero-name {
            font-size: 0.75rem;
            color: white;
            margin-top: 5px;
        }

        .battle-hero-option .hero-lvl {
            font-size: 0.65rem;
            color: #64748b;
        }

        /* ========== BATTLE RESULT MODAL ========== */
        .battle-result-modal {
            background: var(--panel);
            padding: 40px;
            border-radius: 20px;
            border: 2px solid #334155;
            text-align: center;
            max-width: 350px;
        }

        .result-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .result-title {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            margin-bottom: 20px;
        }

        .result-title.victory {
            color: #22c55e;
        }

        .result-title.defeat {
            color: #ef4444;
        }

        .result-rewards {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .reward-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
        }

        .reward-label {
            color: #94a3b8;
        }

        .reward-value {
            color: #22c55e;
            font-weight: 700;
        }

        /* ========== UTILITY ========== */
        .text-gold {
            color: var(--gold);
        }

        .text-purple {
            color: var(--purple);
        }

        .text-green {
            color: var(--green);
        }

        .text-muted {
            color: #94a3b8;
        }

        .mt-20 {
            margin-top: 20px;
        }

        /* ========== DIALOGUE BOX ========== */
        .dialogue-modal {
            z-index: 2000;
        }

        .dialogue-box {
            background: var(--panel);
            border: 3px solid var(--gold);
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            text-align: center;
            animation: dialoguePopIn 0.3s ease-out;
        }

        .player-dialogue {
            border-color: var(--purple);
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), var(--panel));
        }

        .enemy-dialogue {
            border-color: var(--red);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), var(--panel));
        }

        @keyframes dialoguePopIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .dialogue-speaker {
            font-family: 'Cinzel', serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .player-dialogue .dialogue-speaker {
            color: var(--purple);
        }

        .enemy-dialogue .dialogue-speaker {
            color: var(--red);
        }

        .dialogue-text {
            font-size: 1.1rem;
            color: white;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .dialogue-next-btn {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            color: black;
            cursor: pointer;
            transition: all 0.3s;
        }

        .dialogue-next-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.5);
        }

        /* === Mobile text overflow fixes === */
        @media (max-width: 480px) {
            .hero-card-name, .character-name, .gym-leader-name,
            .summon-hero-name, .hero-name, .trainer-name,
            .battle-hero-option .hero-name, .gym-select-hero .hero-name {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                max-width: 100%;
                font-size: 0.85rem !important;
            }
            
            .hero-card {
                padding: 8px;
                min-width: 0;
            }
            
            .hero-card-name {
                font-size: 0.9rem !important;
                word-break: break-word;
                white-space: normal;
                line-height: 1.2;
            }
            
            .hero-card-type, .hero-card-level {
                font-size: 0.7rem !important;
            }
            
            .summon-hero-name {
                font-size: 1.4rem !important;
                word-break: break-word;
            }
            
            .gym-leader-name {
                font-size: 1rem !important;
            }
            
            .battle-hero-grid, .gym-select-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 6px !important;
            }
            
            .heroes-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }
            
            .screen-title, .section-title {
                font-size: 1.3rem !important;
                word-break: break-word;
            }
            
            .game-logo {
                font-size: 2rem !important;
            }
            
            /* Fix nav bar text overflow */
            .nav-bar button, .bottom-nav button {
                font-size: 0.65rem !important;
                padding: 6px 4px !important;
            }
            
            /* Fix summon modal */
            .summon-modal {
                width: 95% !important;
                max-width: 340px !important;
                padding: 12px !important;
            }
            
            .summon-hero-stars {
                font-size: 0.9rem !important;
            }
        }
    </style>
    <style>
        /* ========== MOBILE RESPONSIVENESS ========== */
        @media (max-width: 768px) {
            .screen {
                padding: 10px;
                padding-bottom: 80px;
                /* Space for nav */
            }

            .game-logo {
                font-size: 2.5rem;
            }

            /* Character Selection */
            .character-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .setup-fields {
                flex-direction: column;
            }

            .field-group {
                width: 100%;
            }

            /* Heroes List */
            .heroes-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .hero-card .hero-card-img {
                height: 120px;
            }

            /* Battle & Gym */
            .battle-hero-grid,
            .gym-select-grid {
                grid-template-columns: repeat(3, 1fr);
                /* Keep 3 for compactness */
            }

            .gym-leader-header {
                flex-direction: column;
                text-align: center;
            }

            /* Modals */
            .summon-modal {
                width: 95%;
                padding: 15px;
            }

            .summon-hero-img {
                height: 200px;
            }
        }
    </style>
    <!-- Monetag MultiTag -->
    <meta name="monetag" content="dc4cd1c75e904df6c3759be0529f93c8">
    <script>(function(d,z,s){s.src='https://'+d+'/400/'+z;try{(document.body||document.documentElement).appendChild(s)}catch(e){}})('thubanoa.com','10303259',document.createElement('script'))</script>
    <!-- Open Graph / SEO -->
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Pocket Conquest - Time Recruit Edition" />
    <meta property="og:description" content="Puzzles and Conquest strategy guides and tools" />
    <meta property="og:image" content="https://noyziz.github.io/my-puzzles-guide/assets/images/noyzzing-logo-premium.jpg" />
    <meta property="og:site_name" content="NoYzzing OPS" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Pocket Conquest - Time Recruit Edition" />
    <meta name="twitter:description" content="Puzzles and Conquest strategy guides and tools" />
</head>

<body>
    <!-- ===== TITLE SCREEN ===== -->
    <div id="titleScreen" class="screen active">
        <h1 class="game-logo">POCKET CONQUEST</h1>
        <p class="game-subtitle">TIME RECRUIT EDITION</p>

        <button class="title-btn" onclick="startNewGame()">NEW GAME</button>
        <button id="continueBtn" class="title-btn secondary hidden" onclick="loadGame()">CONTINUE</button>
    </div>

    <!-- ===== CHARACTER SELECT ===== -->
    <div id="characterSelect" class="screen">
        <h2 class="screen-title">CHOOSE YOUR TRAINER</h2>

        <!-- Username & Alliance Setup -->
        <div class="setup-fields">
            <div class="field-group">
                <label for="usernameInput">Your Name</label>
                <input type="text" id="usernameInput" placeholder="Enter your name..." maxlength="20">
            </div>
            <div class="field-group">
                <label for="allianceSelect">Alliance</label>
                <select id="allianceSelect" onchange="handleAllianceChange()">
                    <option value="ROL">ROL (Rebirth of Legends)</option>
                    <option value="custom">Other Alliance...</option>
                </select>
                <input type="text" id="customAllianceInput" class="hidden" placeholder="Enter alliance name..."
                    maxlength="20">
            </div>
        </div>

        <div class="character-grid">
            <div class="character-card" onclick="selectCharacter('kai', this)">
                <div class="character-portrait">
                    <img src="assets/trainers/kai.png" alt="Kai"
                        onerror="this.parentElement.innerHTML='<div style=&quot;width:100%;height:100%;background:#ef4444;display:flex;align-items:center;justify-content:center;font-size:3rem;&quot;></div>'">
                </div>
                <div class="character-name">KAI</div>
                <div class="character-desc">The Adventurer</div>
            </div>

            <div class="character-card" onclick="selectCharacter('raven', this)">
                <div class="character-portrait">
                    <img src="assets/trainers/raven.png" alt="Raven"
                        onerror="this.parentElement.innerHTML='<div style=&quot;width:100%;height:100%;background:#3b82f6;display:flex;align-items:center;justify-content:center;font-size:3rem;&quot;></div>'">
                </div>
                <div class="character-name">RAVEN</div>
                <div class="character-desc">The Strategist</div>
            </div>

            <div class="character-card" onclick="selectCharacter('luna', this)">
                <div class="character-portrait">
                    <img src="assets/trainers/luna.png" alt="Luna"
                        onerror="this.parentElement.innerHTML='<div style=&quot;width:100%;height:100%;background:#ec4899;display:flex;align-items:center;justify-content:center;font-size:3rem;&quot;></div>'">
                </div>
                <div class="character-name">LUNA</div>
                <div class="character-desc">The Cheerful One</div>
            </div>

            <div class="character-card" onclick="selectCharacter('nova', this)">
                <div class="character-portrait">
                    <img src="assets/trainers/nova.png" alt="Nova"
                        onerror="this.parentElement.innerHTML='<div style=&quot;width:100%;height:100%;background:#a855f7;display:flex;align-items:center;justify-content:center;font-size:3rem;&quot;></div>'">
                </div>
                <div class="character-name">NOVA</div>
                <div class="character-desc">The Scholar</div>
            </div>
        </div>

        <button id="confirmCharBtn" class="confirm-btn" onclick="confirmCharacter()" disabled>SELECT TRAINER</button>
    </div>

    <!-- ===== HOME SCREEN ===== -->
    <div id="homeScreen" class="screen">
        <div class="home-header">
            <div class="player-profile">
                <div class="player-avatar">
                    <img id="homeAvatar" src="assets/trainers/kai.png" alt="Trainer"
                        style="width:100%;height:100%;object-fit:cover;">
                </div>
                <div class="player-info">
                    <h3 id="homePlayerName" onclick="secretTap()">TRAINER</h3>
                    <p>Level <span id="homePlayerLevel">1</span>  <span id="homeGymBadges">0</span>/12 Badges</p>
                    <p class="player-alliance"><span id="homeAlliance">ROL</span></p>
                </div>
            </div>
            <div class="currency-display">
                <div class="currency-item tr-currency">
                    <img src="assets/tr_coin.png" alt="TR" class="tr-coin-header">
                    <span id="homeTRCoins" class="currency-amount">0</span>
                </div>
            </div>
        </div>

        <div class="menu-grid">
            <div class="menu-item time-recruit" onclick="showScreen('timeRecruitScreen')">
                <div class="menu-icon-text">TR</div>
                <div class="menu-label">Time Recruit</div>
                <div class="menu-status">Summon Heroes</div>
            </div>

            <div class="menu-item search" onclick="openBattleSelect()">
                <div class="menu-icon-text">VS</div>
                <div class="menu-label">Battle</div>
                <div class="menu-status">Find Wild Heroes</div>
            </div>

            <div class="menu-item heroes" onclick="showScreen('heroesScreen')">
                <div class="menu-icon-text">H</div>
                <div class="menu-label">My Heroes</div>
                <div class="menu-status" id="homeHeroCount">0 Heroes</div>
            </div>

            <div class="menu-item gym" onclick="goToGym()">
                <div class="menu-icon-text">GYM</div>
                <div class="menu-label">Gym Battle</div>
                <div class="menu-status">12 Gyms</div>
            </div>
        </div>
    </div>

    <!-- ===== TIME RECRUIT SCREEN ===== -->
    <div id="timeRecruitScreen" class="screen">
        <button class="back-btn" onclick="showScreen('homeScreen')"> Back</button>

        <!-- Floating Particles -->
        <div class="particles-container">
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
        </div>

        <div class="time-recruit-container">
            <!-- Title Section -->
            <div class="tr-title-section">
                <h1 class="tr-title">TIME RECRUIT</h1>
                <p class="tr-subtitle">SUMMON HEROES FROM ACROSS TIME</p>
            </div>

            <!-- Coin Display -->
            <div class="tr-coins-display">
                <img src="assets/tr_coin.png" alt="TR Coin">
                <span class="coin-count" id="trScreenCoins">0</span>
                <span class="coin-label">TR Coins</span>
            </div>

            <!-- Magical Portal -->
            <div class="portal-container">
                <div class="portal-ring"></div>
                <div class="portal-core"></div>
                <div class="portal-icon"></div>
            </div>

            <!-- Summon Section -->
            <div class="summon-section">
                <button class="summon-btn-premium" onclick="summonHero()">
                    <img src="assets/tr_coin.png" alt="TR">
                    <span>SUMMON</span>
                </button>

                <div class="summon-info">
                    <p class="summon-cost-text"> 1 TR Coin</p>
                    <p class="summon-hint-text">Tap to summon a random hero.<br>Duplicates grant bonus XP!</p>
                </div>

                <!-- Decorative Preview Cards -->
                <div class="hero-preview-cards">
                    <div class="preview-card"></div>
                    <div class="preview-card"></div>
                    <div class="preview-card"></div>
                </div>

                <!-- Spirit Stone Shop (only shows after Gym 2) -->
                <div id="spiritStoneShop" class="spirit-stone-shop"
                    style="margin-top: 20px; padding: 15px; background: rgba(147, 51, 234, 0.2); border-radius: 12px; border: 1px solid #9333ea; display: none;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 2rem;"></span>
                            <div>
                                <div style="color: #c084fc; font-weight: bold;">Spirit Stone</div>
                                <div style="color: #94a3b8; font-size: 0.8rem;">Evolve Yune at MAX level</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span id="spiritStoneCount" style="color: #fbbf24; font-weight: bold;">0</span>
                            <button onclick="buySpiritStone()"
                                style="background: linear-gradient(135deg, #9333ea, #7c3aed); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                Buy (30 )
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Demon Core Shop (only shows when player has Lucifer) -->
                <div id="demonCoreShop" class="demon-core-shop"
                    style="margin-top: 15px; padding: 15px; background: rgba(239, 68, 68, 0.2); border-radius: 12px; border: 1px solid #dc2626; display: none;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 2rem;"></span>
                            <div>
                                <div style="color: #ef4444; font-weight: bold;">Demon Core</div>
                                <div style="color: #94a3b8; font-size: 0.8rem;">Evolve Lucifer at MAX level</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span id="demonCoreCount" style="color: #fbbf24; font-weight: bold;">0</span>
                            <button onclick="buyDemonCore()"
                                style="background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                Buy (40 )
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== GYM CAMPAIGN SCREEN ===== -->
    <div id="gymCampaignScreen" class="screen">
        <button class="back-btn" onclick="showScreen('homeScreen')"> Back</button>
        <h2 class="screen-title">GYM BATTLE CAMPAIGN</h2>

        <div class="campaign-list"
            style="max-width:500px;margin:20px auto;display:flex;flex-direction:column;gap:15px;">
            <!-- GYM 1 -->
            <div class="campaign-item" onclick="selectGym(1)"
                style="background:var(--panel);padding:20px;border-radius:15px;border:2px solid var(--red);cursor:pointer;display:flex;align-items:center;gap:15px;transition:transform 0.2s;"
                onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div class="gym-icon" style="font-size:2rem;"></div>
                <div style="text-align:left;flex:1;">
                    <div style="font-family:'Cinzel';color:var(--gold);font-size:1.2rem;">GYM 1: SHELAK</div>
                    <div style="font-size:0.8rem;color:#94a3b8;">The Flame Warden</div>
                </div>
                <div
                    style="background:var(--red);color:white;padding:5px 15px;border-radius:20px;font-size:0.8rem;font-weight:bold;">
                    BATTLE</div>
            </div>

            <!-- GYM 2 - Dynamic based on gym1Completed -->
            <div id="gym2Card" class="campaign-item" onclick="selectGym(2)"
                style="background:var(--panel);padding:20px;border-radius:15px;border:2px solid #a855f7;cursor:pointer;display:flex;align-items:center;gap:15px;transition:transform 0.2s;"
                onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div class="gym-icon" style="font-size:2rem;"></div>
                <div style="text-align:left;flex:1;">
                    <div style="font-family:'Cinzel';color:#a855f7;font-size:1.2rem;">GYM 2: ARIONNA</div>
                    <div style="font-size:0.8rem;color:#94a3b8;">The Fox Spirit Summoner</div>
                </div>
                <div id="gym2Status"
                    style="background:#a855f7;color:white;padding:5px 15px;border-radius:20px;font-size:0.8rem;font-weight:bold;">
                    BATTLE</div>
            </div>

            <!-- GYM 3 -->
            <div id="gym3Card" class="campaign-item" onclick="selectGym(3)"
                style="background:var(--panel);padding:20px;border-radius:15px;border:2px solid #1e1b4b;cursor:pointer;display:flex;align-items:center;gap:15px;transition:transform 0.2s;"
                onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div class="gym-icon" style="font-size:2rem;"></div>
                <div style="text-align:left;flex:1;">
                    <div style="font-family:'Cinzel';color:#6366f1;font-size:1.2rem;">GYM 3: NILOCK</div>
                    <div style="font-size:0.8rem;color:#94a3b8;">The Serpent Master</div>
                </div>
                <div id="gym3Status"
                    style="background:#6366f1;color:white;padding:5px 15px;border-radius:20px;font-size:0.8rem;font-weight:bold;">
                    BATTLE</div>
            </div>
        </div>
    </div>

    <!-- ===== BATTLE SCREEN (SEARCH) ===== -->
    <div id="searchScreen" class="screen">
        <button class="back-btn" onclick="fleeBattle()"> Flee</button>

        <!-- ENEMY SIDE (top) -->
        <div class="battle-enemy-side">
            <img id="enemyImage" src="" alt="Enemy" class="battle-enemy-img">
            <div class="battle-enemy-info">
                <span class="battle-name" id="enemyName">Wild Hero</span>
                <span class="battle-level" id="enemyLevel">Lv.1</span>
            </div>
            <div class="battle-hp-bar">
                <div class="hp-fill enemy-hp" id="enemyHpBar" style="width:100%"></div>
            </div>
            <div class="battle-hp-text" id="enemyHpText">100/100</div>
            <div class="status-icons" id="enemyStatusIcons"></div>
        </div>

        <!-- PLAYER SIDE (bottom) -->
        <div class="battle-player-side">
            <img id="playerHeroImage" src="" alt="Hero" class="battle-player-img">
            <div class="battle-player-info">
                <span class="battle-name" id="playerHeroName">Your Hero</span>
                <span class="battle-level" id="playerHeroLevel">Lv.1</span>
            </div>
            <div class="battle-hp-bar player-bar">
                <div class="hp-fill player-hp" id="playerHpBar" style="width:100%"></div>
            </div>
            <div class="battle-hp-text" id="playerHpText">100/100</div>
            <div class="status-icons" id="playerStatusIcons"></div>
        </div>

        <!-- BATTLE LOG -->
        <div class="battle-log" id="battleLog">
            <p>A wild hero appeared!</p>
        </div>

        <!-- ATTACK BUTTONS -->
        <div class="attack-panel" id="attackPanel">
            <button class="attack-btn" onclick="useAttack(0)" id="atkBtn0">Attack 1</button>
            <button class="attack-btn" onclick="useAttack(1)" id="atkBtn1">Attack 2</button>
            <button class="attack-btn" onclick="useAttack(2)" id="atkBtn2">Attack 3</button>
            <button class="attack-btn ultimate" onclick="useAttack(3)" id="atkBtn3">Ultimate</button>
        </div>
    </div>

    <!-- ===== GYM INTRO VIDEO SCREEN ===== -->
    <div id="gymIntroScreen" class="screen">
        <div class="gym-intro-container">
            <video id="gymIntroVideo" class="gym-intro-video" autoplay playsinline>
                <source src="" type="video/mp4">
            </video>
            <button class="skip-intro-btn" onclick="skipGymIntro()">Skip </button>
        </div>
    </div>

    <!-- ===== GYM HERO SELECTION ===== -->
    <div id="gymSelectScreen" class="screen">
        <button class="back-btn" onclick="showScreen('homeScreen')"> Back</button>
        <h2 class="screen-title">SELECT YOUR TEAM</h2>
        <p style="text-align:center;color:#94a3b8;margin-bottom:15px;">Choose 5 heroes for the gym battle</p>

        <div class="gym-select-grid" id="gymSelectGrid">
            <!-- Heroes rendered here -->
        </div>

        <div class="selected-team">
            <h3>Your Team (<span id="selectedCount">0</span>/5)</h3>
            <div class="selected-team-row" id="selectedTeamRow">
                <!-- Selected heroes appear here -->
            </div>
        </div>

        <button id="startGymBattleBtn" class="confirm-btn" onclick="startGymBattle()" disabled>START GYM
            BATTLE</button>
    </div>

    <!-- ===== GYM BATTLE SCREEN ===== -->
    <div id="gymBattleScreen" class="screen">
        <button class="back-btn" onclick="fleeGymBattle()" style="left:auto;right:20px;">Forfeit </button>

        <!-- GYM LEADER INFO -->
        <div class="gym-leader-header">
            <img id="gymLeaderImg" src="" alt="Gym Leader" class="gym-leader-portrait">
            <div class="gym-leader-info">
                <div class="gym-leader-name" id="gymLeaderName">GYM LEADER</div>
                <div class="gym-leader-title" id="gymLeaderTitle">The Flame Warden</div>
            </div>
        </div>

        <!-- ENEMY TEAM ROSTER -->
        <div class="gym-roster enemy-roster">
            <div class="roster-icons" id="enemyRoster">
                <!-- Enemy hero icons -->
            </div>
        </div>

        <!-- ACTIVE ENEMY -->
        <div class="gym-battle-enemy">
            <img id="gymEnemyImage" src="" alt="Enemy" class="gym-battle-img">
            <div class="gym-battle-info">
                <span class="battle-name" id="gymEnemyName">Enemy</span>
                <span class="battle-level" id="gymEnemyLevel">Lv.130</span>
            </div>
            <div class="battle-hp-bar">
                <div class="hp-fill enemy-hp" id="gymEnemyHpBar" style="width:100%"></div>
            </div>
            <div class="battle-hp-text" id="gymEnemyHpText">500/500</div>
            <div class="status-icons" id="gymEnemyStatusIcons"></div>
        </div>

        <!-- PLAYER TEAM ROSTER -->
        <div class="gym-roster player-roster">
            <div class="roster-icons" id="playerRoster">
                <!-- Player hero icons -->
            </div>
        </div>

        <!-- ACTIVE PLAYER HERO -->
        <div class="gym-battle-player">
            <img id="gymPlayerImage" src="" alt="Hero" class="gym-battle-img">
            <div class="gym-battle-info">
                <span class="battle-name" id="gymPlayerName">Your Hero</span>
                <span class="battle-level" id="gymPlayerLevel">Lv.1</span>
            </div>
            <div class="battle-hp-bar player-bar">
                <div class="hp-fill player-hp" id="gymPlayerHpBar" style="width:100%"></div>
            </div>
            <div class="battle-hp-text" id="gymPlayerHpText">100/100</div>
            <div class="status-icons" id="gymPlayerStatusIcons"></div>
        </div>

        <!-- BATTLE LOG -->
        <div class="battle-log" id="gymBattleLog">
            <p>Gym battle started!</p>
        </div>

        <!-- ATTACK BUTTONS -->
        <div class="attack-panel" id="gymAttackPanel">
            <button class="attack-btn" onclick="useGymAttack(0)" id="gymAtkBtn0">Attack 1</button>
            <button class="attack-btn" onclick="useGymAttack(1)" id="gymAtkBtn1">Attack 2</button>
            <button class="attack-btn" onclick="useGymAttack(2)" id="gymAtkBtn2">Attack 3</button>
            <button class="attack-btn ultimate" onclick="useGymAttack(3)" id="gymAtkBtn3">Ultimate</button>
        </div>
    </div>

    <!-- ===== HEROES SCREEN ===== -->
    <div id="heroesScreen" class="screen">
        <button class="back-btn" onclick="showScreen('homeScreen')"> Back</button>

        <h2 class="screen-title">MY HEROES</h2>

        <div id="heroListContainer">
            <!-- Heroes will be dynamically rendered here -->
        </div>

        <div id="noHeroesMessage" class="coming-soon-box">
            <img id="heroesTrainerImg" src="assets/trainers/kai.png" alt="Trainer"
                style="width:100px;height:100px;border-radius:50%;object-fit:cover;border:3px solid var(--gold);margin-bottom:20px;">
            <h3>No Heroes Yet</h3>
            <p>Use Time Recruit to summon your first hero!</p>
        </div>
    </div>



    <!-- ===== SUMMON RESULT MODAL ===== -->
    <div id="summonModal" class="modal-overlay" style="display:none;">
        <div class="summon-modal">
            <div class="summon-glow"></div>
            <div class="summon-hero-reveal">
                <img id="summonHeroImg" src="" alt="Hero" class="summon-hero-img">
            </div>
            <div class="summon-hero-info">
                <div class="summon-rarity" id="summonRarity">RARE</div>
                <h2 class="summon-hero-name" id="summonHeroName">Hero Name</h2>
                <div class="summon-hero-type" id="summonHeroType">Type</div>
                <div class="summon-stats">
                    <div class="stat-box"><span class="stat-label">HP</span><span class="stat-value"
                            id="summonHP">100</span></div>
                    <div class="stat-box"><span class="stat-label">ATK</span><span class="stat-value"
                            id="summonATK">30</span></div>
                    <div class="stat-box"><span class="stat-label">DEF</span><span class="stat-value"
                            id="summonDEF">25</span></div>
                </div>
            </div>
            <button class="summon-close-btn" onclick="closeSummonModal()">TAP TO CONTINUE</button>
        </div>
    </div>

    <!-- ===== CUSTOM MESSAGE MODAL ===== -->
    <div id="messageModal" class="modal-overlay" style="display:none;">
        <div class="message-modal">
            <div class="message-icon" id="messageIcon"></div>
            <h3 class="message-title" id="messageTitle">Title</h3>
            <p class="message-text" id="messageText">Message text here</p>
            <button class="message-ok-btn" onclick="closeMessageModal()">OK</button>
        </div>
    </div>

    <!-- ===== HERO DETAILS MODAL ===== -->
    <div id="heroDetailModal" class="modal-overlay" style="display:none;">
        <div class="hero-detail-modal">
            <button class="modal-close-x" onclick="closeHeroDetailModal()"></button>
            <img id="heroDetailImg" src="" alt="Hero" class="hero-detail-img">
            <div class="hero-detail-info">
                <div class="hero-detail-rarity" id="heroDetailRarity">COMMON</div>
                <h2 class="hero-detail-name" id="heroDetailName">Hero Name</h2>
                <div class="hero-detail-type" id="heroDetailType">Type</div>
                <div class="hero-detail-level" id="heroDetailLevel">Level 1</div>
            </div>
            <div class="hero-detail-stats">
                <div class="stat-box"><span class="stat-label">HP</span><span class="stat-value"
                        id="heroDetailHP">100</span></div>
                <div class="stat-box"><span class="stat-label">ATK</span><span class="stat-value"
                        id="heroDetailATK">30</span></div>
                <div class="stat-box"><span class="stat-label">DEF</span><span class="stat-value"
                        id="heroDetailDEF">25</span></div>
            </div>
            <div class="hero-xp-section">
                <div class="xp-header">
                    <span class="xp-label">EXP</span>
                    <span class="xp-text" id="heroDetailXP">0 / 20</span>
                </div>
                <div class="xp-bar">
                    <div class="xp-fill" id="heroDetailXPBar" style="width:0%"></div>
                </div>
                <div class="xp-next">Next Level: <span id="heroDetailXPNeeded">20 XP</span></div>
            </div>
            <div class="hero-detail-attacks">
                <h4>ATTACKS</h4>
                <div id="heroDetailAttacksList" class="attacks-list"></div>
            </div>
            <button class="message-ok-btn" onclick="closeHeroDetailModal()">CLOSE</button>
        </div>
    </div>

    <!-- ===== BATTLE HERO SELECT MODAL ===== -->
    <div id="battleSelectModal" class="modal-overlay" style="display:none;">
        <div class="battle-select-modal">
            <button class="modal-close-x" onclick="closeBattleSelect()"></button>
            <h2 class="modal-title">SELECT YOUR HERO</h2>
            <p class="modal-subtitle">Choose a hero to battle with</p>
            <div id="battleHeroGrid" class="battle-hero-grid">
                <!-- Heroes will be rendered here -->
            </div>
            <div id="noHeroesForBattle" style="display:none; text-align:center; padding:20px;">
                <p style="color:#94a3b8;">You need at least 1 hero to battle!</p>
                <button class="message-ok-btn" onclick="closeBattleSelect(); showScreen('timeRecruitScreen');">
                    Go Summon
                </button>
            </div>
        </div>
    </div>

    <!-- ===== BATTLE RESULT MODAL ===== -->
    <div id="battleResultModal" class="modal-overlay" style="display:none;">
        <div class="battle-result-modal">
            <div class="result-icon" id="resultIcon"></div>
            <h2 class="result-title" id="resultTitle">VICTORY!</h2>
            <div class="result-rewards">
                <div class="reward-item">
                    <span class="reward-label">XP Gained:</span>
                    <span class="reward-value" id="resultXP">+20</span>
                </div>
                <div class="reward-item" id="coinRewardRow" style="display:none;">
                    <span class="reward-label">TR Coin:</span>
                    <span class="reward-value">+1 </span>
                </div>
            </div>
            <button class="message-ok-btn" onclick="closeBattleResult()">CONTINUE</button>
        </div>
    </div>

    <script>
        // ========== GAME STATE ==========
        let gameState = {
            trainer: null,
            trainerName: '',
            level: 1,
            trCoins: 0,
            gems: 100,
            badges: 0,
            heroes: [],
            gym1Completed: false,  // Unlocks Malice in Time Recruit
            gym2Completed: false,  // Unlocks Yune in Time Recruit
            gym3Completed: false,  // Unlocks Gym 4 (Orochi NOT obtainable)
            spiritStone: 0,        // Evolution item for Yune
            demonCore: 0,          // Evolution item for Lucifer
            soundEnabled: true     // Sound toggle
        };

        // ========== SOUND EFFECTS SYSTEM (Web Audio API) ==========
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioCtx;
        }

        // Play a tone with envelope
        function playTone(frequency, duration, type = 'sine', volume = 0.3) {
            if (!gameState.soundEnabled) return;
            try {
                const ctx = initAudio();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();

                osc.type = type;
                osc.frequency.setValueAtTime(frequency, ctx.currentTime);
                osc.connect(gain);
                gain.connect(ctx.destination);

                // Envelope
                gain.gain.setValueAtTime(volume, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);

                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + duration);
            } catch (e) { /* Audio not supported */ }
        }

        // Sound Effects Library
        const SFX = {
            // Attack hit - punchy impact
            attack: () => {
                playTone(150, 0.1, 'square', 0.7);
                setTimeout(() => playTone(100, 0.15, 'sawtooth', 0.6), 50);
            },

            // Heal - gentle ascending chime
            heal: () => {
                playTone(523, 0.15, 'sine', 0.5);
                setTimeout(() => playTone(659, 0.15, 'sine', 0.5), 100);
                setTimeout(() => playTone(784, 0.2, 'sine', 0.6), 200);
            },

            // Buff - power up sound
            buff: () => {
                playTone(262, 0.1, 'square', 0.5);
                setTimeout(() => playTone(330, 0.1, 'square', 0.5), 80);
                setTimeout(() => playTone(392, 0.15, 'square', 0.6), 160);
            },

            // Debuff - descending tone
            debuff: () => {
                playTone(392, 0.1, 'sawtooth', 0.5);
                setTimeout(() => playTone(330, 0.1, 'sawtooth', 0.5), 80);
                setTimeout(() => playTone(262, 0.15, 'sawtooth', 0.6), 160);
            },

            // Victory fanfare
            victory: () => {
                const notes = [523, 659, 784, 1047];
                notes.forEach((freq, i) => {
                    setTimeout(() => playTone(freq, 0.2, 'square', 0.6), i * 150);
                });
                setTimeout(() => playTone(1047, 0.4, 'sine', 0.7), 600);
            },

            // Defeat - sad descending
            defeat: () => {
                playTone(392, 0.3, 'sine', 0.5);
                setTimeout(() => playTone(330, 0.3, 'sine', 0.5), 300);
                setTimeout(() => playTone(262, 0.5, 'sine', 0.5), 600);
            },

            // Summon - magical whoosh
            summon: () => {
                for (let i = 0; i < 10; i++) {
                    setTimeout(() => {
                        playTone(200 + i * 80, 0.1, 'sine', 0.4);
                    }, i * 40);
                }
                setTimeout(() => playTone(800, 0.3, 'sine', 0.7), 400);
            },

            // UI click
            click: () => {
                playTone(800, 0.05, 'square', 0.5);
            },

            // Super effective hit
            superEffective: () => {
                playTone(200, 0.08, 'square', 0.7);
                setTimeout(() => playTone(400, 0.1, 'sawtooth', 0.7), 60);
                setTimeout(() => playTone(600, 0.12, 'square', 0.6), 120);
            },

            // Not effective hit
            notEffective: () => {
                playTone(200, 0.15, 'triangle', 0.5);
            }
        };

        // Resume audio context on user interaction (browser requirement)
        document.addEventListener('click', () => {
            if (audioCtx && audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }, { once: true });

        // ========== SCREEN MANAGEMENT ==========
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');

            if (screenId === 'homeScreen') updateHomeScreen();
            if (screenId === 'heroesScreen') updateHeroesScreen();
            if (screenId === 'timeRecruitScreen') updateTimeRecruitScreen();
        }

        function updateTimeRecruitScreen() {
            document.getElementById('trScreenCoins').textContent = gameState.trCoins;
            document.getElementById('spiritStoneCount').textContent = gameState.spiritStone || 0;
            document.getElementById('demonCoreCount').textContent = gameState.demonCore || 0;
            // Only show Spirit Stone shop after Gym 2 (when player has Yune)
            const spiritShop = document.getElementById('spiritStoneShop');
            if (spiritShop) {
                spiritShop.style.display = gameState.gym2Completed ? 'block' : 'none';
            }
            // Only show Demon Core shop when player has Lucifer
            const demonShop = document.getElementById('demonCoreShop');
            if (demonShop) {
                const hasLucifer = gameState.heroes.some(h => h.id === 'lucifer');
                demonShop.style.display = hasLucifer ? 'block' : 'none';
            }
        }

        function buySpiritStone() {
            if (gameState.trCoins < 30) {
                showMessage('Not enough TR Coins! You need 30.');
                return;
            }
            gameState.trCoins -= 30;
            gameState.spiritStone = (gameState.spiritStone || 0) + 1;
            saveGame();
            updateTimeRecruitScreen();
            SFX.summon();
            showMessage(' You got a Spirit Stone! Use it on MAX level Yune to evolve!');
        }

        function buyDemonCore() {
            if (gameState.trCoins < 40) {
                showMessage('Not enough TR Coins! You need 40.');
                return;
            }
            gameState.trCoins -= 40;
            gameState.demonCore = (gameState.demonCore || 0) + 1;
            saveGame();
            updateTimeRecruitScreen();
            SFX.summon();
            showMessage(' You got a Demon Core! Use it on MAX level Lucifer to evolve!');
        }

        function updateHeroesScreen() {
            const container = document.getElementById('heroListContainer');
            const noHeroesMsg = document.getElementById('noHeroesMessage');

            // Update trainer image
            if (gameState.trainer) {
                document.getElementById('heroesTrainerImg').src = 'assets/trainers/' + gameState.trainer + '.png';
            }

            // Check if player has heroes
            if (gameState.heroes.length === 0) {
                container.innerHTML = '';
                noHeroesMsg.style.display = 'block';
                return;
            }

            // Hide no heroes message
            noHeroesMsg.style.display = 'none';

            // Render hero grid
            container.innerHTML = '<div class="heroes-grid">' +
                gameState.heroes.map((hero, index) => `
                    <div class="hero-card" onclick="showHeroDetails(${index})">
                        <img src="${hero.image}" alt="${hero.name}" class="hero-card-img">
                        <div class="hero-card-info">
                            <div class="hero-card-name">${hero.name}</div>
                            <div class="hero-card-type">${hero.type}</div>
                            <div class="hero-card-level">Lv.${getLevelDisplay(hero)}</div>
                        </div>
                    </div>
                `).join('') +
                '</div>';
        }

        function showHeroDetails(index) {
            const hero = gameState.heroes[index];
            if (!hero) return;

            // Populate modal
            document.getElementById('heroDetailImg').src = hero.image;
            document.getElementById('heroDetailRarity').textContent = hero.rarity.toUpperCase();
            document.getElementById('heroDetailName').textContent = hero.name;
            document.getElementById('heroDetailType').textContent = hero.type + ' Type';
            document.getElementById('heroDetailLevel').textContent = 'Level ' + getLevelDisplay(hero);
            document.getElementById('heroDetailHP').textContent = hero.hp + '/' + hero.maxHp;
            document.getElementById('heroDetailATK').textContent = hero.attack;
            document.getElementById('heroDetailDEF').textContent = hero.defense;

            // Calculate XP progress - hide if at MAX level
            const isMaxLevel = hero.level >= getMaxLevel(hero);
            if (isMaxLevel) {
                document.getElementById('heroDetailXP').textContent = 'MAX LEVEL';
                document.getElementById('heroDetailXPBar').style.width = '100%';
                document.getElementById('heroDetailXPBar').style.background = 'linear-gradient(90deg, #fbbf24, #f59e0b)';
                document.getElementById('heroDetailXPNeeded').textContent = '';
            } else {
                const xpNeeded = 50 + (hero.level * 3);
                const currentXp = hero.xp || 0;
                const xpPct = Math.min(100, (currentXp / xpNeeded) * 100);
                document.getElementById('heroDetailXP').textContent = currentXp + ' / ' + xpNeeded;
                document.getElementById('heroDetailXPBar').style.width = xpPct + '%';
                document.getElementById('heroDetailXPBar').style.background = '';
                document.getElementById('heroDetailXPNeeded').textContent = (xpNeeded - currentXp) + ' XP';
            }

            // Build attacks list
            let attacksHtml = hero.attacks.map(a => `
                <div class="attack-item">
                    <span class="attack-name">${a.name}</span>
                    <span class="attack-dmg">${a.damage} DMG</span>
                    ${a.effect ? '<span class="attack-effect">' + a.effect + '</span>' : ''}
                </div>
            `).join('');
            document.getElementById('heroDetailAttacksList').innerHTML = attacksHtml;

            // Show evolve button for Yune at MAX level with Spirit Stone
            let evolveHtml = '';
            if (hero.id === 'yune' && isMaxLevel && (gameState.spiritStone || 0) > 0) {
                evolveHtml = `
                    <button onclick="evolveYune(${index})" style="width: 100%; margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #9333ea, #ec4899); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                         EVOLVE TO FOX SPIRIT 
                    </button>
                `;
            }
            // Show evolve button for Lucifer at MAX level with Demon Core
            if (hero.id === 'lucifer' && isMaxLevel && (gameState.demonCore || 0) > 0) {
                evolveHtml = `
                    <button onclick="evolveLucifer(${index})" style="width: 100%; margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                         EVOLVE TO LORD OF PRIDE 
                    </button>
                `;
            }
            document.getElementById('heroDetailAttacksList').insertAdjacentHTML('afterend', evolveHtml);

            // Show modal
            document.getElementById('heroDetailModal').style.display = 'flex';
        }

        function evolveYune(heroIndex) {
            const hero = gameState.heroes[heroIndex];
            if (!hero || hero.id !== 'yune') return;
            if ((gameState.spiritStone || 0) < 1) {
                showMessage('You need a Spirit Stone to evolve Yune!');
                return;
            }

            // Use the spirit stone
            gameState.spiritStone--;

            // Find Fox Spirit data
            const foxSpiritData = wildHeroes.find(h => h.id === 'yune-fox-spirit');
            if (!foxSpiritData) return;

            // Transform Yune into Fox Spirit (keep level, recalculate stats)
            const level = hero.level;
            const levelBonus = level - 1;
            gameState.heroes[heroIndex] = {
                id: foxSpiritData.id,
                name: foxSpiritData.name,
                type: foxSpiritData.type,
                rarity: foxSpiritData.rarity,
                image: foxSpiritData.image,
                level: level,
                xp: 0,
                hp: foxSpiritData.baseHp + (levelBonus * 5),
                maxHp: foxSpiritData.baseHp + (levelBonus * 5),
                attack: foxSpiritData.baseAtk + (levelBonus * 4),
                defense: foxSpiritData.baseDef + (levelBonus * 1),
                attacks: foxSpiritData.attacks
            };

            saveGame();
            SFX.victory();
            closeHeroDetailModal();
            updateHeroesScreen();
            showMessage(' Yune evolved into Yune (Fox Spirit)! Much stronger now!');
        }

        function evolveLucifer(heroIndex) {
            const hero = gameState.heroes[heroIndex];
            if (!hero || hero.id !== 'lucifer') return;
            if ((gameState.demonCore || 0) < 1) {
                showMessage('You need a Demon Core to evolve Lucifer!');
                return;
            }

            // Use the demon core
            gameState.demonCore--;

            // Find Lord of Pride data
            const lordData = wildHeroes.find(h => h.id === 'lucifer-lord-of-pride');
            if (!lordData) return;

            // Transform Lucifer into Lord of Pride (keep level, recalculate stats with Epic scaling)
            const level = hero.level;
            const levelBonus = level - 1;
            gameState.heroes[heroIndex] = {
                id: lordData.id,
                name: lordData.name,
                type: lordData.type,
                rarity: lordData.rarity,
                image: lordData.image,
                level: level,
                xp: 0,
                hp: lordData.baseHp + (levelBonus * 6),  // Epic scaling
                maxHp: lordData.baseHp + (levelBonus * 6),
                attack: lordData.baseAtk + (levelBonus * 5),
                defense: lordData.baseDef + (levelBonus * 2),
                attacks: lordData.attacks
            };

            saveGame();
            SFX.victory();
            closeHeroDetailModal();
            updateHeroesScreen();
            showMessage(' Lucifer evolved into Lord of Pride! Ultimate power unleashed!');
        }

        function closeHeroDetailModal() {
            document.getElementById('heroDetailModal').style.display = 'none';
            // Clean up any evolve buttons
            const oldBtn = document.querySelector('#heroDetailAttacksList + button');
            if (oldBtn) oldBtn.remove();
        }

        // ========== CHARACTER SELECTION ==========
        let selectedTrainer = null;

        function selectCharacter(name, element) {
            document.querySelectorAll('.character-card').forEach(c => c.classList.remove('selected'));
            element.classList.add('selected');
            selectedTrainer = name;
            document.getElementById('confirmCharBtn').disabled = false;
        }

        function handleAllianceChange() {
            const select = document.getElementById('allianceSelect');
            const customInput = document.getElementById('customAllianceInput');

            if (select.value === 'custom') {
                customInput.classList.remove('hidden');
                customInput.focus();
            } else {
                customInput.classList.add('hidden');
                customInput.value = '';
            }
        }

        function confirmCharacter() {
            if (!selectedTrainer) return;

            // Get username
            const usernameInput = document.getElementById('usernameInput');
            const username = usernameInput.value.trim();

            if (!username) {
                showMessage('Please enter your name!');
                usernameInput.focus();
                return;
            }

            // Get alliance
            const allianceSelect = document.getElementById('allianceSelect');
            const customAlliance = document.getElementById('customAllianceInput');
            let alliance = allianceSelect.value;

            if (alliance === 'custom') {
                alliance = customAlliance.value.trim();
                if (!alliance) {
                    showMessage('Please enter your alliance name!');
                    customAlliance.focus();
                    return;
                }
            }

            gameState.trainer = selectedTrainer;
            gameState.username = username;
            gameState.trainerName = username.toUpperCase();
            gameState.alliance = alliance;
            gameState.trCoins = 1; // Standard starter bonus

            // No fake heroes - wait for user to provide real hero images
            // Heroes will be added via Time Recruit when we have the assets

            saveGame();
            showScreen('homeScreen');
        }

        // ========== HOME SCREEN ==========
        function updateHomeScreen() {
            document.getElementById('homePlayerName').textContent = gameState.trainerName;
            document.getElementById('homePlayerLevel').textContent = gameState.level;
            document.getElementById('homeGymBadges').textContent = gameState.badges;
            document.getElementById('homeTRCoins').textContent = gameState.trCoins;
            document.getElementById('homeAlliance').textContent = gameState.alliance || 'ROL';

            // Update hero count
            const heroCount = gameState.heroes.length;
            document.getElementById('homeHeroCount').textContent = heroCount + ' Hero' + (heroCount !== 1 ? 'es' : '');

            // Update avatar to selected trainer image
            if (gameState.trainer) {
                document.getElementById('homeAvatar').src = 'assets/trainers/' + gameState.trainer + '.png';
            }
        }

        // ========== STARTER HEROES DATABASE ==========
        const starterHeroes = [
            {
                id: 'naax',
                name: 'Naax',
                type: 'Steel',
                rarity: 'Common',
                image: 'assets/heroes/naax.png',
                baseHp: 120,
                baseAtk: 35,
                baseDef: 40,
                attacks: [
                    { name: 'Sword Slash', damage: 25, type: 'Physical' },
                    { name: 'Shield Bash', damage: 20, type: 'Physical', effect: 'Stun 20%' },
                    { name: 'Steel Guard', damage: 0, type: 'Buff', effect: 'Defense +30%' },
                    { name: 'Knight\'s Fury', damage: 45, type: 'Physical', effect: 'Ultimate' }
                ]
            },
            {
                id: 'lamassu',
                name: 'Lamassu',
                type: 'Dark',
                rarity: 'Common',
                image: 'assets/heroes/lamassu.png',
                baseHp: 100,
                baseAtk: 45,
                baseDef: 25,
                attacks: [
                    { name: 'Shadow Claw', damage: 30, type: 'Dark' },
                    { name: 'Wing Gust', damage: 25, type: 'Wind', effect: 'Knockback' },
                    { name: 'Curse of Ages', damage: 20, type: 'Dark', effect: 'Poison 3 turns' },
                    { name: 'Abyssal Roar', damage: 50, type: 'Dark', effect: 'Ultimate' }
                ]
            },
            {
                id: 'albertus',
                name: 'Albertus',
                type: 'Light',
                rarity: 'Common',
                image: 'assets/heroes/albertus.png',
                baseHp: 130,
                baseAtk: 30,
                baseDef: 45,
                attacks: [
                    { name: 'Holy Flail', damage: 28, type: 'Light' },
                    { name: 'Divine Shield', damage: 0, type: 'Buff', effect: 'Block next hit' },
                    { name: 'Blessing', damage: 0, type: 'Heal', effect: 'Heal 30 HP' },
                    { name: 'Judgement', damage: 55, type: 'Light', effect: 'Ultimate' }
                ]
            },
            {
                id: 'garnet',
                name: 'Garnet',
                type: 'Fire',
                rarity: 'Common',
                image: 'assets/heroes/garnet.png',
                baseHp: 90,
                baseAtk: 50,
                baseDef: 20,
                attacks: [
                    { name: 'Flame Burst', damage: 35, type: 'Fire' },
                    { name: 'Ember Burst', damage: 18, type: 'Fire', effect: 'Burns enemy for 3 turns' },
                    { name: 'Ember Touch', damage: 25, type: 'Fire', effect: 'Burn 2 turns' },
                    { name: 'Inferno Crown', damage: 60, type: 'Fire', effect: 'Ultimate' }
                ]
            },
            {
                id: 'florine',
                name: 'Florine',
                type: 'Wind',
                rarity: 'Common',
                image: 'assets/heroes/florine.png',
                baseHp: 95,
                baseAtk: 40,
                baseDef: 30,
                attacks: [
                    { name: 'Swift Strike', damage: 28, type: 'Physical', effect: 'Always first' },
                    { name: 'Wind Cloak', damage: 0, type: 'Buff', effect: 'Evasion +40%' },
                    { name: 'Poison Dagger', damage: 22, type: 'Physical', effect: 'Poison 3 turns' },
                    { name: 'Gale Assault', damage: 48, type: 'Wind', effect: 'Ultimate, hits twice' }
                ]
            }
        ];

        // ========== WILD HEROES DATABASE (Unlocked after first starter) ==========
        // These appear as wild enemies AND are summonable via Time Recruit
        // Slightly stronger than starters - Uncommon rarity
        const wildHeroes = [
            {
                id: 'talon',
                name: 'Talon',
                type: 'Wind',
                rarity: 'Uncommon',
                image: 'assets/heroes/talon.png',
                baseHp: 140,
                baseAtk: 42,
                baseDef: 35,
                attacks: [
                    { name: 'Talon Strike', damage: 32, type: 'Physical' },
                    { name: 'Wing Buffet', damage: 28, type: 'Wind', effect: 'Knockback' },
                    { name: 'Eagle Eye', damage: 0, type: 'Buff', effect: 'Accuracy +50%' },
                    { name: 'Sky Dive', damage: 55, type: 'Wind', effect: 'Ultimate' }
                ]
            },
            {
                id: 'harald',
                name: 'Harald',
                type: 'Fire',
                rarity: 'Uncommon',
                image: 'assets/heroes/harald.png',
                baseHp: 155,
                baseAtk: 48,
                baseDef: 30,
                attacks: [
                    { name: 'Axe Cleave', damage: 35, type: 'Physical' },
                    { name: 'Lava Blade', damage: 30, type: 'Fire', effect: 'Burn 2 turns' },
                    { name: 'Stone Skin', damage: 0, type: 'Buff', effect: 'Defense +40%' },
                    { name: 'Magma Fury', damage: 60, type: 'Fire', effect: 'Ultimate' }
                ]
            },
            {
                id: 'hendrik',
                name: 'Hendrik',
                type: 'Light',
                rarity: 'Uncommon',
                image: 'assets/heroes/hendrik.png',
                baseHp: 160,
                baseAtk: 40,
                baseDef: 45,
                attacks: [
                    { name: 'Golden Blade', damage: 30, type: 'Light' },
                    { name: 'Shield Wall', damage: 0, type: 'Buff', effect: 'Block 2 hits' },
                    { name: 'Radiant Smite', damage: 35, type: 'Light', effect: 'Blind' },
                    { name: 'Divine Wrath', damage: 58, type: 'Light', effect: 'Ultimate' }
                ]
            },
            {
                id: 'eri',
                name: 'Eri',
                type: 'Nature',
                rarity: 'Uncommon',
                image: 'assets/heroes/eri.png',
                baseHp: 130,
                baseAtk: 38,
                baseDef: 32,
                attacks: [
                    { name: 'Thorn Whip', damage: 28, type: 'Nature' },
                    { name: 'Nature\'s Blessing', damage: 0, type: 'Heal', effect: 'Heal 35 HP' },
                    { name: 'Entangle', damage: 22, type: 'Nature', effect: 'Root 2 turns' },
                    { name: 'Forest Spirit', damage: 52, type: 'Nature', effect: 'Ultimate' }
                ]
            },
            {
                id: 'elros',
                name: 'Elros',
                type: 'Arcane',
                rarity: 'Uncommon',
                image: 'assets/heroes/elros.png',
                baseHp: 115,
                baseAtk: 52,
                baseDef: 25,
                attacks: [
                    { name: 'Fireball', damage: 38, type: 'Fire' },
                    { name: 'Ice Shard', damage: 32, type: 'Ice', effect: 'Slow' },
                    { name: 'Arcane Shield', damage: 0, type: 'Buff', effect: 'Magic DEF +50%' },
                    { name: 'Elemental Storm', damage: 65, type: 'Arcane', effect: 'Ultimate' }
                ]
            },
            {
                id: 'sakhir',
                name: 'Sakhir',
                type: 'Dark',
                rarity: 'Uncommon',
                image: 'assets/heroes/sakhir.png',
                baseHp: 125,
                baseAtk: 50,
                baseDef: 28,
                attacks: [
                    { name: 'Soul Drain', damage: 30, type: 'Dark', effect: 'Lifesteal' },
                    { name: 'Curse', damage: 25, type: 'Dark', effect: 'ATK -30%' },
                    { name: 'Dark Tome', damage: 0, type: 'Buff', effect: 'ATK +40%' },
                    { name: 'Necrotic Blast', damage: 62, type: 'Dark', effect: 'Ultimate' }
                ]
            },
            {
                id: 'dracula',
                name: 'Dracula',
                type: 'Dark',
                rarity: 'Uncommon',
                image: 'assets/heroes/dracula.png',
                baseHp: 135,
                baseAtk: 48,
                baseDef: 32,
                attacks: [
                    { name: 'Blood Lance', damage: 32, type: 'Dark' },
                    { name: 'Vampiric Bite', damage: 28, type: 'Dark', effect: 'Lifesteal 50%' },
                    { name: 'Bat Swarm', damage: 20, type: 'Dark', effect: 'Hits 3 times' },
                    { name: 'Crimson Night', damage: 58, type: 'Dark', effect: 'Ultimate' }
                ]
            },
            {
                id: 'al-morrah',
                name: 'Al-Morrah',
                type: 'Arcane',
                rarity: 'Uncommon',
                image: 'assets/heroes/al-morrah.png',
                baseHp: 120,
                baseAtk: 45,
                baseDef: 35,
                attacks: [
                    { name: 'Mystic Bolt', damage: 30, type: 'Arcane' },
                    { name: 'Wish', damage: 0, type: 'Heal', effect: 'Heal 40 HP' },
                    { name: 'Sandstorm', damage: 25, type: 'Arcane', effect: 'Blind 2 turns' },
                    { name: 'Genie\'s Wrath', damage: 56, type: 'Arcane', effect: 'Ultimate' }
                ]
            },
            {
                id: 'scarlet',
                name: 'Scarlet',
                type: 'Dark',
                rarity: 'Uncommon',
                image: 'assets/heroes/scarlet.png',
                baseHp: 110,
                baseAtk: 55,
                baseDef: 22,
                attacks: [
                    { name: 'Whip Lash', damage: 35, type: 'Physical' },
                    { name: 'Charm', damage: 0, type: 'Debuff', effect: 'Confuse 2 turns' },
                    { name: 'Hellfire', damage: 38, type: 'Fire', effect: 'Burn' },
                    { name: 'Demon\'s Embrace', damage: 60, type: 'Dark', effect: 'Ultimate' }
                ]
            },
            {
                id: 'cerno',
                name: 'Cerno',
                type: 'Nature',
                rarity: 'Uncommon',
                image: 'assets/heroes/cerno.png',
                baseHp: 165,
                baseAtk: 44,
                baseDef: 38,
                attacks: [
                    { name: 'Battle Axe', damage: 34, type: 'Physical' },
                    { name: 'Nature\'s Rage', damage: 30, type: 'Nature', effect: 'ATK +25%' },
                    { name: 'Stampede', damage: 28, type: 'Physical', effect: 'Stun' },
                    { name: 'Wild Fury', damage: 58, type: 'Nature', effect: 'Ultimate' }
                ]
            },
            // ===== CHAPTER 2 HEROES (Rare - 4) =====
            {
                id: 'deedoe',
                name: 'Deedoe',
                type: 'Nature',
                rarity: 'Rare',
                chapter: 2,
                image: 'assets/heroes/deedoe.png',
                baseHp: 215,
                baseAtk: 90,
                baseDef: 140,
                attacks: [
                    { name: 'Antler Charge', damage: 40, type: 'Nature', effect: 'Knockback' },
                    { name: 'Forest Blessing', damage: 0, type: 'Heal', effect: 'Heal 50 HP' },
                    { name: 'Verdant Aura', damage: 0, type: 'Buff', effect: 'DEF +50%' },
                    { name: 'Spirit of the Grove', damage: 68, type: 'Nature', effect: 'Ultimate' }
                ]
            },
            {
                id: 'toke',
                name: 'Toke',
                type: 'Light',
                rarity: 'Rare',
                chapter: 2,
                image: 'assets/heroes/toke.png',
                baseHp: 240,
                baseAtk: 76,
                baseDef: 150,
                attacks: [
                    { name: 'Golden Axe', damage: 42, type: 'Physical', effect: 'Armor Break' },
                    { name: 'Shield Bash', damage: 35, type: 'Physical', effect: 'Stun' },
                    { name: 'Lion\'s Guard', damage: 0, type: 'Buff', effect: 'DEF +60%' },
                    { name: 'Lion\'s Roar', damage: 65, type: 'Light', effect: 'Ultimate' }
                ]
            },
            {
                id: 'apollo',
                name: 'Apollo',
                type: 'Light',
                rarity: 'Rare',
                chapter: 2,
                image: 'assets/heroes/apollo.png',
                baseHp: 235,
                baseAtk: 100,
                baseDef: 120,
                attacks: [
                    { name: 'Sun Bolt', damage: 45, type: 'Light' },
                    { name: 'Radiant Heal', damage: 0, type: 'Heal', effect: 'Heal 40 HP' },
                    { name: 'Solar Blessing', damage: 0, type: 'Buff', effect: 'ATK +50%' },
                    { name: 'Solar Flare', damage: 72, type: 'Light', effect: 'Ultimate' }
                ]
            },
            {
                id: 'fuga',
                name: 'Fuga',
                type: 'Wind',
                rarity: 'Rare',
                chapter: 2,
                image: 'assets/heroes/fuga.png',
                baseHp: 175,
                baseAtk: 85,
                baseDef: 115,
                attacks: [
                    { name: 'Talon Slash', damage: 38, type: 'Wind' },
                    { name: 'Feather Storm', damage: 42, type: 'Wind', effect: 'Blind 2 turns' },
                    { name: 'Wind Rush', damage: 0, type: 'Buff', effect: 'ATK +50%' },
                    { name: 'Tempest Dive', damage: 70, type: 'Wind', effect: 'Ultimate' }
                ]
            },
            {
                id: 'regina',
                name: 'Regina',
                type: 'Ice',
                rarity: 'Rare',
                chapter: 2,
                image: 'assets/heroes/regina.png',
                baseHp: 200,
                baseAtk: 78,
                baseDef: 135,
                attacks: [
                    { name: 'Tidal Wave', damage: 40, type: 'Ice' },
                    { name: 'Siren\'s Song', damage: 0, type: 'Debuff', effect: 'Confuse 2 turns' },
                    { name: 'Ocean\'s Embrace', damage: 0, type: 'Heal', effect: 'Heal 45 HP' },
                    { name: 'Frozen Depths', damage: 68, type: 'Ice', effect: 'Ultimate' }
                ]
            },
            // ===== BOSS HEROES =====
            {
                id: 'malice',
                name: 'Malice',
                type: 'Fire',
                rarity: 'Rare',
                image: 'assets/heroes/malice.png',
                baseHp: 150,
                baseAtk: 70,
                baseDef: 110,
                attacks: [
                    { name: 'Lava Fist', damage: 38, type: 'Fire', effect: 'Burn' },
                    { name: 'Demon Crush', damage: 42, type: 'Physical', effect: 'Stun' },
                    { name: 'Hellforge', damage: 0, type: 'Buff', effect: 'ATK +50%' },
                    { name: 'Infernal Wrath', damage: 70, type: 'Fire', effect: 'Ultimate' }
                ]
            },
            {
                id: 'yune',
                name: 'Yune',
                type: 'Arcane',
                rarity: 'Rare',
                chapter: 2,
                boss: true,
                image: 'assets/heroes/yune.png',
                baseHp: 220,
                baseAtk: 120,
                baseDef: 180,
                attacks: [
                    { name: 'Fox Fire', damage: 45, type: 'Arcane', effect: 'Burn 3 turns' },
                    { name: 'Spirit Drain', damage: 38, type: 'Dark', effect: 'Lifesteal 50%' },
                    { name: 'Nine Tails', damage: 0, type: 'Buff', effect: 'ATK +60%' },
                    { name: 'Celestial Storm', damage: 95, type: 'Arcane', effect: 'Ultimate' }
                ]
            },
            {
                id: 'yune-fox-spirit',
                name: 'Yune (Fox Spirit)',
                type: 'Arcane',
                rarity: 'Rare',
                chapter: 2,
                boss: true,
                image: 'assets/heroes/yune-fox-spirit.png',
                baseHp: 290,
                baseAtk: 150,
                baseDef: 250,
                attacks: [
                    { name: 'Spirit Flame', damage: 52, type: 'Arcane', effect: 'Burn 3 turns' },
                    { name: 'Soul Siphon', damage: 45, type: 'Dark', effect: 'Lifesteal 60%' },
                    { name: 'Divine Nine Tails', damage: 0, type: 'Buff', effect: 'ATK +70%' },
                    { name: 'Ascended Storm', damage: 110, type: 'Arcane', effect: 'Ultimate' }
                ]
            },
            // ========== CHAPTER 3 HEROES (4 Rare) ==========
            {
                id: 'hart',
                name: 'Hart',
                type: 'Dark',
                rarity: 'Rare',
                chapter: 3,
                image: 'assets/heroes/hart.png',
                baseHp: 140,
                baseAtk: 65,
                baseDef: 100,
                attacks: [
                    { name: 'Shadow Blade', damage: 36, type: 'Dark' },
                    { name: 'Knight\'s Vow', damage: 0, type: 'Buff', effect: 'DEF +45%' },
                    { name: 'Dark Slash', damage: 42, type: 'Dark', effect: 'Bleed 3 turns' },
                    { name: 'Dread Execution', damage: 68, type: 'Dark', effect: 'Ultimate' }
                ]
            },
            {
                id: 'ammon',
                name: 'Ammon',
                type: 'Dark',
                rarity: 'Rare',
                chapter: 3,
                image: 'assets/heroes/ammon.png',
                baseHp: 220,
                baseAtk: 120,
                baseDef: 180,
                attacks: [
                    { name: 'Forbidden Tome', damage: 48, type: 'Dark', effect: 'Curse 2 turns' },
                    { name: 'Necro Bolt', damage: 55, type: 'Dark', effect: 'Lifesteal 40%' },
                    { name: 'Dark Ritual', damage: 0, type: 'Buff', effect: 'ATK +60%' },
                    { name: 'Apocalypse', damage: 95, type: 'Dark', effect: 'Ultimate' }
                ]
            },
            {
                id: 'nilesh',
                name: 'Nilesh',
                type: 'Ice',
                rarity: 'Rare',
                chapter: 3,
                image: 'assets/heroes/nilesh.png',
                baseHp: 260,
                baseAtk: 140,
                baseDef: 200,
                attacks: [
                    { name: 'Frost Blade', damage: 52, type: 'Ice' },
                    { name: 'Glacial Fury', damage: 62, type: 'Ice', effect: 'Freeze 2 turns' },
                    { name: 'Beast Rage', damage: 0, type: 'Buff', effect: 'ATK +65%' },
                    { name: 'Absolute Zero', damage: 115, type: 'Ice', effect: 'Ultimate' }
                ]
            },
            // ========== 5 HEROES (Epic) ==========
            {
                id: 'savannah',
                name: 'Savannah',
                type: 'Light',
                rarity: 'Legendary',
                chapter: 3,
                image: 'assets/heroes/savannah.png',
                baseHp: 300,
                baseAtk: 160,
                baseDef: 220,
                attacks: [
                    { name: 'Divine Arrow', damage: 58, type: 'Light', effect: 'Pierce' },
                    { name: 'Golden Wings', damage: 0, type: 'Buff', effect: 'ATK +75%' },
                    { name: 'Celestial Rain', damage: 72, type: 'Light', effect: 'Hits all' },
                    { name: 'Judgment\'s End', damage: 130, type: 'Light', effect: 'Ultimate' }
                ]
            },
            {
                id: 'lucifer',
                name: 'Lucifer',
                type: 'Dark',
                rarity: 'Legendary',
                chapter: 3,
                image: 'assets/heroes/lucifer.png',
                baseHp: 300,
                baseAtk: 160,
                baseDef: 220,
                attacks: [
                    { name: 'Hellfire Bolt', damage: 55, type: 'Fire', effect: 'Burn 3 turns' },
                    { name: 'Fallen Grace', damage: 0, type: 'Buff', effect: 'ATK +70%' },
                    { name: 'Dark Descent', damage: 68, type: 'Dark', effect: 'Fear 2 turns' },
                    { name: 'Infernal Judgment', damage: 125, type: 'Dark', effect: 'Ultimate' }
                ]
            },
            {
                id: 'lucifer-lord-of-pride',
                name: 'Lucifer (Lord of Pride)',
                type: 'Dark',
                rarity: 'Legendary',
                chapter: 3,
                boss: true,
                image: 'assets/heroes/lucifer-lord-of-pride.png',
                baseHp: 350,
                baseAtk: 180,
                baseDef: 260,
                attacks: [
                    { name: 'Pride\'s Flame', damage: 65, type: 'Fire', effect: 'Burn 3 turns' },
                    { name: 'Demon\'s Majesty', damage: 0, type: 'Buff', effect: 'ATK +85%' },
                    { name: 'Sin of Pride', damage: 78, type: 'Dark', effect: 'Curse 3 turns' },
                    { name: 'Reign of Hell', damage: 145, type: 'Dark', effect: 'Ultimate' }
                ]
            },
            // ========== OROCHI - NILOCK'S ULTIMATE BOSS (5 Epic) ==========
            {
                id: 'orochi',
                name: 'Orochi',
                type: 'Dark',
                rarity: 'Legendary',
                chapter: 3,
                boss: true,
                image: 'assets/heroes/orochi.png',
                baseHp: 420,
                baseAtk: 210,
                baseDef: 300,
                attacks: [
                    { name: 'Serpent\'s Fangs', damage: 75, type: 'Dark', effect: 'Poison 4 turns' },
                    { name: 'Eight Headed Strike', damage: 88, type: 'Physical', effect: 'Hits 3 times' },
                    { name: 'Dragon\'s Blessing', damage: 0, type: 'Buff', effect: 'ATK +100%' },
                    { name: 'Yamata no Orochi', damage: 160, type: 'Dark', effect: 'Ultimate, Fear 3 turns' }
                ]
            }
        ];

        // ========== GYM DATA ==========
        const gyms = [
            {
                id: 1,
                name: 'Shelak',
                title: 'The Flame Warden',
                image: 'assets/gym_leaders/shelak.png',
                introVideo: 'assets/cutscenes/gym1_intro.mp4',
                heroes: [
                    {
                        id: 'harald',
                        name: 'Harald',
                        type: 'Fire',
                        image: 'assets/heroes/harald.png',
                        level: 130,
                        baseHp: 130,
                        baseAtk: 42,
                        baseDef: 28,
                        attacks: [
                            { name: 'Lava Axe', damage: 30, type: 'Fire' },
                            { name: 'Molten Shield', damage: 0, type: 'Buff', effect: 'DEF +30%' },
                            { name: 'Magma Slam', damage: 35, type: 'Fire', effect: 'Burn' },
                            { name: 'Volcanic Eruption', damage: 45, type: 'Fire', effect: 'Ultimate' }
                        ]
                    },
                    {
                        id: 'malice',
                        name: 'Malice',
                        type: 'Fire',
                        rarity: 'Rare',
                        image: 'assets/heroes/malice.png',
                        level: 130,
                        baseHp: 160,
                        baseAtk: 55,
                        baseDef: 80,
                        attacks: [
                            { name: 'Lava Fist', damage: 35, type: 'Fire', effect: 'Burn' },
                            { name: 'Demon Crush', damage: 40, type: 'Physical', effect: 'Stun' },
                            { name: 'Hellforge', damage: 0, type: 'Buff', effect: 'ATK +50%' },
                            { name: 'Infernal Wrath', damage: 60, type: 'Fire', effect: 'Ultimate' }
                        ]
                    }
                ],
                badge: 'Flame Badge',
                reward: { trCoins: 10, xp: 2000 }
            },
            {
                id: 2,
                name: 'Arionna',
                title: 'The Fox Spirit Summoner',
                image: 'assets/gym_leaders/arionna.png',
                introVideo: 'assets/cutscenes/gym2_intro.mp4',
                heroes: [
                    {
                        id: 'yune',
                        name: 'Yune',
                        type: 'Arcane',
                        rarity: 'Rare',
                        image: 'assets/heroes/yune.png',
                        level: 210,
                        baseHp: 220,
                        baseAtk: 120,
                        baseDef: 180,
                        attacks: [
                            { name: 'Fox Fire', damage: 45, type: 'Arcane', effect: 'Burn 3 turns' },
                            { name: 'Spirit Drain', damage: 38, type: 'Dark', effect: 'Lifesteal 50%' },
                            { name: 'Nine Tails', damage: 0, type: 'Buff', effect: 'ATK +60%' },
                            { name: 'Celestial Storm', damage: 95, type: 'Arcane', effect: 'Ultimate' }
                        ]
                    },
                    {
                        id: 'yune-fox-spirit',
                        name: 'Yune (Fox Spirit)',
                        type: 'Arcane',
                        rarity: 'Rare',
                        image: 'assets/heroes/yune-fox-spirit.png',
                        level: 210,
                        baseHp: 290,
                        baseAtk: 150,
                        baseDef: 250,
                        attacks: [
                            { name: 'Spirit Flame', damage: 52, type: 'Arcane', effect: 'Burn 3 turns' },
                            { name: 'Soul Siphon', damage: 45, type: 'Dark', effect: 'Lifesteal 60%' },
                            { name: 'Divine Nine Tails', damage: 0, type: 'Buff', effect: 'ATK +70%' },
                            { name: 'Ascended Storm', damage: 110, type: 'Arcane', effect: 'Ultimate' }
                        ]
                    }
                ],
                badge: 'Spirit Badge',
                reward: { trCoins: 15, xp: 6000 }
            },
            // ========== GYM 3: NILOCK - THE SERPENT MASTER ==========
            {
                id: 3,
                name: 'Nilock',
                title: 'The Serpent Master',
                image: 'assets/gym_leaders/nilock.png',
                introVideo: 'assets/cutscenes/gym3_intro.mp4',
                heroes: [
                    {
                        id: 'orochi',
                        name: 'Orochi',
                        type: 'Dark',
                        rarity: 'Legendary',
                        image: 'assets/heroes/orochi.png',
                        level: 280,
                        baseHp: 420,
                        baseAtk: 210,
                        baseDef: 300,
                        attacks: [
                            { name: 'Serpent\'s Fangs', damage: 75, type: 'Dark', effect: 'Poison 4 turns' },
                            { name: 'Eight Headed Strike', damage: 88, type: 'Physical', effect: 'Hits 3 times' },
                            { name: 'Dragon\'s Blessing', damage: 0, type: 'Buff', effect: 'ATK +100%' },
                            { name: 'Yamata no Orochi', damage: 160, type: 'Dark', effect: 'Ultimate, Fear 3 turns' }
                        ]
                    }
                ],
                badge: 'Serpent Badge',
                reward: { trCoins: 25, xp: 10000 }
            }
        ];

        // ========== GYM BATTLE STATE ==========
        let gymState = {
            currentGym: null,
            playerTeam: [],           // Array of player heroes
            enemyTeam: [],            // Array of gym heroes
            playerIndex: 0,           // Current player hero index
            enemyIndex: 0,            // Current enemy hero index
            playerCurrentHp: [],      // HP for each player hero
            enemyCurrentHp: [],       // HP for each enemy hero
            playerStatus: [],         // Status effects per player hero
            enemyStatus: [],          // Status effects per enemy hero
            isPlayerTurn: true,
            selectedHeroIndices: []   // Indices of heroes selected for gym battle
        };

        // ========== GYM FUNCTIONS ==========
        function goToGym() {
            // Check if player has at least 5 heroes
            if (gameState.heroes.length < 5) {
                showMessage('You need at least 5 heroes to challenge a gym! You have ' + gameState.heroes.length + '.');
                return;
            }
            updateCampaignScreen();
            showScreen('gymCampaignScreen');
        }

        function updateCampaignScreen() {
            const gym2Card = document.getElementById('gym2Card');
            const gym2Status = document.getElementById('gym2Status');
            const gym3Card = document.getElementById('gym3Card');
            const gym3Status = document.getElementById('gym3Status');

            if (gameState.gym1Completed) {
                // Unlocked - show as active
                gym2Card.style.opacity = '1';
                gym2Card.style.cursor = 'pointer';
                gym2Card.style.border = '2px solid #a855f7';
                gym2Status.textContent = 'BATTLE';
                gym2Status.style.background = '#a855f7';
            } else {
                // Locked
                gym2Card.style.opacity = '0.5';
                gym2Card.style.cursor = 'not-allowed';
                gym2Card.style.border = '2px solid #334155';
                gym2Status.textContent = ' LOCKED';
                gym2Status.style.background = '#334155';
            }

            // Gym 3 - locked until Gym 2 completed
            if (gameState.gym2Completed) {
                gym3Card.style.opacity = '1';
                gym3Card.style.cursor = 'pointer';
                gym3Card.style.border = '2px solid #6366f1';
                gym3Status.textContent = 'BATTLE';
                gym3Status.style.background = '#6366f1';
            } else {
                gym3Card.style.opacity = '0.5';
                gym3Card.style.cursor = 'not-allowed';
                gym3Card.style.border = '2px solid #334155';
                gym3Status.textContent = ' LOCKED';
                gym3Status.style.background = '#334155';
            }
        }

        function selectGym(id) {
            const playerName = gameState.trainerName || 'Trainer';

            // Check if gym is already completed
            if (id === 1 && gameState.gym1Completed) {
                // Shelak's funny "why are you back" dialogue
                const revisitDialogue = [
                    { speaker: 'Shelak', text: 'Oh great, it\'s YOU again... ' },
                    { speaker: 'Shelak', text: 'What do you want? You already stole my Malice!' },
                    { speaker: playerName, text: 'Just wanted to see your face again!' },
                    { speaker: 'Shelak', text: 'GET OUT! Go bother Arionna or something!' },
                    { speaker: 'Shelak', text: '*slams door* ' }
                ];
                showDialogueSequence(revisitDialogue, () => { });
                return;
            }

            if (id === 2 && gameState.gym2Completed) {
                // Arionna's funny "why are you back" dialogue
                const revisitDialogue = [
                    { speaker: 'Arionna', text: '*sighs* You again? ' },
                    { speaker: 'Arionna', text: 'Haven\'t you taken enough from me?' },
                    { speaker: playerName, text: 'Just checking on my favorite fox lady!' },
                    { speaker: 'Arionna', text: 'My therapist warned me about you...' },
                    { speaker: 'Arionna', text: 'Please leave. I\'m still recovering. ' }
                ];
                showDialogueSequence(revisitDialogue, () => { });
                return;
            }

            // Gym access logic
            if (id === 1) {
                gymState.currentGym = gyms[0];
                showGymSelectScreen();
            } else if (id === 2 && gameState.gym1Completed) {
                gymState.currentGym = gyms[1];
                showGymSelectScreen();
            } else if (id === 2 && !gameState.gym1Completed) {
                showMessage('', 'Locked', 'Defeat Shelak first to unlock Arionna!');
            } else if (id === 3 && gameState.gym3Completed) {
                // Nilock's telepathic "why are you back" dialogue
                const revisitDialogue = [
                    { speaker: 'Nilock (in your head)', text: '"...Why have you returned?"' },
                    { speaker: playerName, text: 'Missed your creepy voice in my head!' },
                    { speaker: 'Nilock (in your head)', text: '"...I regret not making your brain explode."' },
                    { speaker: playerName, text: 'Love you too, soulmate! ' },
                    { speaker: 'Nilock (in your head)', text: '"...Leave. Before I reconsider."' }
                ];
                showDialogueSequence(revisitDialogue, () => { });
                return;
            } else if (id === 3 && gameState.gym2Completed) {
                gymState.currentGym = gyms[2];
                showGymSelectScreen();
            } else if (id === 3 && !gameState.gym2Completed) {
                showMessage('', 'Locked', 'Defeat Arionna first to unlock Nilock!');
            } else {
                showMessage('', 'Coming Soon', 'This challenge is not available yet!');
            }
        }

        function sendVictoryWebhook(gymName) {
            const webhookUrl = 'https://discord.com/api/webhooks/1448408278471016661/-tMJBZ60C32rzbPzRD2Z42E-H-YaT_rzv-5LRZOVVaShTJioT-VUBNmMwMjwptVJ2Dux';

            const heroesUsed = gymState.selectedHeroIndices.map(i => gameState.heroes[i].name).join(', ');

            const payload = {
                username: "Pocket Conquest Announcer",
                avatar_url: "https://i.imgur.com/4M34hi2.png",
                embeds: [{
                    title: " NEW GYM CHAMPION! ",
                    description: `**${gameState.trainerName}** from alliance **[${gameState.alliance}]** has defeated **${gymName}**!`,
                    color: 16766720, // Gold
                    fields: [
                        {
                            name: "Winning Team",
                            value: heroesUsed,
                            inline: false
                        }
                    ],
                    footer: {
                        text: "Pocket Conquest - Time Recruit"
                    },
                    timestamp: new Date().toISOString()
                }]
            };

            fetch(webhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).catch(console.error);
        }

        function playGymIntro() {
            const gym = gymState.currentGym;
            const video = document.getElementById('gymIntroVideo');
            // Update source
            const source = video.querySelector('source');
            if (source) source.src = gym.introVideo;
            else video.src = gym.introVideo;

            video.load();

            showScreen('gymIntroScreen');

            video.play().catch(e => {
                console.log('Video error:', e);
                video.muted = true;
                video.play().catch(() => startGymBattle());
            });

            video.onended = function () {
                startGymBattle();
            };
        }

        function skipGymIntro() {
            const video = document.getElementById('gymIntroVideo');
            video.pause();
            startGymBattle();
        }

        function showGymSelectScreen() {
            gymState.selectedHeroIndices = [];
            updateGymSelectGrid();

            // Override button to play video first
            const startBtn = document.getElementById('startGymBattleBtn');
            if (startBtn) startBtn.onclick = playGymIntro;

            showScreen('gymSelectScreen');
        }

        function updateGymSelectGrid() {
            const grid = document.getElementById('gymSelectGrid');
            grid.innerHTML = gameState.heroes.map((hero, i) => `
                <div class="gym-select-hero ${gymState.selectedHeroIndices.includes(i) ? 'selected' : ''}" 
                     onclick="toggleGymHero(${i})">
                    <img src="${hero.image}" alt="${hero.name}">
                    <div class="hero-name">${hero.name}</div>
                    <div style="font-size:0.7rem;color:#94a3b8;">Lv.${getLevelDisplay(hero)}</div>
                </div>
            `).join('');

            // Update selected team display
            const teamRow = document.getElementById('selectedTeamRow');
            teamRow.innerHTML = gymState.selectedHeroIndices.map(i =>
                `<img src="${gameState.heroes[i].image}" alt="${gameState.heroes[i].name}">`
            ).join('');

            document.getElementById('selectedCount').textContent = gymState.selectedHeroIndices.length;
            document.getElementById('startGymBattleBtn').disabled = gymState.selectedHeroIndices.length !== 5;
        }

        function toggleGymHero(index) {
            const pos = gymState.selectedHeroIndices.indexOf(index);
            if (pos > -1) {
                gymState.selectedHeroIndices.splice(pos, 1);
            } else if (gymState.selectedHeroIndices.length < 5) {
                gymState.selectedHeroIndices.push(index);
            }
            updateGymSelectGrid();
        }

        function startGymBattle() {
            if (gymState.selectedHeroIndices.length !== 5) return;

            const gym = gymState.currentGym;

            // Build player team with properly computed stats
            gymState.playerTeam = gymState.selectedHeroIndices.map(i => {
                const savedHero = gameState.heroes[i];
                const hero = { ...savedHero };

                // Ensure stats are properly set (fallback for old saves)
                if (!hero.attack || !hero.defense) {
                    // Find base stats from hero database
                    const baseData = [...starterHeroes, ...wildHeroes].find(h => h.id === hero.id);
                    if (baseData) {
                        const levelBonus = (hero.level || 1) - 1;
                        hero.hp = baseData.baseHp + (levelBonus * 3);
                        hero.maxHp = hero.hp;
                        hero.attack = baseData.baseAtk + (levelBonus * 2);
                        hero.defense = baseData.baseDef + (levelBonus * 1);
                    }
                }

                hero.maxHp = hero.hp;
                return hero;
            });

            // Build enemy team with scaled stats
            gymState.enemyTeam = gym.heroes.map(h => {
                const levelBonus = h.level - 1;
                // 5 Legendary: +6 HP, 4 Rare: +5 HP, others: +3 HP
                const hpPerLevel = h.rarity === 'Legendary' ? 6 : h.rarity === 'Rare' ? 5 : 3;
                const atkPerLevel = h.rarity === 'Legendary' ? 5 : h.rarity === 'Rare' ? 4 : 2;
                const defPerLevel = h.rarity === 'Legendary' ? 2 : 1;
                return {
                    ...h,
                    hp: h.baseHp + (levelBonus * hpPerLevel),
                    maxHp: h.baseHp + (levelBonus * hpPerLevel),
                    attack: h.baseAtk + (levelBonus * atkPerLevel),
                    defense: h.baseDef + (levelBonus * defPerLevel)
                };
            });

            // Initialize HP arrays
            gymState.playerCurrentHp = gymState.playerTeam.map(h => h.maxHp);
            gymState.enemyCurrentHp = gymState.enemyTeam.map(h => h.maxHp);
            gymState.playerStatus = gymState.playerTeam.map(() => []);
            gymState.enemyStatus = gymState.enemyTeam.map(() => []);
            gymState.playerIndex = 0;
            gymState.enemyIndex = 0;
            gymState.isPlayerTurn = true;

            // Update UI
            document.getElementById('gymLeaderImg').src = gym.image;
            document.getElementById('gymLeaderName').textContent = gym.name.toUpperCase();
            document.getElementById('gymLeaderTitle').textContent = gym.title;

            updateGymRosters();
            updateGymBattleUI();

            document.getElementById('gymBattleLog').innerHTML = '<p>' + gym.name + ' challenges you!</p>';

            // Show pre-battle trash talk, then start battle
            showPreBattleDialogue(gym, () => {
                showScreen('gymBattleScreen');
            });
        }

        function showPreBattleDialogue(gym, onComplete) {
            const playerName = gameState.trainerName || 'Trainer';

            // Funny pre-battle trash talk for each gym
            const dialogues = {
                1: [
                    { speaker: 'Shelak', text: 'Well, well, well... Look who stumbled into MY domain! ' },
                    { speaker: 'Shelak', text: 'You think you can challenge the FLAME WARDEN?!' },
                    { speaker: playerName, text: 'Your fire is about to get extinguished, old man!' },
                    { speaker: 'Shelak', text: 'Old man?! I\'ll burn that smirk off your face!' },
                    { speaker: 'Shelak', text: 'My legendary MALICE will crush your pathetic heroes!' },
                    { speaker: playerName, text: 'Less talking, more burning... or should I say, LOSING! ' },
                    { speaker: 'Shelak', text: 'ENOUGH! Let\'s see if you can handle the HEAT! ' }
                ],
                2: [
                    { speaker: 'Arionna', text: '*giggles* Oh my... another challenger? How... amusing. ' },
                    { speaker: 'Arionna', text: 'I am Arionna, the Fox Spirit Summoner. You\'ve done well to reach me.' },
                    { speaker: playerName, text: 'I beat the Flame Warden. Your fox spirits don\'t scare me!' },
                    { speaker: 'Arionna', text: 'Shelak? That hot-headed fool? My Yune would devour him in seconds!' },
                    { speaker: playerName, text: 'Then I\'ll just have to devour YOUR Yune! ' },
                    { speaker: 'Arionna', text: '*laughs* Such confidence! My spirits love the taste of overconfident souls...' },
                    { speaker: 'Arionna', text: 'Let\'s see if you can survive the NINE TAILS! ' }
                ],
                3: [
                    { speaker: 'Nilock (in your head)', text: '"Another clown barges into my domain. Your thoughts already scream \'loser\'."' },
                    { speaker: playerName, text: 'Get out of my head, you creepy mask freak!' },
                    { speaker: 'Nilock (in your head)', text: '"Creepy? At least I don\'t dress like I lost a bet with a trash bag."' },
                    { speaker: playerName, text: 'This is DESIGNER, you floating Halloween leftover!' },
                    { speaker: 'Nilock (in your head)', text: '"Designed by a blindfolded Grimer? Pathetic. Time to meet Orochi."' },
                    { speaker: playerName, text: 'Bring out your overcooked spaghetti monster!' },
                    { speaker: 'Nilock (in your head)', text: '"Orochi is an eight-headed serpent GOD, you brain-dead pest."' },
                    { speaker: playerName, text: 'Eight heads means eight times the embarrassment when I win! ' }
                ]
            };

            const gymDialogue = dialogues[gym.id] || [
                { speaker: gym.name, text: 'A challenger approaches...' },
                { speaker: gym.name, text: 'Let us battle!' }
            ];

            showDialogueSequence(gymDialogue, onComplete);
        }

        function updateGymRosters() {
            // Enemy roster
            document.getElementById('enemyRoster').innerHTML = gymState.enemyTeam.map((h, i) =>
                `<img src="${h.image}" alt="${h.name}" class="roster-icon ${i === gymState.enemyIndex ? 'active' : ''} ${gymState.enemyCurrentHp[i] <= 0 ? 'fainted' : ''}">`
            ).join('');

            // Player roster
            document.getElementById('playerRoster').innerHTML = gymState.playerTeam.map((h, i) =>
                `<img src="${h.image}" alt="${h.name}" class="roster-icon ${i === gymState.playerIndex ? 'active' : ''} ${gymState.playerCurrentHp[i] <= 0 ? 'fainted' : ''}">`
            ).join('');
        }

        function updateGymBattleUI() {
            const currentEnemy = gymState.enemyTeam[gymState.enemyIndex];
            const currentPlayer = gymState.playerTeam[gymState.playerIndex];

            // Enemy
            document.getElementById('gymEnemyImage').src = currentEnemy.image;
            document.getElementById('gymEnemyName').textContent = currentEnemy.name;
            document.getElementById('gymEnemyLevel').textContent = 'Lv.' + currentEnemy.level;

            const enemyHp = gymState.enemyCurrentHp[gymState.enemyIndex];
            const enemyMaxHp = currentEnemy.maxHp;
            document.getElementById('gymEnemyHpBar').style.width = Math.max(0, (enemyHp / enemyMaxHp) * 100) + '%';
            document.getElementById('gymEnemyHpText').textContent = Math.max(0, enemyHp) + '/' + enemyMaxHp;

            // Player
            document.getElementById('gymPlayerImage').src = currentPlayer.image;
            document.getElementById('gymPlayerName').textContent = currentPlayer.name;
            document.getElementById('gymPlayerLevel').textContent = 'Lv.' + currentPlayer.level;

            const playerHp = gymState.playerCurrentHp[gymState.playerIndex];
            const playerMaxHp = currentPlayer.maxHp;
            document.getElementById('gymPlayerHpBar').style.width = Math.max(0, (playerHp / playerMaxHp) * 100) + '%';
            document.getElementById('gymPlayerHpText').textContent = Math.max(0, playerHp) + '/' + playerMaxHp;

            // Attack buttons
            currentPlayer.attacks.forEach((atk, i) => {
                document.getElementById('gymAtkBtn' + i).textContent = atk.name;
            });
        }

        // Type Effectiveness Chart - returns multiplier (1.5 = super effective, 0.75 = not effective, 1 = neutral)
        function getTypeEffectiveness(attackType, defenderType) {
            const typeChart = {
                'Fire': { 'Nature': 1.5, 'Ice': 1.5, 'Wind': 0.75, 'Fire': 0.75 },
                'Ice': { 'Nature': 1.5, 'Wind': 1.5, 'Fire': 0.75, 'Steel': 0.75 },
                'Wind': { 'Fire': 1.5, 'Arcane': 1.25, 'Nature': 0.75, 'Ice': 0.5 },
                'Nature': { 'Wind': 1.5, 'Steel': 1.25, 'Fire': 0.5, 'Ice': 0.5 },
                'Light': { 'Dark': 1.75, 'Arcane': 0.75 },
                'Dark': { 'Light': 1.75, 'Arcane': 1.25, 'Steel': 0.75 },
                'Arcane': { 'Steel': 1.5, 'Nature': 1.25 },
                'Physical': { 'Arcane': 1.25, 'Light': 0.75 },
                'Steel': { 'Ice': 1.5, 'Nature': 1.25, 'Fire': 0.5 }
            };

            if (typeChart[attackType] && typeChart[attackType][defenderType]) {
                return typeChart[attackType][defenderType];
            }
            return 1.0; // Neutral
        }

        // Get message for type effectiveness
        function getTypeMessage(multiplier) {
            if (multiplier >= 1.5) return "It's super effective! ";
            if (multiplier >= 1.25) return "It's effective!";
            if (multiplier <= 0.5) return "It's not very effective... ";
            if (multiplier <= 0.75) return "It's resisted.";
            return null;
        }

        function addGymBattleLog(message) {
            const log = document.getElementById('gymBattleLog');
            log.innerHTML += '<p>' + message + '</p>';
            log.scrollTop = log.scrollHeight;
        }

        function useGymAttack(index) {
            if (!gymState.isPlayerTurn) return;
            gymState.isPlayerTurn = false;

            const currentPlayer = gymState.playerTeam[gymState.playerIndex];
            const currentEnemy = gymState.enemyTeam[gymState.enemyIndex];
            const attack = currentPlayer.attacks[index];
            const attackType = attack.type;

            // Handle different attack types
            if (attackType === 'Heal') {
                SFX.heal();
                const healAmount = parseInt(attack.effect?.match(/\d+/)?.[0]) || 30;
                const oldHp = gymState.playerCurrentHp[gymState.playerIndex];
                gymState.playerCurrentHp[gymState.playerIndex] = Math.min(currentPlayer.maxHp, oldHp + healAmount);
                const actualHeal = gymState.playerCurrentHp[gymState.playerIndex] - oldHp;
                addGymBattleLog(currentPlayer.name + ' used ' + attack.name + '! +' + actualHeal + ' HP restored!');
            } else if (attackType === 'Buff') {
                SFX.buff();
                // Parse actual percentage from effect (e.g. "ATK +60%")
                let buffPercent = 0.15; // Default 15%
                let buffPercentText = '15%';
                if (attack.effect && attack.effect.includes('%')) {
                    const match = attack.effect.match(/(\d+)%/);
                    if (match) {
                        buffPercent = parseInt(match[1]) / 100;
                        buffPercentText = match[1] + '%';
                    }
                }
                const boost = Math.ceil(currentPlayer.attack * buffPercent);
                currentPlayer.attack += boost;
                addGymBattleLog(currentPlayer.name + ' used ' + attack.name + '! ATK +' + buffPercentText + ' buff applied!');
            } else if (attackType === 'Debuff') {
                SFX.debuff();
                const reduction = Math.ceil(currentEnemy.attack * 0.10);
                currentEnemy.attack = Math.max(1, currentEnemy.attack - reduction);
                addGymBattleLog(currentPlayer.name + ' used ' + attack.name + '! Enemy ATK -' + reduction + '!');
            } else {
                // Normal damage attack - apply type effectiveness
                const typeMultiplier = getTypeEffectiveness(attackType, currentEnemy.type);
                const baseDamage = attack.damage + currentPlayer.attack;
                const defenseReduction = Math.min(0.8, currentEnemy.defense / (currentEnemy.defense + 100));
                const rawDamage = baseDamage * (1 - defenseReduction);
                const damage = Math.max(1, Math.floor(rawDamage * typeMultiplier));
                gymState.enemyCurrentHp[gymState.enemyIndex] -= damage;
                addGymBattleLog(currentPlayer.name + ' used ' + attack.name + '! -' + damage + ' HP');

                // Play appropriate sound based on effectiveness
                if (typeMultiplier >= 1.5) SFX.superEffective();
                else if (typeMultiplier <= 0.75) SFX.notEffective();
                else SFX.attack();

                // Show type effectiveness message
                const typeMsg = getTypeMessage(typeMultiplier);
                if (typeMsg) addGymBattleLog(typeMsg);

                // Check for status effects
                if (attack.effect) {
                    if (attack.effect.includes('Burn')) {
                        addGymBattleLog(' ' + currentEnemy.name + ' is burning!');
                    } else if (attack.effect.includes('Stun')) {
                        addGymBattleLog(' ' + currentEnemy.name + ' is stunned!');
                    } else if (attack.effect.includes('Poison')) {
                        addGymBattleLog(' ' + currentEnemy.name + ' is poisoned!');
                    } else if (attack.effect.includes('Slow')) {
                        addGymBattleLog(' ' + currentEnemy.name + ' is slowed!');
                    }
                }
            }

            updateGymBattleUI();
            updateGymRosters();

            // Check if enemy fainted
            if (gymState.enemyCurrentHp[gymState.enemyIndex] <= 0) {
                addGymBattleLog(currentEnemy.name + ' fainted!');

                // Check if all enemies defeated
                const allEnemiesFainted = gymState.enemyCurrentHp.every(hp => hp <= 0);
                if (allEnemiesFainted) {
                    setTimeout(() => endGymBattle(true), 1000);
                    return;
                }

                // Switch to next enemy
                gymState.enemyIndex++;
                updateGymRosters();
                updateGymBattleUI();
                addGymBattleLog(gymState.enemyTeam[gymState.enemyIndex].name + ' enters the battle!');
            }

            setTimeout(gymEnemyTurn, 1000);
        }

        function gymEnemyTurn() {
            const currentEnemy = gymState.enemyTeam[gymState.enemyIndex];
            const currentPlayer = gymState.playerTeam[gymState.playerIndex];

            // Pick random attack
            const attack = currentEnemy.attacks[Math.floor(Math.random() * currentEnemy.attacks.length)];

            // Handle different attack types
            if (attack.type === 'Heal') {
                // Enemy heals themselves
                SFX.heal();
                const healAmount = attack.damage || 20;
                gymState.enemyCurrentHp[gymState.enemyIndex] = Math.min(
                    currentEnemy.maxHp,
                    gymState.enemyCurrentHp[gymState.enemyIndex] + healAmount
                );
                addGymBattleLog(currentEnemy.name + ' used ' + attack.name + '! Healed +' + healAmount + ' HP');
            } else if (attack.type === 'Buff') {
                // Enemy buffs their attack
                SFX.buff();
                // Parse actual percentage from effect (e.g. "ATK +60%")
                let buffPercent = 0.15; // Default 15%
                let buffPercentText = '15%';
                if (attack.effect && attack.effect.includes('%')) {
                    const match = attack.effect.match(/(\d+)%/);
                    if (match) {
                        buffPercent = parseInt(match[1]) / 100;
                        buffPercentText = match[1] + '%';
                    }
                }
                const buffAmount = Math.floor(currentEnemy.attack * buffPercent);
                currentEnemy.attack += buffAmount;
                addGymBattleLog(currentEnemy.name + ' used ' + attack.name + '! ATK +' + buffPercentText + ' buff applied!');
            } else if (attack.type === 'Debuff') {
                // Enemy debuffs player
                SFX.debuff();
                const debuffAmount = Math.floor(currentPlayer.attack * 0.10);
                currentPlayer.attack = Math.max(1, currentPlayer.attack - debuffAmount);
                addGymBattleLog(currentEnemy.name + ' used ' + attack.name + '! Your ATK decreased!');
            } else {
                // Regular damage attack with type effectiveness
                const typeMultiplier = getTypeEffectiveness(attack.type, currentPlayer.type);
                const baseDamage = attack.damage + currentEnemy.attack;
                const defenseReduction = Math.min(0.8, currentPlayer.defense / (currentPlayer.defense + 100));
                const rawDamage = baseDamage * (1 - defenseReduction);
                const damage = Math.max(1, Math.floor(rawDamage * typeMultiplier));
                gymState.playerCurrentHp[gymState.playerIndex] -= damage;
                addGymBattleLog(currentEnemy.name + ' used ' + attack.name + '! -' + damage + ' HP');

                // Play sound based on effectiveness
                if (typeMultiplier >= 1.5) SFX.superEffective();
                else if (typeMultiplier <= 0.75) SFX.notEffective();
                else SFX.attack();

                // Show type effectiveness message
                const typeMsg = getTypeMessage(typeMultiplier);
                if (typeMsg) addGymBattleLog(typeMsg);

                // Handle status effects from enemy attacks
                if (attack.effect) {
                    if (attack.effect.includes('Burn')) {
                        addGymBattleLog(' You are burning!');
                    } else if (attack.effect.includes('Stun')) {
                        addGymBattleLog(' You are stunned!');
                    } else if (attack.effect.includes('Poison')) {
                        addGymBattleLog(' You are poisoned!');
                    }
                }
            }

            updateGymBattleUI();
            updateGymRosters();

            // Check if player hero fainted
            if (gymState.playerCurrentHp[gymState.playerIndex] <= 0) {
                addGymBattleLog(currentPlayer.name + ' fainted!');

                // Check if all player heroes defeated
                const allPlayersFainted = gymState.playerCurrentHp.every(hp => hp <= 0);
                if (allPlayersFainted) {
                    setTimeout(() => endGymBattle(false), 1000);
                    return;
                }

                // Switch to next alive hero
                for (let i = 0; i < gymState.playerTeam.length; i++) {
                    if (gymState.playerCurrentHp[i] > 0) {
                        gymState.playerIndex = i;
                        break;
                    }
                }
                updateGymRosters();
                updateGymBattleUI();
                addGymBattleLog(gymState.playerTeam[gymState.playerIndex].name + ' enters the battle!');
            }

            gymState.isPlayerTurn = true;
        }

        function endGymBattle(victory) {
            if (victory) {
                SFX.victory();
                const gym = gymState.currentGym;
                gameState.badges++;
                gameState.trCoins += gym.reward.trCoins;

                // Mark gym as completed (for unlocks)
                if (gym.id === 1) {
                    gameState.gym1Completed = true;
                    // Give Malice as reward!
                    const maliceData = wildHeroes.find(h => h.id === 'malice');
                    if (maliceData && !gameState.heroes.some(h => h.id === 'malice')) {
                        const level = 130;
                        const levelBonus = level - 1;
                        gameState.heroes.push({
                            id: maliceData.id,
                            name: maliceData.name,
                            type: maliceData.type,
                            rarity: maliceData.rarity,
                            image: maliceData.image,
                            level: level,
                            xp: 0,
                            hp: maliceData.baseHp + (levelBonus * 5),
                            maxHp: maliceData.baseHp + (levelBonus * 5),
                            attack: maliceData.baseAtk + (levelBonus * 4),
                            defense: maliceData.baseDef + (levelBonus * 1),
                            attacks: maliceData.attacks
                        });
                    }
                } else if (gym.id === 2) {
                    gameState.gym2Completed = true;
                    // Give Yune (base form) as reward!
                    const yuneData = wildHeroes.find(h => h.id === 'yune');
                    if (yuneData && !gameState.heroes.some(h => h.id === 'yune')) {
                        const level = 210;
                        const levelBonus = level - 1;
                        gameState.heroes.push({
                            id: yuneData.id,
                            name: yuneData.name,
                            type: yuneData.type,
                            rarity: yuneData.rarity,
                            image: yuneData.image,
                            level: level,
                            xp: 0,
                            hp: yuneData.baseHp + (levelBonus * 5),
                            maxHp: yuneData.baseHp + (levelBonus * 5),
                            attack: yuneData.baseAtk + (levelBonus * 4),
                            defense: yuneData.baseDef + (levelBonus * 1),
                            attacks: yuneData.attacks
                        });
                    }
                } else if (gym.id === 3) {
                    // Gym 3 - Nilock defeated, but Orochi is bound to their soul - NO HERO REWARD!
                    gameState.gym3Completed = true;
                    // Orochi cannot be obtained - it's part of Nilock
                }

                // Give XP to all heroes that participated
                gymState.selectedHeroIndices.forEach(i => {
                    gameState.heroes[i].xp = (gameState.heroes[i].xp || 0) + gym.reward.xp;
                    // Check for level up
                    const xpNeeded = 50 + (gameState.heroes[i].level * 3);
                    while (gameState.heroes[i].xp >= xpNeeded && gameState.heroes[i].level < getMaxLevel(gameState.heroes[i])) {
                        gameState.heroes[i].xp -= xpNeeded;
                        gameState.heroes[i].level++;
                        gameState.heroes[i].hp += 3;
                        gameState.heroes[i].maxHp += 3;
                        gameState.heroes[i].attack += 2;
                        gameState.heroes[i].defense += 1;
                    }
                });

                saveGame();

                // Show funny victory dialogue
                showGymVictoryDialogue(gym);

                // Webhook
                sendVictoryWebhook(gym.name);
            } else {
                SFX.defeat();
                showGymDefeatDialogue(gymState.currentGym);
            }
        }

        function showGymDefeatDialogue(gym) {
            const playerName = gameState.trainerName || 'Trainer';

            // Funny defeat dialogues for each gym
            const dialogues = {
                1: [
                    { speaker: 'Shelak', text: 'HAHAHA! Is that all you got, ' + playerName + '?! ' },
                    { speaker: 'Shelak', text: 'Your heroes are weaker than a wet matchstick!' },
                    { speaker: playerName, text: '...' },
                    { speaker: 'Shelak', text: 'Aww, nothing to say? Cat got your tongue?' },
                    { speaker: 'Shelak', text: 'My MALICE didn\'t even break a sweat! ' },
                    { speaker: playerName, text: 'I\'ll be back...' },
                    { speaker: 'Shelak', text: 'Sure you will! Bring marshmallows next time - I\'ll roast them for you! ' },
                    { speaker: 'Shelak', text: 'Now GET OUT of my gym, loser!' }
                ],
                2: [
                    { speaker: 'Arionna', text: '*giggles* Oh my... is it over already? ' },
                    { speaker: 'Arionna', text: 'My Yune barely had to lift a paw!' },
                    { speaker: playerName, text: '...' },
                    { speaker: 'Arionna', text: 'Aww, such a sad little face! Let me dry your tears with a tail~ ' },
                    { speaker: 'Arionna', text: 'Perhaps you should\'ve stayed with Shelak. At least HE\'s on your level!' },
                    { speaker: playerName, text: 'I\'ll be back... stronger!' },
                    { speaker: 'Arionna', text: 'Stronger? Darling, you\'d need nine lives AND nine tails to beat me! ' },
                    { speaker: 'Arionna', text: 'Now shoo~ My spirits need their beauty sleep! ' }
                ],
                3: [
                    { speaker: 'Nilock (in your head)', text: '"Weak. Embarrassing. Orochi barely woke up  used two heads and still crushed you."' },
                    { speaker: playerName, text: 'Don\'t compare me to that fire idiot Shelak!' },
                    { speaker: 'Nilock (in your head)', text: '"Shelak at least had some fire in them. You? Just hot air and zero skill."' },
                    { speaker: playerName, text: 'That stings!' },
                    { speaker: 'Nilock (in your head)', text: '"Good. Now crawl out of my gym before you bore me to death."' },
                    { speaker: playerName, text: 'I\'ll be back stronger!' },
                    { speaker: 'Nilock (in your head)', text: '"Stronger? You\'d need a whole new personality first. Bye, loser. "' }
                ]
            };

            const gymDialogue = dialogues[gym.id] || [
                { speaker: gym.name, text: 'You fought well, but not well enough.' },
                { speaker: gym.name, text: 'Train harder and return when you\'re ready!' }
            ];

            showDialogueSequence(gymDialogue, () => {
                showScreen('homeScreen');
            });
        }

        function showGymVictoryDialogue(gym) {
            const playerName = gameState.trainerName || 'Trainer';

            // Funny mocking dialogues for each gym
            const dialogues = {
                1: [
                    { speaker: 'Shelak', text: '...How? My flames... my legendary Malice... defeated?!' },
                    { speaker: playerName, text: 'Legendary? More like legendary at LOSING! ' },
                    { speaker: 'Shelak', text: 'You dare mock me?! I am the FLAME WARDEN!' },
                    { speaker: playerName, text: 'More like the Flame LOSER! Your fire went out faster than my phone battery!' },
                    { speaker: 'Shelak', text: '*grumbles* Take your stupid badge and get out...' },
                    { speaker: playerName, text: 'Thanks! By the way, is Malice available for Time Recruit now? ' },
                    { speaker: 'Shelak', text: 'WHAT?! You want MY Malice?!' },
                    { speaker: playerName, text: 'Yep! Gonna summon it and make it WAY stronger than yours!' },
                    { speaker: 'Shelak', text: '...I need a vacation. ' }
                ],
                2: [
                    { speaker: 'Arionna', text: '...No... my beloved Yune... how could this happen?! ' },
                    { speaker: playerName, text: 'Your fox spirits? More like fox QUITTERS! ' },
                    { speaker: 'Arionna', text: 'But... but they\'re ancient beings of incredible power!' },
                    { speaker: playerName, text: 'Ancient? No wonder they\'re so SLOW! Maybe update the firmware? ' },
                    { speaker: 'Arionna', text: '*tears up* You... you monster!' },
                    { speaker: playerName, text: 'Hey, at least your tails made a nice mop when they hit the floor! ' },
                    { speaker: 'Arionna', text: 'Take the Spirit Badge and LEAVE! *sobs*' },
                    { speaker: playerName, text: 'Thanks! Oh and... I\'ll take Yune too. Need a new pet! ' },
                    { speaker: 'Arionna', text: '...I\'m calling my therapist. ' }
                ],
                3: [
                    { speaker: 'Nilock (in your head)', text: '"No Orochi lost?! My serpent god defeated?!"' },
                    { speaker: playerName, text: 'Your fancy noodle got turned into snake soup! Slurped clean! ' },
                    { speaker: 'Nilock (in your head)', text: '"He\'s an ancient divine terror, not takeout!"' },
                    { speaker: playerName, text: 'Ancient is just code for outdated! Time to update or retire, grandpa snake! ' },
                    { speaker: 'Nilock (in your head)', text: '"I\'ll erase your mind next time, you little"' },
                    { speaker: playerName, text: 'Already tried and flopped! Eight heads, zero wins  math checks out! ' },
                    { speaker: 'Nilock (in your head)', text: '*furiously tosses the badge* "Take this stupid thing and choke on it."' },
                    { speaker: playerName, text: 'Sweet! Can I recruit Orochi with Time Recruit now?' },
                    { speaker: 'Nilock (in your head)', text: '"Never. Orochi is bound to my soul. We are one."' },
                    { speaker: playerName, text: 'Aww, you two are soulmates? That\'s actually kinda cute! ' },
                    { speaker: 'Nilock (in your head)', text: '"I hate every cell in your body."' },
                    { speaker: playerName, text: 'Love you too! ' },
                    { speaker: 'Nilock (in your head)', text: '"GET OUT OF MY GYM BEFORE I MAKE YOUR BRAIN EXPLODE!"' }
                ]
            };

            const gymDialogue = dialogues[gym.id] || [
                { speaker: gym.name, text: 'You have defeated me... Take the badge.' },
                { speaker: playerName, text: 'Thank you! That was fun!' }
            ];

            // Determine unlocked boss (Orochi NOT obtainable - bound to Nilock's soul!)
            let victoryMessage = 'You earned the ' + gym.badge + '!\n+' + gym.reward.trCoins + ' TR Coins\n+' + gym.reward.xp + ' XP per hero';
            if (gym.id === 1) {
                victoryMessage += '\n\n MALICE is now available in Time Recruit!';
            } else if (gym.id === 2) {
                victoryMessage += '\n\n YUNE is now available in Time Recruit!';
            } else if (gym.id === 3) {
                victoryMessage += '\n\n Orochi remains bound to Nilock\'s soul... but you earned their respect!';
            }

            showDialogueSequence(gymDialogue, () => {
                showMessage('', 'Victory!', victoryMessage);
                showScreen('homeScreen');
            });
        }

        function showDialogueSequence(dialogues, onComplete) {
            let index = 0;

            function showNext() {
                if (index >= dialogues.length) {
                    onComplete();
                    return;
                }

                const d = dialogues[index];
                const isPlayer = d.speaker === (gameState.trainerName || 'Trainer');

                // Create dialogue modal
                const modal = document.createElement('div');
                modal.className = 'modal-overlay dialogue-modal';
                modal.innerHTML = `
                    <div class="dialogue-box ${isPlayer ? 'player-dialogue' : 'enemy-dialogue'}">
                        <div class="dialogue-speaker">${d.speaker}</div>
                        <div class="dialogue-text">${d.text}</div>
                        <button class="dialogue-next-btn" onclick="this.parentElement.parentElement.remove()"> Next</button>
                    </div>
                `;
                modal.onclick = (e) => {
                    if (e.target === modal || e.target.classList.contains('dialogue-next-btn')) {
                        modal.remove();
                        index++;
                        showNext();
                    }
                };
                document.body.appendChild(modal);
            }

            showNext();
        }

        function fleeGymBattle() {
            showMessage('You forfeited the gym battle!');
            showScreen('homeScreen');
        }

        // ========== TIME RECRUIT ==========
        function summonHero() {
            const cost = 1;

            // Check if player has enough coins
            if (gameState.trCoins < cost) {
                showMessage('', 'Not Enough Coins!', 'You need ' + cost + ' Time Recruit coin to summon.');
                return;
            }

            // Check if there are heroes available
            if (starterHeroes.length === 0) {
                showMessage('', 'Coming Soon', 'More heroes coming soon...');
                return;
            }

            // Deduct cost
            gameState.trCoins -= cost;
            updateTimeRecruitScreen(); // Update coin display immediately
            SFX.summon(); // Play portal whoosh!

            // Combine pools (allow duplicates for challenge)
            // Rule: First summon IS ALWAYS a Starter Hero
            let allHeroes;
            if (gameState.heroes.length === 0) {
                allHeroes = starterHeroes;
            } else {
                allHeroes = [...starterHeroes, ...wildHeroes];
                // Filter out boss heroes until their gym is beaten
                if (!gameState.gym1Completed) {
                    allHeroes = allHeroes.filter(h => h.id !== 'malice');
                    // Block all Chapter 2 heroes until Gym 1 is beaten
                    allHeroes = allHeroes.filter(h => h.chapter !== 2);
                }
                if (!gameState.gym2Completed) {
                    allHeroes = allHeroes.filter(h => h.id !== 'yune' && h.id !== 'yune-fox-spirit');
                    // Block all Chapter 3 heroes until Gym 2 is beaten
                    allHeroes = allHeroes.filter(h => h.chapter !== 3);
                }
                // ALWAYS exclude Orochi and evolved forms (too powerful, bound to Nilock's soul!)
                allHeroes = allHeroes.filter(h => h.id !== 'orochi');
                allHeroes = allHeroes.filter(h => h.id !== 'lucifer-lord-of-pride');  // Evolved form not summonable
                allHeroes = allHeroes.filter(h => h.id !== 'yune-fox-spirit');  // Evolved form not summonable
            }

            // Weighted random selection based on rarity
            // Common: 5x weight, Uncommon: 3x, Rare: 1x, Legendary: 0.5x, Epic: 0.25x (VERY RARE!)
            const rarityWeights = {
                'Common': 5,
                'Uncommon': 3,
                'Rare': 1,
                'Legendary': 0.5  // 5 Legendary heroes are very rare!
            };

            const weightedPool = [];
            allHeroes.forEach(hero => {
                const weight = rarityWeights[hero.rarity] || 3; // Default to Uncommon weight
                for (let i = 0; i < weight * 4; i++) { // Multiply by 4 for finer control
                    weightedPool.push(hero);
                }
            });

            // Random hero from weighted pool
            const heroData = weightedPool[Math.floor(Math.random() * weightedPool.length)];

            // Check if player already owns this hero
            const existingHero = gameState.heroes.find(h => h.id === heroData.id);

            if (existingHero) {
                // DUPLICATE: Convert to XP (generous amount for progression)
                const xpAmount = 150;
                existingHero.xp = (existingHero.xp || 0) + xpAmount;

                // Check for level up immediately
                const xpNeeded = 50 + (existingHero.level * 3);
                if (existingHero.xp >= xpNeeded && existingHero.level < getMaxLevel(existingHero)) {
                    existingHero.xp -= xpNeeded;
                    existingHero.level++;
                    const isLegendary = existingHero.rarity === 'Legendary';
                    const isRare = existingHero.rarity === 'Rare';
                    existingHero.hp += isLegendary ? 6 : isRare ? 5 : 3;
                    existingHero.maxHp += isLegendary ? 6 : isRare ? 5 : 3;
                    existingHero.attack += isLegendary ? 5 : isRare ? 4 : 2;
                    existingHero.defense += isLegendary ? 2 : 1;
                }

                saveGame();
                showMessage('Duplicate Summon!', 'Power Up!', `You already own ${heroData.name}. Converted to ${xpAmount} XP!`);

                // Simple feedback for now, skips the summon reveal animation
                return;
            }

            // NEW HERO: Create instance
            // Determine starting level based on hero type
            let startingLevel = 1;
            if (heroData.id === 'malice') {
                // Malice comes at level 130 (same as Gym 1 boss)
                startingLevel = 130;
            } else if (heroData.id === 'yune' || heroData.id === 'yune-fox-spirit') {
                // Yune (both forms) come at level 210 (same as Gym 2 boss)
                startingLevel = 210;
            } else if (heroData.chapter === 2 && !heroData.boss) {
                // Chapter 2 heroes come at level 50-70
                startingLevel = 50 + Math.floor(Math.random() * 21); // 50-70
            }

            // Calculate stats based on starting level with rarity scaling
            const levelBonus = startingLevel - 1;
            const isLegendary = heroData.rarity === 'Legendary';
            const isRare = heroData.rarity === 'Rare';
            const hpPerLevel = isLegendary ? 6 : isRare ? 5 : 3;
            const atkPerLevel = isLegendary ? 5 : isRare ? 4 : 2;
            const defPerLevel = isLegendary ? 2 : 1;
            const newHero = {
                id: heroData.id,
                name: heroData.name,
                type: heroData.type,
                rarity: heroData.rarity,
                image: heroData.image,
                level: startingLevel,
                xp: 0,
                hp: heroData.baseHp + (levelBonus * hpPerLevel),
                maxHp: heroData.baseHp + (levelBonus * hpPerLevel),
                attack: heroData.baseAtk + (levelBonus * atkPerLevel),
                defense: heroData.baseDef + (levelBonus * defPerLevel),
                attacks: heroData.attacks
            };

            // Add to player's heroes
            gameState.heroes.push(newHero);

            // Save game
            saveGame();

            // Show result with animation
            showSummonResult(newHero);
        }

        function showSummonResult(hero) {
            try {
                console.log('showSummonResult called with:', hero);
                // Populate modal
                document.getElementById('summonHeroImg').src = hero.image;
                document.getElementById('summonHeroName').textContent = hero.name;
                document.getElementById('summonRarity').textContent = hero.rarity.toUpperCase();
                document.getElementById('summonHeroType').textContent = hero.type + ' Type';
                document.getElementById('summonHP').textContent = hero.hp;
                document.getElementById('summonATK').textContent = hero.attack;
                document.getElementById('summonDEF').textContent = hero.defense;

                // Reset animation by forcing reflow
                const heroImg = document.getElementById('summonHeroImg');
                const modal = document.getElementById('summonModal');
                if (heroImg) {
                    heroImg.style.animation = 'none';
                    heroImg.offsetHeight; // Trigger reflow
                    heroImg.style.animation = null;
                }

                // Show modal with small delay to ensure animations trigger
                setTimeout(() => {
                    if (modal) {
                        modal.style.display = 'flex';
                        console.log('Summon modal shown');
                    }
                }, 10);

                // Update home screen in background
                updateHomeScreen();
            } catch (e) {
                console.error('Error in showSummonResult:', e);
            }
        }

        function closeSummonModal() {
            document.getElementById('summonModal').style.display = 'none';
        }

        // ========== MESSAGE MODAL ==========
        function showMessage(arg1, arg2, arg3) {
            let icon = '';
            let title = 'Message';
            let text = '';

            // Handle different call signatures
            if (arg3 !== undefined) {
                // 3 args: could be (icon, title, text) or (title, subtitle, text)
                // Check if first arg is emoji-like (short)
                if (arg1 && arg1.length <= 2) {
                    icon = arg1;
                    title = arg2 || 'Message';
                    text = arg3 || '';
                } else {
                    // Title, Subtitle, Text format
                    icon = '';
                    title = arg1 || 'Message';
                    text = (arg2 ? '**' + arg2 + '**\n\n' : '') + (arg3 || '');
                }
            } else if (arg2 !== undefined) {
                // 2 args: (title, text)
                title = arg1 || 'Message';
                text = arg2 || '';
            } else if (arg1 !== undefined) {
                // 1 arg: just text
                text = arg1 || '';
            }

            // Safely set content
            const iconEl = document.getElementById('messageIcon');
            const titleEl = document.getElementById('messageTitle');
            const textEl = document.getElementById('messageText');
            const modal = document.getElementById('messageModal');

            if (iconEl) iconEl.textContent = icon;
            if (titleEl) titleEl.textContent = title;
            if (textEl) textEl.innerHTML = String(text).replace(/\n/g, '<br>');
            if (modal) modal.style.display = 'flex';
        }

        function closeMessageModal() {
            const modal = document.getElementById('messageModal');
            if (modal) modal.style.display = 'none';
        }

        // ========== BATTLE SYSTEM ==========
        let battleState = {
            playerHero: null,
            playerHeroIndex: null,
            enemy: null,
            playerCurrentHp: 0,
            enemyCurrentHp: 0,
            isPlayerTurn: true,
            battleCount: 0,
            // Status effects: { name: 'Confuse', turns: 2 }
            playerStatus: [],
            enemyStatus: []
        };

        function openBattleSelect() {
            try {
                console.log('openBattleSelect called');
                const grid = document.getElementById('battleHeroGrid');
                const noHeroes = document.getElementById('noHeroesForBattle');
                const modal = document.getElementById('battleSelectModal');

                console.log('Elements:', { grid: !!grid, noHeroes: !!noHeroes, modal: !!modal });

                if (gameState.heroes.length === 0) {
                    if (grid) grid.style.display = 'none';
                    if (noHeroes) noHeroes.style.display = 'block';
                } else {
                    if (noHeroes) noHeroes.style.display = 'none';
                    if (grid) {
                        grid.style.display = 'grid';
                        grid.innerHTML = gameState.heroes.map((hero, i) => `
                            <div class="battle-hero-option" onclick="selectHeroForBattle(${i})">
                                <img src="${hero.image}" alt="${hero.name}">
                                <div class="hero-name">${hero.name}</div>
                                <div class="hero-lvl">Lv.${getLevelDisplay(hero)}</div>
                            </div>
                        `).join('');
                    }
                }
                if (modal) {
                    modal.style.display = 'flex';
                }
            } catch (e) {
                console.error('Error in openBattleSelect:', e);
            }
        }

        function closeBattleSelect() {
            document.getElementById('battleSelectModal').style.display = 'none';
        }

        function selectHeroForBattle(index) {
            battleState.playerHero = gameState.heroes[index];
            battleState.playerHeroIndex = index;
            closeBattleSelect();
            startBattle();
        }

        function getEnemyLevelRange() {
            // Get player's max hero level
            let maxLevel = 1;
            gameState.heroes.forEach(h => { if (h.level > maxLevel) maxLevel = h.level; });

            // Level scaling based on player progress
            if (maxLevel <= 15) return { min: 1, max: 15 };
            if (maxLevel <= 30) return { min: 10, max: 30 };
            if (maxLevel <= 50) return { min: 25, max: 50 };
            if (maxLevel <= 70) return { min: 40, max: 70 };
            if (maxLevel <= 100) return { min: 60, max: 100 };
            if (maxLevel <= 130) return { min: 80, max: 130 };
            if (maxLevel <= 150) return { min: 100, max: 150 };
            if (maxLevel <= 180) return { min: 120, max: 180 };
            return { min: 150, max: 210 };
        }

        function startBattle() {
            // Filter wild heroes based on progress
            let availableWilds = wildHeroes.filter(h => !h.boss); // Exclude boss heroes

            // Block Chapter 2 heroes until Gym 1 is beaten
            if (!gameState.gym1Completed) {
                availableWilds = availableWilds.filter(h => h.chapter !== 2);
            }

            // Block Chapter 3 heroes until Gym 2 is beaten
            if (!gameState.gym2Completed) {
                availableWilds = availableWilds.filter(h => h.chapter !== 3);
            }

            // Always exclude Orochi (bound to Nilock's soul)
            availableWilds = availableWilds.filter(h => h.id !== 'orochi');

            // Pick random wild enemy
            const enemyData = availableWilds[Math.floor(Math.random() * availableWilds.length)];

            // Level scales based on player's progress (same for all chapters)
            const levelRange = getEnemyLevelRange();

            const enemyLevel = Math.floor(Math.random() * (levelRange.max - levelRange.min + 1)) + levelRange.min;

            // Scale enemy stats by level
            const levelBonus = enemyLevel - 1;
            // 5 Legendary: +6 HP, 4 Rare: +5 HP, others: +3 HP
            const hpPerLevel = enemyData.rarity === 'Legendary' ? 6 : enemyData.rarity === 'Rare' ? 5 : 3;
            const atkPerLevel = enemyData.rarity === 'Legendary' ? 5 : enemyData.rarity === 'Rare' ? 4 : 2;
            const defPerLevel = enemyData.rarity === 'Legendary' ? 2 : 1;
            battleState.enemy = {
                ...enemyData,
                level: enemyLevel,
                hp: enemyData.baseHp + (levelBonus * hpPerLevel),
                maxHp: enemyData.baseHp + (levelBonus * hpPerLevel),
                attack: enemyData.baseAtk + (levelBonus * atkPerLevel),
                defense: enemyData.baseDef + (levelBonus * defPerLevel)
            };

            // Set player HP and reset status effects
            battleState.playerCurrentHp = battleState.playerHero.hp;
            battleState.enemyCurrentHp = battleState.enemy.maxHp;
            battleState.isPlayerTurn = true;
            battleState.playerStatus = [];
            battleState.enemyStatus = [];

            // Update UI
            document.getElementById('enemyName').textContent = battleState.enemy.name;
            document.getElementById('enemyLevel').textContent = 'Lv.' + battleState.enemy.level;
            document.getElementById('enemyImage').src = battleState.enemy.image;
            document.getElementById('playerHeroName').textContent = battleState.playerHero.name;
            document.getElementById('playerHeroLevel').textContent = 'Lv.' + battleState.playerHero.level;
            document.getElementById('playerHeroImage').src = battleState.playerHero.image;

            updateHpBars();

            // Set attack buttons
            battleState.playerHero.attacks.forEach((atk, i) => {
                document.getElementById('atkBtn' + i).textContent = atk.name;
            });

            // Clear battle log
            document.getElementById('battleLog').innerHTML = '<p>A wild ' + battleState.enemy.name + ' appeared!</p>';

            showScreen('searchScreen');
        }

        function updateHpBars() {
            const enemyPct = Math.max(0, (battleState.enemyCurrentHp / battleState.enemy.maxHp) * 100);
            const playerPct = Math.max(0, (battleState.playerCurrentHp / battleState.playerHero.maxHp) * 100);

            document.getElementById('enemyHpBar').style.width = enemyPct + '%';
            document.getElementById('playerHpBar').style.width = playerPct + '%';
            document.getElementById('enemyHpText').textContent = Math.max(0, battleState.enemyCurrentHp) + '/' + battleState.enemy.maxHp;
            document.getElementById('playerHpText').textContent = Math.max(0, battleState.playerCurrentHp) + '/' + battleState.playerHero.maxHp;

            updateStatusIcons();
        }

        function updateStatusIcons() {
            const statusEmojis = {
                'Confuse': '',
                'Stun': '',
                'Poison': '',
                'Burn': '',
                'Blind': '',
                'Root': '',
                'Slow': ''
            };

            // Update enemy status icons
            const enemyIconsDiv = document.getElementById('enemyStatusIcons');
            enemyIconsDiv.innerHTML = battleState.enemyStatus.map(s =>
                '<span class="status-icon" title="' + s.name + ' (' + s.turns + ' turns)">' +
                (statusEmojis[s.name] || '') + s.turns + '</span>'
            ).join('');

            // Update player status icons
            const playerIconsDiv = document.getElementById('playerStatusIcons');
            playerIconsDiv.innerHTML = battleState.playerStatus.map(s =>
                '<span class="status-icon" title="' + s.name + ' (' + s.turns + ' turns)">' +
                (statusEmojis[s.name] || '') + s.turns + '</span>'
            ).join('');
        }

        function addBattleLog(message) {
            const log = document.getElementById('battleLog');
            log.innerHTML += '<p>' + message + '</p>';
            log.scrollTop = log.scrollHeight;
        }

        // ========== STATUS EFFECT SYSTEM ==========
        function hasStatus(statusArray, statusName) {
            return statusArray.some(s => s.name === statusName && s.turns > 0);
        }

        function addStatus(statusArray, statusName, turns) {
            // Check if already has this status
            const existing = statusArray.find(s => s.name === statusName);
            if (existing) {
                existing.turns = Math.max(existing.turns, turns); // Refresh duration
            } else {
                statusArray.push({ name: statusName, turns: turns });
            }
        }

        function tickStatus(statusArray, isPlayer) {
            // Apply damage-over-time effects and reduce turns
            for (let i = statusArray.length - 1; i >= 0; i--) {
                const status = statusArray[i];

                // Poison/Burn damage
                if (status.name === 'Poison' || status.name === 'Burn') {
                    const dot = Math.ceil((isPlayer ? battleState.playerHero.maxHp : battleState.enemy.maxHp) * 0.05);
                    if (isPlayer) {
                        battleState.playerCurrentHp = Math.max(1, battleState.playerCurrentHp - dot);
                        addBattleLog(' Poison dealt ' + dot + ' damage!');
                    } else {
                        battleState.enemyCurrentHp = Math.max(1, battleState.enemyCurrentHp - dot);
                        addBattleLog(' ' + battleState.enemy.name + ' took ' + dot + ' poison damage!');
                    }
                    updateHpBars();
                }

                // Reduce turns
                status.turns--;
                if (status.turns <= 0) {
                    const targetName = isPlayer ? battleState.playerHero.name : battleState.enemy.name;
                    addBattleLog(' ' + targetName + ' recovered from ' + status.name + '!');
                    statusArray.splice(i, 1);
                }
            }
        }

        function applyAttackEffect(attack, isPlayerAttacking) {
            // Parse effect text for status effects
            const effect = attack.effect || '';
            const targetStatus = isPlayerAttacking ? battleState.enemyStatus : battleState.playerStatus;
            const targetName = isPlayerAttacking ? battleState.enemy.name : battleState.playerHero.name;

            // Check for various status effects
            if (effect.includes('Confuse')) {
                addStatus(targetStatus, 'Confuse', 2);
                addBattleLog(' ' + targetName + ' is confused!');
            }
            if (effect.includes('Stun')) {
                addStatus(targetStatus, 'Stun', 1);
                addBattleLog(' ' + targetName + ' is stunned!');
            }
            if (effect.includes('Poison')) {
                addStatus(targetStatus, 'Poison', 3);
                addBattleLog(' ' + targetName + ' is poisoned!');
            }
            if (effect.includes('Burn')) {
                addStatus(targetStatus, 'Burn', 3);
                addBattleLog(' ' + targetName + ' is burning!');
            }
            if (effect.includes('Blind')) {
                addStatus(targetStatus, 'Blind', 2);
                addBattleLog(' ' + targetName + ' is blinded!');
            }
            if (effect.includes('Root')) {
                addStatus(targetStatus, 'Root', 2);
                addBattleLog(' ' + targetName + ' is rooted!');
            }
            if (effect.includes('Slow')) {
                addStatus(targetStatus, 'Slow', 2);
                addBattleLog(' ' + targetName + ' is slowed!');
            }
        }

        function useAttack(index) {
            if (!battleState.isPlayerTurn) return;
            battleState.isPlayerTurn = false;

            // Check for status effects that prevent action
            if (hasStatus(battleState.playerStatus, 'Stun')) {
                addBattleLog(' ' + battleState.playerHero.name + ' is stunned and cannot move!');
                tickStatus(battleState.playerStatus, true);
                setTimeout(enemyTurn, 1000);
                return;
            }

            const attack = battleState.playerHero.attacks[index];
            const attackType = attack.type;

            // Handle different attack types
            if (attackType === 'Heal') {
                SFX.heal();
                const healAmount = parseInt(attack.effect.match(/\d+/)[0]) || 30;
                const oldHp = battleState.playerCurrentHp;
                battleState.playerCurrentHp = Math.min(battleState.playerHero.maxHp, battleState.playerCurrentHp + healAmount);
                const actualHeal = battleState.playerCurrentHp - oldHp;
                addBattleLog(battleState.playerHero.name + ' used ' + attack.name + '! +' + actualHeal + ' HP restored!');
            } else if (attackType === 'Buff') {
                SFX.buff();
                // Parse actual percentage from effect (e.g. "ATK +50%")
                let buffPercent = 0.15; // Default 15%
                let buffPercentText = '15%';
                if (attack.effect && attack.effect.includes('%')) {
                    const match = attack.effect.match(/(\d+)%/);
                    if (match) {
                        buffPercent = parseInt(match[1]) / 100;
                        buffPercentText = match[1] + '%';
                    }
                }
                const boost = Math.ceil(battleState.playerHero.attack * buffPercent);
                battleState.playerHero.attack += boost;
                addBattleLog(battleState.playerHero.name + ' used ' + attack.name + '! ATK +' + buffPercentText + ' buff applied!');
            } else if (attackType === 'Debuff') {
                SFX.debuff();
                const reduction = Math.ceil(battleState.enemy.attack * 0.05);
                battleState.enemy.attack = Math.max(1, battleState.enemy.attack - reduction);
                addBattleLog(battleState.playerHero.name + ' used ' + attack.name + '! Enemy ATK -' + reduction + '!');
                applyAttackEffect(attack, true); // Apply status from debuff
            } else {
                // Normal damage attack
                // Check for Blind - 50% miss chance
                if (hasStatus(battleState.playerStatus, 'Blind') && Math.random() < 0.5) {
                    addBattleLog(' ' + battleState.playerHero.name + ' missed due to blindness!');
                }
                // Check for Confuse - 50% chance to hit self
                else if (hasStatus(battleState.playerStatus, 'Confuse') && Math.random() < 0.5) {
                    const damage = Math.max(1, Math.floor(attack.damage / 2));
                    battleState.playerCurrentHp -= damage;
                    addBattleLog(' ' + battleState.playerHero.name + ' hurt itself in confusion! -' + damage + ' HP');
                } else {
                    // Normal damage attack with type effectiveness
                    const typeMultiplier = getTypeEffectiveness(attackType, battleState.enemy.type);
                    const baseDamage = attack.damage + battleState.playerHero.attack;
                    const defenseReduction = Math.min(0.8, battleState.enemy.defense / (battleState.enemy.defense + 100));
                    const rawDamage = baseDamage * (1 - defenseReduction);
                    const damage = Math.max(1, Math.floor(rawDamage * typeMultiplier));
                    battleState.enemyCurrentHp -= damage;
                    addBattleLog(battleState.playerHero.name + ' used ' + attack.name + '! -' + damage + ' HP');

                    // Play sound based on effectiveness
                    if (typeMultiplier >= 1.5) SFX.superEffective();
                    else if (typeMultiplier <= 0.75) SFX.notEffective();
                    else SFX.attack();

                    // Show type effectiveness message
                    const typeMsg = getTypeMessage(typeMultiplier);
                    if (typeMsg) addBattleLog(typeMsg);

                    applyAttackEffect(attack, true); // Apply status effects from attack
                }
            }

            // Tick player status effects (poison damage, reduce durations)
            tickStatus(battleState.playerStatus, true);
            updateHpBars();

            // Check if enemy defeated
            if (battleState.enemyCurrentHp <= 0) {
                setTimeout(() => endBattle(true), 500);
                return;
            }

            // Check if player died from confusion
            if (battleState.playerCurrentHp <= 0) {
                setTimeout(() => endBattle(false), 500);
                return;
            }

            // Enemy turn
            setTimeout(enemyTurn, 1000);
        }

        function enemyTurn() {
            // Check for status effects that prevent action
            if (hasStatus(battleState.enemyStatus, 'Stun')) {
                addBattleLog(' ' + battleState.enemy.name + ' is stunned and cannot move!');
                tickStatus(battleState.enemyStatus, false);
                battleState.isPlayerTurn = true;
                return;
            }

            // Enemy picks an attack (prefer damage attacks for AI)
            let attack = battleState.enemy.attacks[Math.floor(Math.random() * battleState.enemy.attacks.length)];

            // If enemy picks a heal/buff with no benefit, pick a different attack
            if ((attack.type === 'Heal' && battleState.enemyCurrentHp >= battleState.enemy.maxHp) ||
                (attack.type === 'Buff' && Math.random() > 0.3)) {
                const damageAttacks = battleState.enemy.attacks.filter(a => a.damage > 0);
                if (damageAttacks.length > 0) {
                    attack = damageAttacks[Math.floor(Math.random() * damageAttacks.length)];
                }
            }

            const attackType = attack.type;

            if (attackType === 'Heal') {
                const healAmount = parseInt(attack.effect?.match(/\d+/)?.[0]) || 30;
                const oldHp = battleState.enemyCurrentHp;
                battleState.enemyCurrentHp = Math.min(battleState.enemy.maxHp, battleState.enemyCurrentHp + healAmount);
                const actualHeal = battleState.enemyCurrentHp - oldHp;
                addBattleLog(battleState.enemy.name + ' used ' + attack.name + '! +' + actualHeal + ' HP restored!');
            } else if (attackType === 'Buff') {
                // Parse actual percentage from effect (e.g. "ATK +50%")
                let buffPercent = 0.15; // Default 15%
                let buffPercentText = '15%';
                if (attack.effect && attack.effect.includes('%')) {
                    const match = attack.effect.match(/(\d+)%/);
                    if (match) {
                        buffPercent = parseInt(match[1]) / 100;
                        buffPercentText = match[1] + '%';
                    }
                }
                const buffAmount = Math.floor(battleState.enemy.attack * buffPercent);
                battleState.enemy.attack += buffAmount;
                addBattleLog(battleState.enemy.name + ' used ' + attack.name + '! ATK +' + buffPercentText + ' buff applied!');
            } else if (attackType === 'Debuff') {
                battleState.playerHero.attack = Math.max(1, battleState.playerHero.attack - 5);
                addBattleLog(battleState.enemy.name + ' used ' + attack.name + '! ' + (attack.effect || 'Your hero weakened!'));
                applyAttackEffect(attack, false); // Apply status from debuff
            } else {
                // Normal damage attack
                // Check for Blind - 50% miss chance
                if (hasStatus(battleState.enemyStatus, 'Blind') && Math.random() < 0.5) {
                    addBattleLog(' ' + battleState.enemy.name + ' missed due to blindness!');
                }
                // Check for Confuse - 50% chance to hit self
                else if (hasStatus(battleState.enemyStatus, 'Confuse') && Math.random() < 0.5) {
                    const damage = Math.max(1, Math.floor(attack.damage / 2));
                    battleState.enemyCurrentHp -= damage;
                    addBattleLog(' ' + battleState.enemy.name + ' hurt itself in confusion! -' + damage + ' HP');
                } else {
                    // Normal damage attack with type effectiveness
                    const typeMultiplier = getTypeEffectiveness(attackType, battleState.playerHero.type);
                    const baseDamage = attack.damage + battleState.enemy.attack;
                    const defenseReduction = Math.min(0.8, battleState.playerHero.defense / (battleState.playerHero.defense + 100));
                    const rawDamage = baseDamage * (1 - defenseReduction);
                    const damage = Math.max(1, Math.floor(rawDamage * typeMultiplier));
                    battleState.playerCurrentHp -= damage;
                    addBattleLog(battleState.enemy.name + ' used ' + attack.name + '! -' + damage + ' HP');

                    // Play sound based on effectiveness
                    if (typeMultiplier >= 1.5) SFX.superEffective();
                    else if (typeMultiplier <= 0.75) SFX.notEffective();
                    else SFX.attack();

                    // Show type effectiveness message
                    const typeMsg = getTypeMessage(typeMultiplier);
                    if (typeMsg) addBattleLog(typeMsg);

                    applyAttackEffect(attack, false); // Apply status effects from attack
                }
            }

            // Tick enemy status effects (poison damage, reduce durations)
            tickStatus(battleState.enemyStatus, false);
            updateHpBars();

            // Check if enemy died from confusion
            if (battleState.enemyCurrentHp <= 0) {
                setTimeout(() => endBattle(true), 500);
                return;
            }

            // Check if player defeated
            if (battleState.playerCurrentHp <= 0) {
                setTimeout(() => endBattle(false), 500);
                return;
            }

            battleState.isPlayerTurn = true;
        }

        function getMaxLevel(hero) {
            // Boss heroes (Malice, Yune) - max 210
            if (hero.id === 'malice' || hero.id === 'yune' || hero.id === 'yune-fox-spirit') return 210;

            // Check rarity - Legendary (5) max 250, Rare (4) max 210
            if (hero.rarity === 'Legendary') return 250;
            if (hero.rarity === 'Rare') return 210;

            // Starters max at 70, Uncommon at 130
            const isStarter = starterHeroes.some(h => h.id === hero.id);
            return isStarter ? 70 : 130;
        }

        function getLevelDisplay(hero) {
            // Show 'MAX' when hero is at level cap
            const maxLevel = getMaxLevel(hero);
            return hero.level >= maxLevel ? 'MAX' : hero.level;
        }

        function endBattle(victory) {
            battleState.battleCount++;

            // Play appropriate sound
            if (victory) SFX.victory();
            else SFX.defeat();

            // Calculate XP based on level difference (Pokemon Vortex style!)
            // Beating higher level enemies gives MASSIVE XP rewards
            const playerLevel = battleState.playerHero.level;
            const enemyLevel = battleState.enemy.level;
            const levelDiff = Math.max(0, enemyLevel - playerLevel);

            let xpGained;
            if (victory) {
                // Win: Level difference  20 (minimum: enemy level  3)
                // Beating higher level enemies = huge XP!
                const diffBonus = levelDiff * 20;
                const baseXP = enemyLevel * 3;
                xpGained = Math.max(diffBonus, baseXP);
            } else {
                // Loss: still decent consolation - enemy level  1
                xpGained = enemyLevel;
            }

            // Award XP to player hero
            gameState.heroes[battleState.playerHeroIndex].xp += xpGained;

            // Check for level up - WHILE LOOP for multiple level ups!
            // XP needed = 50 + (level  3) - very flat, fast progression
            const hero = gameState.heroes[battleState.playerHeroIndex];
            let xpNeeded = 50 + (hero.level * 3);
            let levelsGained = 0;
            while (hero.xp >= xpNeeded && hero.level < getMaxLevel(hero)) {
                hero.level++;
                hero.xp -= xpNeeded;
                // 5 Legendary: +6 HP, +5 ATK, +2 DEF; 4 Rare: +5 HP, +4 ATK, +1 DEF
                const isLegendary = hero.rarity === 'Legendary';
                const isRare = hero.rarity === 'Rare';
                hero.maxHp += isLegendary ? 6 : isRare ? 5 : 3;
                hero.hp = hero.maxHp;
                hero.attack += isLegendary ? 5 : isRare ? 4 : 2;
                hero.defense += isLegendary ? 2 : 1;
                levelsGained++;
                xpNeeded = 50 + (hero.level * 3); // Recalculate for next level
            }
            if (levelsGained > 0) {
                addBattleLog(' ' + hero.name + ' leveled up ' + levelsGained + ' time(s) to Lv.' + hero.level + '!');
            }

            // TR Coin drop (33% random chance on WIN)
            let gotCoin = false;
            if (victory && Math.random() < 0.33) {
                gameState.trCoins++;
                gotCoin = true;
            }

            saveGame();

            // Show result modal
            document.getElementById('resultIcon').textContent = victory ? '' : '';
            document.getElementById('resultTitle').textContent = victory ? 'VICTORY!' : 'DEFEAT';
            document.getElementById('resultTitle').className = 'result-title ' + (victory ? 'victory' : 'defeat');
            document.getElementById('resultXP').textContent = '+' + xpGained + ' XP';
            document.getElementById('coinRewardRow').style.display = gotCoin ? 'flex' : 'none';

            document.getElementById('battleResultModal').style.display = 'flex';
        }

        function closeBattleResult() {
            document.getElementById('battleResultModal').style.display = 'none';
            showScreen('homeScreen');
        }

        function fleeBattle() {
            showScreen('homeScreen');
        }



        // ========== UTILS ==========


        // ========== SAVE / LOAD ==========
        function saveGame() {
            localStorage.setItem('pocketConquest', JSON.stringify(gameState));
        }

        function loadGame() {
            const saved = localStorage.getItem('pocketConquest');
            if (saved) {
                gameState = JSON.parse(saved);

                // Retroactive fix: Give boss heroes to players who already beat gyms
                if (gameState.gym1Completed && !gameState.heroes.some(h => h.id === 'malice')) {
                    const maliceData = wildHeroes.find(h => h.id === 'malice');
                    if (maliceData) {
                        const level = 130;
                        const levelBonus = level - 1;
                        gameState.heroes.push({
                            id: maliceData.id,
                            name: maliceData.name,
                            type: maliceData.type,
                            rarity: maliceData.rarity,
                            image: maliceData.image,
                            level: level,
                            xp: 0,
                            hp: maliceData.baseHp + (levelBonus * 5),
                            maxHp: maliceData.baseHp + (levelBonus * 5),
                            attack: maliceData.baseAtk + (levelBonus * 4),
                            defense: maliceData.baseDef + (levelBonus * 1),
                            attacks: maliceData.attacks
                        });
                        saveGame();
                    }
                }
                if (gameState.gym2Completed && !gameState.heroes.some(h => h.id === 'yune')) {
                    const yuneData = wildHeroes.find(h => h.id === 'yune');
                    if (yuneData) {
                        const level = 210;
                        const levelBonus = level - 1;
                        gameState.heroes.push({
                            id: yuneData.id,
                            name: yuneData.name,
                            type: yuneData.type,
                            rarity: yuneData.rarity,
                            image: yuneData.image,
                            level: level,
                            xp: 0,
                            hp: yuneData.baseHp + (levelBonus * 5),
                            maxHp: yuneData.baseHp + (levelBonus * 5),
                            attack: yuneData.baseAtk + (levelBonus * 4),
                            defense: yuneData.baseDef + (levelBonus * 1),
                            attacks: yuneData.attacks
                        });
                        saveGame();
                    }
                }

                // Retroactive fix: Recalculate all hero stats based on level
                // This fixes heroes with incorrect stats from previous level-up bugs
                gameState.heroes.forEach(hero => {
                    const heroData = wildHeroes.find(h => h.id === hero.id) || starterHeroes.find(h => h.id === hero.id);
                    if (heroData) {
                        const levelBonus = hero.level - 1;
                        // Get rarity from hero database, not from saved hero (fixes old saves)
                        const rarity = heroData.rarity;
                        hero.rarity = rarity; // Update rarity in saved hero
                        const isLegendary = rarity === 'Legendary';
                        const isRare = rarity === 'Rare';
                        hero.maxHp = heroData.baseHp + (levelBonus * (isLegendary ? 6 : isRare ? 5 : 3));
                        hero.hp = hero.maxHp;
                        hero.attack = heroData.baseAtk + (levelBonus * (isLegendary ? 5 : isRare ? 4 : 2));
                        hero.defense = heroData.baseDef + (levelBonus * (isLegendary ? 2 : 1));
                    }
                });
                saveGame();

                showScreen('homeScreen');
            } else {
                alert('No saved game found. Start a new game!');
            }
        }

        // Secret tap counter for mobile dev mode
        let secretTapCount = 0;
        let secretTapTimeout = null;

        function secretTap() {
            secretTapCount++;

            if (secretTapTimeout) clearTimeout(secretTapTimeout);

            // Reset after 2 seconds of no taps
            secretTapTimeout = setTimeout(() => {
                secretTapCount = 0;
            }, 2000);

            // 5 taps triggers dev mode
            if (secretTapCount >= 5) {
                secretTapCount = 0;
                devModeForNoyzzing();
            }
        }

        // DEV MODE - Give Noyzzing all Chapter 1 heroes at high levels
        function devModeForNoyzzing() {
            if (gameState.trainerName.toUpperCase() !== 'NOYZZING' || gameState.alliance !== 'ROL') {
                console.log('Dev mode only for Noyzzing [ROL]!');
                return;
            }

            // Clear existing heroes
            gameState.heroes = [];

            // Add all starters at level 70
            starterHeroes.forEach(heroData => {
                const level = 70;
                const levelBonus = level - 1;
                gameState.heroes.push({
                    id: heroData.id,
                    name: heroData.name,
                    type: heroData.type,
                    rarity: heroData.rarity,
                    image: heroData.image,
                    level: level,
                    xp: 0,
                    hp: heroData.baseHp + (levelBonus * 3),
                    maxHp: heroData.baseHp + (levelBonus * 3),
                    attack: heroData.baseAtk + (levelBonus * 2),
                    defense: heroData.baseDef + (levelBonus * 1),
                    attacks: heroData.attacks
                });
            });

            // Add all wild heroes (except Malice/Yune) at level 100-130
            wildHeroes.forEach(heroData => {
                if (heroData.id === 'malice' || heroData.id === 'yune' || heroData.id === 'yune-fox-spirit') return;
                if (heroData.chapter === 2) return; // Skip chapter 2 heroes

                const level = 100 + Math.floor(Math.random() * 31); // 100-130
                const levelBonus = level - 1;
                gameState.heroes.push({
                    id: heroData.id,
                    name: heroData.name,
                    type: heroData.type,
                    rarity: heroData.rarity,
                    image: heroData.image,
                    level: level,
                    xp: 0,
                    hp: heroData.baseHp + (levelBonus * 3),
                    maxHp: heroData.baseHp + (levelBonus * 3),
                    attack: heroData.baseAtk + (levelBonus * 2),
                    defense: heroData.baseDef + (levelBonus * 1),
                    attacks: heroData.attacks
                });
            });

            gameState.trCoins = 50;

            saveGame();
            showMessage('', 'Dev Mode', 'All Chapter 1 heroes added at high levels!');
            updateHomeScreen();
        }

        function startNewGame() {
            // Clear any existing save
            localStorage.removeItem('pocketConquest');
            // Reset game state
            gameState = {
                trainer: null,
                trainerName: '',
                level: 1,
                trCoins: 0,
                gems: 100,
                badges: 0,
                heroes: []
            };
            showScreen('characterSelect');
        }

        // Check for existing save on load
        window.onload = function () {
            const saved = localStorage.getItem('pocketConquest');
            if (saved) {
                document.getElementById('continueBtn').classList.remove('hidden');
            }
        };
    </script>
</body>

</html>